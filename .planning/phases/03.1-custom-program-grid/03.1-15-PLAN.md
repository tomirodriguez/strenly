---
phase: 03.1-custom-program-grid
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/transform-program.ts
  - apps/coach-web/src/components/programs/program-grid/types.ts
  - apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Every exercise belongs to a group (standalone = group of 1)"
    - "Each group gets a sequential letter (A, B, C)"
    - "Each item within a group gets a sequential number (1, 2, 3)"
    - "Display format is always letter+number (A1, B1, B2, C1)"
    - "A1,A2,A3 followed by standalone shows B1, not D1"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/types.ts"
      provides: "groupLetter and groupIndex properties on GridRow"
      contains: "groupLetter?: string"
    - path: "apps/coach-web/src/components/programs/program-grid/transform-program.ts"
      provides: "Logical group calculation treating all exercises as groups"
      contains: "row.groupLetter ="
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx"
      provides: "Unified display: always letter + number"
      contains: "groupLetter"
  key_links:
    - from: "transform-program.ts"
      to: "exercise-row-prefix.tsx"
      via: "GridRow.groupLetter and GridRow.groupIndex properties"
      pattern: "groupLetter.*groupIndex"
---

<objective>
Simplify row labeling by treating ALL exercises as groups.

**Mental model shift:**
- OLD: "supersets" vs "standalone exercises" (two systems)
- NEW: "everything is a group" (one system)
  - Standalone exercise = group with 1 item (A1)
  - Superset = group with multiple items (B1, B2, B3)

This eliminates all special cases and conditional logic.

Output: Every row displays `groupLetter + groupIndex` (A1, B1, B2, C1, D1, D2, D3).
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-UAT-v3.md
@apps/coach-web/src/components/programs/program-grid/transform-program.ts
@apps/coach-web/src/components/programs/program-grid/types.ts
@apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add groupLetter and groupIndex to GridRow type</name>
  <files>apps/coach-web/src/components/programs/program-grid/types.ts</files>
  <action>
Add two optional properties to the GridRow interface (after supersetPosition field):

```typescript
// Row data structure
export interface GridRow {
  // ... existing fields ...

  // Superset fields
  supersetGroup: string | null
  supersetOrder: number | null
  supersetPosition: SupersetPosition

  // Logical group for display (calculated in transform)
  // Every exercise belongs to a group - standalone = group of 1
  groupLetter?: string  // A, B, C...
  groupIndex?: number   // 1, 2, 3... (position within group)

  // Split row fields
  // ...
}
```

These are optional because session-header and add-exercise rows don't need them.
  </action>
  <verify>
`pnpm typecheck` - should pass (optional properties don't require assignment)
  </verify>
  <done>
GridRow type includes groupLetter and groupIndex for unified labeling system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Calculate group assignments in transform-program.ts</name>
  <files>apps/coach-web/src/components/programs/program-grid/transform-program.ts</files>
  <action>
Add logic to calculate `groupLetter` and `groupIndex` for all exercise rows.

**Key insight:** Treat everything as a group. A superset is a named group. A standalone exercise is an implicit group of 1.

Algorithm:
1. Process rows in order within each session
2. Track `currentLetterIndex` starting at 0 (A=0, B=1, C=2...)
3. Track `supersetLetters` Map for named superset groups
4. Track `supersetCounters` Map for item index within each superset
5. For each EXERCISE row:
   - If has supersetGroup: use/assign letter for that group, increment counter
   - If no supersetGroup: assign new letter, index is always 1

Add this logic AFTER the supersetOrder calculation but BEFORE returning flatRows:

```typescript
// Calculate logical groups - treating ALL exercises as groups
// Standalone = group of 1, Superset = group of N
const LETTER_A_CODE = 65

sessions.forEach(session => {
  const sessionExerciseRows = flatRows.filter(
    r => r.sessionId === session.id && r.type === 'exercise'
  )

  let letterIndex = 0
  const supersetLetters = new Map<string, string>()
  const supersetCounters = new Map<string, number>()

  for (const row of sessionExerciseRows) {
    if (row.supersetGroup) {
      // Named group (superset) - share letter, increment counter
      let letter = supersetLetters.get(row.supersetGroup)
      if (!letter) {
        letter = String.fromCharCode(LETTER_A_CODE + letterIndex)
        supersetLetters.set(row.supersetGroup, letter)
        supersetCounters.set(row.supersetGroup, 0)
        letterIndex++
      }
      const counter = (supersetCounters.get(row.supersetGroup) ?? 0) + 1
      supersetCounters.set(row.supersetGroup, counter)

      row.groupLetter = letter
      row.groupIndex = counter
    } else {
      // Standalone exercise = implicit group of 1
      row.groupLetter = String.fromCharCode(LETTER_A_CODE + letterIndex)
      row.groupIndex = 1
      letterIndex++
    }
  }
})
```

Result examples:
- Superset A (3 items): A1, A2, A3
- Standalone after: B1
- Another superset (2 items): C1, C2
- Two standalones: D1, E1
  </action>
  <verify>
`pnpm typecheck` - should pass
  </verify>
  <done>
transform-program.ts calculates groupLetter and groupIndex treating all exercises as groups.
  </done>
</task>

<task type="auto">
  <name>Task 3: Simplify exercise-row-prefix to use unified format</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx</files>
  <action>
Simplify getLabel() to use the unified group system - no more conditionals.

Current logic (complex):
```tsx
const getLabel = (): string => {
  if (row.supersetGroup) {
    return `${row.supersetGroup}${row.supersetOrder ?? ''}`
  }
  const position = row.exercise?.position ?? 0
  const letter = POSITION_LETTERS[position] ?? 'A'
  return `${letter}1`
}
```

New logic (simple):
```tsx
const getLabel = (): string => {
  // Unified format: always letter + number
  // Standalone exercises are just groups of 1
  const letter = row.groupLetter ?? 'A'
  const index = row.groupIndex ?? 1
  return `${letter}${index}`
}
```

Also:
1. Remove the POSITION_LETTERS constant (no longer needed)
2. Remove any conditional logic based on supersetGroup for label generation

The component still uses `row.supersetGroup` for the blue indicator (to show when group has multiple items), but the LABEL is now always the same format.
  </action>
  <verify>
1. `pnpm typecheck` - passes
2. `pnpm lint` - passes (no unused POSITION_LETTERS)
3. Manual test:
   - Add 3 exercises to superset A → shows A1, A2, A3
   - Add standalone after → shows B1 (not D1)
   - Add another standalone → shows C1
   - No duplicate labels ever
  </verify>
  <done>
exercise-row-prefix.tsx uses unified labeling: always letter + number. No special cases.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Every exercise shows `letter + number` format
- Superset A1, A2, A3 → next standalone is B1 (not D1)
- Standalone exercises show X1 (group of 1)
- No label collisions - each group has unique letter
- Blue superset indicator still shows for groups with multiple items
</verification>

<success_criteria>
- GridRow type includes optional groupLetter?: string and groupIndex?: number
- transform-program.ts calculates groups treating all exercises uniformly
- exercise-row-prefix.tsx uses single unified format: `${groupLetter}${groupIndex}`
- POSITION_LETTERS constant removed
- No conditional logic for superset vs standalone in label generation
- Labels follow logical sequence: A1,A2,A3 → B1 → C1,C2 → D1 → E1
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-15-SUMMARY.md`
</output>
