---
phase: 03.1-custom-program-grid
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/transform-program.ts
  - apps/coach-web/src/components/programs/program-grid/types.ts
  - apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Each superset group uses one letter (A, B, C)"
    - "Each standalone non-superset row uses one letter with '1' suffix"
    - "Letters assigned sequentially by logical group order, not physical row position"
    - "A1,A2,A3 followed by non-superset shows B1, not D1"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/transform-program.ts"
      provides: "Logical group letter calculation during transformation"
      contains: "groupLetter"
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx"
      provides: "Display using pre-calculated groupLetter"
      contains: "row.groupLetter"
  key_links:
    - from: "transform-program.ts"
      to: "exercise-row-prefix.tsx"
      via: "GridExerciseRow.groupLetter property"
      pattern: "groupLetter.*[A-Z]"
---

<objective>
Fix row labeling to use logical group letters instead of physical position.

Purpose: Currently non-superset rows use physical position (A1, B1, C1, D1 for positions 0,1,2,3). This causes issues:
1. Label collision when superset exists (superset A1 and non-superset at position 0 both show A1)
2. After superset A1,A2,A3 the next row shows D1 instead of B1

Output: Labels based on logical groups - each superset group = one letter, each standalone row = one letter. Sequence: A1,A2,A3 (superset A), B1 (standalone), C1,C2 (superset C), D1 (standalone).
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-UAT-v3.md
@apps/coach-web/src/components/programs/program-grid/transform-program.ts
@apps/coach-web/src/components/programs/program-grid/types.ts
@apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add groupLetter to GridExerciseRow type</name>
  <files>apps/coach-web/src/components/programs/program-grid/types.ts</files>
  <action>
Add `groupLetter` property to the GridExerciseRow interface.

Find the GridExerciseRow interface and add:
```typescript
groupLetter: string  // Calculated logical group letter (A, B, C...)
```

This will hold the pre-calculated letter for each row based on logical grouping.
  </action>
  <verify>
`pnpm typecheck` - will show errors in transform-program.ts (expected, fixed in next task)
  </verify>
  <done>
GridExerciseRow type includes groupLetter property for logical group labeling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Calculate groupLetter in transform-program.ts</name>
  <files>apps/coach-web/src/components/programs/program-grid/transform-program.ts</files>
  <action>
Modify the transformProgramToGrid function to calculate `groupLetter` for each row.

The algorithm:
1. Process rows in order within each session
2. Track `currentLetter` starting at 'A' (charCode 65)
3. Track `seenSupersetGroups` as a Map<string, string> (supersetGroup -> assigned letter)
4. For each row:
   - If row has supersetGroup AND group already seen: use the assigned letter
   - If row has supersetGroup AND group NOT seen: assign currentLetter, increment currentLetter
   - If row has NO supersetGroup: assign currentLetter, increment currentLetter

Add this logic AFTER the supersetOrder calculation (around line 170-180) but BEFORE returning flatRows.

```typescript
// Calculate logical group letters for each session
const LETTER_A_CODE = 65

sessions.forEach(session => {
  const sessionRows = flatRows.filter(r => r.sessionId === session.id)
  let letterIndex = 0
  const supersetLetters = new Map<string, string>()

  sessionRows.forEach(row => {
    if (row.supersetGroup) {
      // Superset row - check if group already has a letter
      if (!supersetLetters.has(row.supersetGroup)) {
        supersetLetters.set(row.supersetGroup, String.fromCharCode(LETTER_A_CODE + letterIndex))
        letterIndex++
      }
      row.groupLetter = supersetLetters.get(row.supersetGroup)!
    } else {
      // Standalone row - gets its own letter
      row.groupLetter = String.fromCharCode(LETTER_A_CODE + letterIndex)
      letterIndex++
    }
  })
})
```

This ensures:
- Superset A (3 rows) all get letter 'A'
- Next standalone row gets letter 'B'
- Another superset gets letter 'C'
- etc.
  </action>
  <verify>
`pnpm typecheck` - should pass (groupLetter now assigned)
  </verify>
  <done>
transform-program.ts calculates groupLetter for each row based on logical group order.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update exercise-row-prefix to use groupLetter</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx</files>
  <action>
Simplify the getLabel() function to use the pre-calculated groupLetter.

Current logic:
```tsx
const getLabel = (): string => {
  if (row.supersetGroup) {
    return `${row.supersetGroup}${row.supersetOrder ?? ''}`
  }
  const position = row.exercise?.position ?? 0
  const letter = POSITION_LETTERS[position] ?? 'A'
  return `${letter}1`
}
```

New logic:
```tsx
const getLabel = (): string => {
  if (row.supersetGroup) {
    // Superset row: letter + order (A1, A2, A3)
    return `${row.groupLetter}${row.supersetOrder ?? ''}`
  }
  // Standalone row: letter + "1" (B1, C1, D1)
  return `${row.groupLetter}1`
}
```

Also remove the unused POSITION_LETTERS constant since it's no longer needed.
  </action>
  <verify>
1. `pnpm typecheck` - passes
2. `pnpm lint` - passes
3. Manual: Create exercises A1, A2, A3 (superset). Next standalone shows B1, not D1.
4. Manual: No duplicate labels between superset and non-superset rows.
  </verify>
  <done>
exercise-row-prefix.tsx uses groupLetter for all row labels. POSITION_LETTERS removed.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Superset A1, A2, A3 all show letter A
- Standalone row after superset A shows B1 (not D1)
- Next superset after that would show C1, C2
- No label collisions between any rows
</verification>

<success_criteria>
- GridExerciseRow type includes groupLetter: string
- transform-program.ts calculates groupLetter based on logical groups
- exercise-row-prefix.tsx uses groupLetter for display
- POSITION_LETTERS constant removed
- Labels follow logical sequence: A1,A2,A3 -> B1 -> C1,C2 -> D1
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-15-SUMMARY.md`
</output>
