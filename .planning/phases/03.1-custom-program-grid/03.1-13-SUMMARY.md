---
phase: 03.1-custom-program-grid
plan: 13
subsystem: ui
tags: [superset, program-grid, reorder, frontend, backend]

# Dependency graph
requires:
  - phase: 03.1-10
    provides: Superset group dropdown menu and toggle functionality
provides:
  - Dynamic supersetOrder calculation based on physical position
  - Row repositioning when joining superset
  - Adjacent superset grouping for correct visual display
affects: [program-grid, superset-ui, exercise-reordering]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Dynamic calculation over stored state for display values"
    - "Physical repositioning on superset join for visual adjacency"

key-files:
  created: []
  modified:
    - apps/coach-web/src/components/programs/program-grid/transform-program.ts
    - packages/core/src/ports/program-repository.port.ts
    - packages/backend/src/infrastructure/repositories/program.repository.ts
    - packages/backend/src/use-cases/programs/toggle-superset.ts

key-decisions:
  - "Calculate supersetOrder dynamically from physical position rather than storing stale values"
  - "Reposition rows to be adjacent when joining a superset group"

patterns-established:
  - "Display values from physical order: Visual indicators (A1, A2) derived from row position, not stored"
  - "Transactional reordering: Update all affected row orderIndex values atomically"

# Metrics
duration: 8min
completed: 2026-01-25
---

# Phase 3.1 Plan 13: Superset Grouping Fix Summary

**Dynamic superset order calculation and row repositioning for correct adjacent grouping behavior**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-25T12:40:00Z
- **Completed:** 2026-01-25T12:48:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- SupersetOrder (A1, A2, A3) now calculated dynamically from physical row position
- Rows joining a superset are automatically repositioned adjacent to existing group members
- Reordering exercises within a superset correctly updates their display order numbers

## Task Commits

Each task was committed atomically:

1. **Task 1: Calculate supersetOrder dynamically** - `afa31cb` (fix)
2. **Task 2: Reposition row when adding to superset** - `6583410` (feat)

## Files Created/Modified
- `apps/coach-web/src/components/programs/program-grid/transform-program.ts` - Dynamic supersetOrder calculation replacing stored values
- `packages/core/src/ports/program-repository.port.ts` - Added repositionRowToAfterSupersetGroup method signature
- `packages/backend/src/infrastructure/repositories/program.repository.ts` - Implemented row repositioning logic
- `packages/backend/src/use-cases/programs/toggle-superset.ts` - Call repositioning after superset join

## Decisions Made
- **Dynamic over stored values:** SupersetOrder is calculated during transform based on physical row position, making reordering update display numbers automatically without needing to update stored values
- **Reposition on join:** When a row joins an existing superset, it physically moves to be adjacent to other group members (immediately after the last member)
- **TypeScript narrowing:** Used const assignment for `targetGroup` to help TypeScript understand the value is non-null in the superset addition branch

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Superset grouping now works correctly per UAT requirements
- Ready for final UAT verification of Tests 3 & 4
- Blue superset indicator should connect all adjacent group members correctly

---
*Phase: 03.1-custom-program-grid*
*Plan: 13 (Gap Closure)*
*Completed: 2026-01-25*
