---
phase: 03.1-custom-program-grid
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/features/programs/components/program-form.tsx
  - packages/contracts/src/programs/program.ts
  - packages/backend/src/use-cases/programs/create-program.ts
autonomous: true

must_haves:
  truths:
    - "Create program form has weeks number input defaulting to 4"
    - "Athlete field is a searchable combobox with clear option"
    - "Form creates program with specified number of weeks"
  artifacts:
    - path: "apps/coach-web/src/features/programs/components/program-form.tsx"
      provides: "Program form with weeks selector and athlete combobox"
      min_lines: 100
    - path: "packages/contracts/src/programs/program.ts"
      provides: "Updated createProgramInputSchema with weeks field"
      contains: "weeksCount"
  key_links:
    - from: "program-form.tsx"
      to: "Combobox"
      via: "import"
      pattern: "import.*Combobox"
---

<objective>
Improve create program form with weeks selector and searchable athlete combobox

Purpose: UAT feedback - users need to specify initial weeks count (default 4) and want searchable athlete selection with clear option.
Output: Enhanced program form with better UX for athlete selection and explicit weeks configuration.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/coach-web/src/features/programs/components/program-form.tsx
@apps/coach-web/src/components/ui/combobox.tsx
@packages/contracts/src/programs/program.ts
@packages/backend/src/use-cases/programs/create-program.ts
@apps/coach-web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add weeksCount to createProgramInputSchema</name>
  <files>packages/contracts/src/programs/program.ts</files>
  <action>
    Add weeksCount field to createProgramInputSchema:

    1. Add `weeksCount: z.number().int().min(1).max(12).default(4)` to the schema
    2. Keep existing fields (name, description, athleteId, isTemplate)
    3. Update any JSDoc comments to document the new field

    The field should:
    - Be optional with default of 4
    - Accept integers from 1 to 12
    - Represent how many weeks to create initially
  </action>
  <verify>pnpm typecheck passes in contracts package</verify>
  <done>createProgramInputSchema includes weeksCount with default 4</done>
</task>

<task type="auto">
  <name>Task 2: Update create-program use case to create multiple weeks</name>
  <files>packages/backend/src/use-cases/programs/create-program.ts</files>
  <action>
    Update createProgram use case to respect weeksCount:

    1. Extract weeksCount from input (default to 4 if not provided)
    2. Instead of creating just one default week, create weeksCount weeks
    3. Generate week names: "Semana 1", "Semana 2", etc.
    4. Create all weeks in a loop with incrementing position
    5. Still create one default session per program (not per week)

    Example logic:
    ```typescript
    const weeksCount = input.weeksCount ?? 4

    // Create weeks
    for (let i = 0; i < weeksCount; i++) {
      await repository.createWeek({
        programId: program.id,
        name: `Semana ${i + 1}`,
        position: i,
      }, ctx)
    }
    ```

    Keep existing program validation and session creation logic.
  </action>
  <verify>pnpm typecheck passes, creating a program with weeksCount=6 creates 6 weeks</verify>
  <done>Use case creates specified number of weeks with sequential names</done>
</task>

<task type="auto">
  <name>Task 3: Update program form with weeks input and athlete combobox</name>
  <files>apps/coach-web/src/features/programs/components/program-form.tsx</files>
  <action>
    Refactor ProgramForm with new fields:

    1. Add weeksCount number input field:
       - Label: "Semanas iniciales"
       - Input type="number" with min=1, max=12
       - Default value: 4
       - Description: "Cantidad de semanas para crear inicialmente"

    2. Replace athlete Select with Combobox:
       - Import Combobox components from @/components/ui/combobox
       - Add local search state for filtering athletes
       - Use useAthletes hook with search parameter
       - Show "Buscar atleta..." placeholder
       - Display "Sin atleta asignado" as first option (value: undefined/null)
       - Allow clearing selection

    3. Combobox pattern:
       ```tsx
       <Combobox
         value={field.value ?? ''}
         onValueChange={(value) => field.onChange(value || undefined)}
       >
         <ComboboxTrigger>
           <ComboboxInput
             placeholder="Buscar atleta..."
             value={searchValue}
             onChange={(e) => setSearchValue(e.target.value)}
           />
         </ComboboxTrigger>
         <ComboboxContent>
           <ComboboxList>
             <ComboboxItem value="">Sin atleta asignado</ComboboxItem>
             {athletes.map(a => (
               <ComboboxItem key={a.id} value={a.id}>{a.name}</ComboboxItem>
             ))}
           </ComboboxList>
         </ComboboxContent>
       </Combobox>
       ```

    4. Update form defaultValues to include weeksCount: 4
    5. Update form types to include weeksCount from updated schema
  </action>
  <verify>Form renders with weeks input and athlete combobox, submission includes weeksCount</verify>
  <done>Program form has weeks selector and searchable athlete combobox with clear option</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no type errors across all packages
2. Run `pnpm lint` - no lint errors
3. Navigate to /{orgSlug}/programs/new
4. Verify weeks input shows with default 4, can be changed 1-12
5. Verify athlete field is a combobox with search
6. Verify "Sin atleta asignado" option clears selection
7. Create program with 6 weeks, verify 6 week columns appear in editor
</verification>

<success_criteria>
- Weeks input defaults to 4 and validates 1-12 range
- Athlete combobox supports search and clear
- Creating program respects weeksCount setting
- Form validation works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-02-SUMMARY.md`
</output>
