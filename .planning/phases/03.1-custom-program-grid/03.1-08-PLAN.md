---
phase: 03.1-custom-program-grid
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/features/programs/views/new-program-view.tsx
  - apps/coach-web/src/features/programs/components/program-form.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Athlete selector performs server-side search with debounce"
    - "Typing filters athletes via API, not client-side"
    - "Empty state shows correctly when no athletes match search"
    - "UX is dropdown/select style, not combobox-with-typing style"
  artifacts:
    - path: "apps/coach-web/src/features/programs/components/program-form.tsx"
      provides: "Server-side athlete search with debounce"
      contains: "useAthletes.*search"
    - path: "apps/coach-web/src/features/programs/views/new-program-view.tsx"
      provides: "Athletes hook without hardcoded limit"
      contains: "useAthletes"
  key_links:
    - from: "program-form.tsx"
      to: "useAthletes hook"
      via: "search parameter passed to API"
      pattern: "useAthletes.*search"
---

<objective>
Fix athlete selector in program form to use server-side search with proper UX.

Purpose: UAT Test 3 failed because athlete selector fetches all athletes client-side (scalability issue for 1000+ athletes) and uses wrong UX pattern (combobox-with-typing instead of dropdown/select).

Output: Athlete selector that performs server-side paginated search with debounce and displays as dropdown-style Select component.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-UAT.md (gap diagnosis)
@apps/coach-web/src/features/programs/views/new-program-view.tsx
@apps/coach-web/src/features/programs/components/program-form.tsx
@apps/coach-web/src/features/athletes/hooks/queries/use-athletes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update new-program-view to not pre-fetch all athletes</name>
  <files>apps/coach-web/src/features/programs/views/new-program-view.tsx</files>
  <action>
    Remove the `useAthletes({ status: 'active', limit: 100 })` call from new-program-view.tsx.

    The athlete fetching will be moved entirely to the ProgramForm component which will handle search.

    Update the ProgramForm props:
    - Remove `athletes` prop
    - Remove `isLoadingAthletes` prop

    Update the ProgramForm usage:
    ```tsx
    <ProgramForm
      id="program-form"
      onSubmit={handleSubmit}
      showWeeksCount={!selectedTemplateId}
      defaultValues={
        selectedTemplate
          ? {
              name: `${selectedTemplate.name} (copia)`,
            }
          : undefined
      }
    />
    ```

    Remove the athletes-related imports and state from this file.
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    new-program-view.tsx no longer fetches athletes; ProgramForm handles its own athlete data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ProgramForm to use server-side athlete search with Select UX</name>
  <files>apps/coach-web/src/features/programs/components/program-form.tsx</files>
  <action>
    Refactor the athlete selector in ProgramForm to:

    1. **Use server-side search with debounce:**
       - Add internal state for `athleteSearch` (string)
       - Add debounced search value (use 300ms debounce)
       - Call `useAthletes({ status: 'active', search: debouncedSearch, limit: 20 })`
       - Remove the client-side `filteredAthletes` useMemo

    2. **Change UX to Select-style component:**
       Replace Combobox with Select component for a dropdown experience:

       ```tsx
       import { useCallback, useMemo, useState } from 'react'
       import { Controller, useForm } from 'react-hook-form'
       import {
         Select,
         SelectContent,
         SelectItem,
         SelectTrigger,
         SelectValue,
       } from '@/components/ui/select'
       import { Input } from '@/components/ui/input'
       import { useAthletes } from '@/features/athletes/hooks/queries/use-athletes'
       ```

       Create a debounce hook or use inline debounce:
       ```tsx
       // Simple debounce with useEffect + setTimeout
       const [athleteSearch, setAthleteSearch] = useState('')
       const [debouncedSearch, setDebouncedSearch] = useState('')

       useEffect(() => {
         const timer = setTimeout(() => {
           setDebouncedSearch(athleteSearch)
         }, 300)
         return () => clearTimeout(timer)
       }, [athleteSearch])

       const { data: athletesData, isLoading: isLoadingAthletes } = useAthletes({
         status: 'active',
         search: debouncedSearch || undefined,
         limit: 20,
       })
       const athletes = athletesData?.items ?? []
       ```

    3. **Implement searchable Select pattern:**
       Use a Select with a search input inside the dropdown:

       ```tsx
       <Controller
         control={control}
         name="athleteId"
         render={({ field }) => (
           <Select
             value={field.value ?? ''}
             onValueChange={(value) => {
               field.onChange(value || undefined)
             }}
           >
             <SelectTrigger id="athlete">
               <SelectValue
                 placeholder={isLoadingAthletes ? 'Cargando...' : 'Seleccionar atleta...'}
               />
             </SelectTrigger>
             <SelectContent>
               {/* Search input inside dropdown */}
               <div className="p-2">
                 <Input
                   placeholder="Buscar atleta..."
                   value={athleteSearch}
                   onChange={(e) => setAthleteSearch(e.target.value)}
                   className="h-8"
                 />
               </div>
               {/* Option to clear selection */}
               <SelectItem value="">Sin atleta asignado</SelectItem>
               {/* Athlete options */}
               {athletes.length === 0 && debouncedSearch && !isLoadingAthletes && (
                 <div className="py-2 text-center text-sm text-muted-foreground">
                   No se encontraron atletas
                 </div>
               )}
               {athletes.map((athlete) => (
                 <SelectItem key={athlete.id} value={athlete.id}>
                   {athlete.name}
                 </SelectItem>
               ))}
               {isLoadingAthletes && (
                 <div className="py-2 text-center text-sm text-muted-foreground">
                   Buscando...
                 </div>
               )}
             </SelectContent>
           </Select>
         )}
       />
       ```

    4. **Update component props:**
       Remove `athletes` and `isLoadingAthletes` from ProgramFormProps since form now fetches its own data:

       ```tsx
       type ProgramFormProps = {
         id?: string
         onSubmit: (data: CreateProgramInput) => void
         defaultValues?: Partial<CreateProgramInput>
         showWeeksCount?: boolean
       }
       ```

    5. **Handle the items prop for Select:**
       Build items array for SelectValue to display labels:
       ```tsx
       const athleteItems = useMemo(() => [
         { value: '', label: 'Sin atleta asignado' },
         ...athletes.map(a => ({ value: a.id, label: a.name }))
       ], [athletes])
       ```

       Pass to Select:
       ```tsx
       <Select items={athleteItems} ... >
       ```

    6. **Remove Combobox imports** - we're switching to Select pattern.
  </action>
  <verify>
    1. TypeScript compiles:
       ```bash
       pnpm --filter coach-web typecheck
       ```
    2. Lint passes:
       ```bash
       pnpm --filter coach-web lint
       ```
    3. Manual test: Navigate to /[org]/programs/new, open athlete dropdown, type search term, verify server request is made with search param (check Network tab), verify results update after debounce delay.
  </verify>
  <done>
    - Athlete selector uses server-side search with 300ms debounce
    - UX is dropdown/select style with search input inside
    - Empty state shows "No se encontraron atletas" only when search has no results
    - Loading state shows "Buscando..." during search
    - "Sin atleta asignado" option allows clearing selection
  </done>
</task>

</tasks>

<verification>
1. Navigate to create program page
2. Open athlete dropdown
3. Type a search term
4. Verify:
   - Network request includes search parameter
   - Results appear after ~300ms debounce
   - Empty state shows correctly when no matches
   - Selecting an athlete closes dropdown and shows name
   - "Sin atleta asignado" clears selection
</verification>

<success_criteria>
- Athlete selector performs server-side search (verified via Network tab)
- Debounce delay of ~300ms before search request
- Dropdown style UX (not combobox-with-typing)
- Proper empty state and loading state
- No client-side filtering of large athlete lists
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-08-SUMMARY.md`
</output>
