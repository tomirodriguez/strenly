---
phase: 03.1-custom-program-grid
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/ports/program-repository.port.ts
  - packages/backend/src/infrastructure/repositories/program.repository.ts
  - packages/backend/src/use-cases/programs/update-week.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Renaming a week preserves its orderIndex"
    - "Week order remains unchanged after rename"
  artifacts:
    - path: "packages/backend/src/use-cases/programs/update-week.ts"
      provides: "Update week use case that preserves orderIndex"
      contains: "existing.orderIndex"
    - path: "packages/core/src/ports/program-repository.port.ts"
      provides: "findWeekById method signature"
      contains: "findWeekById"
    - path: "packages/backend/src/infrastructure/repositories/program.repository.ts"
      provides: "findWeekById implementation"
      contains: "findWeekById"
  key_links:
    - from: "update-week.ts"
      to: "programRepository.findWeekById"
      via: "fetch existing week first"
      pattern: "findWeekById.*existing"
---

<objective>
Fix week ordering bug where renaming a week changes its position.

Purpose: UAT Test 4 failed because update-week.ts hardcodes `orderIndex: 0` when updating a week, overwriting the existing order.

Output: Update week use case that fetches existing week first and preserves its orderIndex when only renaming.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-UAT.md (gap diagnosis)
@packages/backend/src/use-cases/programs/update-week.ts
@packages/backend/src/infrastructure/repositories/program.repository.ts
@packages/core/src/ports/program-repository.port.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add findWeekById to port and repository, then fix update-week.ts</name>
  <files>
    packages/core/src/ports/program-repository.port.ts
    packages/backend/src/infrastructure/repositories/program.repository.ts
    packages/backend/src/use-cases/programs/update-week.ts
  </files>
  <action>
    The bug is at line 47 of update-week.ts where `orderIndex: 0` is hardcoded. Fix by adding findWeekById method and using it to preserve orderIndex.

    **Step 1: Add findWeekById to ProgramRepositoryPort**

    In `packages/core/src/ports/program-repository.port.ts`, add:

    ```typescript
    findWeekById(
      ctx: OrganizationContext,
      weekId: string
    ): ResultAsync<ProgramWeek, ProgramRepositoryError>
    ```

    **Step 2: Implement findWeekById in program.repository.ts**

    Add implementation that reuses verifyWeekAccess logic:

    ```typescript
    findWeekById(ctx: OrganizationContext, weekId: string): ResultAsync<ProgramWeek, ProgramRepositoryError> {
      return RA.fromPromise(
        verifyWeekAccess(ctx, weekId),
        wrapDbError
      ).andThen((row) => {
        if (!row) {
          return err(notFoundError('week', weekId))
        }
        return ok(mapWeekToDomain(row))
      })
    },
    ```

    **Step 3: Update update-week.ts to use findWeekById**

    Replace the current implementation with:

    ```typescript
    export const makeUpdateWeek =
      (deps: Dependencies) =>
      (input: UpdateWeekInput): ResultAsync<ProgramWeek, UpdateWeekError> => {
        // 1. Authorization FIRST
        if (!hasPermission(input.memberRole, 'programs:write')) {
          return errAsync({
            type: 'forbidden',
            message: 'No permission to modify programs',
          })
        }

        const ctx = { organizationId: input.organizationId, userId: input.userId, memberRole: input.memberRole }

        // 2. Fetch existing week to preserve orderIndex
        return deps.programRepository
          .findWeekById(ctx, input.weekId)
          .mapErr((e): UpdateWeekError => {
            if (e.type === 'NOT_FOUND') {
              return { type: 'not_found', weekId: input.weekId }
            }
            return { type: 'repository_error', message: e.message }
          })
          .andThen((existing) => {
            // 3. Update with new name but preserve orderIndex
            const week: ProgramWeek = {
              ...existing,
              name: input.name.trim(),
              updatedAt: new Date(),
            }

            return deps.programRepository.updateWeek(ctx, week).mapErr((e): UpdateWeekError => {
              if (e.type === 'NOT_FOUND') {
                return { type: 'not_found', weekId: input.weekId }
              }
              return { type: 'repository_error', message: e.message }
            })
          })
      }
    ```
  </action>
  <verify>
    1. TypeScript compiles (all packages):
       ```bash
       pnpm typecheck
       ```
    2. Manual test:
       - Open program with 4+ weeks
       - Note the order (Semana 1, 2, 3, 4)
       - Rename "Semana 3" to "Week Three"
       - Verify it's still in position 3 (not moved to beginning)
  </verify>
  <done>
    - findWeekById added to ProgramRepositoryPort interface
    - findWeekById implemented in program.repository.ts
    - update-week.ts fetches existing week and preserves orderIndex
    - Renaming a week no longer changes its position
  </done>
</task>

</tasks>

<verification>
1. Create a program with 4 weeks
2. Verify weeks display in order: Semana 1, Semana 2, Semana 3, Semana 4
3. Rename Semana 3 to "Test Week"
4. Refresh the page
5. Verify order is: Semana 1, Semana 2, Test Week, Semana 4
</verification>

<success_criteria>
- Renaming a week preserves its position in the grid
- Week orderIndex is not overwritten with 0
- All existing week functionality continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-09-SUMMARY.md`
</output>
