---
phase: 03.1-custom-program-grid
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/use-cases/programs/update-week.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Renaming a week preserves its orderIndex"
    - "Week order remains unchanged after rename"
  artifacts:
    - path: "packages/backend/src/use-cases/programs/update-week.ts"
      provides: "Update week use case that preserves orderIndex"
      contains: "existing.orderIndex"
  key_links:
    - from: "update-week.ts"
      to: "programRepository.findWeekById"
      via: "fetch existing week first"
      pattern: "findWeekById.*existing"
---

<objective>
Fix week ordering bug where renaming a week changes its position.

Purpose: UAT Test 4 failed because update-week.ts hardcodes `orderIndex: 0` when updating a week, overwriting the existing order.

Output: Update week use case that fetches existing week first and preserves its orderIndex when only renaming.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-UAT.md (gap diagnosis)
@packages/backend/src/use-cases/programs/update-week.ts
@packages/backend/src/infrastructure/repositories/program.repository.ts
@packages/core/src/ports/program-repository.port.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix update-week.ts to preserve orderIndex</name>
  <files>packages/backend/src/use-cases/programs/update-week.ts</files>
  <action>
    The bug is at line 47 where `orderIndex: 0` is hardcoded. Fix by fetching the existing week first and preserving its orderIndex.

    Current problematic code:
    ```typescript
    const week: ProgramWeek = {
      id: input.weekId,
      programId: '', // Will be ignored by update
      name: input.name.trim(),
      orderIndex: 0, // BUG: Overwrites existing order!
      createdAt: new Date(),
      updatedAt: new Date(),
    }
    ```

    Fix approach: Add a `findWeekById` method to the port or use existing repository method to fetch the week first.

    Check if `findWeekById` exists on ProgramRepositoryPort. If not, the cleanest fix is to modify the repository's `updateWeek` to only update the `name` field for rename operations.

    **Option A: Fetch existing week first (preferred if findWeekById exists)**
    ```typescript
    return deps.programRepository
      .findWeekById(ctx, input.weekId)
      .mapErr((e): UpdateWeekError => {
        if (e.type === 'NOT_FOUND') {
          return { type: 'not_found', weekId: input.weekId }
        }
        return { type: 'repository_error', message: e.message }
      })
      .andThen((existing) => {
        const week: ProgramWeek = {
          ...existing,
          name: input.name.trim(),
          updatedAt: new Date(),
        }
        return deps.programRepository.updateWeek(ctx, week).mapErr((e): UpdateWeekError => {
          if (e.type === 'NOT_FOUND') {
            return { type: 'not_found', weekId: input.weekId }
          }
          return { type: 'repository_error', message: e.message }
        })
      })
    ```

    **Option B: Add findWeekById to port and repository if it doesn't exist**

    First check the port interface. Looking at the repository code, `verifyWeekAccess` exists internally but isn't exposed on the port.

    The simplest fix: Add `findWeekById` to the repository port and implement it, OR since the repository already verifies week access and the updateWeek method receives a full ProgramWeek but only updates certain fields, modify the repository to fetch existing values internally for fields not being updated.

    Actually, looking at the repository's updateWeek implementation (lines 564-596), it already fetches the existing week via `verifyWeekAccess`, but then it updates BOTH `name` and `orderIndex` from the input.

    The cleanest fix is to modify the use case to not pass orderIndex at all, and have the repository's updateWeek only update the name. But that would require repository changes.

    **Simplest fix for use case only:**
    Since repository's updateWeek already fetches existing week internally, we need to ensure we pass the correct orderIndex. We need a way to get the existing week's orderIndex.

    Add `findWeekById` to the port interface in @strenly/core and implement in repository, OR use a simpler approach:

    **Recommended approach:** Modify the repository's updateWeek to not update orderIndex when called with orderIndex: 0 or a sentinel value. But that's hacky.

    **Best approach:** Add findWeekById to the port and use it in the use case.

    1. First check if findWeekById exists on ProgramRepositoryPort
    2. If not, add it to the port interface in @strenly/core
    3. Implement it in program.repository.ts (similar to verifyWeekAccess but returns domain object)
    4. Use it in update-week.ts

    Since this is a gap closure plan, let's do the minimal fix:

    Looking at the port interface, we need to add a method. But wait - we can use `findWithDetails` to get the week, but that's overkill for just getting one week's orderIndex.

    **Minimal fix in use case only:**
    The repository already has internal `verifyWeekAccess` that returns the week row. Let's expose this as `findWeekById` on the port.

    For this task, modify update-week.ts to work around the issue by:
    1. First trying to use an existing method or
    2. Adding a simple internal fetch

    Actually, looking at available methods on ProgramRepositoryPort, there's no direct findWeekById. The proper fix requires adding it.

    **For a truly minimal fix (no port changes):**
    We could have the use case call findWithDetails and extract the week, but that's wasteful.

    **Recommended fix (requires 2 files):**
    Since this gap closure needs to be complete, let's add findWeekById to the port and repository, then use it.

    But the instructions say to only modify update-week.ts. Let me re-read the UAT diagnosis...

    The diagnosis says:
    - "Fetch existing week first to preserve orderIndex"
    - OR "change repository to only update name field for rename"

    Let's go with the repository modification approach - change the repository's updateWeek to only update the name field (not orderIndex) since the use case input for rename only provides name.

    Actually, looking more carefully at the port and repository, the repository's updateWeek takes a full ProgramWeek and updates all mutable fields. This is the correct design - it should update what it's given.

    The bug is in the use case constructing a ProgramWeek with orderIndex: 0 when it should preserve the existing value.

    **Final approach:**
    We need to either:
    1. Add findWeekById to the port (requires core package change)
    2. Have the use case somehow get the existing orderIndex

    Since the repository's updateWeek internally calls verifyWeekAccess which fetches the existing week but doesn't return it to the caller, we could modify the repository to merge instead of replace... but that changes behavior.

    **Cleanest solution:** Add findWeekById to port. But that's a core change.

    Given we're in gap closure mode and need a working fix, let's modify the use-case AND add findWeekById to the port if needed.

    Actually, reading the files_modified in the frontmatter, it only lists update-week.ts. Let me check if there's already a way to get week info without modifying the port...

    Looking at the repository, there's no public findWeekById. We need to add it.

    **Update files_modified to include:**
    - packages/core/src/ports/program-repository.port.ts (add findWeekById signature)
    - packages/backend/src/infrastructure/repositories/program.repository.ts (implement findWeekById)

    But wait, the task says only update-week.ts. Let me re-scope...

    Actually, the PROPER fix requires port + repository changes. Let me add those to files_modified and do it right.
  </action>
  <verify>
    1. TypeScript compiles:
       ```bash
       pnpm typecheck
       ```
    2. Manual test: Create program with multiple weeks, rename week 3, verify it stays in position 3.
  </verify>
  <done>
    Renaming a week no longer changes its orderIndex. The week stays in its original position.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add findWeekById to port and repository</name>
  <files>
    packages/core/src/ports/program-repository.port.ts
    packages/backend/src/infrastructure/repositories/program.repository.ts
  </files>
  <action>
    **Step 1: Add findWeekById to ProgramRepositoryPort**

    In `packages/core/src/ports/program-repository.port.ts`, add:

    ```typescript
    findWeekById(
      ctx: OrganizationContext,
      weekId: string
    ): ResultAsync<ProgramWeek, ProgramRepositoryError>
    ```

    **Step 2: Implement findWeekById in program.repository.ts**

    Add implementation that reuses verifyWeekAccess logic:

    ```typescript
    findWeekById(ctx: OrganizationContext, weekId: string): ResultAsync<ProgramWeek, ProgramRepositoryError> {
      return RA.fromPromise(
        verifyWeekAccess(ctx, weekId),
        wrapDbError
      ).andThen((row) => {
        if (!row) {
          return err(notFoundError('week', weekId))
        }
        return ok(mapWeekToDomain(row))
      })
    },
    ```

    **Step 3: Update update-week.ts to use findWeekById**

    Replace the current implementation with:

    ```typescript
    export const makeUpdateWeek =
      (deps: Dependencies) =>
      (input: UpdateWeekInput): ResultAsync<ProgramWeek, UpdateWeekError> => {
        // 1. Authorization FIRST
        if (!hasPermission(input.memberRole, 'programs:write')) {
          return errAsync({
            type: 'forbidden',
            message: 'No permission to modify programs',
          })
        }

        const ctx = { organizationId: input.organizationId, userId: input.userId, memberRole: input.memberRole }

        // 2. Fetch existing week to preserve orderIndex
        return deps.programRepository
          .findWeekById(ctx, input.weekId)
          .mapErr((e): UpdateWeekError => {
            if (e.type === 'NOT_FOUND') {
              return { type: 'not_found', weekId: input.weekId }
            }
            return { type: 'repository_error', message: e.message }
          })
          .andThen((existing) => {
            // 3. Update with new name but preserve orderIndex
            const week: ProgramWeek = {
              ...existing,
              name: input.name.trim(),
              updatedAt: new Date(),
            }

            return deps.programRepository.updateWeek(ctx, week).mapErr((e): UpdateWeekError => {
              if (e.type === 'NOT_FOUND') {
                return { type: 'not_found', weekId: input.weekId }
              }
              return { type: 'repository_error', message: e.message }
            })
          })
      }
    ```
  </action>
  <verify>
    1. TypeScript compiles (all packages):
       ```bash
       pnpm typecheck
       ```
    2. Manual test:
       - Open program with 4+ weeks
       - Note the order (Semana 1, 2, 3, 4)
       - Rename "Semana 3" to "Week Three"
       - Verify it's still in position 3 (not moved to beginning)
  </verify>
  <done>
    - findWeekById added to ProgramRepositoryPort interface
    - findWeekById implemented in program.repository.ts
    - update-week.ts fetches existing week and preserves orderIndex
    - Renaming a week no longer changes its position
  </done>
</task>

</tasks>

<verification>
1. Create a program with 4 weeks
2. Verify weeks display in order: Semana 1, Semana 2, Semana 3, Semana 4
3. Rename Semana 3 to "Test Week"
4. Refresh the page
5. Verify order is: Semana 1, Semana 2, Test Week, Semana 4
</verification>

<success_criteria>
- Renaming a week preserves its position in the grid
- Week orderIndex is not overwritten with 0
- All existing week functionality continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-09-SUMMARY.md`
</output>
