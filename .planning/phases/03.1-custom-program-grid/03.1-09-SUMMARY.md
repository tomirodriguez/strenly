---
phase: 03.1-custom-program-grid
plan: 09
subsystem: api
tags: [program, week, orderIndex, neverthrow, drizzle]

# Dependency graph
requires:
  - phase: 03-program-builder
    provides: Program repository and update-week use case
provides:
  - findWeekById method on ProgramRepositoryPort
  - Week orderIndex preservation when renaming
affects: [program-builder, grid-operations]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Fetch existing entity before partial update to preserve unchanged fields"

key-files:
  created: []
  modified:
    - packages/core/src/ports/program-repository.port.ts
    - packages/backend/src/infrastructure/repositories/program.repository.ts
    - packages/backend/src/use-cases/programs/update-week.ts

key-decisions:
  - "Reuse verifyWeekAccess helper for findWeekById implementation"
  - "Fetch existing week first in use case to preserve all fields"

patterns-established:
  - "Use findById before updateX to preserve non-input fields"

# Metrics
duration: 1min
completed: 2026-01-25
---

# Phase 3.1 Plan 09: Week Ordering Bug Fix Summary

**Fix week ordering bug by adding findWeekById method and preserving orderIndex when renaming weeks**

## Performance

- **Duration:** 1 min 15s
- **Started:** 2026-01-25T17:33:02Z
- **Completed:** 2026-01-25T17:34:17Z
- **Tasks:** 1
- **Files modified:** 3

## Accomplishments
- Added `findWeekById` method to `ProgramRepositoryPort` interface
- Implemented `findWeekById` in repository using existing `verifyWeekAccess` helper
- Fixed `update-week.ts` use case to fetch existing week first and preserve `orderIndex`
- UAT Test 4 root cause resolved: renaming a week no longer moves it to position 0

## Task Commits

Each task was committed atomically:

1. **Task 1: Add findWeekById to port and repository, fix update-week.ts** - `7ead56b` (fix)

## Files Created/Modified
- `packages/core/src/ports/program-repository.port.ts` - Added `findWeekById` method signature
- `packages/backend/src/infrastructure/repositories/program.repository.ts` - Implemented `findWeekById` using `verifyWeekAccess`
- `packages/backend/src/use-cases/programs/update-week.ts` - Now fetches existing week and preserves `orderIndex`

## Decisions Made
- Reused `verifyWeekAccess` helper for `findWeekById` to avoid code duplication
- Use case fetches full existing week to preserve all fields, not just orderIndex

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

Pre-existing TypeScript errors in `coach-web/src/components/programs/exercise-row-actions.tsx` (unrelated to this fix). The core and backend packages compile correctly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Week ordering bug is fixed
- Renaming weeks now preserves their position in the grid
- Ready for UAT re-verification

---
*Phase: 03.1-custom-program-grid*
*Completed: 2026-01-25*
