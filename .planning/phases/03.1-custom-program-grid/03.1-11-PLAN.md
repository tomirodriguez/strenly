---
phase: 03.1-custom-program-grid
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/use-grid-navigation.ts
  - apps/coach-web/src/components/programs/program-grid/use-cell-editing.ts
  - apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
  - apps/coach-web/src/components/programs/program-grid/grid-body.tsx
  - apps/coach-web/src/components/programs/program-grid/exercise-row.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Arrow keys move between cells consistently without losing focus"
    - "Single click selects cell without entering edit mode"
    - "Double-click or Enter/F2 enters edit mode"
    - "S key toggles superset when cell is selected but not editing"
    - "Escape exits edit mode and returns focus to cell"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/use-grid-navigation.ts"
      provides: "DOM focus management with ref-based cell focusing"
      contains: "focusCell"
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      provides: "Separated click-to-select from double-click-to-edit"
      contains: "onDoubleClick"
    - path: "apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx"
      provides: "Separated click-to-select from double-click-to-edit"
      contains: "onDoubleClick"
  key_links:
    - from: "use-grid-navigation.ts"
      to: "DOM elements"
      via: "element.focus() calls"
      pattern: "focus\\(\\)"
    - from: "use-cell-editing.ts"
      to: "use-grid-navigation.ts"
      via: "onEditStop callback for focus restoration"
      pattern: "onEditStop.*focus"
---

<objective>
Fix keyboard navigation and edit mode to work correctly.

Purpose: UAT Tests 10 and 13 failed due to same root cause:
1. Click conflates selection with editing - clicking a cell auto-enters edit mode
2. Missing DOM focus management - focus is lost when navigating or exiting edit mode
3. S key shortcut fails because editingCell is always set on click

Output: Grid with proper click-to-select, explicit edit mode entry (Enter/F2/double-click), and reliable keyboard navigation.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-UAT.md (gap diagnosis)
@apps/coach-web/src/components/programs/program-grid/use-grid-navigation.ts
@apps/coach-web/src/components/programs/program-grid/use-cell-editing.ts
@apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
@apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
@apps/coach-web/src/components/programs/program-grid/program-grid.tsx
@apps/coach-web/src/components/programs/program-grid/grid-body.tsx
@apps/coach-web/src/components/programs/program-grid/exercise-row.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DOM focus management to use-grid-navigation.ts</name>
  <files>apps/coach-web/src/components/programs/program-grid/use-grid-navigation.ts</files>
  <action>
    The hook updates `activeCell` state but never manages DOM focus. Add focus management.

    **Changes:**

    1. **Add a ref map or callback for focusing cells:**
       ```typescript
       interface UseGridNavigationOptions {
         rows: GridRow[]
         columns: GridColumn[]
         onCellChange?: (cell: GridCell | null) => void
         /** Ref to the table element for querying cells */
         tableRef?: React.RefObject<HTMLTableElement>
       }
       ```

    2. **Add focusCell helper function:**
       ```typescript
       const focusCell = useCallback((rowId: string, colId: string) => {
         if (!tableRef?.current) return

         // Find the cell element by data attributes
         // Exercise cells are in column 0, prescription cells have data-row-id and data-week-id
         let cellElement: HTMLElement | null = null

         if (colId === 'exercise') {
           // Exercise column - find by row ID
           cellElement = tableRef.current.querySelector(
             `td[data-row-id="${rowId}"][data-col-id="exercise"]`
           ) as HTMLElement
         } else {
           // Prescription cell - find by row and week ID
           cellElement = tableRef.current.querySelector(
             `td[data-row-id="${rowId}"][data-week-id="${colId}"]`
           ) as HTMLElement
         }

         if (cellElement) {
           cellElement.focus()
         }
       }, [tableRef])
       ```

    3. **Call focusCell when activeCell changes:**
       Add useEffect to focus the cell element:
       ```typescript
       useEffect(() => {
         if (activeCell) {
           focusCell(activeCell.rowId, activeCell.colId)
         }
       }, [activeCell, focusCell])
       ```

    4. **Update moveTo to trigger focus after state update:**
       The useEffect above handles this automatically.

    5. **Export focusCell for external use (e.g., after edit stops):**
       ```typescript
       return {
         activeCell,
         setActiveCell,
         clearActiveCell,
         handleKeyDown,
         focusCell,  // New export
       }
       ```
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    - DOM focus management added via focusCell function
    - Cell receives focus when activeCell changes
    - focusCell exported for use by cell editing hook
  </done>
</task>

<task type="auto">
  <name>Task 2: Add focus restoration to use-cell-editing.ts</name>
  <files>apps/coach-web/src/components/programs/program-grid/use-cell-editing.ts</files>
  <action>
    When exiting edit mode, focus should return to the cell. The hook needs access to the focusCell function.

    **Changes:**

    1. **Update options to accept focusCell callback:**
       ```typescript
       interface UseCellEditingOptions {
         onEditStart?: (cell: GridCell) => void
         onEditStop?: () => void
         /** Callback to restore focus to a cell after editing */
         focusCell?: (rowId: string, colId: string) => void
       }
       ```

    2. **Store last edited cell for focus restoration:**
       ```typescript
       const [lastEditedCell, setLastEditedCell] = useState<GridCell | null>(null)
       ```

    3. **Update startEditing to track the cell:**
       ```typescript
       const startEditing = useCallback(
         (cell: GridCell) => {
           setEditingCell(cell)
           setLastEditedCell(cell)
           onEditStart?.(cell)
         },
         [onEditStart],
       )
       ```

    4. **Update stopEditing to restore focus:**
       ```typescript
       const stopEditing = useCallback(() => {
         const cellToFocus = editingCell ?? lastEditedCell
         setEditingCell(null)
         onEditStop?.()

         // Restore focus to the cell after a microtask to let React update DOM
         if (cellToFocus && focusCell) {
           requestAnimationFrame(() => {
             focusCell(cellToFocus.rowId, cellToFocus.colId)
           })
         }
       }, [editingCell, lastEditedCell, focusCell, onEditStop])
       ```
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    - Focus restoration on edit stop
    - Uses requestAnimationFrame to ensure DOM is updated before focusing
  </done>
</task>

<task type="auto">
  <name>Task 3: Separate click-to-select from edit in exercise-cell.tsx</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx</files>
  <action>
    Currently `onClick={onStartEdit}` makes click immediately enter edit mode. Change to:
    - Single click: select cell (call onSelect)
    - Double click: enter edit mode (call onStartEdit)

    **Changes:**

    1. **Add onSelect prop:**
       ```typescript
       interface ExerciseCellProps {
         row: GridRow
         programId: string
         sessionRowIds: string[]
         sessionRows: Array<{ id: string; supersetGroup: string | null }>
         isActive: boolean
         isEditing: boolean
         onSelect: () => void      // NEW: for single click
         onStartEdit: () => void   // For double click / Enter / F2
         onCommit: (exerciseId: string, exerciseName: string) => void
         onCancel: () => void
         onAddSplitRow: () => void
       }
       ```

    2. **Add data attribute for focus targeting:**
       On the view mode td, add data attributes:
       ```tsx
       <td
         className={cn(...)}
         onClick={onSelect}         // Changed from onStartEdit
         onDoubleClick={onStartEdit}  // NEW: double click to edit
         onKeyDown={handleCellKeyDown}
         tabIndex={isActive ? 0 : -1}
         data-row-id={row.id}        // NEW
         data-col-id="exercise"      // NEW
       >
       ```

    3. **Update handleCellKeyDown to properly handle edit triggers:**
       ```typescript
       const handleCellKeyDown = (e: React.KeyboardEvent) => {
         // Enter or F2 to start editing (Excel convention)
         if (e.key === 'Enter' || e.key === 'F2') {
           e.preventDefault()
           onStartEdit()
           return
         }
         // Any printable character starts editing (quick-edit mode)
         if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
           // Start editing with this character
           onStartEdit()
           // Don't prevent default - let the character be typed
           return
         }
       }
       ```
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    - Single click selects cell (calls onSelect)
    - Double click enters edit mode
    - Enter/F2 enters edit mode
    - Printable character starts editing
    - Data attributes added for focus targeting
  </done>
</task>

<task type="auto">
  <name>Task 4: Separate click-to-select from edit in prescription-cell.tsx</name>
  <files>apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
    Apply same pattern as exercise-cell.

    **Changes:**

    1. **Add onSelect prop:**
       ```typescript
       interface PrescriptionCellProps {
         value: string
         rowId: string
         weekId: string
         isActive: boolean
         isEditing: boolean
         isSubRow: boolean
         onSelect: () => void       // NEW: for single click
         onStartEdit: () => void    // For double click / Enter / F2
         onCommit: (value: string) => void
         onCancel: () => void
         onNavigate: (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => void
       }
       ```

    2. **Update view mode td:**
       ```tsx
       <td
         className={cn(...)}
         onClick={onSelect}           // Changed from onStartEdit
         onDoubleClick={onStartEdit}  // NEW
         onKeyDown={handleCellKeyDown}
         tabIndex={isActive ? 0 : -1}
         data-row-id={rowId}
         data-week-id={weekId}
       >
       ```

    3. **Update handleCellKeyDown for view mode:**
       The existing implementation is mostly correct but ensure it doesn't call onStartEdit on navigation:
       ```typescript
       const handleCellKeyDown = (e: React.KeyboardEvent) {
         switch (e.key) {
           case 'ArrowUp':
           case 'ArrowDown':
           case 'ArrowLeft':
           case 'ArrowRight':
           case 'Tab':
             // Navigation handled by parent grid
             // Don't prevent default - let grid handle
             break
           case 'Enter':
           case 'F2':
             e.preventDefault()
             onStartEdit()
             break
           default:
             // Start editing on any printable character
             if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
               setEditValue(e.key)
               onStartEdit()
             }
         }
       }
       ```

       Wait, looking at current implementation, handleCellKeyDown already handles navigation internally. This is wrong - navigation should be handled by the grid, not individual cells.

       **Fix: Remove navigation handling from cell's view mode handler:**
       The cell should only handle Enter/F2 for editing. Navigation keys should bubble up to the grid.

       ```typescript
       const handleCellKeyDown = (e: React.KeyboardEvent) => {
         // Only handle edit triggers, let navigation bubble to grid
         switch (e.key) {
           case 'Enter':
           case 'F2':
             e.preventDefault()
             onStartEdit()
             break
           default:
             // Start editing on any printable character
             if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
               setEditValue(e.key)
               onStartEdit()
             }
             // Other keys (arrows, tab) bubble up to grid
         }
       }
       ```
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    - Single click selects cell
    - Double click enters edit mode
    - Navigation keys bubble to grid
    - Edit mode triggers work correctly
  </done>
</task>

<task type="auto">
  <name>Task 5: Update program-grid.tsx to wire new props and focus management</name>
  <files>apps/coach-web/src/components/programs/program-grid/program-grid.tsx</files>
  <action>
    Wire up the changes from previous tasks.

    **Changes:**

    1. **Pass tableRef to useGridNavigation:**
       ```typescript
       const tableRef = useRef<HTMLTableElement>(null)

       const { activeCell, setActiveCell, handleKeyDown, focusCell } = useGridNavigation({
         rows,
         columns,
         tableRef,  // NEW
       })
       ```

    2. **Pass focusCell to useCellEditing:**
       ```typescript
       const { editingCell, startEditing, stopEditing } = useCellEditing({
         focusCell,  // NEW
       })
       ```

    3. **Update GridBody props to support separate select and edit:**
       Update the calls to pass both onCellSelect and onCellEdit (or however GridBody handles it).

       Looking at current code, handleCellClick just sets active cell, and handleStartEdit starts editing.
       We need to ensure GridBody passes these correctly to cells.

       **In program-grid.tsx:**
       ```typescript
       // Handle cell selection (single click)
       const handleCellSelect = (rowId: string, colId: string) => {
         setActiveCell(rowId, colId)
       }

       // Handle edit start (double click or Enter)
       const handleStartEdit = (rowId: string, colId: string) => {
         // First select the cell
         setActiveCell(rowId, colId)

         const rowIndex = rows.findIndex((r) => r.id === rowId)
         const colIndex = columns.findIndex((c) => c.id === colId)
         if (rowIndex >= 0 && colIndex >= 0) {
           const cell = { rowId, colId, rowIndex, colIndex }
           startEditing(cell)
         }
       }
       ```

       **Pass to GridBody:**
       ```tsx
       <GridBody
         rows={rows}
         columns={columns}
         programId={program.id}
         activeCell={activeCell}
         editingCell={editingCell}
         onCellSelect={handleCellSelect}   // Renamed from onCellClick
         onStartEdit={handleStartEdit}
         onStopEdit={stopEditing}
         onCommitExercise={handleCommitExercise}
         onCommitPrescription={handleCommitPrescription}
         onNavigate={handleNavigate}
         onAddExercise={handleAddExercise}
         onAddSplitRow={handleAddSplitRow}
       />
       ```

    4. **Update S key shortcut check:**
       The S key shortcut should work now since editingCell is only set on explicit edit actions.
       Verify the condition:
       ```typescript
       if (e.key === 's' && !editingCell && activeCell && !e.ctrlKey && !e.metaKey) {
       ```
       This should now work correctly.
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    - tableRef passed to useGridNavigation
    - focusCell passed to useCellEditing
    - Cell selection and edit triggers properly separated
    - S key shortcut works when cell selected but not editing
  </done>
</task>

<task type="auto">
  <name>Task 6: Update grid-body.tsx to pass new props to cells</name>
  <files>apps/coach-web/src/components/programs/program-grid/grid-body.tsx</files>
  <action>
    Update GridBody to receive and pass the separated select/edit props.

    **Changes:**

    1. **Update GridBodyProps:**
       ```typescript
       interface GridBodyProps {
         rows: GridRow[]
         columns: GridColumn[]
         programId: string
         activeCell: GridCell | null
         editingCell: GridCell | null
         onCellSelect: (rowId: string, colId: string) => void  // Renamed
         onStartEdit: (rowId: string, colId: string) => void
         onStopEdit: () => void
         onCommitExercise: (rowId: string, exerciseId: string, exerciseName: string) => void
         onCommitPrescription: (rowId: string, weekId: string, value: string) => void
         onNavigate: (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => void
         onAddExercise: (sessionId: string, exerciseId: string, exerciseName: string) => void
         onAddSplitRow: (rowId: string) => void
       }
       ```

    2. **Pass to ExerciseRow:**
       ```tsx
       <ExerciseRow
         row={row}
         columns={columns}
         programId={programId}
         sessionRowIds={sessionRowIds}
         sessionRows={rowsBySession.get(row.sessionId) ?? []}
         isActiveRow={activeCell?.rowId === row.id}
         activeColId={activeCell?.rowId === row.id ? activeCell.colId : null}
         editingColId={editingCell?.rowId === row.id ? editingCell.colId : null}
         onCellSelect={(colId) => onCellSelect(row.id, colId)}  // Updated
         onStartEdit={(colId) => onStartEdit(row.id, colId)}
         onStopEdit={onStopEdit}
         onCommitExercise={(exerciseId, name) => onCommitExercise(row.id, exerciseId, name)}
         onCommitPrescription={(weekId, value) => onCommitPrescription(row.id, weekId, value)}
         onNavigate={onNavigate}
         onAddSplitRow={() => onAddSplitRow(row.id)}
       />
       ```
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    GridBody passes onCellSelect and onStartEdit separately to child components.
  </done>
</task>

<task type="auto">
  <name>Task 7: Update exercise-row.tsx to pass new props to cells</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-row.tsx</files>
  <action>
    Update ExerciseRow to accept and pass the separated select/edit props.

    **Changes:**

    1. **Update ExerciseRowProps:**
       ```typescript
       interface ExerciseRowProps {
         row: GridRow
         columns: GridColumn[]
         programId: string
         sessionRowIds: string[]
         sessionRows: Array<{ id: string; supersetGroup: string | null }>
         isActiveRow: boolean
         activeColId: string | null
         editingColId: string | null
         onCellSelect: (colId: string) => void  // NEW
         onStartEdit: (colId: string) => void
         onStopEdit: () => void
         onCommitExercise: (exerciseId: string, exerciseName: string) => void
         onCommitPrescription: (weekId: string, value: string) => void
         onNavigate: (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => void
         onAddSplitRow: () => void
       }
       ```

    2. **Pass to ExerciseCell:**
       ```tsx
       <ExerciseCell
         row={row}
         programId={programId}
         sessionRowIds={sessionRowIds}
         sessionRows={sessionRows}
         isActive={isActiveRow && activeColId === 'exercise'}
         isEditing={editingColId === 'exercise'}
         onSelect={() => onCellSelect('exercise')}      // NEW
         onStartEdit={() => onStartEdit('exercise')}
         onCommit={onCommitExercise}
         onCancel={onStopEdit}
         onAddSplitRow={onAddSplitRow}
       />
       ```

    3. **Pass to PrescriptionCell (for each week column):**
       ```tsx
       <PrescriptionCell
         key={column.id}
         value={prescriptionValue}
         rowId={row.id}
         weekId={column.id}
         isActive={isActiveRow && activeColId === column.id}
         isEditing={editingColId === column.id}
         isSubRow={row.isSubRow ?? false}
         onSelect={() => onCellSelect(column.id)}      // NEW
         onStartEdit={() => onStartEdit(column.id)}
         onCommit={(value) => onCommitPrescription(column.id, value)}
         onCancel={onStopEdit}
         onNavigate={onNavigate}
       />
       ```
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    pnpm --filter coach-web typecheck
    ```
  </verify>
  <done>
    ExerciseRow passes onSelect and onStartEdit separately to ExerciseCell and PrescriptionCell.
  </done>
</task>

</tasks>

<verification>
**Test keyboard navigation (UAT Test 10):**
1. Click on a prescription cell
2. Verify cell is selected (blue ring) but NOT in edit mode (no input)
3. Press arrow keys
4. Verify focus moves to adjacent cells without losing focus
5. Verify no auto-edit on exercise cells when navigating

**Test edit mode entry:**
1. Select a cell with single click
2. Press Enter - verify edit mode starts
3. Press Escape - verify returns to selected state
4. Double-click a cell - verify edit mode starts directly

**Test S key shortcut (UAT Test 13):**
1. Navigate to an exercise row (not editing)
2. Press S key
3. Verify superset toggles (blue line appears/disappears)
4. Verify S does NOT type into any input

**Test focus consistency:**
1. Start editing a prescription cell
2. Type a value and press Escape
3. Verify focus returns to the cell (not lost)
4. Press arrow key
5. Verify navigation works immediately
</verification>

<success_criteria>
- Arrow key navigation works consistently without focus loss
- Single click selects cell, double-click/Enter/F2 edits
- S key toggles superset when cell selected but not editing
- Escape exits edit mode and returns focus to cell
- Tab navigation commits edit and moves to next cell
- No auto-edit on exercise cells when navigating
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-11-SUMMARY.md`
</output>
