---
phase: 03.1-custom-program-grid
plan: 06
type: execute
wave: 4
depends_on: ["03.1-04", "03.1-05"]
files_modified:
  - apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/exercise-row.tsx
  - apps/coach-web/src/components/programs/program-grid/grid-body.tsx
autonomous: true

must_haves:
  truths:
    - "Prescription cells display notation and edit inline"
    - "Exercise rows combine exercise cell with prescription cells"
    - "Grid body renders all rows with proper structure"
    - "Keyboard navigation moves between cells"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx"
      provides: "Editable prescription cell"
      min_lines: 60
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-row.tsx"
      provides: "Complete exercise row"
      min_lines: 50
    - path: "apps/coach-web/src/components/programs/program-grid/grid-body.tsx"
      provides: "Grid body with all rows"
      min_lines: 80
  key_links:
    - from: "exercise-row.tsx"
      to: "prescription-cell.tsx"
      via: "composition"
      pattern: "<PrescriptionCell"
    - from: "grid-body.tsx"
      to: "exercise-row.tsx"
      via: "composition"
      pattern: "<ExerciseRow"
---

<objective>
Create prescription cell, exercise row, and grid body components

Purpose: Complete the grid row components - prescription cells for week columns and the grid body that assembles all rows.
Output: Full row rendering with editable prescription cells and keyboard navigation support.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-RESEARCH.md
@.planning/phases/03-program-builder/ui-ux-specifications/code.html
@apps/coach-web/src/components/programs/program-grid/types.ts
@apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
@apps/coach-web/src/components/programs/program-grid/session-header-row.tsx
@apps/coach-web/src/components/programs/program-grid/add-exercise-row.tsx
@apps/coach-web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PrescriptionCell component</name>
  <files>apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
    Create editable prescription cell with click-to-edit behavior:

    ```typescript
    import { useEffect, useRef, useState } from 'react'
    import { Input } from '@/components/ui/input'
    import { cn } from '@/lib/utils'

    interface PrescriptionCellProps {
      value: string
      rowId: string
      weekId: string
      isActive: boolean
      isEditing: boolean
      isSubRow: boolean
      onStartEdit: () => void
      onCommit: (value: string) => void
      onCancel: () => void
      onNavigate: (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => void
    }

    export function PrescriptionCell({
      value,
      rowId,
      weekId,
      isActive,
      isEditing,
      isSubRow,
      onStartEdit,
      onCommit,
      onCancel,
      onNavigate,
    }: PrescriptionCellProps) {
      const [editValue, setEditValue] = useState(value)
      const inputRef = useRef<HTMLInputElement>(null)

      // Focus input when entering edit mode
      useEffect(() => {
        if (isEditing) {
          inputRef.current?.focus()
          inputRef.current?.select()
        }
      }, [isEditing])

      // Reset edit value when cell value changes externally
      useEffect(() => {
        if (!isEditing) {
          setEditValue(value)
        }
      }, [value, isEditing])

      const handleKeyDown = (e: React.KeyboardEvent) => {
        switch (e.key) {
          case 'Enter':
            e.preventDefault()
            onCommit(editValue)
            break
          case 'Escape':
            e.preventDefault()
            setEditValue(value)
            onCancel()
            break
          case 'Tab':
            e.preventDefault()
            onCommit(editValue)
            onNavigate(e.shiftKey ? 'shift-tab' : 'tab')
            break
          case 'ArrowUp':
            if (!e.shiftKey) {
              e.preventDefault()
              onCommit(editValue)
              onNavigate('up')
            }
            break
          case 'ArrowDown':
            if (!e.shiftKey) {
              e.preventDefault()
              onCommit(editValue)
              onNavigate('down')
            }
            break
        }
      }

      const handleCellKeyDown = (e: React.KeyboardEvent) => {
        // Start editing on Enter or any printable character
        if (e.key === 'Enter' || (e.key.length === 1 && !e.ctrlKey && !e.metaKey)) {
          e.preventDefault()
          if (e.key.length === 1) {
            setEditValue(e.key) // Start with typed character
          }
          onStartEdit()
        }
      }

      // Edit mode
      if (isEditing) {
        return (
          <td className="border-r border-b border-border p-0 group">
            <Input
              ref={inputRef}
              value={editValue}
              onChange={(e) => setEditValue(e.target.value)}
              onBlur={() => onCommit(editValue)}
              onKeyDown={handleKeyDown}
              className="h-10 w-full border-none bg-transparent text-center text-[13px] focus-visible:ring-1 focus-visible:ring-inset focus-visible:ring-primary placeholder:text-muted-foreground/40"
              placeholder="3x8@RIR2"
            />
          </td>
        )
      }

      // View mode
      return (
        <td
          className={cn(
            "border-r border-b border-border p-0 cursor-text",
            isActive && "bg-primary/5 ring-1 ring-inset ring-primary"
          )}
          onClick={onStartEdit}
          onKeyDown={handleCellKeyDown}
          tabIndex={isActive ? 0 : -1}
        >
          <div
            className={cn(
              "flex h-10 items-center justify-center px-2 text-[13px]",
              isSubRow ? "text-muted-foreground" : "text-foreground"
            )}
          >
            {value || '\u2014'} {/* Em dash for empty cells */}
          </div>
        </td>
      )
    }
    ```

    Features:
    - Click to start editing
    - Type any key to start editing with that character
    - Enter commits, Escape cancels
    - Tab/Shift+Tab commit and navigate
    - Arrow keys commit and navigate
    - Em dash for empty values
    - Sub-row values dimmed
  </action>
  <verify>TypeScript compiles, cell editing works correctly</verify>
  <done>Prescription cell with inline editing and keyboard support</done>
</task>

<task type="auto">
  <name>Task 2: Create ExerciseRow component</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-row.tsx</files>
  <action>
    Create complete exercise row that combines exercise cell with prescription cells:

    ```typescript
    import type { GridCell, GridColumn, GridRow } from './types'
    import { ExerciseCell } from './exercise-cell'
    import { PrescriptionCell } from './prescription-cell'

    interface ExerciseRowProps {
      row: GridRow
      columns: GridColumn[]
      programId: string
      sessionRowIds: string[]
      activeCell: GridCell | null
      editingCell: GridCell | null
      onCellClick: (rowId: string, colId: string) => void
      onStartEdit: (rowId: string, colId: string) => void
      onStopEdit: () => void
      onCommitExercise: (rowId: string, exerciseId: string, exerciseName: string) => void
      onCommitPrescription: (rowId: string, weekId: string, value: string) => void
      onNavigate: (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => void
      onAddSplitRow: (rowId: string) => void
    }

    export function ExerciseRow({
      row,
      columns,
      programId,
      sessionRowIds,
      activeCell,
      editingCell,
      onCellClick,
      onStartEdit,
      onStopEdit,
      onCommitExercise,
      onCommitPrescription,
      onNavigate,
      onAddSplitRow,
    }: ExerciseRowProps) {
      const isActiveRow = activeCell?.rowId === row.id
      const isEditingRow = editingCell?.rowId === row.id

      return (
        <tr className="group">
          {columns.map((col, colIndex) => {
            const isActiveCell = isActiveRow && activeCell?.colId === col.id
            const isEditingCell = isEditingRow && editingCell?.colId === col.id

            if (col.type === 'exercise') {
              return (
                <ExerciseCell
                  key={col.id}
                  row={row}
                  programId={programId}
                  sessionRowIds={sessionRowIds}
                  isActive={isActiveCell}
                  isEditing={isEditingCell}
                  onStartEdit={() => {
                    onCellClick(row.id, col.id)
                    onStartEdit(row.id, col.id)
                  }}
                  onCommit={(exerciseId, exerciseName) => {
                    onCommitExercise(row.id, exerciseId, exerciseName)
                    onStopEdit()
                  }}
                  onCancel={onStopEdit}
                  onAddSplitRow={() => onAddSplitRow(row.id)}
                />
              )
            }

            // Week column - prescription cell
            const weekId = col.weekId
            if (!weekId) return <td key={col.id} />

            const prescriptionValue = row.prescriptions[weekId] ?? ''

            return (
              <PrescriptionCell
                key={col.id}
                value={prescriptionValue}
                rowId={row.id}
                weekId={weekId}
                isActive={isActiveCell}
                isEditing={isEditingCell}
                isSubRow={row.isSubRow}
                onStartEdit={() => {
                  onCellClick(row.id, col.id)
                  onStartEdit(row.id, col.id)
                }}
                onCommit={(value) => {
                  onCommitPrescription(row.id, weekId, value)
                  onStopEdit()
                }}
                onCancel={onStopEdit}
                onNavigate={onNavigate}
              />
            )
          })}
        </tr>
      )
    }
    ```
  </action>
  <verify>TypeScript compiles, row renders exercise and prescription cells</verify>
  <done>Exercise row combines exercise cell with prescription cells per week</done>
</task>

<task type="auto">
  <name>Task 3: Create GridBody component</name>
  <files>apps/coach-web/src/components/programs/program-grid/grid-body.tsx</files>
  <action>
    Create grid body that renders all rows - session headers, exercise rows, and add-exercise rows:

    ```typescript
    import type { GridCell, GridColumn, GridRow } from './types'
    import { AddExerciseRow } from './add-exercise-row'
    import { ExerciseRow } from './exercise-row'
    import { SessionHeaderRow } from './session-header-row'

    interface GridBodyProps {
      rows: GridRow[]
      columns: GridColumn[]
      programId: string
      activeCell: GridCell | null
      editingCell: GridCell | null
      onCellClick: (rowId: string, colId: string) => void
      onStartEdit: (rowId: string, colId: string) => void
      onStopEdit: () => void
      onCommitExercise: (rowId: string, exerciseId: string, exerciseName: string) => void
      onCommitPrescription: (rowId: string, weekId: string, value: string) => void
      onNavigate: (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => void
      onAddExercise: (sessionId: string, exerciseId: string, exerciseName: string) => void
      onAddSplitRow: (rowId: string) => void
    }

    export function GridBody({
      rows,
      columns,
      programId,
      activeCell,
      editingCell,
      onCellClick,
      onStartEdit,
      onStopEdit,
      onCommitExercise,
      onCommitPrescription,
      onNavigate,
      onAddExercise,
      onAddSplitRow,
    }: GridBodyProps) {
      // Group rows by session to get row IDs for each session
      const sessionRowIds = new Map<string, string[]>()
      for (const row of rows) {
        if (row.type === 'exercise') {
          const ids = sessionRowIds.get(row.sessionId) ?? []
          ids.push(row.id)
          sessionRowIds.set(row.sessionId, ids)
        }
      }

      return (
        <tbody>
          {rows.map((row) => {
            switch (row.type) {
              case 'session-header':
                return (
                  <SessionHeaderRow
                    key={row.id}
                    sessionName={row.sessionName}
                    colSpan={columns.length}
                  />
                )

              case 'exercise':
                return (
                  <ExerciseRow
                    key={row.id}
                    row={row}
                    columns={columns}
                    programId={programId}
                    sessionRowIds={sessionRowIds.get(row.sessionId) ?? []}
                    activeCell={activeCell}
                    editingCell={editingCell}
                    onCellClick={onCellClick}
                    onStartEdit={onStartEdit}
                    onStopEdit={onStopEdit}
                    onCommitExercise={onCommitExercise}
                    onCommitPrescription={onCommitPrescription}
                    onNavigate={onNavigate}
                    onAddSplitRow={onAddSplitRow}
                  />
                )

              case 'add-exercise':
                return (
                  <AddExerciseRow
                    key={row.id}
                    sessionId={row.sessionId}
                    columns={columns}
                    onAddExercise={onAddExercise}
                  />
                )

              default:
                return null
            }
          })}

          {/* Bottom padding row */}
          <tr>
            <td colSpan={columns.length} className="h-16" />
          </tr>
        </tbody>
      )
    }
    ```

    Features:
    - Renders session headers, exercise rows, and add-exercise rows
    - Passes down active/editing cell state
    - Computes session row IDs for reordering
    - Adds bottom padding row
  </action>
  <verify>TypeScript compiles, grid body renders all row types</verify>
  <done>Grid body assembles all rows with proper structure and callbacks</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. PrescriptionCell edits inline with keyboard support
4. ExerciseRow combines exercise and prescription cells
5. GridBody renders all row types correctly
6. Keyboard navigation between cells works
</verification>

<success_criteria>
- Prescription cells show notation and edit inline
- Enter/Escape/Tab work correctly for cell editing
- Arrow keys navigate between cells
- Session headers and add-exercise rows render
- Row structure matches UI/UX specification
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-06-SUMMARY.md`
</output>
