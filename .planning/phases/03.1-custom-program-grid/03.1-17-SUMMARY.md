---
phase: 03.1
plan: 17
subsystem: program-builder
tags:
  - superset
  - reorder
  - backend
  - bug-fix
dependency-graph:
  requires:
    - 03.1-13 (superset grouping fix)
    - 03.1-15 (unified row labeling)
  provides:
    - Superset row repositioning on removal
    - Superset adjacency validation in reorder
  affects:
    - Future superset UI interactions
tech-stack:
  added: []
  patterns:
    - Repository method for session row queries
    - Auto-repair pattern in use case validation
file-tracking:
  key-files:
    created: []
    modified:
      - packages/core/src/ports/program-repository.port.ts
      - packages/backend/src/infrastructure/repositories/program.repository.ts
      - packages/backend/src/use-cases/programs/toggle-superset.ts
      - packages/backend/src/use-cases/programs/reorder-exercise-rows.ts
decisions: []
metrics:
  duration: 5 min
  completed: 2026-01-25
---

# Phase 03.1 Plan 17: Superset Row Positioning Fixes Summary

Superset groups maintain physical adjacency: rows repositioned on removal, reorder validates adjacency.

## Objective Achieved

Fixed two related superset adjacency bugs:
1. When removing a row from a superset, it now moves to the end of the session instead of staying in place between group members
2. Move up/down operations now auto-repair to maintain superset adjacency, preventing non-superset rows from being placed between superset group members

## Implementation Details

### Repository Methods Added

**repositionRowToEndOfSession** (`packages/backend/src/infrastructure/repositories/program.repository.ts`):
- Moves a row to the end of a session
- Gets all rows, removes target row, appends it to end
- Updates all orderIndex values in a transaction

**findExerciseRowsBySessionId** (`packages/core/src/ports/program-repository.port.ts`):
- Returns all exercise rows for a session ordered by orderIndex
- Used for validating reorder operations

### Use Case Changes

**toggle-superset.ts**:
- When removing from superset (supersetGroup = null), now chains repositionRowToEndOfSession after metadata update
- Ensures removed row doesn't stay between remaining superset members

**reorder-exercise-rows.ts**:
- Added `ensureSupersetAdjacency` helper function
- Before persisting order, fetches row metadata via findExerciseRowsBySessionId
- Auto-repairs any split superset groups by consolidating members at first occurrence
- Prevents breaking superset adjacency via move up/down

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 2af2509 | feat | Add repositionRowToEndOfSession and findExerciseRowsBySessionId repository methods |
| 7fd5342 | fix | Reposition row to end of session when removing from superset |
| eb625d5 | fix | Add superset adjacency validation to reorder-exercise-rows |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- `pnpm typecheck` passes for all packages
- `pnpm biome check` passes for all modified files

## Files Modified

1. `packages/core/src/ports/program-repository.port.ts` - Added 2 new port methods
2. `packages/backend/src/infrastructure/repositories/program.repository.ts` - Implemented 2 new repository methods
3. `packages/backend/src/use-cases/programs/toggle-superset.ts` - Added repositioning on superset removal
4. `packages/backend/src/use-cases/programs/reorder-exercise-rows.ts` - Added superset adjacency validation

## Next Phase Readiness

UAT v4 gap closure complete. Phase 3.1 verified with all superset functionality working correctly.
