---
phase: 03.1-custom-program-grid
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/features/programs/components/program-form.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can open athlete dropdown and navigate options with arrow keys"
    - "User can filter athletes by typing in the search input"
    - "User can select an athlete with Enter key"
    - "Search is server-side with debounced requests"
  artifacts:
    - path: "apps/coach-web/src/features/programs/components/program-form.tsx"
      provides: "Accessible athlete selector using Combobox"
      contains: "Combobox"
  key_links:
    - from: "program-form.tsx"
      to: "@base-ui/react Combobox"
      via: "import from ui/combobox"
      pattern: "import.*Combobox.*from.*components/ui/combobox"
---

<objective>
Replace the custom Popover-based athlete selector with the accessible Combobox component from @base-ui/react.

Purpose: UAT Test 1 revealed the current implementation lacks keyboard navigation - users cannot navigate athlete options with arrow keys. The existing Combobox component already provides full keyboard accessibility.

Output: Athlete selector in program-form.tsx uses Combobox with server-side search, debounced requests, and full keyboard navigation.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/coach-web/src/features/programs/components/program-form.tsx
@apps/coach-web/src/components/ui/combobox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Popover athlete selector with Combobox</name>
  <skills>/orpc-query, /form</skills>
  <files>apps/coach-web/src/features/programs/components/program-form.tsx</files>
  <action>
Replace the custom Popover implementation (lines 105-225) with the Combobox component.

**Requirements:**
1. Use Combobox from `@/components/ui/combobox` (already exists)
2. Keep server-side search with debounce (useDebounce hook already in place)
3. Keep the Controller pattern for React Hook Form integration
4. Support clearing the selection (clear button)
5. Show loading state during search
6. Show empty state when no results

**Implementation approach:**

```tsx
// Replace Popover with Combobox
<Controller
  control={control}
  name="athleteId"
  render={({ field }) => {
    // Find selected athlete for display
    const selectedAthlete = field.value
      ? athletes.find(a => a.id === field.value) ?? { id: field.value, name: selectedAthleteName }
      : null

    return (
      <Combobox
        value={selectedAthlete}
        onValueChange={(value) => {
          if (value === null) {
            field.onChange(undefined)
            setSelectedAthleteName('')
          } else {
            field.onChange(value.id)
            setSelectedAthleteName(value.name)
          }
        }}
        inputValue={athleteSearch}
        onInputValueChange={(value) => setAthleteSearch(value)}
        getOptionLabel={(option) => option.name}
        getOptionValue={(option) => option.id}
      >
        <ComboboxInput
          id="athlete"
          placeholder="Buscar atleta..."
          showClear={!!field.value}
          showTrigger
        />
        <ComboboxContent>
          <ComboboxList>
            {/* Clear option */}
            <ComboboxItem value={null}>
              Sin atleta asignado
            </ComboboxItem>

            {/* Loading state */}
            {isLoadingAthletes && (
              <div className="py-2 text-center text-sm text-muted-foreground">
                <Loader2Icon className="h-4 w-4 animate-spin inline mr-2" />
                Buscando...
              </div>
            )}

            {/* Athlete options */}
            {athletes.map((athlete) => (
              <ComboboxItem key={athlete.id} value={athlete}>
                {athlete.name}
              </ComboboxItem>
            ))}

            {/* Empty state */}
            <ComboboxEmpty>No se encontraron atletas</ComboboxEmpty>
          </ComboboxList>
        </ComboboxContent>
      </Combobox>
    )
  }}
/>
```

**Key differences from current implementation:**
- Combobox provides built-in keyboard navigation (arrow up/down, Enter to select)
- Built-in focus management
- Proper ARIA attributes
- Keep exact same search/API behavior

**Remove these imports (no longer needed):**
- ChevronDownIcon (Combobox has its own)
- SearchIcon (Combobox input handles this)
- Popover, PopoverContent, PopoverTrigger

**Note on Combobox API:**
The @base-ui/react Combobox may have different props than shown above. Reference the actual component at `apps/coach-web/src/components/ui/combobox.tsx` for exact API. The key is using ComboboxInput, ComboboxContent, ComboboxList, ComboboxItem components.
  </action>
  <verify>
1. Open create program modal
2. Click on athlete field - dropdown opens
3. Type to filter athletes - server search works
4. Use arrow keys to navigate options - focus moves correctly
5. Press Enter to select - value updates
6. Click clear button - selection clears
7. Run: `pnpm typecheck && pnpm lint`
  </verify>
  <done>
Athlete selector uses Combobox with full keyboard accessibility. Arrow keys navigate, Enter selects, search filters via server-side API with debounce.
  </done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles: `pnpm typecheck`
- [ ] Lint passes: `pnpm lint`
- [ ] Manual test: Arrow key navigation works in athlete dropdown
- [ ] Manual test: Enter key selects highlighted option
- [ ] Manual test: Server-side search with debounce still works
</verification>

<success_criteria>
1. Athlete selector uses Combobox component instead of custom Popover
2. Arrow key navigation works between athlete options
3. Enter key selects the highlighted athlete
4. Escape key closes the dropdown
5. Server-side search with debounce preserved
6. Clear button removes selection
7. Loading and empty states display correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-12-SUMMARY.md`
</output>
