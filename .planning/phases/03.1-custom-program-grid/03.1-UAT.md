---
status: diagnosed
phase: 03.1-custom-program-grid
source:
  - 03.1-01-SUMMARY.md
  - 03.1-02-SUMMARY.md
  - 03.1-03-SUMMARY.md
  - 03.1-04-SUMMARY.md
  - 03.1-05-SUMMARY.md
  - 03.1-06-SUMMARY.md
  - 03.1-07-SUMMARY.md
started: 2026-01-25T14:30:00Z
updated: 2026-01-25T14:55:00Z
---

## Current Test

[testing complete]

## Tests

### 1. Programs List DataTable
expected: Navigate to /programs. The programs list displays as a table (not cards) with columns: name, status, athlete, weeks count, template indicator, and updated date. Pagination controls appear at the bottom. Row actions menu (Edit, Duplicate, Archive) available via 3-dot button.
result: pass

### 2. Create Program with Weeks Selector
expected: Click "Crear programa". The form shows a weeks count input (default 4, range 1-12). Create a program with 6 weeks. After creation, the program editor shows 6 week columns.
result: pass

### 3. Athlete Combobox in Program Form
expected: In the create program form, the athlete field is a searchable combobox. Type to filter athletes. "Sin atleta asignado" option clears selection. Clear button (X) appears when an athlete is selected.
result: issue
reported: "El selector de atletas no funciona bien. No se hace una busqueda paginada en el servidor, sino que se estan trayendo todos los atletas de una y se filtra. Eso no esta bien porque puede haber gimnasios con 1000 atletas. La UI tambien esta mal. Se muestra siempre el texto 'No se encontraron atletas'. A la vez es mas parecido a un combobox donde se escribe que a un dropdown mas parecido a un select. Deberia ser ese ultimo caso con un multiselect o algo asi, no un input para escribir."
severity: major

### 4. Grid Week Columns Display
expected: Open a program in editor. Week columns show names ("Semana 1", "Semana 2", etc.) in the header. Each week column has an actions menu (rename, duplicate, delete).
result: issue
reported: "Se ve bien pero al renombrar cambia el orden. No se como se esta guardando en la base de datos pero cada semana tiene que tener un orden de posicion"
severity: major

### 5. Session Header Rows
expected: In the program grid, session headers (training days like "Día 1", "Día 2") appear as full-width dividers with primary color text, separating exercises by session.
result: pass

### 6. Exercise Cell Display
expected: Each exercise row shows: row prefix (A1, B1), exercise name in first column. The exercise column is sticky on horizontal scroll with shadow effect.
result: skipped
reason: App shell scrolling is broken - can't test sticky behavior. Will fix app shell in separate task.

### 7. Exercise Selection Combobox
expected: Click on an exercise cell (or press Enter/F2). A searchable combobox opens. Search for an exercise, select it. The cell updates with the new exercise name.
result: pass

### 8. Superset Visual Indicator
expected: When exercises are in a superset, a vertical blue line connects them on the left side. Superset rows show group labels (A1, A2 for first superset, B1, B2 for second).
result: issue
reported: "No funciona bien. El boton para agregar superseries muestra una cantidad fixed de superseries: A B C D E. Esto no es correcto ya que depende de los ejercicios actuales. Si tengo solo A1 B1 C1, si quiero agregar C1 a una superserie deberia ser solo A y B. Cuando selecciono agregar a B, lo pone como B1 en lugar de combinar ambos ejercicios. Crea una superserie nueva sin tener en cuenta los ejercicios que ya estaban en esa letra. Necesita un rework."
severity: major

### 9. Prescription Cell Editing
expected: Click on a prescription cell (intersection of exercise row and week column). Cell becomes editable with an input. Type prescription (e.g., "3x10@70kg"). Press Enter to save.
result: pass

### 10. Keyboard Navigation - Arrows
expected: Use arrow keys to move between cells. Up/Down moves between exercise rows. Left/Right moves between week columns. Session header rows are skipped automatically.
result: issue
reported: "No funciona bien: 1) Si clickeo una celda y me muevo, se mueve solo una vez y luego deja de moverse - el foco va a la pantalla y scrollea. 2) Al mover a columna de ejercicios, aparece dropdown automáticamente - mala UX. 3) Debería requerir doble click o Enter para editar, incluyendo ejercicios. Tocar número también podría entrar en edición. 4) Navegación con flechas debería solo mover entre celdas sin editar. 5) Problemas claros con el foco - la celda/botón con foco no se alinea con la celda activa/seleccionada que persistimos. Necesita rework."
severity: major

### 11. Keyboard Navigation - Tab
expected: Press Tab to move to next cell (left to right, then down). Shift+Tab moves backwards. Commits any current edit before moving.
result: pass

### 12. Prescription Cell - Cancel Edit
expected: Start editing a prescription cell, type something, then press Escape. The edit is cancelled and the cell reverts to its previous value.
result: pass

### 13. Toggle Superset Keyboard Shortcut
expected: Select an exercise row, press "S" key. The exercise toggles in/out of a superset group. Visual indicator (blue line) updates accordingly.
result: issue
reported: "Not working. Selecting an exercise row opens the combobox automatically, so pressing 'S' just types in the combobox instead of toggling superset. Same root cause as test 10 - need explicit edit mode entry instead of auto-edit on selection."
severity: major

### 14. Add Exercise Row
expected: At the end of each session, there's a faded "add exercise" row. Click it or focus and start typing. A combobox appears to search and add a new exercise to that session.
result: pass

### 15. Grid Dark Theme
expected: The program grid uses dark slate theme: dark background (slate-900/950), muted borders, blue primary accents for selected states and superset indicators.
result: pass

## Summary

total: 15
passed: 9
issues: 5
pending: 0
skipped: 1

## Gaps

- truth: "Athlete selector is a searchable combobox with server-side pagination, correct empty state, and dropdown-style UX"
  status: failed
  reason: "User reported: No server-side paginated search - fetches all athletes client-side (scalability issue for 1000+ athletes). UI shows 'No se encontraron atletas' incorrectly. UX is combobox-with-typing instead of dropdown/select style. Suggested using multi-select pattern like shadcn combobox multiple."
  severity: major
  test: 3
  root_cause: "1) new-program-view.tsx uses hardcoded limit:100 without search param. 2) program-form.tsx filters client-side via useMemo. 3) Backend API already supports search param but frontend ignores it. 4) Wrong UX pattern - should be dropdown/select style."
  artifacts:
    - path: "apps/coach-web/src/features/programs/views/new-program-view.tsx"
      issue: "useAthletes({ status: 'active', limit: 100 }) - no search param"
    - path: "apps/coach-web/src/features/programs/components/program-form.tsx"
      issue: "Client-side filtering via useMemo, wrong combobox pattern"
  missing:
    - "Debounced server search - pass search term to useAthletes hook"
    - "Remove client-side filtering"
    - "Proper empty state handling"
    - "UX change to dropdown/select style"
  debug_session: ".planning/debug/uat3-athlete-selector.md"

- truth: "Week columns maintain their position/order when renamed"
  status: failed
  reason: "User reported: Renaming a week changes the order. Weeks need a position field to maintain ordering in the database."
  severity: major
  test: 4
  root_cause: "update-week.ts creates ProgramWeek object with hardcoded orderIndex: 0 (line 47). Repository updateWeek applies this value, overwriting existing order. Schema already has orderIndex field - bug is in use case not preserving it."
  artifacts:
    - path: "packages/backend/src/use-cases/programs/update-week.ts"
      issue: "Line 47: orderIndex: 0 hardcoded instead of preserving existing"
  missing:
    - "Fetch existing week first to preserve orderIndex"
    - "OR change repository to only update name field for rename"
  debug_session: ""

- truth: "Superset button shows dynamic groups based on existing exercises, and adding to a group combines with existing exercises"
  status: failed
  reason: "User reported: Superset button shows fixed list (A B C D E) instead of dynamic based on current exercises. When adding to group B, creates B1 instead of combining with existing B exercises. Needs rework to consider existing superset groups."
  severity: major
  test: 8
  root_cause: "1) exercise-row-actions.tsx line 48 has hardcoded SUPERSET_GROUPS = ['A', 'B', 'C', 'D', 'E']. 2) toggle-superset.ts sets supersetOrder: 1 for new entries without counting existing rows in group (MVP approach in code comments)."
  artifacts:
    - path: "apps/coach-web/src/components/programs/exercise-row-actions.tsx"
      issue: "Line 48: Hardcoded SUPERSET_GROUPS array instead of dynamic"
    - path: "packages/backend/src/use-cases/programs/toggle-superset.ts"
      issue: "Lines 98-99: Sets supersetOrder to 1 without querying existing group members"
  missing:
    - "Frontend: Derive available groups from session rows + next available letter"
    - "Backend: Query existing rows with same supersetGroup to calculate max(supersetOrder) + 1"
    - "UI decision: Show existing groups + 'Create new' or just available letters"
  debug_session: ""

- truth: "Arrow key navigation moves between cells consistently, edit mode requires explicit action (Enter/double-click/typing number)"
  status: failed
  reason: "User reported: 1) Click cell + arrow moves only once then focus goes to page (scrolls). 2) Exercise column auto-opens dropdown on navigation - bad UX. 3) Should require Enter/double-click to edit. 4) Arrows should just navigate without editing. 5) Focus tracking broken - focused cell/button doesn't align with tracked active cell. Additional insight: Problem occurs when EXITING edit mode - focus is lost at that instant, breaking navigation. Need to press Tab twice to recover. Root cause is how we track edit mode - differentiating with Enter/double-click/typing numbers to enter edit mode should fix it."
  severity: major
  test: 10
  root_cause: "1) Missing DOM focus management - code never calls element.focus() when activeCell changes or when exitingz edit mode. 2) Click conflates selection with editing - both cells have onClick={onStartEdit} instead of just setting active cell."
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/use-grid-navigation.ts"
      issue: "Updates activeCell state but never manages DOM focus"
    - path: "apps/coach-web/src/components/programs/program-grid/use-cell-editing.ts"
      issue: "startEditing/stopEditing only manage React state, no DOM focus restoration"
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      issue: "Line 124: onClick={onStartEdit} - click immediately edits instead of just selecting"
    - path: "apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx"
      issue: "Line 172: onClick={onStartEdit} - same conflation issue"
  missing:
    - "Add useEffect to focus cell DOM element when activeCell changes"
    - "Add focus restoration when stopEditing() is called"
    - "Separate click-to-select from click-to-edit (use double-click or Enter for edit)"
  debug_session: ".planning/debug/keyboard-navigation-focus-loss.md"

- truth: "S key toggles superset when exercise row is selected (not editing)"
  status: failed
  reason: "User reported: Selecting exercise row auto-opens combobox, so S just types instead of toggling superset. Same root cause as test 10 - need explicit edit mode entry."
  severity: major
  test: 13
  related_to: 10
  root_cause: "Clicking exercise cell calls onStartEdit immediately (exercise-cell.tsx line 124), setting editingCell. S key shortcut in program-grid.tsx checks !editingCell which fails. Same root cause as test 10 - click conflates selection with editing."
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      issue: "onClick={onStartEdit} immediately opens combobox"
    - path: "apps/coach-web/src/components/programs/program-grid/program-grid.tsx"
      issue: "Line 138: S key checks !editingCell but editingCell is always set on click"
  missing:
    - "Fix is same as test 10 - separate click-to-select from click-to-edit"
  debug_session: ".planning/debug/keyboard-navigation-focus-loss.md"
