---
phase: 03.1-custom-program-grid
plan: 05
type: execute
wave: 3
depends_on: ["03.1-03"]
files_modified:
  - apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx
autonomous: true

must_haves:
  truths:
    - "Exercise cell displays exercise name with proper styling"
    - "Click on exercise cell opens searchable combobox"
    - "Row prefix shows superset group (A1, B2) or position number"
    - "Split rows show dimmed exercise name with set type badge"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      provides: "Exercise cell with combobox editing"
      min_lines: 80
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx"
      provides: "Row prefix with superset indicator"
      min_lines: 40
  key_links:
    - from: "exercise-cell.tsx"
      to: "Combobox"
      via: "import"
      pattern: "import.*Combobox"
---

<objective>
Create exercise cell component with combobox editing and row prefix

Purpose: Build the first column cell that displays exercise names and allows changing exercises via a searchable combobox.
Output: ExerciseCell and ExerciseRowPrefix components matching the UI/UX specification.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-RESEARCH.md
@.planning/phases/03-program-builder/ui-ux-specifications/code.html
@apps/coach-web/src/components/programs/program-grid/types.ts
@apps/coach-web/src/components/programs/program-grid/superset-indicator.tsx
@apps/coach-web/src/components/ui/combobox.tsx
@apps/coach-web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExerciseRowPrefix component</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-row-prefix.tsx</files>
  <action>
    Create row prefix component that shows superset group or position number:

    ```typescript
    import type { GridRow } from './types'
    import { SupersetIndicator } from './superset-indicator'
    import { cn } from '@/lib/utils'

    interface ExerciseRowPrefixProps {
      row: GridRow
    }

    export function ExerciseRowPrefix({ row }: ExerciseRowPrefixProps) {
      // Generate display label: A1, B2, C1 for supersets, or just position number
      const getLabel = () => {
        if (row.supersetGroup) {
          return `${row.supersetGroup}${row.supersetOrder ?? ''}`
        }
        // For non-superset rows, just show letter based on position
        const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']
        const letter = letters[row.exercise?.position ?? 0] ?? 'A'
        return `${letter}1`
      }

      const label = getLabel()

      return (
        <div className="relative flex items-center h-full">
          {/* Superset line indicator */}
          <SupersetIndicator position={row.supersetPosition} />

          {/* Prefix label */}
          <span
            className={cn(
              "w-10 flex justify-center text-[10px] font-bold border-r border-border h-full items-center z-30",
              row.supersetGroup
                ? "text-primary bg-background"
                : "text-muted-foreground bg-muted/20"
            )}
          >
            {label}
          </span>
        </div>
      )
    }
    ```

    Visual rules from UI/UX spec:
    - Superset rows: primary color text, background-dark bg
    - Non-superset rows: muted text, slightly darker bg
    - Width: w-10 (40px)
    - Font: 10px, bold
  </action>
  <verify>TypeScript compiles, component displays correct labels</verify>
  <done>Row prefix shows superset groups and position labels correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create ExerciseCell component</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx</files>
  <action>
    Create exercise cell with view and edit modes:

    ```typescript
    import { useState } from 'react'
    import type { GridRow } from './types'
    import { ExerciseRowPrefix } from './exercise-row-prefix'
    import { ExerciseRowActions } from '../exercise-row-actions'
    import {
      Combobox,
      ComboboxContent,
      ComboboxInput,
      ComboboxItem,
      ComboboxList,
      ComboboxTrigger,
    } from '@/components/ui/combobox'
    import { useExercises } from '@/features/exercises/hooks/queries/use-exercises'
    import { cn } from '@/lib/utils'

    interface ExerciseCellProps {
      row: GridRow
      programId: string
      sessionRowIds: string[]
      isActive: boolean
      isEditing: boolean
      onStartEdit: () => void
      onCommit: (exerciseId: string, exerciseName: string) => void
      onCancel: () => void
      onAddSplitRow: () => void
    }

    export function ExerciseCell({
      row,
      programId,
      sessionRowIds,
      isActive,
      isEditing,
      onStartEdit,
      onCommit,
      onCancel,
      onAddSplitRow,
    }: ExerciseCellProps) {
      const [searchValue, setSearchValue] = useState('')

      const { data: exercisesData } = useExercises({
        search: searchValue || undefined,
        limit: 10,
      })

      const exercises = exercisesData?.items ?? []

      const handleKeyDown = (e: React.KeyboardEvent) => {
        if (e.key === 'Escape') {
          onCancel()
        }
      }

      // Edit mode - show combobox
      if (isEditing) {
        return (
          <td className="sticky left-0 z-10 border-r border-b border-border bg-background p-0">
            <div className="flex items-center h-full">
              <ExerciseRowPrefix row={row} />
              <div className="flex-1 px-2">
                <Combobox
                  defaultOpen
                  onValueChange={(value) => {
                    const exercise = exercises.find(e => e.id === value)
                    if (exercise) {
                      onCommit(exercise.id, exercise.name)
                    }
                  }}
                >
                  <ComboboxTrigger className="w-full">
                    <ComboboxInput
                      placeholder="Buscar ejercicio..."
                      value={searchValue}
                      onChange={(e) => setSearchValue(e.target.value)}
                      onKeyDown={handleKeyDown}
                      className="h-8 border-none bg-transparent text-sm"
                      autoFocus
                    />
                  </ComboboxTrigger>
                  <ComboboxContent>
                    <ComboboxList>
                      {exercises.map((exercise) => (
                        <ComboboxItem key={exercise.id} value={exercise.id}>
                          {exercise.name}
                        </ComboboxItem>
                      ))}
                    </ComboboxList>
                  </ComboboxContent>
                </Combobox>
              </div>
            </div>
          </td>
        )
      }

      // View mode
      return (
        <td
          className={cn(
            "sticky left-0 z-10 border-r border-b border-border p-0",
            row.isSubRow ? "bg-zinc-950/20" : "bg-background",
            isActive && "ring-1 ring-inset ring-primary"
          )}
          onClick={onStartEdit}
          tabIndex={isActive ? 0 : -1}
        >
          <div className="flex items-center h-10 group">
            <ExerciseRowPrefix row={row} />

            <div className="flex-1 flex items-center justify-between px-3 min-w-0">
              <span
                className={cn(
                  "text-[13px] font-semibold truncate",
                  row.isSubRow ? "text-foreground/50" : "text-foreground"
                )}
              >
                {row.exercise?.exerciseName || 'Seleccionar ejercicio'}
              </span>

              {/* Set type badge for split rows */}
              {row.setTypeLabel && (
                <span className="text-[9px] font-bold text-muted-foreground bg-muted/50 px-1.5 py-0.5 rounded uppercase ml-2 shrink-0">
                  {row.setTypeLabel}
                </span>
              )}
            </div>

            {/* Row actions menu */}
            <div className="opacity-0 group-hover:opacity-100 transition-opacity pr-2">
              <ExerciseRowActions
                programId={programId}
                sessionId={row.sessionId}
                rowId={row.id}
                exerciseName={row.exercise?.exerciseName ?? ''}
                supersetGroup={row.supersetGroup}
                isSubRow={row.isSubRow}
                sessionRowIds={sessionRowIds}
                onAddSplitRow={onAddSplitRow}
              />
            </div>
          </div>
        </td>
      )
    }
    ```

    Features:
    - Sticky first column with shadow
    - Row prefix with superset indicator
    - Exercise name with proper styling (dimmed for sub-rows)
    - Set type badge for split rows (HEAVY SINGLES, BACK-OFF, etc.)
    - Row actions menu on hover
    - Click to edit with combobox
  </action>
  <verify>TypeScript compiles, exercise cell renders and edits correctly</verify>
  <done>Exercise cell with view/edit modes, combobox, and row actions</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. ExerciseRowPrefix shows correct labels for superset and non-superset rows
4. ExerciseCell displays exercise name, set type badge, and row actions
5. Clicking cell opens combobox for exercise search
6. Selecting exercise calls onCommit with correct data
</verification>

<success_criteria>
- Row prefix displays superset groups (A1, B2) with blue indicator lines
- Exercise cell shows name with proper styling for main/sub rows
- Set type badges display for split rows
- Combobox opens on click with exercise search
- Row actions menu appears on hover
- Sticky column works correctly during horizontal scroll
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-05-SUMMARY.md`
</output>
