---
phase: 03.1-custom-program-grid
plan: 07
type: execute
wave: 5
depends_on: ["03.1-06"]
files_modified:
  - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
  - apps/coach-web/src/components/programs/program-grid/index.ts
  - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
  - apps/coach-web/src/styles/program-grid.css
autonomous: true

must_haves:
  truths:
    - "ProgramGrid component integrates all grid parts"
    - "Grid connects to existing mutation hooks"
    - "Program editor page uses new custom grid"
    - "Keyboard shortcuts (S, Shift+Enter) work"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/program-grid.tsx"
      provides: "Main grid container component"
      min_lines: 150
    - path: "apps/coach-web/src/components/programs/program-grid/index.ts"
      provides: "Public exports"
      exports: ["ProgramGrid"]
    - path: "apps/coach-web/src/styles/program-grid.css"
      provides: "Grid-specific CSS styles"
      min_lines: 40
  key_links:
    - from: "program-grid.tsx"
      to: "use-grid-mutations.ts"
      via: "import"
      pattern: "import.*useUpdatePrescription.*from.*use-grid-mutations"
    - from: "$programId.tsx"
      to: "program-grid.tsx"
      via: "import"
      pattern: "import.*ProgramGrid"
---

<objective>
Integrate all grid components and connect to program editor page

Purpose: Assemble the custom grid, connect to mutation hooks, and replace the react-datasheet-grid in the program editor.
Output: Working program editor with custom grid that matches the design system.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-custom-program-grid/03.1-RESEARCH.md
@.planning/phases/03-program-builder/ui-ux-specifications/code.html
@apps/coach-web/src/features/programs/hooks/mutations/use-grid-mutations.ts
@apps/coach-web/src/components/programs/split-row-dialog.tsx
@apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
@apps/coach-web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create program-grid.css styles</name>
  <files>apps/coach-web/src/styles/program-grid.css</files>
  <action>
    Create CSS file for grid-specific styles:

    ```css
    /* Program Grid Styles */

    .program-grid-container {
      overflow-x: auto;
      overflow-y: visible;
    }

    .program-grid {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      min-width: 800px;
    }

    /* Sticky column shadow */
    .program-grid tbody td:first-child,
    .program-grid thead th:first-child {
      box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.3);
    }

    /* Cell base styles */
    .program-grid th,
    .program-grid td {
      transition: background-color 75ms ease;
    }

    /* Focus visible for keyboard navigation */
    .program-grid td:focus-visible {
      outline: none;
    }

    /* Custom scrollbar for grid container */
    .program-grid-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .program-grid-container::-webkit-scrollbar-track {
      background: hsl(var(--muted));
    }

    .program-grid-container::-webkit-scrollbar-thumb {
      background: hsl(var(--muted-foreground) / 0.3);
      border-radius: 9999px;
      border: 2px solid hsl(var(--muted));
    }

    .program-grid-container::-webkit-scrollbar-thumb:hover {
      background: hsl(var(--muted-foreground) / 0.5);
    }

    /* Grid footer with keyboard hints */
    .program-grid-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      height: 4rem;
      border-top: 1px solid hsl(var(--border));
      background: hsl(var(--background));
    }

    .keyboard-hint {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: hsl(var(--muted) / 0.5);
      padding: 0.25rem 0.625rem;
      border-radius: 0.25rem;
      border: 1px solid hsl(var(--border));
    }

    .keyboard-hint kbd {
      font-size: 9px;
      font-weight: 700;
      background: hsl(var(--muted));
      padding: 0.125rem 0.25rem;
      border-radius: 0.125rem;
      color: hsl(var(--muted-foreground));
    }

    .keyboard-hint span {
      font-size: 10px;
      color: hsl(var(--muted-foreground));
    }
    ```
  </action>
  <verify>CSS file exists and is valid</verify>
  <done>Grid CSS styles created for scrollbar, sticky column, and keyboard hints</done>
</task>

<task type="auto">
  <name>Task 2: Create main ProgramGrid component</name>
  <files>
    apps/coach-web/src/components/programs/program-grid/program-grid.tsx
    apps/coach-web/src/components/programs/program-grid/index.ts
  </files>
  <action>
    Create the main ProgramGrid component that integrates everything:

    ```typescript
    // program-grid.tsx
    import { useMemo, useRef, useState } from 'react'
    import type { ProgramWithDetails } from '@strenly/contracts/programs/program'
    import { GridBody } from './grid-body'
    import { GridHeader } from './grid-header'
    import { transformProgramToGrid } from './transform-program'
    import { useCellEditing } from './use-cell-editing'
    import { useGridNavigation } from './use-grid-navigation'
    import { SplitRowDialog } from '../split-row-dialog'
    import {
      useAddExerciseRow,
      useAddSplitRow,
      useToggleSuperset,
      useUpdateExerciseRow,
      useUpdatePrescription,
    } from '@/features/programs/hooks/mutations/use-grid-mutations'
    import { Button } from '@/components/ui/button'
    import { Skeleton } from '@/components/ui/skeleton'
    import { SaveIcon } from 'lucide-react'
    import '@/styles/program-grid.css'

    interface ProgramGridProps {
      program: ProgramWithDetails
      isLoading?: boolean
    }

    export function ProgramGrid({ program, isLoading }: ProgramGridProps) {
      const tableRef = useRef<HTMLTableElement>(null)
      const [splitRowId, setSplitRowId] = useState<string | null>(null)

      // Transform program data for grid display
      const { rows, columns } = useMemo(
        () => transformProgramToGrid(program),
        [program]
      )

      // Grid state hooks
      const { activeCell, setActiveCell, handleKeyDown } = useGridNavigation({
        rows,
        columns,
      })
      const { editingCell, startEditing, stopEditing, isEditing } = useCellEditing()

      // Mutation hooks
      const updatePrescription = useUpdatePrescription(program.id)
      const updateExerciseRow = useUpdateExerciseRow(program.id)
      const addExerciseRow = useAddExerciseRow(program.id)
      const addSplitRow = useAddSplitRow(program.id)
      const toggleSuperset = useToggleSuperset(program.id)

      // Handle cell click
      const handleCellClick = (rowId: string, colId: string) => {
        setActiveCell(rowId, colId)
      }

      // Handle edit start
      const handleStartEdit = (rowId: string, colId: string) => {
        const cell = { rowId, colId, rowIndex: 0, colIndex: 0 }
        startEditing(cell)
      }

      // Handle prescription commit
      const handleCommitPrescription = (rowId: string, weekId: string, value: string) => {
        updatePrescription.mutate({
          exerciseRowId: rowId,
          weekId,
          rawNotation: value || null,
        })
      }

      // Handle exercise commit
      const handleCommitExercise = (rowId: string, exerciseId: string, exerciseName: string) => {
        updateExerciseRow.mutate({
          rowId,
          exerciseId,
          exerciseName,
        })
      }

      // Handle add exercise
      const handleAddExercise = (sessionId: string, exerciseId: string, exerciseName: string) => {
        addExerciseRow.mutate({
          programId: program.id,
          sessionId,
          exerciseId,
          exerciseName,
        })
      }

      // Handle navigation from cell (called by PrescriptionCell after committing)
      // This creates a synthetic keyboard event and dispatches it to trigger useGridNavigation
      const handleNavigate = (direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'shift-tab') => {
        if (!activeCell) return

        // Map direction to key event
        const keyMap: Record<string, { key: string; shiftKey?: boolean }> = {
          up: { key: 'ArrowUp' },
          down: { key: 'ArrowDown' },
          left: { key: 'ArrowLeft' },
          right: { key: 'ArrowRight' },
          tab: { key: 'Tab' },
          'shift-tab': { key: 'Tab', shiftKey: true },
        }

        const eventConfig = keyMap[direction]
        if (eventConfig) {
          // Create and dispatch synthetic keyboard event to trigger navigation
          const event = new KeyboardEvent('keydown', {
            key: eventConfig.key,
            shiftKey: eventConfig.shiftKey ?? false,
            bubbles: true,
          })
          // Call the navigation handler directly with the synthetic event
          handleKeyDown(event as unknown as React.KeyboardEvent)
        }
      }

      // Handle split row dialog
      const handleAddSplitRow = (rowId: string) => {
        setSplitRowId(rowId)
      }

      const handleSplitRowSubmit = (setTypeLabel: string) => {
        if (splitRowId) {
          addSplitRow.mutate({
            parentRowId: splitRowId,
            setTypeLabel,
          })
        }
        setSplitRowId(null)
      }

      // Handle global keyboard shortcuts
      const handleTableKeyDown = (e: React.KeyboardEvent) => {
        // S key for superset toggle (when not editing)
        if (e.key === 's' && !editingCell && activeCell && !e.ctrlKey && !e.metaKey) {
          const row = rows.find(r => r.id === activeCell.rowId)
          if (row && row.type === 'exercise') {
            e.preventDefault()
            const nextGroup = row.supersetGroup ? null : 'A'
            toggleSuperset.mutate({
              rowId: activeCell.rowId,
              supersetGroup: nextGroup,
            })
          }
          return
        }

        // Shift+Enter for split row (when not editing)
        if (e.shiftKey && e.key === 'Enter' && !editingCell && activeCell) {
          const row = rows.find(r => r.id === activeCell.rowId)
          if (row && row.type === 'exercise' && !row.isSubRow) {
            e.preventDefault()
            handleAddSplitRow(activeCell.rowId)
          }
          return
        }

        // Pass to navigation handler
        handleKeyDown(e)
      }

      if (isLoading) {
        return (
          <div className="space-y-2">
            <Skeleton className="h-12 w-full" />
            <Skeleton className="h-64 w-full" />
          </div>
        )
      }

      return (
        <div className="flex flex-col h-full">
          {/* Grid container */}
          <div className="flex-1 program-grid-container">
            <table
              ref={tableRef}
              className="program-grid"
              role="grid"
              aria-label={`Programa: ${program.name}`}
              onKeyDown={handleTableKeyDown}
            >
              <GridHeader
                columns={columns}
                programId={program.id}
                weeksCount={program.weeks.length}
              />
              <GridBody
                rows={rows}
                columns={columns}
                programId={program.id}
                activeCell={activeCell}
                editingCell={editingCell}
                onCellClick={handleCellClick}
                onStartEdit={handleStartEdit}
                onStopEdit={stopEditing}
                onCommitExercise={handleCommitExercise}
                onCommitPrescription={handleCommitPrescription}
                onNavigate={handleNavigate}
                onAddExercise={handleAddExercise}
                onAddSplitRow={handleAddSplitRow}
              />
            </table>
          </div>

          {/* Footer with keyboard hints */}
          <footer className="program-grid-footer">
            <div className="flex items-center gap-8 text-[11px] font-medium uppercase tracking-wider text-muted-foreground">
              <div className="keyboard-hint">
                <kbd>Shift + Enter</kbd>
                <span>Agregar fila dividida</span>
              </div>
              <div className="keyboard-hint">
                <kbd>S</kbd>
                <span>Toggle Superserie</span>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <Button variant="outline">
                Exportar PDF
              </Button>
              <Button>
                <SaveIcon className="size-4" />
                Guardar Programa
              </Button>
            </div>
          </footer>

          {/* Split row dialog */}
          <SplitRowDialog
            open={splitRowId !== null}
            onOpenChange={(open) => !open && setSplitRowId(null)}
            onSubmit={handleSplitRowSubmit}
          />
        </div>
      )
    }
    ```

    Create index.ts:
    ```typescript
    export { ProgramGrid } from './program-grid'
    ```
  </action>
  <verify>TypeScript compiles, component integrates all parts</verify>
  <done>Main ProgramGrid component created with full integration</done>
</task>

<task type="auto">
  <name>Task 3: Update program editor page to use new grid</name>
  <files>apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx</files>
  <action>
    Update the program editor page to use the new custom ProgramGrid:

    1. Remove imports for react-datasheet-grid and old program-grid component
    2. Import new ProgramGrid from '@/components/programs/program-grid'
    3. Replace the old grid component with the new ProgramGrid
    4. Pass program data and isLoading state

    The page should:
    - Keep the program header component
    - Keep the grid toolbar (add week, add session buttons)
    - Replace the grid rendering with new ProgramGrid component
    - Remove any react-datasheet-grid specific code/state

    Example structure:
    ```tsx
    import { ProgramGrid } from '@/components/programs/program-grid'

    // ... in component
    return (
      <div className="flex flex-col h-full">
        <ProgramHeader ... />
        <GridToolbar ... />
        <ProgramGrid
          program={program}
          isLoading={isLoading}
        />
      </div>
    )
    ```

    Also update imports in vite config or remove react-datasheet-grid from package.json if no longer needed.
  </action>
  <verify>Program editor page loads and displays the new grid</verify>
  <done>Program editor uses new custom grid instead of react-datasheet-grid</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. Navigate to /{orgSlug}/programs/{programId}
4. Verify grid displays with correct styling matching UI/UX spec
5. Verify keyboard navigation works (arrow keys, tab, enter)
6. Verify cell editing works (click, type, commit)
7. Verify S key toggles superset
8. Verify Shift+Enter opens split row dialog
9. Verify adding exercise via combobox works
10. Verify week actions menu works
</verification>

<success_criteria>
- Program grid displays with dark slate theme
- Keyboard navigation moves between cells
- Inline editing with prescription notation works
- Exercise combobox search works
- Superset toggle (S key) works
- Split row (Shift+Enter) works
- Week column actions work
- All mutations update the grid correctly
- Grid matches UI/UX specification design
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-custom-program-grid/03.1-07-SUMMARY.md`
</output>
