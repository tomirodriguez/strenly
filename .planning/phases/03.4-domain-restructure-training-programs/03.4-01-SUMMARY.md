---
phase: "03.4"
plan: "01"
subsystem: "domain"
tags: ["domain-entity", "aggregate", "ddd", "neverthrow", "validation"]
requires: []
provides:
  - "Program aggregate root with createProgram() and reconstituteProgram()"
  - "Shared types (ProgramStatus, IntensityType, input types)"
  - "Hierarchical validation (Program -> Weeks -> Sessions -> Groups -> Items -> Series)"
affects:
  - "03.4-02 (repository restructure)"
  - "03.4-03 (contracts alignment)"
tech-stack:
  added: []
  patterns:
    - "Aggregate root pattern"
    - "Factory function with Result<T, E>"
    - "Nested validation with context propagation"
    - "Reconstitute function for DB loads"
key-files:
  created:
    - "packages/core/src/domain/entities/program/types.ts"
    - "packages/core/src/domain/entities/program/series.ts"
    - "packages/core/src/domain/entities/program/group-item.ts"
    - "packages/core/src/domain/entities/program/exercise-group.ts"
    - "packages/core/src/domain/entities/program/session.ts"
    - "packages/core/src/domain/entities/program/week.ts"
    - "packages/core/src/domain/entities/program/program.ts"
    - "packages/core/src/domain/entities/program/program.test.ts"
  modified: []
decisions:
  - id: "program-aggregate-folder"
    title: "Program aggregate in dedicated folder"
    choice: "Use packages/core/src/domain/entities/program/ folder"
    rationale: "Keeps aggregate files organized, clear aggregate boundary"
  - id: "for-of-instead-of-index"
    title: "Use for-of with entries() for iteration"
    choice: "for...of instead of indexed for loops"
    rationale: "TypeScript doesn't narrow array[i] types, for-of provides better type safety"
  - id: "helper-functions-in-tests"
    title: "Helper functions for nested access in tests"
    choice: "getWeek(), getSession(), etc. helpers with runtime validation"
    rationale: "Avoids non-null assertions (!) while maintaining type safety"
metrics:
  duration: "7 min"
  tests-added: 60
  coverage: "99.73%"
  completed: "2026-01-26"
---

# Phase 03.4 Plan 01: Program Aggregate Domain Entity Summary

Program aggregate root that validates the entire training program hierarchy: Program -> Weeks -> Sessions -> ExerciseGroups -> GroupItems -> Series.

## What Was Built

### Domain Types (types.ts)
- `ProgramStatus`: 'draft' | 'active' | 'archived' with type guard
- `IntensityType`: 'absolute' | 'percentage' | 'rpe' | 'rir' with type guard
- Domain types: `Program`, `Week`, `Session`, `ExerciseGroup`, `GroupItem`, `Series`
- Input types: `CreateProgramInput`, `WeekInput`, `SessionInput`, etc.
- Error types: Discriminated union `ProgramError` with context fields

### Validation Modules
- **series.ts**: Validates intensity bounds, AMRAP rules, tempo format (4-char ECCC)
- **group-item.ts**: Validates exerciseId required, collects validated series
- **exercise-group.ts**: Validates at least 1 item per group, no duplicate orderIndexes
- **session.ts**: Validates name required (3-100 chars), collects groups
- **week.ts**: Auto-generates default name "Semana N", validates sessions
- **program.ts**: Aggregate root that orchestrates all validation

### Factory Functions
- `createProgram(input)`: Validates entire hierarchy, returns `Result<Program, ProgramError>`
- `reconstituteProgram(props)`: Direct construction for DB loads (no re-validation)

## Test Coverage

```
-------------------|---------|----------|---------|---------|
File               | % Stmts | % Branch | % Funcs | % Lines |
-------------------|---------|----------|---------|---------|
All files          |   99.73 |    99.08 |     100 |   99.73 |
exercise-group.ts  |     100 |      100 |     100 |     100 |
group-item.ts      |     100 |      100 |     100 |     100 |
program.ts         |     100 |      100 |     100 |     100 |
series.ts          |   99.09 |    97.36 |     100 |   99.09 |
session.ts         |     100 |      100 |     100 |     100 |
types.ts           |     100 |      100 |     100 |     100 |
week.ts            |     100 |      100 |     100 |     100 |
-------------------|---------|----------|---------|---------|
```

60 tests covering:
- All validation rules at each level
- Error context propagation (weekIndex, sessionIndex, etc.)
- Complex hierarchy validation
- Type guards

## Validation Rules Implemented

| Entity | Rule | Error Type |
|--------|------|------------|
| Program | Name 3-100 chars | NAME_REQUIRED/TOO_SHORT/TOO_LONG |
| Week | orderIndex >= 0 | WEEK_INVALID_ORDER_INDEX |
| Week | Unique orderIndexes | WEEK_DUPLICATE_ORDER_INDEX |
| Session | Name required | SESSION_NAME_REQUIRED |
| Group | At least 1 item | GROUP_EMPTY |
| Item | exerciseId required | ITEM_EXERCISE_ID_REQUIRED |
| Series | Percentage 0-100 | SERIES_PERCENTAGE_INVALID |
| Series | RPE/RIR 0-10 | SERIES_RPE_INVALID/SERIES_RIR_INVALID |
| Series | AMRAP + reps conflict | SERIES_AMRAP_WITH_REPS |
| Series | Tempo 4-char format | SERIES_TEMPO_INVALID |

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

Ready for 03.4-02 (Repository restructure):
- Domain types exported and ready for repository mapping
- `reconstituteProgram()` ready for DB load path
- Input types define the contract for `saveProgramAggregate()`
