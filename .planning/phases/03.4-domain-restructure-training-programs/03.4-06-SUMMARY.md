---
phase: 03.4
plan: 06
subsystem: frontend/programs
tags: [zustand, aggregate, transform, hooks, grid]
dependency-graph:
  requires: [03.4-04, 03.4-05]
  provides: [frontend-aggregate-integration]
  affects: [full-stack-testing, athlete-pwa]
tech-stack:
  added: []
  patterns: [aggregate-store, exercises-lookup, client-side-join]
key-files:
  created:
    - apps/coach-web/src/features/programs/hooks/queries/use-exercises-map.ts
  modified:
    - apps/coach-web/src/stores/grid-store.ts
    - apps/coach-web/src/components/programs/program-grid/transform-program.ts
    - apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts
    - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
decisions:
  - key: exercise-name-lookup
    choice: Client-side map lookup instead of API join
    rationale: Exercises cached via TanStack Query, programs typically 10-30 exercises
  - key: series-formatting
    choice: Use formatSeriesToNotation from @strenly/contracts
    rationale: Tested formatter in contracts handles all edge cases
  - key: aggregate-store-pattern
    choice: Store maintains full aggregate, not deltas
    rationale: Simplifies save operation - send full aggregate atomically
metrics:
  duration: ~5 minutes
  completed: 2026-01-26
---

# Phase 03.4 Plan 06: Frontend Aggregate Integration Summary

Frontend grid store and hooks updated to work with Program aggregate pattern - store maintains aggregate, save sends full program.

## What Was Done

### Task 1: useExercisesMap Hook
Created hook to fetch all exercises and build Map<exerciseId, exerciseName> for efficient O(1) lookup.
- Fetches with limit 1000 (all exercises)
- 5 minute staleTime for caching
- Used by transform function for grid display

### Task 2: Grid Store Refactor
Completely refactored grid store from delta-based to aggregate-based pattern:
- **Removed**: changedPrescriptions, changedExerciseRows, newWeeks, newSessions, newExerciseRows Maps
- **Added**: `aggregate: ProgramAggregate | null` as source of truth
- **Added**: `exercisesMap: Map<string, string>` for exercise names
- **Added**: `getAggregateForSave()` returns full program for API
- **Updated**: `initialize()` accepts aggregate + exercisesMap
- All mutations update aggregate directly, grid data derived from it

### Task 3: Transform Function Update
Updated transform function for aggregate pattern:
- Input: `ProgramAggregate` + `Map<string, string>` (exercises map)
- Uses `formatSeriesToNotation` from `@strenly/contracts/programs/prescription`
- Looks up exercise names via `exercisesMap.get(item.exerciseId)`
- Removed legacy ProgramWithDetails support

### Task 4: Hooks and Page Update
- **useSaveDraft**: Unchanged API path, now receives aggregate data structure
- **Program editor page**:
  - Fetches both program and exercises in parallel
  - Waits for both before initializing store
  - Save handler calls `getAggregateForSave()` and sends to API

## Technical Details

### Client-Side Exercise Join
```typescript
const exerciseName = exercisesMap.get(item.exerciseId) ?? 'Unknown Exercise'
```
Efficient because:
- Exercises are cached (TanStack Query with 5 min staleTime)
- Programs typically have 10-30 exercises
- O(1) map lookup per exercise

### Series Formatting
```typescript
import { formatSeriesToNotation } from '@strenly/contracts/programs/prescription'
prescriptions[week.id] = formatSeriesToNotation(seriesInput)
```
Uses tested formatter that handles AMRAP, rep ranges, RPE, RIR, tempo, etc.

### Aggregate Store Pattern
```typescript
getAggregateForSave: () => {
  const program: ProgramDataInput = {
    name: state.aggregate.name,
    weeks: state.aggregate.weeks.map(week => ({
      // ... full hierarchy
    })),
  }
  return { program, lastLoadedAt: state.lastLoadedAt }
}
```

## Files Changed

| File | Change |
|------|--------|
| `use-exercises-map.ts` | NEW: Hook for exercises map |
| `grid-store.ts` | REFACTOR: Delta-based to aggregate-based |
| `transform-program.ts` | UPDATE: Accept exercisesMap, use contracts formatter |
| `use-save-draft.ts` | UPDATE: Documentation for aggregate approach |
| `$programId.tsx` | UPDATE: Fetch exercises, aggregate-based save |

## Commits

1. `50cecb8` - feat(03.4-06): add useExercisesMap hook for exercise name lookup
2. `d479399` - feat(03.4-06): refactor grid store to use aggregate pattern
3. `f8f4a39` - feat(03.4-06): update transform function for aggregate pattern
4. `bc458e2` - feat(03.4-06): update hooks and page for aggregate API

## Deviations from Plan

None - plan executed as written.

## Notes

- Backend typecheck has pre-existing errors from domain restructure (03.4-01 through 03.4-05 work)
- Coach-web typecheck passes cleanly
- The `program` from `useProgram` is typed via oRPC output schema as `ProgramAggregate`

## Next Phase Readiness

Frontend is now ready to work with the aggregate API. The full stack is aligned:
- API returns `ProgramAggregate`
- Store maintains aggregate
- Save sends full aggregate
- Grid displays correctly with exercise names

**Next**: Integration testing to verify end-to-end flow works correctly.
