---
phase: 03.4-domain-restructure-training-programs
plan: 08
type: execute
wave: 1
depends_on: ["03.4-07"]
files_modified:
  - packages/contracts/src/programs/prescription.ts
  - apps/coach-web/src/components/programs/program-grid/transform-program.ts
  - apps/coach-web/src/stores/grid-store.ts
  - apps/coach-web/src/components/programs/exercise-row-actions.tsx
  - apps/coach-web/src/components/ui/dropdown-menu.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Prescription displays with correct unit (3x10@100kg not 3x10@100null)"
    - "'Agrupar arriba' button merges exercise into group above"
    - "Superset grouping persists after save"
    - "No console warnings about Base UI button component"
  artifacts:
    - path: "packages/contracts/src/programs/prescription.ts"
      provides: "mapIntensityTypeToUnit helper function"
    - path: "apps/coach-web/src/components/programs/program-grid/transform-program.ts"
      provides: "Unit derivation from intensityType"
    - path: "apps/coach-web/src/stores/grid-store.ts"
      provides: "Aggregate-level superset manipulation"
    - path: "apps/coach-web/src/components/programs/exercise-row-actions.tsx"
      provides: "Simplified 'Agrupar arriba' button"
    - path: "apps/coach-web/src/components/ui/dropdown-menu.tsx"
      provides: "nativeButton={false} on trigger"
  key_links:
    - from: "apps/coach-web/src/components/programs/program-grid/transform-program.ts"
      to: "packages/contracts/src/programs/prescription.ts"
      via: "mapIntensityTypeToUnit"
      pattern: "mapIntensityTypeToUnit"
    - from: "apps/coach-web/src/components/programs/exercise-row-actions.tsx"
      to: "apps/coach-web/src/stores/grid-store.ts"
      via: "groupWithAbove action"
      pattern: "groupWithAbove"
---

<objective>
Close three UAT gaps from Phase 3.4:
1. Fix prescription unit display (3x10@100null -> 3x10@100kg)
2. Simplify superset UX to "Agrupar arriba" button that actually modifies aggregate
3. Fix Base UI button component warning

Purpose: Complete the program builder to production-ready state with correct display and functioning superset grouping.

Output: Prescription cells display correct units, superset grouping works and persists, no console warnings.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Files to modify
@packages/contracts/src/programs/prescription.ts
@apps/coach-web/src/components/programs/program-grid/transform-program.ts
@apps/coach-web/src/stores/grid-store.ts
@apps/coach-web/src/components/programs/exercise-row-actions.tsx
@apps/coach-web/src/components/ui/dropdown-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix prescription unit display</name>
  <files>
    packages/contracts/src/programs/prescription.ts
    apps/coach-web/src/components/programs/program-grid/transform-program.ts
    apps/coach-web/src/stores/grid-store.ts
  </files>
  <action>
    The issue: `transform-program.ts` line 126 and `grid-store.ts` line 153 hardcode `intensityUnit: null` when building series input for the formatter. The formatter then outputs "3x10@100null" because it uses the null value directly.

    **Step 1: Add helper in prescription.ts**

    Add a helper function to derive unit from type:

    ```typescript
    /**
     * Derive intensity unit from intensity type.
     * Used when aggregate data only has type but not unit.
     */
    export function mapIntensityTypeToUnit(type: IntensityType | null | undefined): IntensityUnit | null {
      if (!type) return null
      switch (type) {
        case 'absolute':
          return 'kg' // Default to kg for absolute weights
        case 'percentage':
          return '%'
        case 'rpe':
          return 'rpe'
        case 'rir':
          return 'rir'
        default:
          return null
      }
    }
    ```

    **Step 2: Update transform-program.ts**

    Import the helper and use it at line 126:

    ```typescript
    import { formatSeriesToNotation, mapIntensityTypeToUnit } from '@strenly/contracts/programs/prescription'

    // In the series mapping (around line 119-128):
    const seriesInput = weekItem.series.map((s, idx) => ({
      orderIndex: idx,
      reps: s.reps,
      repsMax: s.repsMax,
      isAmrap: s.isAmrap,
      intensityType: s.intensityType,
      intensityValue: s.intensityValue,
      intensityUnit: mapIntensityTypeToUnit(s.intensityType), // Derive from type
      tempo: s.tempo,
    }))
    ```

    **Step 3: Update grid-store.ts**

    Import the helper and use it at line 153 (in aggregateToGridData):

    ```typescript
    import { formatSeriesToNotation, parsePrescriptionToSeries, mapIntensityTypeToUnit } from '@strenly/contracts/programs/prescription'

    // In the series mapping (around line 146-156):
    const seriesInput = weekItem.series.map((s, idx) => ({
      orderIndex: idx,
      reps: s.reps,
      repsMax: s.repsMax,
      isAmrap: s.isAmrap,
      intensityType: s.intensityType,
      intensityValue: s.intensityValue,
      intensityUnit: mapIntensityTypeToUnit(s.intensityType), // Derive from type
      tempo: s.tempo,
    }))
    ```
  </action>
  <verify>
    ```bash
    cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter @strenly/contracts --filter coach-web
    ```
  </verify>
  <done>
    Prescription cells display "3x10@100kg" instead of "3x10@100null".
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement "Agrupar arriba" superset action</name>
  <files>
    apps/coach-web/src/stores/grid-store.ts
    apps/coach-web/src/components/programs/exercise-row-actions.tsx
  </files>
  <action>
    The current `updateSupersetGroup` only updates UI state, not the aggregate. Replace the complex superset menu with a simple "Agrupar arriba" button that:
    1. Moves the current exercise's items into the group above
    2. Updates the aggregate (so it persists on save)
    3. Cleans up empty groups and recalculates order indices

    **Step 1: Add groupWithAbove action to grid-store.ts**

    Add a new action that manipulates the aggregate:

    ```typescript
    // Add to GridActions interface:
    groupWithAbove: (itemId: string, sessionId: string) => void

    // Add implementation:
    groupWithAbove: (itemId: string, sessionId: string) =>
      set((state) => {
        if (!state.aggregate || !state.data) return state

        const newAggregate = deepClone(state.aggregate)

        // Find the item and its current group in first week (canonical structure)
        const firstWeek = newAggregate.weeks[0]
        if (!firstWeek) return state

        const session = firstWeek.sessions.find((s) => s.id === sessionId)
        if (!session) return state

        // Sort groups by orderIndex to find "above"
        const sortedGroups = [...session.exerciseGroups].sort((a, b) => a.orderIndex - b.orderIndex)

        // Find current item's group
        let currentGroupIndex = -1
        let currentItemIndex = -1
        for (let gi = 0; gi < sortedGroups.length; gi++) {
          const group = sortedGroups[gi]
          if (!group) continue
          const itemIdx = group.items.findIndex((i) => i.id === itemId)
          if (itemIdx >= 0) {
            currentGroupIndex = gi
            currentItemIndex = itemIdx
            break
          }
        }

        if (currentGroupIndex === -1) return state

        // Check if there's a group above
        if (currentGroupIndex === 0) {
          // No group above - can't merge
          return state
        }

        const currentGroup = sortedGroups[currentGroupIndex]
        const targetGroup = sortedGroups[currentGroupIndex - 1]
        if (!currentGroup || !targetGroup) return state

        const currentItem = currentGroup.items[currentItemIndex]
        if (!currentItem) return state

        // Now apply the same change to ALL weeks
        for (const week of newAggregate.weeks) {
          const weekSession = week.sessions.find((s) => s.id === sessionId)
          if (!weekSession) continue

          const weekCurrentGroup = weekSession.exerciseGroups.find((g) => g.id === currentGroup.id)
          const weekTargetGroup = weekSession.exerciseGroups.find((g) => g.id === targetGroup.id)
          if (!weekCurrentGroup || !weekTargetGroup) continue

          // Find and move the item
          const weekItemIndex = weekCurrentGroup.items.findIndex((i) => i.id === itemId)
          if (weekItemIndex === -1) continue

          const [movedItem] = weekCurrentGroup.items.splice(weekItemIndex, 1)
          if (!movedItem) continue

          // Add to target group at end, update orderIndex
          movedItem.orderIndex = weekTargetGroup.items.length
          weekTargetGroup.items.push(movedItem)

          // If current group is now empty, remove it
          if (weekCurrentGroup.items.length === 0) {
            const groupIdx = weekSession.exerciseGroups.findIndex((g) => g.id === weekCurrentGroup.id)
            if (groupIdx >= 0) {
              weekSession.exerciseGroups.splice(groupIdx, 1)
            }
          }

          // Recalculate orderIndex for all groups in session
          const weekSortedGroups = [...weekSession.exerciseGroups].sort((a, b) => a.orderIndex - b.orderIndex)
          weekSortedGroups.forEach((g, idx) => {
            g.orderIndex = idx
          })
        }

        // Regenerate grid data
        const gridData = aggregateToGridData(newAggregate, state.exercisesMap)

        return {
          aggregate: newAggregate,
          data: gridData,
          isDirty: true,
        }
      }),
    ```

    Also add to the useGridActions selector:
    ```typescript
    groupWithAbove: state.groupWithAbove,
    ```

    **Step 2: Simplify exercise-row-actions.tsx**

    Replace the complex superset menu with a simple "Agrupar arriba" button:

    ```typescript
    // Remove Link2Icon, Link2OffIcon, PlusIcon from imports
    // Add ArrowUpToLineIcon from lucide-react

    // Remove: supersetGroup, sessionRows props (no longer needed for complex menu)
    // Keep: sessionRowIds for move up/down

    // Replace the superset DropdownMenuGroup with:
    <DropdownMenuGroup>
      <DropdownMenuItem
        onClick={handleGroupWithAbove}
        disabled={!canGroupWithAbove}
      >
        <ArrowUpToLineIcon className="size-4" />
        Agrupar arriba
      </DropdownMenuItem>
    </DropdownMenuGroup>

    // Add handler:
    const groupWithAbove = useGridStore((state) => state.groupWithAbove)

    // Determine if there's a group above to merge with
    // First exercise row in session cannot group with above
    const canGroupWithAbove = useMemo(() => {
      // Find all exercise rows for this session in grid data
      const gridData = useGridStore.getState().data
      if (!gridData) return false

      const sessionExerciseRows = gridData.rows.filter(
        (row) => row.type === 'exercise' && row.sessionId === sessionId
      )
      const rowIndex = sessionExerciseRows.findIndex((row) => row.id === rowId)

      // Can't group if first exercise or not found
      return rowIndex > 0
    }, [sessionId, rowId])

    const handleGroupWithAbove = () => {
      groupWithAbove(rowId, sessionId)
      setOpen(false)
    }
    ```

    The key insight is that we no longer need the complex "join group X" menu. The user just wants to combine adjacent exercises into groups. "Agrupar arriba" is simple and intuitive: it merges the current exercise with whatever is above it.
  </action>
  <verify>
    ```bash
    cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter coach-web
    cd /Users/tomiardz/Projects/treino && pnpm lint --filter coach-web
    ```
  </verify>
  <done>
    "Agrupar arriba" button works, merges exercises into group above, persists on save.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Base UI button warning</name>
  <files>apps/coach-web/src/components/ui/dropdown-menu.tsx</files>
  <action>
    The warning occurs because DropdownMenuTrigger wraps styled divs but Base UI expects a native button by default.

    Update line 17 in dropdown-menu.tsx to add nativeButton={false}:

    ```typescript
    function DropdownMenuTrigger({ ...props }: MenuPrimitive.Trigger.Props) {
      return <MenuPrimitive.Trigger data-slot="dropdown-menu-trigger" nativeButton={false} {...props} />
    }
    ```

    This tells Base UI that the trigger content is not necessarily a native button element, which suppresses the warning.
  </action>
  <verify>
    ```bash
    cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter coach-web
    ```
  </verify>
  <done>
    No console warning about button component when using DropdownMenu.
  </done>
</task>

</tasks>

<verification>
```bash
# Full typecheck
cd /Users/tomiardz/Projects/treino && pnpm typecheck

# Lint check
cd /Users/tomiardz/Projects/treino && pnpm lint

# Build check
cd /Users/tomiardz/Projects/treino && pnpm build --filter coach-web --filter @strenly/contracts
```
</verification>

<success_criteria>
- Prescription cells display correct units (kg, %, RPE, RIR)
- "Agrupar arriba" button appears in exercise actions menu
- Clicking "Agrupar arriba" merges exercise into group above
- Superset grouping persists after save and refresh
- No console warnings about Base UI button component
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-domain-restructure-training-programs/03.4-08-SUMMARY.md`
</output>
