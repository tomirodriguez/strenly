---
phase: 03.4-domain-restructure-training-programs
plan: 02
type: execute
wave: 4
depends_on: ["03.4-04", "03.4-05"]
files_modified:
  - packages/core/src/domain/entities/prescription.ts (DELETE)
  - packages/core/src/domain/entities/prescription.test.ts (DELETE)
  - packages/core/src/domain/entities/prescription-series.ts (DELETE)
  - packages/core/src/domain/entities/prescription-series.test.ts (DELETE)
  - packages/core/src/domain/entities/exercise-group.ts (DELETE)
  - packages/core/src/domain/entities/exercise-group.test.ts (DELETE)
  - packages/core/src/domain/entities/program.ts (DELETE)
  - packages/core/src/domain/entities/program.test.ts (DELETE)
  - packages/core/src/ports/program-repository.port.ts
autonomous: true

must_haves:
  truths:
    - "Old Prescription entity with 'sets' number is completely removed"
    - "Old standalone domain files are deleted (program.ts, exercise-group.ts at root level)"
    - "No imports reference deleted files"
    - "Port references new Program aggregate types"
  artifacts:
    - path: "packages/core/src/ports/program-repository.port.ts"
      provides: "Updated port with aggregate-based types"
      contains: "import.*program/program"
  key_links:
    - from: "packages/core/src/ports/program-repository.port.ts"
      to: "packages/core/src/domain/entities/program/program.ts"
      via: "import Program aggregate"
      pattern: "from.*domain/entities/program/program"
---

<objective>
Delete legacy domain entities that have been superseded by the Program aggregate. Update the repository port to reference the new aggregate types.

Purpose: Clean up the domain layer by removing:
1. Old Prescription entity (with `sets: number`) - replaced by Series in aggregate
2. Old PrescriptionSeries entity (standalone) - now nested in aggregate
3. Old ExerciseGroup entity (standalone) - now nested in aggregate
4. Old Program entity (flat, no hierarchy) - replaced by aggregate

This follows the user decision: "Delete all legacy code completely (no deprecated folder)".

Output: Clean domain layer with only the new aggregate structure.

**IMPORTANT: This plan executes in Wave 4, AFTER Plans 04 and 05 complete.**
Plans 04 and 05 update use cases and procedures that reference the old files.
Deleting the old files first would break those plans. This plan cleans up after
the use cases and procedures have been migrated to the new aggregate structure.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-domain-restructure-training-programs/03.4-01-SUMMARY.md
@.planning/phases/03.4-domain-restructure-training-programs/03.4-04-SUMMARY.md
@.planning/phases/03.4-domain-restructure-training-programs/03.4-05-SUMMARY.md

# Files to delete
@packages/core/src/domain/entities/prescription.ts
@packages/core/src/domain/entities/exercise-group.ts
@packages/core/src/domain/entities/program.ts

# Port to update
@packages/core/src/ports/program-repository.port.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete Legacy Domain Entity Files</name>
  <files>
    packages/core/src/domain/entities/prescription.ts (DELETE)
    packages/core/src/domain/entities/prescription.test.ts (DELETE)
    packages/core/src/domain/entities/prescription-series.ts (DELETE)
    packages/core/src/domain/entities/prescription-series.test.ts (DELETE)
    packages/core/src/domain/entities/exercise-group.ts (DELETE)
    packages/core/src/domain/entities/exercise-group.test.ts (DELETE)
    packages/core/src/domain/entities/program.ts (DELETE)
    packages/core/src/domain/entities/program.test.ts (DELETE)
  </files>
  <action>
    Delete the following files:
    - packages/core/src/domain/entities/prescription.ts
    - packages/core/src/domain/entities/prescription.test.ts
    - packages/core/src/domain/entities/prescription-series.ts
    - packages/core/src/domain/entities/prescription-series.test.ts
    - packages/core/src/domain/entities/exercise-group.ts
    - packages/core/src/domain/entities/exercise-group.test.ts
    - packages/core/src/domain/entities/program.ts
    - packages/core/src/domain/entities/program.test.ts

    These are superseded by the Program aggregate in:
    - packages/core/src/domain/entities/program/program.ts (aggregate root)
    - packages/core/src/domain/entities/program/series.ts (replaces prescription-series.ts)
    - packages/core/src/domain/entities/program/exercise-group.ts (replaces standalone)
    - packages/core/src/domain/entities/program/types.ts (includes IntensityType, ProgramStatus)

    Use bash `rm` to delete files.
  </action>
  <verify>
    ```bash
    # Verify files are deleted
    ls packages/core/src/domain/entities/prescription*.ts 2>&1 | grep -q "No such file"
    ls packages/core/src/domain/entities/exercise-group.ts 2>&1 | grep -q "No such file"
    ls packages/core/src/domain/entities/program.ts 2>&1 | grep -q "No such file"
    ```
  </verify>
  <done>
    Old flat entities (prescription.ts, prescription-series.ts, exercise-group.ts, program.ts) and their tests are deleted from packages/core/src/domain/entities/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Repository Port Imports</name>
  <files>packages/core/src/ports/program-repository.port.ts</files>
  <action>
    Update the program-repository.port.ts to:

    1. Remove imports from deleted files:
       - Remove: import { Prescription } from '../domain/entities/prescription'
       - Remove: import { Program, ProgramStatus } from '../domain/entities/program'

    2. Add imports from new aggregate:
       - Add: import type { Program, ProgramStatus } from '../domain/entities/program/program'
       - Add: import type { Series } from '../domain/entities/program/types'

    3. Update type references:
       - Change Prescription references to use Series where appropriate
       - The port structure will be further refactored in Plan 03, but imports must be valid now

    4. Keep existing port interface methods for now (they'll be refactored in Plan 03)
       - Just ensure imports compile

    IMPORTANT: The port will be substantially simplified in Plan 03 when we add saveProgramAggregate.
    For now, just fix the imports so the code compiles.
  </action>
  <verify>
    ```bash
    cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter @strenly/core
    ```
  </verify>
  <done>
    Repository port imports the new Program aggregate types and compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Any Remaining Import Errors in Core Package</name>
  <files>packages/core/src/**/*.ts</files>
  <action>
    Search for any remaining imports of deleted files and fix them:

    1. Grep for imports of old entities:
       ```bash
       grep -r "from.*domain/entities/prescription" packages/core/src/
       grep -r "from.*domain/entities/exercise-group" packages/core/src/
       grep -r "from.*domain/entities/program['\"]" packages/core/src/
       ```

    2. For any found imports, update to use the new aggregate:
       - ProgramStatus -> packages/core/src/domain/entities/program/types.ts
       - IntensityType -> packages/core/src/domain/entities/program/types.ts
       - Program -> packages/core/src/domain/entities/program/program.ts

    3. Run typecheck to confirm all core package compiles.

    Note: The backend package will have import errors - those are fixed in Plan 03/04.
  </action>
  <verify>
    ```bash
    cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter @strenly/core
    ```
  </verify>
  <done>
    Core package (@strenly/core) compiles with no type errors. All imports reference the new aggregate structure.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify deleted files don't exist
ls -la packages/core/src/domain/entities/prescription.ts 2>&1 || echo "File deleted: prescription.ts"
ls -la packages/core/src/domain/entities/exercise-group.ts 2>&1 || echo "File deleted: exercise-group.ts"
ls -la packages/core/src/domain/entities/program.ts 2>&1 || echo "File deleted: program.ts"

# New aggregate exists
ls -la packages/core/src/domain/entities/program/

# Core package compiles
cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter @strenly/core

# Tests pass (aggregate tests from Plan 01)
cd /Users/tomiardz/Projects/treino && pnpm test --filter @strenly/core
```
</verification>

<success_criteria>
- prescription.ts, prescription.test.ts deleted
- prescription-series.ts, prescription-series.test.ts deleted
- exercise-group.ts, exercise-group.test.ts deleted (root level)
- program.ts, program.test.ts deleted (root level, not aggregate folder)
- Repository port imports compile from new aggregate
- Core package typecheck passes
- Core package tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-domain-restructure-training-programs/03.4-02-SUMMARY.md`
</output>
