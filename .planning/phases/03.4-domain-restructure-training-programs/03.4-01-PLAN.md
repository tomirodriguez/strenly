---
phase: 03.4-domain-restructure-training-programs
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/domain/entities/program/program.ts
  - packages/core/src/domain/entities/program/program.test.ts
  - packages/core/src/domain/entities/program/types.ts
  - packages/core/src/domain/entities/program/week.ts
  - packages/core/src/domain/entities/program/session.ts
  - packages/core/src/domain/entities/program/exercise-group.ts
  - packages/core/src/domain/entities/program/group-item.ts
  - packages/core/src/domain/entities/program/series.ts
autonomous: true

must_haves:
  truths:
    - "createProgram() validates entire hierarchy in one operation"
    - "Program aggregate contains weeks -> sessions -> groups -> items -> series"
    - "Validation errors bubble up with context (which week, which session, etc.)"
    - "reconstituteProgram() loads from database without re-validation"
    - "All nested entities are immutable (readonly properties)"
  artifacts:
    - path: "packages/core/src/domain/entities/program/program.ts"
      provides: "Program aggregate root with createProgram() and reconstituteProgram()"
      exports: ["Program", "createProgram", "reconstituteProgram", "ProgramError"]
    - path: "packages/core/src/domain/entities/program/program.test.ts"
      provides: "Comprehensive tests for aggregate validation"
      min_lines: 200
    - path: "packages/core/src/domain/entities/program/types.ts"
      provides: "Shared types for the aggregate hierarchy"
      exports: ["ProgramStatus", "IntensityType", "WeekInput", "SessionInput", "ExerciseGroupInput", "GroupItemInput", "SeriesInput"]
  key_links:
    - from: "packages/core/src/domain/entities/program/program.ts"
      to: "packages/core/src/domain/entities/program/types.ts"
      via: "imports type definitions"
      pattern: "import.*from.*types"
---

<objective>
Create the Program aggregate domain entity that models the complete training program hierarchy: Program -> Weeks -> Sessions -> ExerciseGroups -> GroupItems -> Series.

Purpose: Establish the correct DDD aggregate pattern where Program is the aggregate root that validates the entire hierarchy before persistence. This enables the replace-on-save strategy and ensures data consistency.

Output: A fully tested Program aggregate in `packages/core/src/domain/entities/program/` directory with 90%+ test coverage.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-domain-restructure-training-programs/03.4-RESEARCH.md

# Existing patterns to follow
@packages/core/src/domain/entities/prescription-series.ts
@packages/core/src/domain/entities/exercise.ts
@packages/core/CLAUDE.md
</context>

<skills>
/domain - Primary skill for creating domain entities with validation
</skills>

<feature>
  <name>Program Aggregate Domain Entity</name>
  <files>
    packages/core/src/domain/entities/program/program.ts
    packages/core/src/domain/entities/program/program.test.ts
    packages/core/src/domain/entities/program/types.ts
    packages/core/src/domain/entities/program/week.ts
    packages/core/src/domain/entities/program/session.ts
    packages/core/src/domain/entities/program/exercise-group.ts
    packages/core/src/domain/entities/program/group-item.ts
    packages/core/src/domain/entities/program/series.ts
  </files>
  <behavior>
    Program aggregate root that validates entire hierarchy:

    1. createProgram(input) -> Result<Program, ProgramError>
       - Validates program name (3-100 chars, trimmed, not empty)
       - Validates each week (name, orderIndex >= 0, unique orderIndexes)
       - Validates each session within weeks (name, orderIndex >= 0)
       - Validates each exerciseGroup within sessions
       - Validates each groupItem within groups (exerciseId required)
       - Validates each series within items (intensity bounds, AMRAP rules)
       - Returns err() with context on first validation failure
       - Returns ok(Program) when all valid

    2. reconstituteProgram(props) -> Program
       - Direct construction without validation (for DB loads)
       - Assumes data already validated

    Test cases:
    - Empty name -> err(NAME_REQUIRED)
    - Name "AB" (2 chars) -> err(NAME_TOO_SHORT)
    - Valid program with no weeks -> ok (empty programs allowed)
    - Valid program with weeks/sessions/groups/items/series -> ok
    - Duplicate week orderIndexes -> err(DUPLICATE_ORDER_INDEX)
    - Negative orderIndex -> err(INVALID_ORDER_INDEX)
    - Series with percentage > 100 -> err(INVALID_PERCENTAGE)
    - Series with RPE > 10 -> err(INVALID_RPE)
    - AMRAP with reps > 0 -> err(AMRAP_WITH_REPS)
    - Valid complex hierarchy validates all levels
  </behavior>
  <implementation>
    File structure in packages/core/src/domain/entities/program/:

    1. types.ts - Shared type definitions
       - ProgramStatus, IntensityType constants and types
       - Input types for each level (WeekInput, SessionInput, etc.)
       - ProgramError discriminated union

    2. series.ts - Series value object validation
       - validateSeries(input, orderIndex) -> Result<Series, ProgramError>
       - Intensity bounds, AMRAP rules, tempo format

    3. group-item.ts - GroupItem validation
       - validateGroupItem(input) -> Result<GroupItem, ProgramError>
       - exerciseId required, validates nested series

    4. exercise-group.ts - ExerciseGroup validation
       - validateExerciseGroup(input) -> Result<ExerciseGroup, ProgramError>
       - name normalization, validates nested items

    5. session.ts - Session validation
       - validateSession(input) -> Result<Session, ProgramError>
       - name required, validates nested groups

    6. week.ts - Week validation
       - validateWeek(input) -> Result<Week, ProgramError>
       - name default, validates nested sessions

    7. program.ts - Aggregate root
       - createProgram(input) -> Result<Program, ProgramError>
       - reconstituteProgram(props) -> Program
       - Orchestrates validation of full hierarchy

    Important:
    - Use neverthrow Result pattern throughout
    - All types are readonly (immutable)
    - Error types include context (which week/session failed)
    - Follow existing project patterns (see prescription-series.ts)
  </implementation>
</feature>

<verification>
```bash
# Run tests with coverage
cd /Users/tomiardz/Projects/treino && pnpm test packages/core/src/domain/entities/program/ --coverage

# Verify minimum 90% coverage on statements
cd /Users/tomiardz/Projects/treino && pnpm test packages/core/src/domain/entities/program/ --coverage | grep -E "^All files|program"

# Type check core package
cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter @strenly/core

# Run full test suite for core
cd /Users/tomiardz/Projects/treino && pnpm test --filter @strenly/core
```
</verification>

<success_criteria>
- Program aggregate validates entire hierarchy in one createProgram() call
- Tests cover all validation rules with 90%+ coverage
- Types are immutable (readonly)
- reconstituteProgram() works for DB loads
- TypeScript passes with no errors
- Follows project conventions (/domain skill patterns)
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-domain-restructure-training-programs/03.4-01-SUMMARY.md`
</output>
