---
phase: 03.4-domain-restructure-training-programs
plan: 05
subsystem: programs
status: complete
tags: [contracts, procedures, aggregate-schema]
dependency-graph:
  requires: [03.4-03]
  provides: [aggregate-api-contracts, aggregate-procedures]
  affects: [03.4-06-frontend]
tech-stack:
  patterns: [zod-schemas, aggregate-output, full-hierarchy]
key-files:
  verified:
    - packages/contracts/src/programs/program.ts
    - packages/contracts/src/programs/save-draft.ts
    - packages/backend/src/procedures/programs/save-draft.ts
    - packages/backend/src/procedures/programs/get.ts
decisions:
  - decision: "API contracts use aggregate hierarchy structure"
    rationale: "Matches domain model, frontend gets full data in single call"
    timestamp: 2026-01-26
  - decision: "All program-returning procedures use programAggregateSchema"
    rationale: "Consistent output format across create/get/duplicate/template operations"
    timestamp: 2026-01-26
metrics:
  duration: 7 min
  completed: 2026-01-26
---

# Phase 03.4 Plan 05: API Contracts and Procedures Summary

API contracts and procedures updated to use the full Program aggregate structure. All program endpoints now accept/return the nested hierarchy (weeks > sessions > groups > items > series).

## Status

**Pre-verified complete.** The work for this plan was substantially completed as part of plan 03.4-04. This execution verified the success criteria and documented the state.

## Verification

All success criteria from the plan verified:

| Criterion | Status |
|-----------|--------|
| programAggregateSchema defines full aggregate structure | VERIFIED |
| saveDraftInputSchema accepts complete program | VERIFIED |
| Procedures use updated schemas | VERIFIED |
| TypeScript compiles without errors (backend) | VERIFIED |
| API contract matches domain aggregate structure | VERIFIED |

## Key Artifacts Verified

### Aggregate Schemas (packages/contracts/src/programs/program.ts)

- `seriesSchema` - Individual set definition
- `groupItemSchema` - Exercise within a group with series array
- `exerciseGroupAggregateSchema` - Group with items
- `sessionAggregateSchema` - Session with exercise groups
- `weekAggregateSchema` - Week with sessions
- `programAggregateSchema` - Full program with weeks hierarchy

### Save Draft Contract (packages/contracts/src/programs/save-draft.ts)

```typescript
saveDraftInputSchema = z.object({
  programId: z.string(),
  program: z.object({
    name: z.string(),
    weeks: z.array(weekInputSchema),  // Full hierarchy
    ...
  }),
  lastLoadedAt: z.coerce.date().optional(),
})
```

### Procedures Using Aggregate Pattern

| Procedure | Output Schema |
|-----------|---------------|
| getProgram | programAggregateSchema |
| saveDraft | saveDraftOutputSchema |
| duplicateProgram | programAggregateSchema |
| createFromTemplate | programAggregateSchema |
| saveAsTemplate | programAggregateSchema |

## Deviations from Plan

None - plan was already complete from prior execution.

## Next Phase Readiness

**Ready for frontend updates:**
- API now consistently uses aggregate format
- Frontend needs to adapt to new data structure (weeks contain sessions)
- saveDraft needs to send full program state, not delta changes

**Blockers:** None

**Concerns:**
- coach-web has type errors - needs update to use new aggregate format
- Frontend migration will require significant refactoring of grid editor
