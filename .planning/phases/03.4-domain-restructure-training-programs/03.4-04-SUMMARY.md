---
phase: 03.4-domain-restructure-training-programs
plan: 04
subsystem: programs
status: complete
tags: [aggregate, use-cases, domain-validation]
dependency-graph:
  requires: [03.4-03]
  provides: [use-cases-aggregate-pattern]
  affects: [03.4-05-delete-legacy]
tech-stack:
  patterns: [aggregate-root, replace-on-save, domain-validation]
key-files:
  modified:
    - packages/backend/src/use-cases/programs/save-draft.ts
    - packages/backend/src/use-cases/programs/get-program.ts
    - packages/backend/src/use-cases/programs/create-program.ts
    - packages/backend/src/use-cases/programs/duplicate-program.ts
    - packages/backend/src/use-cases/programs/create-from-template.ts
    - packages/backend/src/use-cases/programs/save-as-template.ts
    - packages/backend/src/procedures/programs/save-draft.ts
    - packages/backend/src/procedures/programs/get.ts
    - packages/backend/src/procedures/programs/duplicate.ts
    - packages/backend/src/procedures/programs/templates.ts
    - packages/contracts/src/programs/save-draft.ts
    - packages/contracts/src/programs/index.ts
decisions:
  - decision: "saveDraft receives full aggregate instead of delta changes"
    rationale: "Simpler mental model, validation via domain factory"
    timestamp: 2026-01-26
  - decision: "Procedures return programAggregateSchema"
    rationale: "Full hierarchy useful for frontend rendering"
    timestamp: 2026-01-26
metrics:
  duration: 6 min
  completed: 2026-01-26
---

# Phase 03.4 Plan 04: Use Cases for Aggregate Pattern Summary

Use cases now work with the Program aggregate pattern. Validation happens through domain factory, persistence through aggregate repository methods.

## Commits

| Hash | Description |
|------|-------------|
| 2de2807 | feat(03.4-04): update saveDraft to use aggregate pattern |
| 20af420 | feat(03.4-04): update getProgram to return full aggregate |
| be5b73e | feat(03.4-04): update createProgram and duplicateProgram for aggregate pattern |

## Changes Made

### 1. saveDraft Use Case

**Before:** Received delta changes (changedPrescriptions, newWeeks, exerciseRowUpdates), mapped to repository's granular operations.

**After:**
- Receives full program aggregate input (not delta)
- Validates via `createProgram()` domain factory
- Saves via `saveProgramAggregate()` (replace-on-save)
- Contract updated to `programDataInputSchema` with nested weeks/sessions/groups/items

### 2. getProgram Use Case

**Before:** Returned `ProgramWithDetails` (flat structure with parallel weeks[] and sessions[]).

**After:**
- Returns full `Program` aggregate via `loadProgramAggregate()`
- Nested hierarchy: weeks > sessions > exerciseGroups > items > series
- Procedure maps to `programAggregateSchema`

### 3. createProgram Use Case

**Before:** Created program, then sequentially inserted weeks and sessions via separate repository calls.

**After:**
- Generates default weeks with empty sessions using helper function
- Validates full aggregate via `createProgram()` domain factory
- Saves complete aggregate via `saveProgramAggregate()`

### 4. duplicateProgram Use Case

**Before:** Complex sequential creation with ID mapping, creating weeks/sessions/groups/rows/prescriptions individually.

**After:**
- Loads source via `loadProgramAggregate()`
- Clones hierarchy with new IDs using helper functions
- Validates clone via `createProgram()`
- Saves via `saveProgramAggregate()`
- Much simpler code (~160 lines vs ~280 lines)

### 5. Dependent Use Cases Updated

- `createFromTemplate`: Now uses `loadProgramAggregate` and returns `Program`
- `saveAsTemplate`: Now returns `Program` aggregate

### 6. Contract Changes

- `saveDraftInputSchema` now expects `program` object with nested structure
- `programAggregateSchema` exported from contracts index
- Procedures use aggregate output format

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Contract required update for aggregate input**
- **Found during:** Task 1
- **Issue:** Original contract used delta-based input, incompatible with aggregate pattern
- **Fix:** Updated contract to accept full program aggregate input
- **Files modified:** `packages/contracts/src/programs/save-draft.ts`

**2. [Rule 3 - Blocking] Dependent use cases and procedures**
- **Found during:** Task 3 typecheck
- **Issue:** `createFromTemplate`, `saveAsTemplate`, and template procedures expected legacy `ProgramWithDetails`
- **Fix:** Updated all to use `Program` aggregate and `programAggregateSchema`
- **Files modified:**
  - `packages/backend/src/use-cases/programs/create-from-template.ts`
  - `packages/backend/src/use-cases/programs/save-as-template.ts`
  - `packages/backend/src/procedures/programs/templates.ts`

## Technical Decisions

| Decision | Rationale |
|----------|-----------|
| Full aggregate input for saveDraft | Simpler than delta - frontend sends current state, domain validates, repo replaces |
| Aggregate output from getProgram | Frontend needs full hierarchy for rendering; avoid multiple API calls |
| Clone helpers for duplicate | Clean separation, recursive cloning with new IDs |

## Verification

```bash
# Type check passes
pnpm typecheck --filter @strenly/backend  # OK

# Domain validation in saveDraft
grep -q "createProgram" packages/backend/src/use-cases/programs/save-draft.ts  # Found

# Aggregate load in getProgram
grep -q "loadProgramAggregate" packages/backend/src/use-cases/programs/get-program.ts  # Found
```

## Next Phase Readiness

**Ready for 03.4-05 (Delete Legacy Code):**
- Use cases no longer use legacy `findWithDetails` (except `list` which is separate)
- Use cases no longer use granular `create/update` methods for nested entities
- Legacy repository methods can be removed
- Legacy contracts can be cleaned up

**Blockers:** None

**Concerns:**
- Frontend will need updates to send/receive aggregate format
- Template list still returns counts as 0 (needs efficient count query)
