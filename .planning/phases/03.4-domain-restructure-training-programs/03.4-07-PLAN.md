---
phase: 03.4-domain-restructure-training-programs
plan: 07
type: execute
wave: 5
depends_on: ["03.4-06"]
files_modified:
  - apps/coach-web/src/routes/_authenticated.$orgSlug/programs/$programId.tsx
autonomous: false

must_haves:
  truths:
    - "Full save cycle works: edit -> save -> refresh shows saved data"
    - "Add week/session/exercise updates aggregate and saves correctly"
    - "Superset grouping persists across save"
    - "Prescription notation parses and displays correctly"
  artifacts:
    - path: "apps/coach-web/src/routes/_authenticated.$orgSlug/programs/$programId.tsx"
      provides: "Program editor wired to aggregate store"
  key_links:
    - from: "apps/coach-web/src/routes/_authenticated.$orgSlug/programs/$programId.tsx"
      to: "apps/coach-web/src/stores/grid-store.ts"
      via: "useGridStore hooks"
      pattern: "useGridStore"
---

<objective>
Wire the program editor page to the updated aggregate store and perform integration testing. Verify the complete flow: load program aggregate, edit in grid, save aggregate, verify persistence.

Purpose: Ensure the full-stack restructure works end-to-end. This is the final integration step before the phase is complete.

Output: Working program editor with aggregate-based save and load.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-domain-restructure-training-programs/03.4-06-SUMMARY.md

# Program editor page
@apps/coach-web/src/routes/_authenticated.$orgSlug/programs/$programId.tsx

# Updated store and hooks
@apps/coach-web/src/stores/grid-store.ts
@apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Program Editor to Aggregate Store</name>
  <files>apps/coach-web/src/routes/_authenticated.$orgSlug/programs/$programId.tsx</files>
  <action>
    Update the program editor page to:

    1. Fetch the program aggregate using the updated query
    2. Initialize the grid store with the aggregate on load
    3. Wire the save button to useSaveDraft
    4. Handle loading and error states

    ```typescript
    import { useParams } from '@tanstack/react-router'
    import { useEffect } from 'react'
    import { useProgram } from '@/features/programs/hooks/queries/use-program'
    import { useSaveDraft } from '@/features/programs/hooks/mutations/use-save-draft'
    import { useGridStore, useGridData, useGridIsDirty } from '@/stores/grid-store'
    import { ProgramGrid } from '@/components/programs/program-grid'
    import { SaveButton } from '@/components/programs/program-grid/save-button'

    export function ProgramEditorPage() {
      const { programId } = useParams({ from: '/_authenticated/$orgSlug/programs/$programId' })

      // Fetch program aggregate
      const { data: program, isLoading, error } = useProgram(programId)

      // Grid store
      const initialize = useGridStore(state => state.initialize)
      const gridData = useGridData()
      const isDirty = useGridIsDirty()

      // Save mutation
      const saveDraft = useSaveDraft()

      // Initialize store when program loads
      useEffect(() => {
        if (program) {
          initialize(program)
        }
      }, [program, initialize])

      // Handle loading state
      if (isLoading) {
        return <div>Cargando programa...</div>
      }

      // Handle error state
      if (error) {
        return <div>Error: {error.message}</div>
      }

      // Handle no data
      if (!gridData) {
        return <div>No hay datos del programa</div>
      }

      return (
        <div className="flex flex-col h-full">
          <header className="flex items-center justify-between p-4 border-b">
            <h1 className="text-xl font-semibold">{program?.name}</h1>
            <SaveButton
              isDirty={isDirty}
              isSaving={saveDraft.isPending}
              onSave={() => saveDraft.mutate()}
              error={saveDraft.error?.message}
            />
          </header>

          <main className="flex-1 overflow-auto">
            <ProgramGrid data={gridData} />
          </main>
        </div>
      )
    }
    ```

    Also ensure:
    - The unsaved changes warning (useUnsavedChanges hook) still works
    - Navigation away from dirty state prompts user
    - Success toast on save
    - Error toast on save failure
  </action>
  <verify>
    ```bash
    cd /Users/tomiardz/Projects/treino && pnpm typecheck --filter coach-web
    cd /Users/tomiardz/Projects/treino && pnpm build --filter coach-web
    ```
  </verify>
  <done>
    Program editor page wired to aggregate store, build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Start Development Server and Basic Verification</name>
  <files>None (testing only)</files>
  <action>
    Start the development environment and perform basic API verification:

    ```bash
    # Terminal 1: Start the server
    cd /Users/tomiardz/Projects/treino && pnpm dev:server

    # Terminal 2: Start the frontend
    cd /Users/tomiardz/Projects/treino && pnpm dev:coach
    ```

    Then verify the API works by checking:
    1. Server starts without errors
    2. Frontend compiles and loads
    3. Navigate to a program editor page
    4. Check browser console for any errors

    If there are TypeScript or import errors, fix them before proceeding to manual verification.
  </action>
  <verify>
    ```bash
    # Build check (ensures everything compiles)
    cd /Users/tomiardz/Projects/treino && pnpm build
    ```
  </verify>
  <done>
    Development environment runs, build succeeds, no console errors on page load.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Program aggregate restructure:
    - Domain: Program aggregate with Week -> Session -> ExerciseGroup -> GroupItem -> Series hierarchy
    - Backend: saveProgramAggregate (DELETE + INSERT), loadProgramAggregate
    - API: Full aggregate contracts for save/load
    - Frontend: Grid store maintains aggregate, sends full aggregate on save
  </what-built>
  <how-to-verify>
    1. Start dev environment:
       ```bash
       cd /Users/tomiardz/Projects/treino
       pnpm dev
       ```

    2. Open coach web app: http://localhost:5173

    3. Navigate to Programs and open an existing program (or create one)

    4. Test the edit flow:
       a. Edit a prescription cell (e.g., type "3x10@80%")
       b. See the "Guardar" button enabled (dirty state)
       c. Click "Guardar"
       d. Verify success (button returns to normal state)

    5. Test persistence:
       a. Refresh the page (Cmd+R / Ctrl+R)
       b. Verify the saved prescription appears correctly

    6. Test structural changes:
       a. Add a week (click "+" on columns)
       b. Add a session (click "Agregar sesion")
       c. Add an exercise to a session
       d. Save and refresh - verify all changes persisted

    7. Test superset grouping:
       a. Create a superset (right-click exercise -> join/create superset)
       b. Save
       c. Refresh - verify superset grouping persisted (A1, A2, etc.)

    8. Check for console errors throughout testing
  </how-to-verify>
  <resume-signal>
    Type "approved" if all tests pass.
    If issues found, describe them and we'll create a gap closure plan.
  </resume-signal>
</task>

</tasks>

<verification>
```bash
# Full project build
cd /Users/tomiardz/Projects/treino && pnpm build

# Type check
cd /Users/tomiardz/Projects/treino && pnpm typecheck

# Run core domain tests
cd /Users/tomiardz/Projects/treino && pnpm test --filter @strenly/core
```
</verification>

<success_criteria>
- Program editor loads program aggregate
- Grid displays program correctly
- Edits update the aggregate in store
- Save sends complete aggregate
- Refresh shows saved data
- Add week/session/exercise persists
- Superset grouping persists
- No console errors
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-domain-restructure-training-programs/03.4-07-SUMMARY.md`
</output>
