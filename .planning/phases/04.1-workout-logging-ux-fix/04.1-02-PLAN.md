---
phase: 04.1-workout-logging-ux-fix
plan: 02
type: execute
wave: 2
depends_on: ["04.1-01"]
files_modified:
  - apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx
  - apps/coach-web/src/features/workout-logs/components/logging-grid.tsx
  - apps/coach-web/src/features/workout-logs/components/exercise-group-section.tsx
  - apps/coach-web/src/features/workout-logs/components/series-row.tsx
  - packages/contracts/src/workout-logs/workout-log.ts
  - packages/backend/src/use-cases/workout-logs/create-log.ts
autonomous: true

must_haves:
  truths:
    - "Prescription values visible in dedicated column, not tooltip"
    - "Exercise groups displayed with visual grouping and labels (A1, A2, B1...)"
    - "Compact grid-like layout, not bulky cards"
    - "Session context visible in header (program, week, athlete)"
  artifacts:
    - path: "apps/coach-web/src/features/workout-logs/components/logging-grid.tsx"
      provides: "Main grid container for logging"
      exports: ["LoggingGrid"]
    - path: "apps/coach-web/src/features/workout-logs/components/exercise-group-section.tsx"
      provides: "Grouped exercises with visual connection"
      exports: ["ExerciseGroupSection"]
    - path: "apps/coach-web/src/features/workout-logs/components/series-row.tsx"
      provides: "Compact series row with prescription column"
      exports: ["SeriesRow"]
---

<objective>
Complete UI overhaul of the session logging view to be compact, grid-like, with visible prescriptions and exercise group visualization.

**Current Problems:**
1. View is bulky with large cards
2. Prescription hidden in tooltips
3. No exercise group visualization (supersets/circuits)
4. Missing session context (program, week, athlete names)
5. Missing prescription details (tempo, rest, intensity type)

**Target Design:**
- Compact grid layout similar to program builder
- Prescription column showing "8 × 100kg @RPE7"
- Exercise groups with A1/A2/B1 labels and visual connection
- Header with full context
- Amber highlight on deviations (inline, visible)

Output: Redesigned logging view that's compact, informative, and matches the program grid UX.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04.1-workout-logging-ux-fix/ANALYSIS.md

# Current implementation
@apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx
@apps/coach-web/src/features/workout-logs/components/logged-exercise-card.tsx
@apps/coach-web/src/features/workout-logs/components/logged-series-input.tsx

# Reference: Program grid for style
@apps/coach-web/src/components/programs/program-grid/program-grid.tsx

# Domain types
@packages/core/src/domain/entities/workout-log/types.ts
@packages/core/src/domain/entities/program/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand LoggedSeries schema with full prescription data</name>
  <files>
    packages/contracts/src/workout-logs/workout-log.ts
    packages/core/src/domain/entities/workout-log/types.ts
  </files>
  <action>
Expand the LoggedSeries type to include more prescription context:

**Add to LoggedSeries:**
```typescript
// Existing
prescribedReps: number | null
prescribedWeight: number | null

// NEW - for display
prescribedRepsMax: number | null      // For rep ranges like 8-10
prescribedIsAmrap: boolean
prescribedIntensityType: 'absolute' | 'percentage' | 'rpe' | 'rir' | null
prescribedIntensityValue: number | null
prescribedTempo: string | null        // "3010"
prescribedRestSeconds: number | null  // 90
```

**Add to LoggedExercise:**
```typescript
// NEW - for group display
groupLabel: string | null   // "A", "B", "C"...
groupOrder: number          // 1, 2, 3... (position within group)
```

Update both:
1. `packages/core/src/domain/entities/workout-log/types.ts`
2. `packages/contracts/src/workout-logs/workout-log.ts`

Keep backward compatible - new fields are optional/nullable.
  </action>
  <verify>
    `pnpm typecheck` passes
    Schemas export correctly
  </verify>
  <done>
    LoggedSeries has full prescription snapshot
    LoggedExercise has group display info
  </done>
</task>

<task type="auto">
  <name>Task 2: Update create-log use case to populate full prescription data</name>
  <files>
    packages/backend/src/use-cases/workout-logs/create-log.ts
  </files>
  <action>
When creating a log from prescription, populate all the new fields:

1. Load the program aggregate (already done)
2. For each exercise in the session:
   - Find its ExerciseGroup
   - Calculate group label (A, B, C based on group orderIndex)
   - Calculate group order (position within group items)
3. For each series:
   - Copy all prescription fields, not just reps/weight:
     - prescribedRepsMax
     - prescribedIsAmrap
     - prescribedIntensityType
     - prescribedIntensityValue (convert to weight if absolute)
     - prescribedTempo
     - prescribedRestSeconds

**Group label calculation:**
```typescript
// Group labels: A, B, C, D...
const groupLabel = String.fromCharCode(65 + group.orderIndex) // 0->A, 1->B, 2->C

// Item order in group: 1, 2, 3...
const groupOrder = item.orderIndex + 1
```

This gives us "A1", "A2", "B1", etc. display strings.
  </action>
  <verify>
    Create log returns full prescription data
    Group labels calculated correctly
  </verify>
  <done>
    Log creation includes complete prescription snapshot
    Exercise groups have labels for display
  </done>
</task>

<task type="auto">
  <name>Task 3: Create compact SeriesRow component</name>
  <files>apps/coach-web/src/features/workout-logs/components/series-row.tsx</files>
  <action>
Create a compact row component for a single series:

**Layout (grid columns):**
```
| # | Prescripción    | Reps  | Peso (kg) | RPE | ⏭️ |
| 1 | 8 × 100kg @RPE7 | [  8] | [  100  ] | [7] | ○  |
```

**Prescription format function:**
```typescript
function formatPrescription(series: LoggedSeries): string {
  const parts: string[] = []

  // Reps part
  if (series.prescribedIsAmrap) {
    parts.push('AMRAP')
  } else if (series.prescribedReps) {
    if (series.prescribedRepsMax && series.prescribedRepsMax !== series.prescribedReps) {
      parts.push(`${series.prescribedReps}-${series.prescribedRepsMax}`)
    } else {
      parts.push(`${series.prescribedReps}`)
    }
  }

  // Weight/intensity
  if (series.prescribedWeight) {
    parts.push(`× ${series.prescribedWeight}kg`)
  }
  if (series.prescribedIntensityType && series.prescribedIntensityValue) {
    switch (series.prescribedIntensityType) {
      case 'rpe': parts.push(`@RPE${series.prescribedIntensityValue}`); break
      case 'rir': parts.push(`@RIR${series.prescribedIntensityValue}`); break
      case 'percentage': parts.push(`@${series.prescribedIntensityValue}%`); break
    }
  }

  // Tempo (smaller, secondary)
  // Rest handled separately

  return parts.join(' ') || '-'
}
```

**Styling:**
- Compact height (~32-36px rows)
- Inputs are small (h-7 or h-8)
- Prescription column is muted text, left-aligned
- Inputs centered
- Amber border on deviation (compare performed vs prescribed)
- Skip button is small icon only

**Props:**
```typescript
interface SeriesRowProps {
  exerciseId: string
  series: LoggedSeries
  seriesIndex: number
  disabled?: boolean
}
```
  </action>
  <verify>
    Component renders compact row
    Prescription displays correctly
    Deviation highlighting works
  </verify>
  <done>
    Compact series row with visible prescription
    ~32px height per row
  </done>
</task>

<task type="auto">
  <name>Task 4: Create ExerciseGroupSection component</name>
  <files>apps/coach-web/src/features/workout-logs/components/exercise-group-section.tsx</files>
  <action>
Create a component that renders a group of exercises (superset/circuit or standalone):

**Visual Design:**
```
For superset (group with 2+ items):
┌──────────────────────────────────────────────────────────┐
│ ┃ A1  Bench Press                             [Omitir]  │
│ ┃ A2  Incline Dumbbell                        [Omitir]  │
│ ├────────────────────────────────────────────────────────┤
│ │ Bench Press (3 series)                                 │
│ │ # │ Prescripción    │ Reps │ Peso  │ RPE │            │
│ │ 1 │ 8 × 100kg       │ [8]  │ [100] │ [7] │ ⏭️         │
│ │ 2 │ 8 × 100kg       │ [8]  │ [102] │ [8] │ ⏭️         │ ← amber
│ │ 3 │ 8 × 100kg       │ [7]  │ [100] │ [9] │ ⏭️         │
│ │ Notas: [                                         ]    │
│ ├────────────────────────────────────────────────────────┤
│ │ Incline Dumbbell (2 series)                            │
│ │ ...                                                    │
└──────────────────────────────────────────────────────────┘

For standalone (group with 1 item):
┌──────────────────────────────────────────────────────────┐
│ B1  Tricep Pushdown                           [Omitir]  │
├──────────────────────────────────────────────────────────┤
│ # │ Prescripción │ Reps │ Peso │ RPE │                  │
│ ...                                                      │
└──────────────────────────────────────────────────────────┘
```

**Key visual elements:**
- Left border (blue) connecting all items in a superset
- Group labels (A1, A2) visible in header
- Exercise name + series count
- Compact table for series
- Notes at bottom of each exercise

**Props:**
```typescript
interface ExerciseGroupSectionProps {
  exercises: LoggedExercise[]  // All exercises in this group
  exercisesMap: Map<string, string>  // exerciseId -> name
  groupLabel: string  // "A", "B", etc.
}
```

The component receives all exercises for a group and renders them together.
  </action>
  <verify>
    Supersets show connected with left border
    Group labels visible (A1, A2, B1)
    Compact layout
  </verify>
  <done>
    Exercise groups render with visual connection
    Standalone exercises work too
  </done>
</task>

<task type="auto">
  <name>Task 5: Create LoggingGrid container component</name>
  <files>apps/coach-web/src/features/workout-logs/components/logging-grid.tsx</files>
  <action>
Create the main grid container that groups exercises by their group:

**Logic:**
1. Take all exercises from log
2. Group them by groupLabel (A, B, C...)
3. Render each group as ExerciseGroupSection
4. Handle cases where groupLabel might be null (legacy data)

```typescript
function groupExercisesByLabel(exercises: LoggedExercise[]): Map<string, LoggedExercise[]> {
  const groups = new Map<string, LoggedExercise[]>()

  for (const exercise of exercises) {
    const label = exercise.groupLabel ?? `_${exercise.orderIndex}` // Fallback for ungrouped
    if (!groups.has(label)) {
      groups.set(label, [])
    }
    groups.get(label)!.push(exercise)
  }

  // Sort each group by groupOrder
  for (const [, items] of groups) {
    items.sort((a, b) => (a.groupOrder ?? 0) - (b.groupOrder ?? 0))
  }

  return groups
}
```

**Render:**
```tsx
export function LoggingGrid({ exercises, exercisesMap }: LoggingGridProps) {
  const groupedExercises = groupExercisesByLabel(exercises)
  const sortedGroups = [...groupedExercises.entries()]
    .sort((a, b) => a[0].localeCompare(b[0]))

  return (
    <div className="space-y-4">
      {sortedGroups.map(([label, groupExercises]) => (
        <ExerciseGroupSection
          key={label}
          exercises={groupExercises}
          exercisesMap={exercisesMap}
          groupLabel={label}
        />
      ))}
    </div>
  )
}
```
  </action>
  <verify>
    Exercises grouped correctly
    Renders all exercises
  </verify>
  <done>
    LoggingGrid groups and renders all exercises
  </done>
</task>

<task type="auto">
  <name>Task 6: Redesign SessionLoggingView with context header</name>
  <files>apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx</files>
  <action>
Complete redesign of the session logging view:

**Header with context:**
```
← Volver                                        [Guardar]

Registro de Entrenamiento
Programa: Fuerza Máxima | Semana 2: Intensificación | Carlos Rodriguez
Sesión: Squat Day
Fecha: Lunes 28 de enero de 2026
```

Need to fetch additional context:
1. Program name (we have programId)
2. Week name (we have weekId)
3. Session name (we have sessionId)
4. Athlete name (we have athleteId)

Options:
- Add these to the log aggregate (denormalized, simpler)
- Fetch program aggregate and extract names (more calls)
- Add a "getSessionContext" procedure that returns names

**Simplest approach:** Add to LoggedExercise or WorkoutLog:
- `programName`
- `weekName`
- `sessionName`
- `athleteName`

These are set once when log is created and stored as snapshot.

**Layout:**
```tsx
<div className="flex h-full flex-col">
  {/* Sticky header */}
  <header className="sticky top-0 z-10 border-b bg-background px-4 py-3">
    <div className="flex items-center justify-between">
      <Button variant="ghost" size="sm">← Volver</Button>
      <Button disabled={!isDirty}>Guardar</Button>
    </div>
    <div className="mt-2">
      <h1 className="text-lg font-semibold">Registro de Entrenamiento</h1>
      <p className="text-sm text-muted-foreground">
        {programName} | {weekName} | {athleteName}
      </p>
      <p className="text-sm text-muted-foreground">
        Sesión: {sessionName} · {formatDate(logDate)}
      </p>
    </div>
  </header>

  {/* Scrollable content */}
  <div className="flex-1 overflow-y-auto p-4">
    <LoggingGrid exercises={logData.exercises} exercisesMap={exercisesMap} />

    {/* Session summary at bottom */}
    <SessionSummaryCard />
  </div>

  {/* Sticky footer */}
  <footer className="border-t px-4 py-3">
    <Button className="w-full" disabled={!isDirty}>Guardar</Button>
  </footer>
</div>
```

Replace the old LoggedExerciseCard usage with new LoggingGrid.
Delete or deprecate old components.
  </action>
  <verify>
    Header shows full context
    LoggingGrid renders instead of old cards
    Layout is compact
  </verify>
  <done>
    Complete redesign with context header
    Compact grid layout
    All exercises visible with groups
  </done>
</task>

<task type="auto">
  <name>Task 7: Add context fields to WorkoutLog and update create-log</name>
  <files>
    packages/core/src/domain/entities/workout-log/types.ts
    packages/contracts/src/workout-logs/workout-log.ts
    packages/backend/src/use-cases/workout-logs/create-log.ts
  </files>
  <action>
Add denormalized context fields to WorkoutLog for display:

**Add to WorkoutLog type:**
```typescript
// Display context (denormalized snapshots)
readonly programName: string
readonly weekName: string
readonly sessionName: string
readonly athleteName: string
```

**Update create-log use case:**
When creating a log, fetch and store these names:
1. Program name from program aggregate (already loaded)
2. Week name from program.weeks.find(w => w.id === weekId)
3. Session name from week.sessions.find(s => s.id === sessionId)
4. Athlete name from athlete repository or context

This allows the frontend to display full context without additional fetches.
  </action>
  <verify>
    WorkoutLog has all context fields
    create-log populates them
    `pnpm typecheck` passes
  </verify>
  <done>
    Log carries all display context
    No additional fetches needed in frontend
  </done>
</task>

<task type="auto">
  <name>Task 8: Cleanup old components and verify</name>
  <files>
    apps/coach-web/src/features/workout-logs/components/logged-exercise-card.tsx
    apps/coach-web/src/features/workout-logs/components/logged-series-input.tsx
  </files>
  <action>
1. Delete old components that are replaced:
   - `logged-exercise-card.tsx` (replaced by ExerciseGroupSection)
   - `logged-series-input.tsx` (replaced by SeriesRow)

2. Update any remaining imports

3. Run typecheck and lint

4. Test the full flow:
   - Navigate to athlete detail
   - Click "Registrar" on a session
   - Verify compact grid layout
   - Verify prescription column visible
   - Verify group labels (A1, A2, B1)
   - Verify amber highlighting on deviation
   - Save and verify
  </action>
  <verify>
    Old components deleted
    No import errors
    `pnpm typecheck` passes
    `pnpm lint` passes
  </verify>
  <done>
    Cleanup complete
    New compact UI working
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
pnpm typecheck

# Lint passes
pnpm lint

# Manual testing
pnpm dev

# Test flow:
# 1. Go to /test/athletes
# 2. Click on Carlos Rodriguez
# 3. Click "Registrar" on Squat Day
# 4. Verify:
#    - Header shows program, week, athlete, session names
#    - Exercises grouped (A1, A2 together if superset)
#    - Prescription column visible (8 × 100kg @RPE7)
#    - Compact rows (~32px height)
#    - Amber border when value differs from prescription
# 5. Save and verify persistence
```
</verification>

<success_criteria>
1. Prescription visible in dedicated column (not tooltip)
2. Exercise groups have visual connection (left border for supersets)
3. Group labels visible (A1, A2, B1...)
4. Compact layout (~32px per series row)
5. Header shows full context (program, week, session, athlete)
6. Amber highlighting on deviations
7. Skip functionality still works
8. Save/load works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-workout-logging-ux-fix/04.1-02-SUMMARY.md`
</output>
