---
phase: 04-coach-workout-logging
plan: 05
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - packages/backend/src/use-cases/workout-logs/list-athlete-logs.ts
  - packages/backend/src/use-cases/workout-logs/list-pending-workouts.ts
  - packages/backend/src/use-cases/workout-logs/delete-log.ts
autonomous: true

must_haves:
  truths:
    - "listAthleteLogs returns paginated history for an athlete"
    - "listPendingWorkouts returns sessions without logs for dashboard"
    - "deleteLog removes log with authorization check"
  artifacts:
    - path: "packages/backend/src/use-cases/workout-logs/list-athlete-logs.ts"
      provides: "listAthleteLogs use case"
      exports: ["listAthleteLogs"]
    - path: "packages/backend/src/use-cases/workout-logs/list-pending-workouts.ts"
      provides: "listPendingWorkouts use case"
      exports: ["listPendingWorkouts"]
    - path: "packages/backend/src/use-cases/workout-logs/delete-log.ts"
      provides: "deleteLog use case"
      exports: ["deleteLog"]
  key_links:
    - from: "packages/backend/src/use-cases/workout-logs/list-pending-workouts.ts"
      to: "workout log repository"
      via: "listPendingWorkouts query"
      pattern: "listPendingWorkouts"
---

<objective>
Implement remaining use cases for listing workout logs and deleting logs.

Purpose: listAthleteLogs supports the history view, listPendingWorkouts powers the logging dashboard, and deleteLog allows coaches to remove logs.

Output: Three use cases completing the workout log use case layer.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-coach-workout-logging/04-CONTEXT.md

# From prior plans
@packages/core/src/ports/workout-log-repository.port.ts
@packages/backend/src/use-cases/workout-logs/create-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create listAthleteLogs Use Case</name>
  <skills>/use-case, /authorization</skills>
  <files>packages/backend/src/use-cases/workout-logs/list-athlete-logs.ts</files>
  <action>
Create the listAthleteLogs use case for history view:

```typescript
import { ResultAsync, errAsync } from 'neverthrow'
import type { WorkoutLog } from '@strenly/core/domain/entities/workout-log/types'
import { hasPermission } from '@strenly/core/services/authorization'
import type { WorkoutLogRepository, WorkoutLogFilters } from '@strenly/core/ports/workout-log-repository.port'
import type { OrganizationContext } from '@strenly/core/types/organization-context'

type ListAthleteLogsInput = {
  athleteId: string
  status?: 'completed' | 'partial' | 'skipped'
  fromDate?: Date
  toDate?: Date
  limit?: number
  offset?: number
}

type ListAthleteLogsOutput = {
  items: WorkoutLog[]
  totalCount: number
}

type ListAthleteLogsError =
  | { type: 'unauthorized'; message: string }
  | { type: 'repository_error'; message: string }

type ListAthleteLogsDeps = {
  workoutLogRepository: WorkoutLogRepository
}

export function listAthleteLogs(
  ctx: OrganizationContext,
  input: ListAthleteLogsInput,
  deps: ListAthleteLogsDeps
): ResultAsync<ListAthleteLogsOutput, ListAthleteLogsError> {
  // 1. Check authorization
  if (!hasPermission(ctx.role, 'workout_log:read')) {
    return errAsync({ type: 'unauthorized', message: 'Cannot read workout logs' })
  }

  // 2. Build filters
  const filters: Omit<WorkoutLogFilters, 'athleteId'> = {
    status: input.status,
    fromDate: input.fromDate,
    toDate: input.toDate,
    limit: input.limit ?? 20,
    offset: input.offset ?? 0,
  }

  // 3. Query repository
  return deps.workoutLogRepository
    .listByAthlete(ctx, input.athleteId, filters)
    .mapErr((e) => ({ type: 'repository_error' as const, message: e.message }))
}
```

Key points:
- Defaults to 20 items per page
- Supports date range and status filtering
- Returns totalCount for pagination UI
  </action>
  <verify>
    `pnpm typecheck` passes
    Function exports listAthleteLogs
  </verify>
  <done>
    listAthleteLogs returns paginated logs for an athlete
    Supports filtering by status and date range
  </done>
</task>

<task type="auto">
  <name>Task 2: Create listPendingWorkouts and deleteLog Use Cases</name>
  <skills>/use-case, /authorization</skills>
  <files>
    packages/backend/src/use-cases/workout-logs/list-pending-workouts.ts
    packages/backend/src/use-cases/workout-logs/delete-log.ts
  </files>
  <action>
**list-pending-workouts.ts:**
```typescript
import { ResultAsync, errAsync } from 'neverthrow'
import { hasPermission } from '@strenly/core/services/authorization'
import type { WorkoutLogRepository } from '@strenly/core/ports/workout-log-repository.port'
import type { OrganizationContext } from '@strenly/core/types/organization-context'

type PendingWorkout = {
  athleteId: string
  athleteName: string
  programId: string
  programName: string
  sessionId: string
  sessionName: string
  weekId: string
  weekName: string
}

type ListPendingWorkoutsInput = {
  limit?: number
  offset?: number
}

type ListPendingWorkoutsOutput = {
  items: PendingWorkout[]
  totalCount: number
}

type ListPendingWorkoutsError =
  | { type: 'unauthorized'; message: string }
  | { type: 'repository_error'; message: string }

type ListPendingWorkoutsDeps = {
  workoutLogRepository: WorkoutLogRepository
}

export function listPendingWorkouts(
  ctx: OrganizationContext,
  input: ListPendingWorkoutsInput,
  deps: ListPendingWorkoutsDeps
): ResultAsync<ListPendingWorkoutsOutput, ListPendingWorkoutsError> {
  // 1. Check authorization
  if (!hasPermission(ctx.role, 'workout_log:read')) {
    return errAsync({ type: 'unauthorized', message: 'Cannot read workout logs' })
  }

  // 2. Query repository for pending workouts
  return deps.workoutLogRepository
    .listPendingWorkouts(ctx, {
      limit: input.limit ?? 50,
      offset: input.offset ?? 0,
    })
    .mapErr((e) => ({ type: 'repository_error' as const, message: e.message }))
}
```

**delete-log.ts:**
```typescript
import { ResultAsync, errAsync, okAsync } from 'neverthrow'
import { hasPermission } from '@strenly/core/services/authorization'
import type { WorkoutLogRepository } from '@strenly/core/ports/workout-log-repository.port'
import type { OrganizationContext } from '@strenly/core/types/organization-context'

type DeleteLogError =
  | { type: 'unauthorized'; message: string }
  | { type: 'not_found'; message: string }
  | { type: 'repository_error'; message: string }

type DeleteLogDeps = {
  workoutLogRepository: WorkoutLogRepository
}

export function deleteLog(
  ctx: OrganizationContext,
  logId: string,
  deps: DeleteLogDeps
): ResultAsync<void, DeleteLogError> {
  // 1. Check authorization
  if (!hasPermission(ctx.role, 'workout_log:delete')) {
    return errAsync({ type: 'unauthorized', message: 'Cannot delete workout logs' })
  }

  // 2. Verify log exists before deleting
  return deps.workoutLogRepository
    .findById(ctx, logId)
    .mapErr((e) => ({ type: 'repository_error' as const, message: e.message }))
    .andThen((log) => {
      if (!log) {
        return errAsync({ type: 'not_found' as const, message: 'Workout log not found' })
      }
      return okAsync(undefined)
    })
    // 3. Delete the log
    .andThen(() =>
      deps.workoutLogRepository
        .delete(ctx, logId)
        .mapErr((e) => ({ type: 'repository_error' as const, message: e.message }))
    )
}
```
  </action>
  <verify>
    `pnpm typecheck` passes
    Both files export their use case functions
  </verify>
  <done>
    listPendingWorkouts returns unlogged sessions for dashboard
    deleteLog removes log with existence check
  </done>
</task>

<task type="auto">
  <name>Task 3: Add workout_log Permissions to Authorization</name>
  <skills>/authorization</skills>
  <files>packages/core/src/services/authorization.ts</files>
  <action>
Add workout_log permissions to the authorization service:

1. Add new permission types:
   - 'workout_log:create'
   - 'workout_log:read'
   - 'workout_log:update'
   - 'workout_log:delete'

2. Update ROLE_PERMISSIONS to grant these to appropriate roles:
   - owner: all workout_log permissions
   - admin: all workout_log permissions
   - coach: all workout_log permissions (coaches log for athletes)

Follow the existing pattern in the file.
  </action>
  <verify>
    `pnpm typecheck` passes
    hasPermission returns true for 'coach' role with 'workout_log:create'
  </verify>
  <done>
    Authorization service includes workout_log permissions
    Coaches can create, read, update, delete workout logs
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
pnpm typecheck

# Verify all exports
grep "export function" packages/backend/src/use-cases/workout-logs/*.ts
```
</verification>

<success_criteria>
1. listAthleteLogs returns paginated history with filters
2. listPendingWorkouts returns sessions without logs (for dashboard)
3. deleteLog checks existence before deleting
4. All use cases have authorization checks
5. workout_log permissions added to authorization service
</success_criteria>

<output>
After completion, create `.planning/phases/04-coach-workout-logging/04-05-SUMMARY.md`
</output>
