---
phase: 04-coach-workout-logging
plan: 09
type: execute
wave: 5
depends_on: ["04-07"]
files_modified:
  - apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/log/$sessionId.tsx
  - apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx
  - apps/coach-web/src/features/workout-logs/components/logged-exercise-card.tsx
  - apps/coach-web/src/features/workout-logs/components/logged-series-input.tsx
  - apps/coach-web/src/features/workout-logs/components/session-summary-card.tsx
  - apps/coach-web/src/hooks/use-unsaved-changes.ts
autonomous: true

must_haves:
  truths:
    - "Session logging view shows all exercises with pre-filled values"
    - "Coach can modify reps, weight, RPE for each set"
    - "Deviation highlighting shows when actual differs from planned"
    - "Coach can skip entire exercises"
    - "Unsaved changes prompt before navigation"
    - "Guardar button persists the log"
  artifacts:
    - path: "apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/log/$sessionId.tsx"
      provides: "Session logging route"
      min_lines: 30
    - path: "apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx"
      provides: "Session logging view component"
      exports: ["SessionLoggingView"]
      min_lines: 100
    - path: "apps/coach-web/src/features/workout-logs/components/logged-exercise-card.tsx"
      provides: "Exercise card with series inputs"
      exports: ["LoggedExerciseCard"]
    - path: "apps/coach-web/src/features/workout-logs/components/logged-series-input.tsx"
      provides: "Series input row with deviation display"
      exports: ["LoggedSeriesInput"]
  key_links:
    - from: "apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx"
      to: "log store"
      via: "state management"
      pattern: "useLogStore|useLogActions"
    - from: "apps/coach-web/src/features/workout-logs/components/logged-series-input.tsx"
      to: "deviation detection"
      via: "comparison logic"
      pattern: "prescribedReps|prescribedWeight"
---

<objective>
Create the session logging view where coaches enter actual workout data.

Purpose: This is the core logging interface. Coaches see pre-filled values from the prescription, modify what's different, add RPE/notes, and save. Deviation highlighting shows what changed from the plan.

Output: Complete session logging page with exercise cards, series inputs, deviation display, skip functionality, and save button.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-coach-workout-logging/04-CONTEXT.md
@.planning/phases/04-coach-workout-logging/04-RESEARCH.md

# From prior plans
@apps/coach-web/src/stores/log-store.ts
@apps/coach-web/src/features/workout-logs/hooks/mutations/use-create-log.ts
@apps/coach-web/src/features/workout-logs/hooks/mutations/use-save-log.ts

# Reference: Existing patterns
@apps/coach-web/src/hooks/use-unsaved-changes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Session Logging Route and View</name>
  <files>
    apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/log/$sessionId.tsx
    apps/coach-web/src/features/workout-logs/views/session-logging-view.tsx
  </files>
  <action>
**Route ($sessionId.tsx):**
```typescript
import { createFileRoute } from '@tanstack/react-router'
import { z } from 'zod'
import { SessionLoggingView } from '@/features/workout-logs/views/session-logging-view'

const searchSchema = z.object({
  programId: z.string(),
  weekId: z.string(),
  logId: z.string().optional(), // For editing existing log
})

export const Route = createFileRoute(
  '/_authenticated/$orgSlug/athletes/$athleteId/log/$sessionId'
)({
  validateSearch: searchSchema,
  component: SessionLoggingPage,
})

function SessionLoggingPage() {
  const { athleteId, sessionId } = Route.useParams()
  const { programId, weekId, logId } = Route.useSearch()

  return (
    <SessionLoggingView
      athleteId={athleteId}
      programId={programId}
      sessionId={sessionId}
      weekId={weekId}
      existingLogId={logId}
    />
  )
}
```

**View (session-logging-view.tsx):**
```typescript
import { useEffect } from 'react'
import { useNavigate, useParams } from '@tanstack/react-router'
import { useCreateLog } from '../hooks/mutations/use-create-log'
import { useSaveLog } from '../hooks/mutations/use-save-log'
import { useWorkoutLog } from '../hooks/queries/use-workout-log'
import { useLogStore, useLogData, useLogIsDirty, useLogActions } from '@/stores/log-store'
import { useUnsavedChanges } from '@/hooks/use-unsaved-changes'
import { LoggedExerciseCard } from '../components/logged-exercise-card'
import { SessionSummaryCard } from '../components/session-summary-card'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'
import { ArrowLeft, Save } from 'lucide-react'
import { toast } from 'sonner'

interface SessionLoggingViewProps {
  athleteId: string
  programId: string
  sessionId: string
  weekId: string
  existingLogId?: string
}

export function SessionLoggingView({
  athleteId,
  programId,
  sessionId,
  weekId,
  existingLogId,
}: SessionLoggingViewProps) {
  const { orgSlug } = useParams({ from: '/_authenticated/$orgSlug' })
  const navigate = useNavigate()

  // Store state
  const log = useLogData()
  const isDirty = useLogIsDirty()
  const { initialize, reset, getLogForSave, markSaved } = useLogActions()

  // Mutations
  const createLogMutation = useCreateLog()
  const saveLogMutation = useSaveLog()

  // Query for existing log (if editing)
  const existingLogQuery = useWorkoutLog(existingLogId)

  // Unsaved changes guard
  useUnsavedChanges(isDirty)

  // Initialize log on mount
  useEffect(() => {
    if (existingLogId && existingLogQuery.data) {
      // Editing existing log
      initialize(existingLogQuery.data)
    } else if (!existingLogId && !log) {
      // Creating new log - fetch pre-filled from server
      createLogMutation.mutate(
        { athleteId, programId, sessionId, weekId },
        {
          onSuccess: (data) => {
            initialize(data)
          },
          onError: (error) => {
            toast.error('Error al cargar sesion')
            navigate({ to: `/${orgSlug}/logging` })
          },
        }
      )
    }
  }, [existingLogId, existingLogQuery.data])

  // Cleanup on unmount
  useEffect(() => {
    return () => reset()
  }, [])

  // Handle save
  const handleSave = () => {
    const logData = getLogForSave()
    if (!logData) return

    saveLogMutation.mutate(logData, {
      onSuccess: () => {
        toast.success('Registro guardado')
        markSaved()
        navigate({ to: `/${orgSlug}/athletes/${athleteId}/logs` })
      },
      onError: () => {
        toast.error('Error al guardar registro')
      },
    })
  }

  // Handle back
  const handleBack = () => {
    navigate({ to: `/${orgSlug}/logging` })
  }

  // Loading state
  if (!log || (existingLogId && existingLogQuery.isLoading)) {
    return (
      <div className="space-y-4">
        <Skeleton className="h-8 w-48" />
        <Skeleton className="h-32 w-full" />
        <Skeleton className="h-32 w-full" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={handleBack}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div>
            <h1 className="text-xl font-bold">Registrar Entrenamiento</h1>
            <p className="text-sm text-muted-foreground">
              {/* TODO: Show session name and date */}
              Sesion de entrenamiento
            </p>
          </div>
        </div>
        <Button onClick={handleSave} disabled={saveLogMutation.isPending}>
          <Save className="h-4 w-4 mr-2" />
          {saveLogMutation.isPending ? 'Guardando...' : 'Guardar'}
        </Button>
      </div>

      {/* Session summary (RPE, notes) */}
      <SessionSummaryCard />

      {/* Exercise list */}
      <div className="space-y-4">
        {log.exercises.map((exercise) => (
          <LoggedExerciseCard key={exercise.id} exercise={exercise} />
        ))}
      </div>

      {/* Empty state */}
      {log.exercises.length === 0 && (
        <div className="text-center py-12 text-muted-foreground">
          Esta sesion no tiene ejercicios
        </div>
      )}
    </div>
  )
}
```

Key features:
- Initializes log from createLog mutation (pre-filled from prescription)
- Uses store for client-side editing
- Unsaved changes guard prompts before navigation
- Save button persists via saveLog mutation
  </action>
  <verify>
    Route file exports Route
    View component renders
    `pnpm typecheck` passes
  </verify>
  <done>
    Session logging route at /athletes/$athleteId/log/$sessionId
    View initializes log and shows exercises
    Save button persists log
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Exercise and Series Components</name>
  <files>
    apps/coach-web/src/features/workout-logs/components/logged-exercise-card.tsx
    apps/coach-web/src/features/workout-logs/components/logged-series-input.tsx
  </files>
  <action>
**logged-exercise-card.tsx:**
```typescript
import type { LoggedExerciseInput } from '@strenly/contracts/workout-logs/workout-log'
import { useLogActions } from '@/stores/log-store'
import { LoggedSeriesInput } from './logged-series-input'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Textarea } from '@/components/ui/textarea'
import { Label } from '@/components/ui/label'
import { SkipForward, RotateCcw } from 'lucide-react'
import { cn } from '@/lib/utils'

interface LoggedExerciseCardProps {
  exercise: LoggedExerciseInput
}

export function LoggedExerciseCard({ exercise }: LoggedExerciseCardProps) {
  const { skipExercise, unskipExercise, updateExerciseNotes } = useLogActions()

  const handleSkip = () => {
    if (exercise.skipped) {
      unskipExercise(exercise.id)
    } else {
      skipExercise(exercise.id)
    }
  }

  return (
    <Card className={cn(exercise.skipped && 'opacity-50')}>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-base font-medium">
          {/* TODO: Get exercise name from exercises map */}
          Ejercicio
        </CardTitle>
        <Button
          variant={exercise.skipped ? 'default' : 'outline'}
          size="sm"
          onClick={handleSkip}
        >
          {exercise.skipped ? (
            <>
              <RotateCcw className="h-4 w-4 mr-1" />
              Restaurar
            </>
          ) : (
            <>
              <SkipForward className="h-4 w-4 mr-1" />
              Saltar
            </>
          )}
        </Button>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Series inputs */}
        {!exercise.skipped && (
          <div className="space-y-2">
            {/* Header row */}
            <div className="grid grid-cols-5 gap-2 text-xs text-muted-foreground font-medium">
              <div>Serie</div>
              <div>Reps</div>
              <div>Peso (kg)</div>
              <div>RPE</div>
              <div></div>
            </div>
            {/* Series rows */}
            {exercise.series.map((series, index) => (
              <LoggedSeriesInput
                key={index}
                exerciseId={exercise.id}
                seriesIndex={index}
                series={series}
              />
            ))}
          </div>
        )}

        {/* Exercise notes */}
        <div className="space-y-2">
          <Label htmlFor={`notes-${exercise.id}`}>Notas</Label>
          <Textarea
            id={`notes-${exercise.id}`}
            placeholder="Notas del ejercicio..."
            value={exercise.notes ?? ''}
            onChange={(e) => updateExerciseNotes(exercise.id, e.target.value || null)}
            disabled={exercise.skipped}
            rows={2}
          />
        </div>
      </CardContent>
    </Card>
  )
}
```

**logged-series-input.tsx:**
```typescript
import type { LoggedSeriesInput as LoggedSeriesType } from '@strenly/contracts/workout-logs/workout-log'
import { useLogActions } from '@/stores/log-store'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'
import { SkipForward, Info } from 'lucide-react'
import { cn } from '@/lib/utils'

interface LoggedSeriesInputProps {
  exerciseId: string
  seriesIndex: number
  series: LoggedSeriesType
}

export function LoggedSeriesInput({
  exerciseId,
  seriesIndex,
  series,
}: LoggedSeriesInputProps) {
  const { updateSeries } = useLogActions()

  // Deviation detection
  const repsDeviation = series.repsPerformed !== series.prescribedReps
  const weightDeviation = series.weightUsed !== series.prescribedWeight

  // Handle input changes
  const handleRepsChange = (value: string) => {
    const numValue = value === '' ? null : parseInt(value, 10)
    if (value !== '' && isNaN(numValue as number)) return
    updateSeries(exerciseId, seriesIndex, { repsPerformed: numValue })
  }

  const handleWeightChange = (value: string) => {
    const numValue = value === '' ? null : parseFloat(value)
    if (value !== '' && isNaN(numValue as number)) return
    updateSeries(exerciseId, seriesIndex, { weightUsed: numValue })
  }

  const handleRpeChange = (value: string) => {
    const numValue = value === '' ? null : parseInt(value, 10)
    if (value !== '' && (isNaN(numValue as number) || numValue < 1 || numValue > 10)) return
    updateSeries(exerciseId, seriesIndex, { rpe: numValue })
  }

  const handleSkipSeries = () => {
    updateSeries(exerciseId, seriesIndex, { skipped: !series.skipped })
  }

  if (series.skipped) {
    return (
      <div className="grid grid-cols-5 gap-2 items-center opacity-50">
        <div className="text-sm">{seriesIndex + 1}</div>
        <div colSpan={3} className="text-sm text-muted-foreground col-span-3">
          Saltada
        </div>
        <Button variant="ghost" size="sm" onClick={handleSkipSeries}>
          Restaurar
        </Button>
      </div>
    )
  }

  return (
    <div className="grid grid-cols-5 gap-2 items-center">
      {/* Series number */}
      <div className="text-sm font-medium">{seriesIndex + 1}</div>

      {/* Reps input with deviation */}
      <div className="relative">
        <Input
          type="number"
          min={0}
          value={series.repsPerformed ?? ''}
          onChange={(e) => handleRepsChange(e.target.value)}
          className={cn(
            'w-full',
            repsDeviation && 'border-amber-500 focus-visible:ring-amber-500'
          )}
        />
        {repsDeviation && series.prescribedReps !== null && (
          <Tooltip>
            <TooltipTrigger asChild>
              <Info className="absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 text-amber-500" />
            </TooltipTrigger>
            <TooltipContent>
              Planificado: {series.prescribedReps}
            </TooltipContent>
          </Tooltip>
        )}
      </div>

      {/* Weight input with deviation */}
      <div className="relative">
        <Input
          type="number"
          min={0}
          step={0.5}
          value={series.weightUsed ?? ''}
          onChange={(e) => handleWeightChange(e.target.value)}
          className={cn(
            'w-full',
            weightDeviation && 'border-amber-500 focus-visible:ring-amber-500'
          )}
        />
        {weightDeviation && series.prescribedWeight !== null && (
          <Tooltip>
            <TooltipTrigger asChild>
              <Info className="absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 text-amber-500" />
            </TooltipTrigger>
            <TooltipContent>
              Planificado: {series.prescribedWeight}kg
            </TooltipContent>
          </Tooltip>
        )}
      </div>

      {/* RPE input */}
      <Input
        type="number"
        min={1}
        max={10}
        value={series.rpe ?? ''}
        onChange={(e) => handleRpeChange(e.target.value)}
        placeholder="RPE"
      />

      {/* Skip button */}
      <Button variant="ghost" size="icon" onClick={handleSkipSeries}>
        <SkipForward className="h-4 w-4" />
      </Button>
    </div>
  )
}
```

Key features:
- Deviation highlighting: amber border when actual differs from prescribed
- Tooltip shows original prescribed value on hover
- Skip button per series
- Numeric inputs with validation
  </action>
  <verify>
    Both components export their functions
    `pnpm typecheck` passes
  </verify>
  <done>
    Exercise card shows all series with skip functionality
    Series input has deviation highlighting and tooltips
    All inputs update store state
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Session Summary Card</name>
  <files>apps/coach-web/src/features/workout-logs/components/session-summary-card.tsx</files>
  <action>
Create session-level inputs for RPE and notes:

```typescript
import { useLogData, useLogActions } from '@/stores/log-store'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Label } from '@/components/ui/label'

export function SessionSummaryCard() {
  const log = useLogData()
  const { updateSession } = useLogActions()

  if (!log) return null

  const handleRpeChange = (value: string) => {
    const numValue = value === '' ? null : parseInt(value, 10)
    if (value !== '' && (isNaN(numValue as number) || numValue < 1 || numValue > 10)) return
    updateSession({ sessionRpe: numValue })
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">Resumen de Sesion</CardTitle>
      </CardHeader>
      <CardContent className="grid gap-4 md:grid-cols-2">
        {/* Session RPE */}
        <div className="space-y-2">
          <Label htmlFor="session-rpe">RPE de la Sesion (1-10)</Label>
          <Input
            id="session-rpe"
            type="number"
            min={1}
            max={10}
            value={log.sessionRpe ?? ''}
            onChange={(e) => handleRpeChange(e.target.value)}
            placeholder="Dificultad general"
          />
          <p className="text-xs text-muted-foreground">
            Que tan dificil fue el entrenamiento en general
          </p>
        </div>

        {/* Session notes */}
        <div className="space-y-2">
          <Label htmlFor="session-notes">Notas de la Sesion</Label>
          <Textarea
            id="session-notes"
            value={log.sessionNotes ?? ''}
            onChange={(e) => updateSession({ sessionNotes: e.target.value || null })}
            placeholder="Fatiga, lesiones, estado de animo..."
            rows={3}
          />
        </div>
      </CardContent>
    </Card>
  )
}
```
  </action>
  <verify>
    Component exports SessionSummaryCard
    `pnpm typecheck` passes
  </verify>
  <done>
    Session summary shows RPE and notes inputs
    Updates go to log store
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
pnpm typecheck

# Start dev and manually test
pnpm dev:coach
# Navigate to session logging from dashboard
```
</verification>

<success_criteria>
1. Session logging route loads and initializes log from prescription
2. Exercises display with series inputs (reps, weight, RPE)
3. Deviation highlighting shows amber border when actual differs from plan
4. Tooltip shows prescribed value on hover
5. Skip buttons work for exercises and individual series
6. Session RPE and notes can be entered
7. Unsaved changes prompt before navigation
8. Guardar button saves log and navigates to history
</success_criteria>

<output>
After completion, create `.planning/phases/04-coach-workout-logging/04-09-SUMMARY.md`
</output>
