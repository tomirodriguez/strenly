---
phase: 04-coach-workout-logging
plan: 07
type: execute
wave: 4
depends_on: ["04-06"]
files_modified:
  - apps/coach-web/src/stores/log-store.ts
  - apps/coach-web/src/features/workout-logs/hooks/queries/use-workout-log.ts
  - apps/coach-web/src/features/workout-logs/hooks/queries/use-athlete-logs.ts
  - apps/coach-web/src/features/workout-logs/hooks/queries/use-pending-workouts.ts
  - apps/coach-web/src/features/workout-logs/hooks/mutations/use-create-log.ts
  - apps/coach-web/src/features/workout-logs/hooks/mutations/use-save-log.ts
  - apps/coach-web/src/features/workout-logs/hooks/mutations/use-delete-log.ts
autonomous: true

must_haves:
  truths:
    - "Zustand store manages client-side log editing state"
    - "Query hooks provide data fetching for logs"
    - "Mutation hooks handle create, save, delete operations"
    - "Cache invalidation on mutations keeps UI in sync"
  artifacts:
    - path: "apps/coach-web/src/stores/log-store.ts"
      provides: "Client-side log editing state"
      exports: ["useLogStore"]
      min_lines: 100
    - path: "apps/coach-web/src/features/workout-logs/hooks/mutations/use-save-log.ts"
      provides: "Save log mutation hook"
      exports: ["useSaveLog"]
  key_links:
    - from: "apps/coach-web/src/stores/log-store.ts"
      to: "WorkoutLogAggregate type"
      via: "import"
      pattern: "WorkoutLogAggregate"
    - from: "apps/coach-web/src/features/workout-logs/hooks/mutations/use-save-log.ts"
      to: "oRPC client"
      via: "mutation"
      pattern: "orpc\\.workoutLogs\\.save"
---

<objective>
Create the frontend state management (Zustand store) and API hooks for workout logging.

Purpose: The log store provides client-side editing with dirty tracking (same pattern as grid-store). Hooks wrap oRPC calls for data fetching and mutations.

Output: Complete frontend data layer for workout logging - store, query hooks, and mutation hooks.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-coach-workout-logging/04-CONTEXT.md
@.planning/phases/04-coach-workout-logging/04-RESEARCH.md

# Reference: Existing patterns
@apps/coach-web/src/stores/grid-store.ts
@apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Log Store (Zustand)</name>
  <skills>/orpc-query</skills>
  <files>apps/coach-web/src/stores/log-store.ts</files>
  <action>
Create the Zustand store for client-side log editing:

```typescript
import type {
  WorkoutLogAggregate,
  LoggedExerciseInput,
  LoggedSeriesInput,
} from '@strenly/contracts/workout-logs/workout-log'
import type { SaveLogInput } from '@strenly/contracts/workout-logs/save-log'
import { create } from 'zustand'
import { useShallow } from 'zustand/react/shallow'

/**
 * Log state interface
 */
interface LogState {
  // Log aggregate (source of truth for save operations)
  log: WorkoutLogAggregate | null

  // Dirty tracking
  isDirty: boolean
}

/**
 * Log actions interface
 */
interface LogActions {
  // Initialize store with log data
  initialize: (log: WorkoutLogAggregate) => void

  // Update a logged series (specific set within an exercise)
  updateSeries: (
    exerciseId: string,
    seriesIndex: number,
    data: Partial<LoggedSeriesInput>
  ) => void

  // Skip an entire exercise (marks all series as skipped)
  skipExercise: (exerciseId: string) => void

  // Unskip an exercise (restore series to not skipped)
  unskipExercise: (exerciseId: string) => void

  // Update exercise notes
  updateExerciseNotes: (exerciseId: string, notes: string | null) => void

  // Update session-level data (RPE, notes)
  updateSession: (data: { sessionRpe?: number | null; sessionNotes?: string | null }) => void

  // Get data formatted for save API call
  getLogForSave: () => SaveLogInput | null

  // Mark as saved (clear dirty flag)
  markSaved: () => void

  // Reset store (for cleanup on unmount)
  reset: () => void
}

type LogStore = LogState & LogActions

/**
 * Calculate status based on exercise states
 */
function calculateStatus(log: WorkoutLogAggregate): 'completed' | 'partial' | 'skipped' {
  if (log.exercises.length === 0) return 'partial'

  const allSkipped = log.exercises.every((e) => e.skipped)
  if (allSkipped) return 'skipped'

  const allCompleted = log.exercises.every(
    (e) => !e.skipped && e.series.every((s) => !s.skipped)
  )
  if (allCompleted) return 'completed'

  return 'partial'
}

/**
 * Deep clone helper
 */
function deepClone<T>(obj: T): T {
  return JSON.parse(JSON.stringify(obj))
}

/**
 * Zustand store for workout log editing
 */
export const useLogStore = create<LogStore>((set, get) => ({
  // Initial state
  log: null,
  isDirty: false,

  // Initialize with log data
  initialize: (log) => {
    set({
      log: deepClone(log),
      isDirty: false,
    })
  },

  // Update a specific series
  updateSeries: (exerciseId, seriesIndex, data) => {
    set((state) => {
      if (!state.log) return state

      const newLog = deepClone(state.log)
      const exercise = newLog.exercises.find((e) => e.id === exerciseId)
      if (exercise && exercise.series[seriesIndex]) {
        exercise.series[seriesIndex] = {
          ...exercise.series[seriesIndex],
          ...data,
        }
      }

      return { log: newLog, isDirty: true }
    })
  },

  // Skip exercise (and all its series)
  skipExercise: (exerciseId) => {
    set((state) => {
      if (!state.log) return state

      const newLog = deepClone(state.log)
      const exercise = newLog.exercises.find((e) => e.id === exerciseId)
      if (exercise) {
        exercise.skipped = true
        exercise.series = exercise.series.map((s) => ({ ...s, skipped: true }))
      }

      return { log: newLog, isDirty: true }
    })
  },

  // Unskip exercise
  unskipExercise: (exerciseId) => {
    set((state) => {
      if (!state.log) return state

      const newLog = deepClone(state.log)
      const exercise = newLog.exercises.find((e) => e.id === exerciseId)
      if (exercise) {
        exercise.skipped = false
        exercise.series = exercise.series.map((s) => ({ ...s, skipped: false }))
      }

      return { log: newLog, isDirty: true }
    })
  },

  // Update exercise notes
  updateExerciseNotes: (exerciseId, notes) => {
    set((state) => {
      if (!state.log) return state

      const newLog = deepClone(state.log)
      const exercise = newLog.exercises.find((e) => e.id === exerciseId)
      if (exercise) {
        exercise.notes = notes
      }

      return { log: newLog, isDirty: true }
    })
  },

  // Update session data
  updateSession: (data) => {
    set((state) => {
      if (!state.log) return state

      const newLog = deepClone(state.log)
      if (data.sessionRpe !== undefined) {
        newLog.sessionRpe = data.sessionRpe
      }
      if (data.sessionNotes !== undefined) {
        newLog.sessionNotes = data.sessionNotes
      }

      return { log: newLog, isDirty: true }
    })
  },

  // Get data for save
  getLogForSave: () => {
    const state = get()
    if (!state.log) return null

    return {
      id: state.log.id,
      athleteId: state.log.athleteId,
      programId: state.log.programId,
      sessionId: state.log.sessionId,
      weekId: state.log.weekId,
      logDate: state.log.logDate,
      sessionRpe: state.log.sessionRpe,
      sessionNotes: state.log.sessionNotes,
      exercises: state.log.exercises,
    }
  },

  // Mark saved
  markSaved: () => set({ isDirty: false }),

  // Reset
  reset: () => set({ log: null, isDirty: false }),
}))

/**
 * Selector hooks
 */
export const useLogData = () => useLogStore((state) => state.log)
export const useLogIsDirty = () => useLogStore((state) => state.isDirty)
export const useLogActions = () =>
  useLogStore(
    useShallow((state) => ({
      initialize: state.initialize,
      updateSeries: state.updateSeries,
      skipExercise: state.skipExercise,
      unskipExercise: state.unskipExercise,
      updateExerciseNotes: state.updateExerciseNotes,
      updateSession: state.updateSession,
      getLogForSave: state.getLogForSave,
      markSaved: state.markSaved,
      reset: state.reset,
    }))
  )
```
  </action>
  <verify>
    `pnpm typecheck` passes
    Store exports useLogStore and selector hooks
  </verify>
  <done>
    Log store provides client-side editing state
    Supports series updates, exercise skip, session data
    Dirty tracking for navigation guard
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Query and Mutation Hooks</name>
  <skills>/orpc-query</skills>
  <files>
    apps/coach-web/src/features/workout-logs/hooks/queries/use-workout-log.ts
    apps/coach-web/src/features/workout-logs/hooks/queries/use-athlete-logs.ts
    apps/coach-web/src/features/workout-logs/hooks/queries/use-pending-workouts.ts
    apps/coach-web/src/features/workout-logs/hooks/mutations/use-create-log.ts
    apps/coach-web/src/features/workout-logs/hooks/mutations/use-save-log.ts
    apps/coach-web/src/features/workout-logs/hooks/mutations/use-delete-log.ts
  </files>
  <action>
Create the API hooks following existing patterns:

**use-workout-log.ts:**
```typescript
import { useQuery } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'

export function useWorkoutLog(logId: string | undefined) {
  return useQuery({
    ...orpc.workoutLogs.get.queryOptions({ input: { logId: logId ?? '' } }),
    enabled: !!logId,
  })
}
```

**use-athlete-logs.ts:**
```typescript
import { useQuery } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'
import type { ListAthleteLogsInput } from '@strenly/contracts/workout-logs/list-logs'

export function useAthleteLogs(input: ListAthleteLogsInput) {
  return useQuery({
    ...orpc.workoutLogs.listByAthlete.queryOptions({ input }),
    enabled: !!input.athleteId,
  })
}
```

**use-pending-workouts.ts:**
```typescript
import { useQuery } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'
import type { z } from 'zod'
import type { listPendingWorkoutsInputSchema } from '@strenly/contracts/workout-logs/list-logs'

type ListPendingInput = z.infer<typeof listPendingWorkoutsInputSchema>

export function usePendingWorkouts(input?: ListPendingInput) {
  return useQuery({
    ...orpc.workoutLogs.listPending.queryOptions({ input: input ?? {} }),
  })
}
```

**use-create-log.ts:**
```typescript
import { useMutation } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'

export function useCreateLog() {
  return useMutation({
    ...orpc.workoutLogs.create.mutationOptions(),
  })
}
```

**use-save-log.ts:**
```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'
import { useLogStore } from '@/stores/log-store'

export function useSaveLog() {
  const queryClient = useQueryClient()
  const markSaved = useLogStore((state) => state.markSaved)

  return useMutation({
    ...orpc.workoutLogs.save.mutationOptions(),
    onSuccess: (data) => {
      markSaved()
      // Invalidate relevant queries
      queryClient.invalidateQueries({ queryKey: orpc.workoutLogs.key() })
    },
  })
}
```

**use-delete-log.ts:**
```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'
import { toast } from 'sonner'

export function useDeleteLog() {
  const queryClient = useQueryClient()

  return useMutation({
    ...orpc.workoutLogs.delete.mutationOptions(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: orpc.workoutLogs.key() })
      toast.success('Registro eliminado')
    },
    onError: (error) => {
      toast.error('Error al eliminar registro')
    },
  })
}
```
  </action>
  <verify>
    `pnpm typecheck` passes
    All hooks export their functions
  </verify>
  <done>
    Query hooks: useWorkoutLog, useAthleteLogs, usePendingWorkouts
    Mutation hooks: useCreateLog, useSaveLog, useDeleteLog
    Cache invalidation on mutations
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
pnpm typecheck

# Verify exports
grep "export function" apps/coach-web/src/features/workout-logs/hooks/**/*.ts
grep "export const" apps/coach-web/src/stores/log-store.ts
```
</verification>

<success_criteria>
1. Log store manages client-side editing state
2. Store supports series updates, exercise skip, session RPE/notes
3. Query hooks fetch workout log data
4. Mutation hooks handle create, save, delete
5. Cache invalidation keeps UI in sync with server
</success_criteria>

<output>
After completion, create `.planning/phases/04-coach-workout-logging/04-07-SUMMARY.md`
</output>
