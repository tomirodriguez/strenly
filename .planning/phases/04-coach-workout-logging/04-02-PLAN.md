---
phase: 04-coach-workout-logging
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/ports/workout-log-repository.port.ts
autonomous: true

must_haves:
  truths:
    - "Repository port defines all CRUD operations for workout logs"
    - "All methods receive OrganizationContext for multi-tenancy"
    - "Error types are discriminated unions for type-safe handling"
  artifacts:
    - path: "packages/core/src/ports/workout-log-repository.port.ts"
      provides: "WorkoutLogRepository interface"
      exports: ["WorkoutLogRepository", "WorkoutLogRepositoryError"]
      min_lines: 50
  key_links:
    - from: "packages/core/src/ports/workout-log-repository.port.ts"
      to: "OrganizationContext"
      via: "import"
      pattern: "import.*OrganizationContext"
    - from: "packages/core/src/ports/workout-log-repository.port.ts"
      to: "WorkoutLog type"
      via: "import"
      pattern: "import.*WorkoutLog"
---

<objective>
Define the WorkoutLogRepository port (interface) that the backend repository will implement.

Purpose: Clean architecture requires ports in core package that define contracts for infrastructure implementations. This port specifies all operations needed for workout log persistence.

Output: WorkoutLogRepository interface with full CRUD operations, typed errors, and multi-tenancy support.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-coach-workout-logging/04-RESEARCH.md

# Reference: Existing repository ports
@packages/core/src/ports/program-repository.port.ts
@packages/core/src/ports/athlete-repository.port.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkoutLogRepository Port</name>
  <skills>/port</skills>
  <files>packages/core/src/ports/workout-log-repository.port.ts</files>
  <action>
Create the WorkoutLogRepository port following existing patterns:

```typescript
import type { ResultAsync } from 'neverthrow'
import type { WorkoutLog } from '../domain/entities/workout-log/types'
import type { OrganizationContext } from '../types/organization-context'

// ============================================================================
// Error Types
// ============================================================================

export type WorkoutLogRepositoryError =
  | { type: 'NOT_FOUND'; message: string }
  | { type: 'CONFLICT'; message: string }  // Duplicate log for session/week
  | { type: 'DATABASE_ERROR'; message: string }

// ============================================================================
// Filter Types
// ============================================================================

export type WorkoutLogFilters = {
  athleteId?: string
  programId?: string
  status?: 'completed' | 'partial' | 'skipped'
  fromDate?: Date
  toDate?: Date
  limit?: number
  offset?: number
}

// ============================================================================
// Repository Port
// ============================================================================

export interface WorkoutLogRepository {
  /**
   * Save a workout log (insert or replace)
   * Uses DELETE + INSERT for simplicity (same as program aggregate pattern)
   */
  save(ctx: OrganizationContext, log: WorkoutLog): ResultAsync<void, WorkoutLogRepositoryError>

  /**
   * Find a workout log by ID
   * Returns full aggregate with exercises and series
   */
  findById(ctx: OrganizationContext, logId: string): ResultAsync<WorkoutLog | null, WorkoutLogRepositoryError>

  /**
   * Find log by athlete + session + week combination
   * Used to check if log already exists before creating
   */
  findByAthleteSessionWeek(
    ctx: OrganizationContext,
    athleteId: string,
    sessionId: string,
    weekId: string
  ): ResultAsync<WorkoutLog | null, WorkoutLogRepositoryError>

  /**
   * List logs for an athlete with pagination
   * Returns items sorted by logDate descending (most recent first)
   */
  listByAthlete(
    ctx: OrganizationContext,
    athleteId: string,
    filters?: Omit<WorkoutLogFilters, 'athleteId'>
  ): ResultAsync<{ items: WorkoutLog[]; totalCount: number }, WorkoutLogRepositoryError>

  /**
   * List pending workouts for all athletes in organization
   * Returns sessions that have no log yet for current week
   * Used for logging dashboard
   */
  listPendingWorkouts(
    ctx: OrganizationContext,
    filters?: { limit?: number; offset?: number }
  ): ResultAsync<{
    items: Array<{
      athleteId: string
      athleteName: string
      programId: string
      programName: string
      sessionId: string
      sessionName: string
      weekId: string
      weekName: string
    }>
    totalCount: number
  }, WorkoutLogRepositoryError>

  /**
   * Delete a workout log by ID
   * Cascades to logged_exercises
   */
  delete(ctx: OrganizationContext, logId: string): ResultAsync<void, WorkoutLogRepositoryError>
}
```

Key design decisions:
- `save()` uses DELETE + INSERT (aggregate pattern, not upsert per field)
- `findByAthleteSessionWeek()` for checking existence before create
- `listPendingWorkouts()` for dashboard (complex join query)
- All methods receive OrganizationContext for multi-tenancy
- Returns `WorkoutLog | null` for find methods (not throwing on not found)
  </action>
  <verify>
    `pnpm typecheck` passes
    File exports WorkoutLogRepository and WorkoutLogRepositoryError
  </verify>
  <done>
    WorkoutLogRepository port exists with all required methods
    Error types defined as discriminated union
    All methods receive OrganizationContext
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
pnpm typecheck

# Verify exports
grep -E "export (type|interface)" packages/core/src/ports/workout-log-repository.port.ts
```
</verification>

<success_criteria>
1. WorkoutLogRepository interface defines save, findById, findByAthleteSessionWeek, listByAthlete, listPendingWorkouts, delete
2. All methods use ResultAsync with typed errors
3. All methods receive OrganizationContext as first parameter
4. Error types are discriminated union with NOT_FOUND, CONFLICT, DATABASE_ERROR
</success_criteria>

<output>
After completion, create `.planning/phases/04-coach-workout-logging/04-02-SUMMARY.md`
</output>
