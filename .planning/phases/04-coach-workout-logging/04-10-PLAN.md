---
phase: 04-coach-workout-logging
plan: 10
type: execute
wave: 6
depends_on: ["04-08", "04-09"]
files_modified:
  - apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/logs/index.tsx
  - apps/coach-web/src/features/workout-logs/views/log-history-view.tsx
  - apps/coach-web/src/features/workout-logs/components/log-history-table.tsx
  - apps/coach-web/src/features/workout-logs/components/log-detail-modal.tsx
autonomous: false

must_haves:
  truths:
    - "Coach can view past workout logs for an athlete"
    - "Log history shows date, session, and status"
    - "Modal displays full log details"
    - "Coach can navigate to edit a log"
    - "Coach can delete logs"
  artifacts:
    - path: "apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/logs/index.tsx"
      provides: "Log history route"
      min_lines: 15
    - path: "apps/coach-web/src/features/workout-logs/views/log-history-view.tsx"
      provides: "Log history view component"
      exports: ["LogHistoryView"]
    - path: "apps/coach-web/src/features/workout-logs/components/log-history-table.tsx"
      provides: "Log history table"
      exports: ["LogHistoryTable"]
    - path: "apps/coach-web/src/features/workout-logs/components/log-detail-modal.tsx"
      provides: "Log detail modal"
      exports: ["LogDetailModal"]
  key_links:
    - from: "apps/coach-web/src/features/workout-logs/views/log-history-view.tsx"
      to: "useAthleteLogs hook"
      via: "data fetching"
      pattern: "useAthleteLogs"
---

<objective>
Create the log history view and final UAT verification checkpoint.

Purpose: Coaches need to view past workout logs for any athlete, see details, and edit or delete logs. This completes the workout logging feature.

Output: Log history page with table, detail modal, edit/delete functionality, and human verification checkpoint.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-coach-workout-logging/04-CONTEXT.md

# From prior plans
@apps/coach-web/src/features/workout-logs/hooks/queries/use-athlete-logs.ts
@apps/coach-web/src/features/workout-logs/hooks/mutations/use-delete-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Log History Route and View</name>
  <files>
    apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/logs/index.tsx
    apps/coach-web/src/features/workout-logs/views/log-history-view.tsx
  </files>
  <action>
**Route (index.tsx):**
```typescript
import { createFileRoute } from '@tanstack/react-router'
import { LogHistoryView } from '@/features/workout-logs/views/log-history-view'

export const Route = createFileRoute(
  '/_authenticated/$orgSlug/athletes/$athleteId/logs/'
)({
  component: LogHistoryPage,
})

function LogHistoryPage() {
  const { athleteId } = Route.useParams()
  return <LogHistoryView athleteId={athleteId} />
}
```

**View (log-history-view.tsx):**
```typescript
import { useState } from 'react'
import { useParams } from '@tanstack/react-router'
import { useAthleteLogs } from '../hooks/queries/use-athlete-logs'
import { LogHistoryTable } from '../components/log-history-table'
import { LogDetailModal } from '../components/log-detail-modal'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import { History } from 'lucide-react'
import type { WorkoutLogAggregate } from '@strenly/contracts/workout-logs/workout-log'

interface LogHistoryViewProps {
  athleteId: string
}

export function LogHistoryView({ athleteId }: LogHistoryViewProps) {
  const [selectedLog, setSelectedLog] = useState<WorkoutLogAggregate | null>(null)
  const [page, setPage] = useState(0)
  const pageSize = 20

  const { data, isLoading, error } = useAthleteLogs({
    athleteId,
    limit: pageSize,
    offset: page * pageSize,
  })

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold tracking-tight">Historial de Entrenamientos</h1>
        <p className="text-muted-foreground">
          Registros de entrenamientos pasados
        </p>
      </div>

      {/* History table */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <History className="h-5 w-5" />
            Registros
          </CardTitle>
          <CardDescription>
            {data?.totalCount ?? 0} registros en total
          </CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="space-y-3">
              <Skeleton className="h-10 w-full" />
              <Skeleton className="h-10 w-full" />
              <Skeleton className="h-10 w-full" />
            </div>
          ) : error ? (
            <div className="text-center py-8 text-muted-foreground">
              Error al cargar historial
            </div>
          ) : data && data.items.length > 0 ? (
            <>
              <LogHistoryTable
                items={data.items}
                onViewLog={setSelectedLog}
              />
              {/* Pagination */}
              {data.totalCount > pageSize && (
                <div className="flex justify-center gap-2 mt-4">
                  <button
                    onClick={() => setPage((p) => Math.max(0, p - 1))}
                    disabled={page === 0}
                    className="px-3 py-1 border rounded disabled:opacity-50"
                  >
                    Anterior
                  </button>
                  <span className="px-3 py-1">
                    Pagina {page + 1} de {Math.ceil(data.totalCount / pageSize)}
                  </span>
                  <button
                    onClick={() => setPage((p) => p + 1)}
                    disabled={(page + 1) * pageSize >= data.totalCount}
                    className="px-3 py-1 border rounded disabled:opacity-50"
                  >
                    Siguiente
                  </button>
                </div>
              )}
            </>
          ) : (
            <div className="text-center py-8 text-muted-foreground">
              <History className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>No hay registros</p>
              <p className="text-sm">
                Los entrenamientos registrados apareceran aqui
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Detail modal */}
      <LogDetailModal
        log={selectedLog}
        onClose={() => setSelectedLog(null)}
      />
    </div>
  )
}
```
  </action>
  <verify>
    Route file exports Route
    View component renders
    `pnpm typecheck` passes
  </verify>
  <done>
    Log history route at /athletes/$athleteId/logs
    View shows paginated history with loading/empty states
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Log History Table and Detail Modal</name>
  <files>
    apps/coach-web/src/features/workout-logs/components/log-history-table.tsx
    apps/coach-web/src/features/workout-logs/components/log-detail-modal.tsx
  </files>
  <action>
**log-history-table.tsx:**
```typescript
import { Link, useParams } from '@tanstack/react-router'
import type { WorkoutLogAggregate } from '@strenly/contracts/workout-logs/workout-log'
import { useDeleteLog } from '../hooks/mutations/use-delete-log'
import { Button } from '@/components/ui/button'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Eye, Edit, Trash, MoreVertical } from 'lucide-react'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'

interface LogHistoryTableProps {
  items: WorkoutLogAggregate[]
  onViewLog: (log: WorkoutLogAggregate) => void
}

const statusLabels = {
  completed: { label: 'Completado', variant: 'default' as const },
  partial: { label: 'Parcial', variant: 'secondary' as const },
  skipped: { label: 'Saltado', variant: 'outline' as const },
}

export function LogHistoryTable({ items, onViewLog }: LogHistoryTableProps) {
  const { orgSlug, athleteId } = useParams({ from: '/_authenticated/$orgSlug/athletes/$athleteId/logs/' })
  const deleteLogMutation = useDeleteLog()

  const handleDelete = (logId: string) => {
    if (confirm('Estas seguro de eliminar este registro?')) {
      deleteLogMutation.mutate({ logId })
    }
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Fecha</TableHead>
          <TableHead>Sesion</TableHead>
          <TableHead>Estado</TableHead>
          <TableHead>RPE</TableHead>
          <TableHead className="w-[80px]"></TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {items.map((log) => {
          const status = statusLabels[log.status]
          return (
            <TableRow key={log.id}>
              <TableCell>
                {format(new Date(log.logDate), 'PPP', { locale: es })}
              </TableCell>
              <TableCell>
                {/* TODO: Get session name */}
                Sesion
              </TableCell>
              <TableCell>
                <Badge variant={status.variant}>{status.label}</Badge>
              </TableCell>
              <TableCell>
                {log.sessionRpe ?? '-'}
              </TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreVertical className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem onClick={() => onViewLog(log)}>
                      <Eye className="h-4 w-4 mr-2" />
                      Ver detalles
                    </DropdownMenuItem>
                    <DropdownMenuItem asChild>
                      <Link
                        to="/$orgSlug/athletes/$athleteId/log/$sessionId"
                        params={{
                          orgSlug,
                          athleteId,
                          sessionId: log.sessionId,
                        }}
                        search={{
                          programId: log.programId,
                          weekId: log.weekId,
                          logId: log.id,
                        }}
                      >
                        <Edit className="h-4 w-4 mr-2" />
                        Editar
                      </Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      onClick={() => handleDelete(log.id)}
                      className="text-destructive"
                    >
                      <Trash className="h-4 w-4 mr-2" />
                      Eliminar
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          )
        })}
      </TableBody>
    </Table>
  )
}
```

**log-detail-modal.tsx:**
```typescript
import type { WorkoutLogAggregate } from '@strenly/contracts/workout-logs/workout-log'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Badge } from '@/components/ui/badge'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'

interface LogDetailModalProps {
  log: WorkoutLogAggregate | null
  onClose: () => void
}

export function LogDetailModal({ log, onClose }: LogDetailModalProps) {
  if (!log) return null

  return (
    <Dialog open={!!log} onOpenChange={(open) => !open && onClose()}>
      <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Detalle del Registro</DialogTitle>
        </DialogHeader>

        <div className="space-y-6">
          {/* Summary */}
          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span className="text-muted-foreground">Fecha:</span>{' '}
              {format(new Date(log.logDate), 'PPP', { locale: es })}
            </div>
            <div>
              <span className="text-muted-foreground">Estado:</span>{' '}
              <Badge variant={log.status === 'completed' ? 'default' : 'secondary'}>
                {log.status}
              </Badge>
            </div>
            {log.sessionRpe && (
              <div>
                <span className="text-muted-foreground">RPE Sesion:</span> {log.sessionRpe}/10
              </div>
            )}
            {log.sessionNotes && (
              <div className="col-span-2">
                <span className="text-muted-foreground">Notas:</span>{' '}
                {log.sessionNotes}
              </div>
            )}
          </div>

          {/* Exercises */}
          <div className="space-y-4">
            <h3 className="font-medium">Ejercicios</h3>
            {log.exercises.map((exercise) => (
              <div
                key={exercise.id}
                className={exercise.skipped ? 'opacity-50' : ''}
              >
                <div className="flex items-center gap-2 mb-2">
                  <span className="font-medium">Ejercicio</span>
                  {exercise.skipped && (
                    <Badge variant="outline">Saltado</Badge>
                  )}
                </div>
                {!exercise.skipped && (
                  <div className="pl-4 space-y-1">
                    {exercise.series.map((series, idx) => (
                      <div key={idx} className="text-sm grid grid-cols-4 gap-2">
                        <span>Serie {idx + 1}</span>
                        <span>
                          {series.repsPerformed ?? '-'} reps
                          {series.repsPerformed !== series.prescribedReps && (
                            <span className="text-amber-500 ml-1">
                              (plan: {series.prescribedReps})
                            </span>
                          )}
                        </span>
                        <span>
                          {series.weightUsed ?? '-'}kg
                          {series.weightUsed !== series.prescribedWeight && (
                            <span className="text-amber-500 ml-1">
                              (plan: {series.prescribedWeight}kg)
                            </span>
                          )}
                        </span>
                        <span>RPE: {series.rpe ?? '-'}</span>
                      </div>
                    ))}
                  </div>
                )}
                {exercise.notes && (
                  <p className="text-sm text-muted-foreground pl-4 mt-1">
                    {exercise.notes}
                  </p>
                )}
              </div>
            ))}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```
  </action>
  <verify>
    Both components export their functions
    `pnpm typecheck` passes
  </verify>
  <done>
    History table shows logs with actions (view, edit, delete)
    Detail modal shows full log information with deviation display
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Link to Log History from Athlete Profile</name>
  <files>apps/coach-web/src/routes/_authenticated/$orgSlug/athletes/$athleteId/index.tsx</files>
  <action>
Add a link or button to access the log history from the athlete profile page.

If the athlete profile page exists, add:
1. A "Ver Historial de Entrenamientos" link/button in the athlete detail view
2. Link to `/$orgSlug/athletes/$athleteId/logs`

If the athlete profile page doesn't exist yet, create a minimal version that links to logs.
  </action>
  <verify>
    Athlete profile has link to log history
    Link navigates correctly
  </verify>
  <done>
    Athlete profile links to log history
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete workout logging feature including:
  - Logging dashboard showing pending workouts
  - Session logging view with pre-fill and deviation display
  - Log history view with detail modal
  - Edit and delete functionality</what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev`
2. Log in and navigate to an organization
3. Go to "Registro" in sidebar - see pending workouts dashboard
4. Click "Registrar" on a pending workout
5. Verify pre-filled values from prescription
6. Modify some values (reps, weight)
7. Verify amber border appears on changed fields
8. Add session RPE and notes
9. Click "Guardar" - verify save success
10. Navigate to athlete profile > log history
11. View the log details in modal
12. Edit the log
13. Delete a log
14. Verify all success criteria are met:
    - Coach can view athlete's assigned program workouts
    - Coach can log execution (sets, reps, weight)
    - Plan vs log separation is maintained
    - Coach can modify logged values and add comments
    - Coach can view past logs
    - Pre-fill from prescription works
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
pnpm typecheck

# Manual testing
pnpm dev
```
</verification>

<success_criteria>
1. Log history route exists at /athletes/$athleteId/logs
2. History table shows date, session, status, RPE
3. View action opens detail modal
4. Edit action navigates to session logging with existing log
5. Delete action removes log with confirmation
6. Athlete profile links to log history
7. Complete end-to-end flow works: dashboard -> log -> history -> edit
</success_criteria>

<output>
After completion, create `.planning/phases/04-coach-workout-logging/04-10-SUMMARY.md`
</output>
