---
phase: 04-coach-workout-logging
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema/workout-logs.ts
  - packages/database/src/schema/logged-exercises.ts
  - packages/database/src/schema/index.ts
  - packages/core/src/domain/entities/workout-log/types.ts
  - packages/core/src/domain/entities/workout-log/logged-series.ts
  - packages/core/src/domain/entities/workout-log/logged-exercise.ts
  - packages/core/src/domain/entities/workout-log/workout-log.ts
  - packages/core/src/domain/entities/workout-log/workout-log.test.ts
autonomous: true

must_haves:
  truths:
    - "WorkoutLog aggregate can be created with valid data"
    - "LoggedSeries captures actual reps, weight, RPE and prescribed snapshot"
    - "LoggedExercise contains ordered series and can be marked skipped"
    - "Validation rejects invalid RPE values (must be 1-10)"
    - "Database schema supports one log per athlete per session per week"
  artifacts:
    - path: "packages/database/src/schema/workout-logs.ts"
      provides: "workout_logs table with unique constraint"
      contains: "workout_logs"
    - path: "packages/database/src/schema/logged-exercises.ts"
      provides: "logged_exercises table with JSONB series"
      contains: "logged_exercises"
    - path: "packages/core/src/domain/entities/workout-log/types.ts"
      provides: "LogStatus, LoggedSeries, LoggedExercise, WorkoutLog types"
      exports: ["LOG_STATUSES", "LogStatus", "LoggedSeries", "LoggedExercise", "WorkoutLog"]
    - path: "packages/core/src/domain/entities/workout-log/workout-log.ts"
      provides: "createWorkoutLog factory function"
      exports: ["createWorkoutLog", "reconstituteWorkoutLog"]
    - path: "packages/core/src/domain/entities/workout-log/workout-log.test.ts"
      provides: "90%+ test coverage"
      min_lines: 100
  key_links:
    - from: "packages/database/src/schema/logged-exercises.ts"
      to: "workout-logs"
      via: "foreign key logId"
      pattern: "references.*workoutLogs"
    - from: "packages/core/src/domain/entities/workout-log/workout-log.ts"
      to: "types.ts"
      via: "import types"
      pattern: "import.*types"
---

<objective>
Create the WorkoutLog aggregate domain entity and database schema for tracking athlete workout execution.

Purpose: Establish the core domain model for workout logging - separate from the Program aggregate (plan vs log separation). The WorkoutLog captures what athletes actually performed versus what was prescribed.

Output: Database schema (workout_logs, logged_exercises) and domain entity with TDD tests achieving 90%+ coverage.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-coach-workout-logging/04-CONTEXT.md
@.planning/phases/04-coach-workout-logging/04-RESEARCH.md

# Reference: Existing Program aggregate pattern
@packages/core/src/domain/entities/program/types.ts
@packages/core/src/domain/entities/program/program.ts
@packages/database/src/schema/programs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Schema for Workout Logs</name>
  <skills>/repository</skills>
  <files>
    packages/database/src/schema/workout-logs.ts
    packages/database/src/schema/logged-exercises.ts
    packages/database/src/schema/index.ts
  </files>
  <action>
Create two new schema files for workout logging:

**workout-logs.ts:**
- Create `logStatusEnum` pgEnum with values: 'completed', 'partial', 'skipped'
- Create `workoutLogs` table:
  - id: text('id').primaryKey() - prefixed 'log-'
  - organizationId: text - FK to organizations.id, cascade delete
  - athleteId: text - FK to athletes.id, cascade delete
  - programId: text - FK to programs.id, cascade delete
  - sessionId: text - reference to program session (not FK, program structure may change)
  - weekId: text - reference to program week (not FK)
  - logDate: timestamp - when the workout occurred (user-editable)
  - status: logStatusEnum, default 'partial'
  - sessionRpe: integer - 1-10 scale, nullable
  - sessionNotes: text - nullable
  - createdAt, updatedAt timestamps
- Add indexes on organizationId, athleteId, programId
- Add unique constraint on (athleteId, sessionId, weekId) - one log per session per week

**logged-exercises.ts:**
- Define LoggedSeriesData interface for JSONB typing
- Create `loggedExercises` table:
  - id: text('id').primaryKey() - prefixed 'lex-'
  - logId: text - FK to workoutLogs.id, cascade delete
  - exerciseId: text - FK to exercises.id, restrict delete
  - groupItemId: text - reference to program group item (for ordering context)
  - orderIndex: integer
  - notes: text - nullable
  - skipped: boolean, default false
  - series: jsonb.$type<LoggedSeriesData[]>()
  - createdAt, updatedAt timestamps
- Add indexes on logId, exerciseId

Export both from schema/index.ts.

Run `pnpm db:push` to apply schema.
  </action>
  <verify>
    `pnpm db:push` succeeds without errors
    Tables visible in `pnpm db:studio`
  </verify>
  <done>
    workout_logs and logged_exercises tables exist with correct columns, indexes, and constraints
  </done>
</task>

<task type="auto">
  <name>Task 2: WorkoutLog Domain Entity with TDD</name>
  <skills>/domain</skills>
  <files>
    packages/core/src/domain/entities/workout-log/types.ts
    packages/core/src/domain/entities/workout-log/logged-series.ts
    packages/core/src/domain/entities/workout-log/logged-exercise.ts
    packages/core/src/domain/entities/workout-log/workout-log.ts
    packages/core/src/domain/entities/workout-log/workout-log.test.ts
  </files>
  <action>
Create WorkoutLog aggregate using TDD (write tests first, then implement):

**types.ts:**
```typescript
export const LOG_STATUSES = ['completed', 'partial', 'skipped'] as const
export type LogStatus = (typeof LOG_STATUSES)[number]

export type LoggedSeries = {
  readonly orderIndex: number
  readonly repsPerformed: number | null
  readonly weightUsed: number | null      // Always in kg
  readonly rpe: number | null             // 1-10 scale
  readonly skipped: boolean
  // Snapshot of prescription for deviation display
  readonly prescribedReps: number | null
  readonly prescribedWeight: number | null
}

export type LoggedExercise = {
  readonly id: string
  readonly exerciseId: string
  readonly groupItemId: string            // Reference to program group item
  readonly orderIndex: number
  readonly notes: string | null
  readonly skipped: boolean
  readonly series: ReadonlyArray<LoggedSeries>
}

export type WorkoutLog = {
  readonly id: string
  readonly organizationId: string
  readonly athleteId: string
  readonly programId: string
  readonly sessionId: string
  readonly weekId: string
  readonly logDate: Date
  readonly status: LogStatus
  readonly sessionRpe: number | null
  readonly sessionNotes: string | null
  readonly exercises: ReadonlyArray<LoggedExercise>
  readonly createdAt: Date
  readonly updatedAt: Date
}

// Input types for factory function
export type LoggedSeriesInput = { ... }
export type LoggedExerciseInput = { ... }
export type CreateWorkoutLogInput = { ... }

// Error types with discriminated union
export type WorkoutLogError =
  | { type: 'ATHLETE_ID_REQUIRED'; message: string }
  | { type: 'PROGRAM_ID_REQUIRED'; message: string }
  | { type: 'SESSION_ID_REQUIRED'; message: string }
  | { type: 'WEEK_ID_REQUIRED'; message: string }
  | { type: 'LOG_DATE_REQUIRED'; message: string }
  | { type: 'INVALID_RPE'; message: string; context: string }
  | { type: 'EXERCISE_ID_REQUIRED'; message: string; exerciseIndex: number }
  | { type: 'SERIES_INVALID_ORDER'; message: string; exerciseIndex: number; seriesIndex: number }
```

**logged-series.ts:**
- validateLoggedSeries(input, orderIndex) - validates RPE bounds (1-10 if present)

**logged-exercise.ts:**
- validateLoggedExercise(input, exerciseIndex) - validates exerciseId required, collects series

**workout-log.ts:**
- createWorkoutLog(input): Result<WorkoutLog, WorkoutLogError> - validates entire hierarchy
- reconstituteWorkoutLog(props): WorkoutLog - for DB loads without re-validation

**TDD Tests (workout-log.test.ts):**
Write tests FIRST covering:
1. Valid log creation with exercises and series
2. Empty exercises array allowed (can create before filling in)
3. athleteId required
4. programId required
5. sessionId required
6. weekId required
7. logDate required
8. RPE validation (1-10 range)
9. sessionRpe validation (1-10 range)
10. exerciseId required in each exercise
11. skipped exercise has all series marked skipped
12. reconstitute function works without validation

Target 90%+ coverage.
  </action>
  <verify>
    `pnpm test --filter=@strenly/core -- --coverage packages/core/src/domain/entities/workout-log/`
    Coverage >= 90%
    All tests pass
  </verify>
  <done>
    WorkoutLog aggregate exists with createWorkoutLog/reconstituteWorkoutLog factories
    90%+ test coverage on workout-log domain
    Types exported for use by repository and contracts
  </done>
</task>

</tasks>

<verification>
```bash
# Database schema applied
pnpm db:push

# Domain tests pass with coverage
cd packages/core && pnpm test -- --coverage src/domain/entities/workout-log/

# TypeScript compiles
pnpm typecheck
```
</verification>

<success_criteria>
1. workout_logs and logged_exercises tables exist in database
2. WorkoutLog aggregate validates input and returns Result<WorkoutLog, WorkoutLogError>
3. LoggedSeries stores both actual (repsPerformed, weightUsed, rpe) and prescribed snapshot
4. Unique constraint enforces one log per athlete per session per week
5. 90%+ test coverage on domain entity
</success_criteria>

<output>
After completion, create `.planning/phases/04-coach-workout-logging/04-01-SUMMARY.md`
</output>
