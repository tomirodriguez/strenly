---
phase: 01-foundation-multi-tenancy
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - packages/contracts/src/auth/sign-up.ts
  - packages/contracts/src/auth/sign-in.ts
  - packages/contracts/src/auth/session.ts
  - packages/contracts/src/auth/password-reset.ts
  - packages/backend/src/procedures/auth/sign-up.ts
  - packages/backend/src/procedures/auth/sign-in.ts
  - packages/backend/src/procedures/auth/session.ts
  - packages/backend/src/procedures/auth/password-reset.ts
  - packages/backend/src/procedures/auth/index.ts
  - packages/backend/src/procedures/router.ts
autonomous: false
user_setup:
  - service: email
    why: "Password reset emails"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
    dashboard_config:
      - task: "Verify sending domain or use test domain"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "User can create account with email and password via /rpc/auth.signUp"
    - "User can sign in with email and password via /rpc/auth.signIn"
    - "User can sign in with Google OAuth via /api/auth/sign-in/google"
    - "User can get current session via /rpc/auth.session"
    - "User can log out via /rpc/auth.signOut"
    - "User can request password reset via /rpc/auth.requestPasswordReset"
  artifacts:
    - path: "packages/contracts/src/auth/sign-up.ts"
      provides: "Sign up input/output schemas"
      exports: ["signUpInputSchema", "signUpOutputSchema"]
    - path: "packages/backend/src/procedures/auth/sign-up.ts"
      provides: "Sign up procedure"
      exports: ["signUp"]
    - path: "packages/backend/src/procedures/auth/index.ts"
      provides: "Auth router aggregation"
      exports: ["authRouter"]
  key_links:
    - from: "packages/backend/src/procedures/auth/sign-up.ts"
      to: "Better-Auth signUp.email"
      via: "auth.api.signUpEmail"
      pattern: "auth\\.api\\.signUpEmail"
    - from: "packages/backend/src/procedures/auth/sign-in.ts"
      to: "Better-Auth signIn.email"
      via: "auth.api.signInEmail"
      pattern: "auth\\.api\\.signInEmail"
---

<objective>
Implement user authentication flows including email/password sign up, sign in, Google OAuth, session management, logout, and password reset.

Purpose: Enables users to create accounts and authenticate. Core requirement for all subsequent features.
Output: Complete authentication API covering AUTH-01 through AUTH-05 requirements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-multi-tenancy/01-RESEARCH.md
@.planning/phases/01-foundation-multi-tenancy/01-01-SUMMARY.md
@.planning/phases/01-foundation-multi-tenancy/01-02-SUMMARY.md
@.claude/skills/procedure/SKILL.md
@.claude/skills/contracts/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Auth Contracts and Sign Up/Sign In Procedures</name>
  <files>
    packages/contracts/src/auth/sign-up.ts
    packages/contracts/src/auth/sign-in.ts
    packages/contracts/src/auth/session.ts
    packages/backend/src/procedures/auth/sign-up.ts
    packages/backend/src/procedures/auth/sign-in.ts
    packages/backend/src/procedures/auth/session.ts
  </files>
  <action>
Create the authentication contracts and procedures:

1. **packages/contracts/src/auth/sign-up.ts** - Sign up schemas:
   ```typescript
   import { z } from 'zod'

   export const signUpInputSchema = z.object({
     name: z.string().min(1, 'El nombre es requerido'),
     email: z.string().email('Email inválido'),
     password: z.string()
       .min(8, 'La contraseña debe tener al menos 8 caracteres')
       .max(128, 'La contraseña es muy larga'),
   })

   export const signUpOutputSchema = z.object({
     user: z.object({
       id: z.string(),
       name: z.string(),
       email: z.string(),
     }),
   })

   export type SignUpInput = z.infer<typeof signUpInputSchema>
   export type SignUpOutput = z.infer<typeof signUpOutputSchema>
   ```

2. **packages/contracts/src/auth/sign-in.ts** - Sign in schemas:
   ```typescript
   import { z } from 'zod'

   export const signInInputSchema = z.object({
     email: z.string().email('Email inválido'),
     password: z.string().min(1, 'La contraseña es requerida'),
     rememberMe: z.boolean().optional().default(false),
   })

   export const signInOutputSchema = z.object({
     user: z.object({
       id: z.string(),
       name: z.string(),
       email: z.string(),
     }),
   })

   export type SignInInput = z.infer<typeof signInInputSchema>
   export type SignInOutput = z.infer<typeof signInOutputSchema>
   ```

3. **packages/contracts/src/auth/session.ts** - Session schemas:
   ```typescript
   import { z } from 'zod'

   export const sessionOutputSchema = z.object({
     user: z.object({
       id: z.string(),
       name: z.string(),
       email: z.string(),
       image: z.string().nullable(),
     }),
     session: z.object({
       id: z.string(),
       expiresAt: z.string(), // ISO date string
     }),
   }).nullable()

   export type SessionOutput = z.infer<typeof sessionOutputSchema>
   ```

4. **packages/backend/src/procedures/auth/sign-up.ts** - Sign up procedure:
   ```typescript
   import { publicProcedure } from '../../lib/orpc'
   import { signUpInputSchema, signUpOutputSchema } from '@strenly/contracts/auth/sign-up'

   export const signUp = publicProcedure
     .errors({
       EMAIL_EXISTS: { message: 'Ya existe una cuenta con este email' },
       WEAK_PASSWORD: { message: 'La contraseña es muy débil' },
     })
     .input(signUpInputSchema)
     .output(signUpOutputSchema)
     .handler(async ({ input, context, errors }) => {
       const result = await context.auth.api.signUpEmail({
         body: {
           name: input.name,
           email: input.email,
           password: input.password,
         },
       })

       if (!result.user) {
         // Better-Auth returns error in result
         throw errors.EMAIL_EXISTS()
       }

       return {
         user: {
           id: result.user.id,
           name: result.user.name ?? input.name,
           email: result.user.email,
         },
       }
     })
   ```

5. **packages/backend/src/procedures/auth/sign-in.ts** - Sign in procedure:
   ```typescript
   import { publicProcedure } from '../../lib/orpc'
   import { signInInputSchema, signInOutputSchema } from '@strenly/contracts/auth/sign-in'

   export const signIn = publicProcedure
     .errors({
       INVALID_CREDENTIALS: { message: 'Email o contraseña incorrectos' },
     })
     .input(signInInputSchema)
     .output(signInOutputSchema)
     .handler(async ({ input, context, errors }) => {
       const result = await context.auth.api.signInEmail({
         body: {
           email: input.email,
           password: input.password,
           rememberMe: input.rememberMe,
         },
       })

       if (!result.user) {
         throw errors.INVALID_CREDENTIALS()
       }

       return {
         user: {
           id: result.user.id,
           name: result.user.name ?? '',
           email: result.user.email,
         },
       }
     })
   ```

6. **packages/backend/src/procedures/auth/session.ts** - Session and logout:
   ```typescript
   import { publicProcedure } from '../../lib/orpc'
   import { sessionOutputSchema } from '@strenly/contracts/auth/session'
   import { z } from 'zod'

   export const session = publicProcedure
     .output(sessionOutputSchema)
     .handler(async ({ context }) => {
       const result = await context.auth.api.getSession({
         headers: context.headers,
       })

       if (!result?.user) {
         return null
       }

       return {
         user: {
           id: result.user.id,
           name: result.user.name ?? '',
           email: result.user.email,
           image: result.user.image ?? null,
         },
         session: {
           id: result.session.id,
           expiresAt: result.session.expiresAt.toISOString(),
         },
       }
     })

   export const signOut = publicProcedure
     .output(z.object({ success: z.boolean() }))
     .handler(async ({ context }) => {
       await context.auth.api.signOut({
         headers: context.headers,
       })
       return { success: true }
     })
   ```

Note: Google OAuth is handled directly by Better-Auth at /api/auth/sign-in/google - no custom procedure needed.
  </action>
  <verify>
`pnpm typecheck` passes for packages/contracts and packages/backend.
All auth procedures use contracts schemas (not inline definitions).
  </verify>
  <done>
Sign up, sign in, session, and sign out procedures implemented using Better-Auth API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Password Reset Flow and Auth Router</name>
  <files>
    packages/contracts/src/auth/password-reset.ts
    packages/backend/src/procedures/auth/password-reset.ts
    packages/backend/src/procedures/auth/index.ts
    packages/backend/src/procedures/router.ts
  </files>
  <action>
Create password reset procedures and aggregate auth router:

1. **packages/contracts/src/auth/password-reset.ts** - Password reset schemas:
   ```typescript
   import { z } from 'zod'

   export const requestPasswordResetInputSchema = z.object({
     email: z.string().email('Email inválido'),
     redirectTo: z.string().url().optional(),
   })

   export const resetPasswordInputSchema = z.object({
     token: z.string().min(1, 'Token requerido'),
     newPassword: z.string()
       .min(8, 'La contraseña debe tener al menos 8 caracteres')
       .max(128, 'La contraseña es muy larga'),
   })

   export const passwordResetOutputSchema = z.object({
     success: z.boolean(),
   })

   export type RequestPasswordResetInput = z.infer<typeof requestPasswordResetInputSchema>
   export type ResetPasswordInput = z.infer<typeof resetPasswordInputSchema>
   ```

2. **packages/backend/src/procedures/auth/password-reset.ts** - Reset procedures:
   ```typescript
   import { publicProcedure } from '../../lib/orpc'
   import {
     requestPasswordResetInputSchema,
     resetPasswordInputSchema,
     passwordResetOutputSchema,
   } from '@strenly/contracts/auth/password-reset'

   export const requestPasswordReset = publicProcedure
     .input(requestPasswordResetInputSchema)
     .output(passwordResetOutputSchema)
     .handler(async ({ input, context }) => {
       // Note: Better-Auth handles email sending via sendResetPassword config
       // This endpoint always returns success to prevent email enumeration
       await context.auth.api.forgetPassword({
         body: {
           email: input.email,
           redirectTo: input.redirectTo,
         },
       })

       return { success: true }
     })

   export const resetPassword = publicProcedure
     .errors({
       INVALID_TOKEN: { message: 'El enlace ha expirado o es inválido' },
       WEAK_PASSWORD: { message: 'La contraseña es muy débil' },
     })
     .input(resetPasswordInputSchema)
     .output(passwordResetOutputSchema)
     .handler(async ({ input, context, errors }) => {
       try {
         await context.auth.api.resetPassword({
           body: {
             token: input.token,
             newPassword: input.newPassword,
           },
         })
         return { success: true }
       } catch {
         throw errors.INVALID_TOKEN()
       }
     })
   ```

3. **packages/backend/src/procedures/auth/index.ts** - Auth router (EXCEPTION: barrel file allowed for router aggregation):
   ```typescript
   import { os } from '@orpc/server'
   import { signUp } from './sign-up'
   import { signIn } from './sign-in'
   import { session, signOut } from './session'
   import { requestPasswordReset, resetPassword } from './password-reset'

   export const authRouter = os.router({
     signUp,
     signIn,
     session,
     signOut,
     requestPasswordReset,
     resetPassword,
   })
   ```

4. **packages/backend/src/procedures/router.ts** - Update main router:
   ```typescript
   import { os } from '@orpc/server'
   import { health } from './health/health'
   import { authRouter } from './auth'

   export const router = os.router({
     health,
     auth: authRouter,
   })

   export type Router = typeof router
   ```

Important:
- Password reset always returns success (prevents email enumeration)
- Use contracts for all input/output schemas
- Spanish error messages for user-facing errors
  </action>
  <verify>
`pnpm typecheck` passes.
Auth router includes: signUp, signIn, session, signOut, requestPasswordReset, resetPassword.
Main router includes auth namespace.
  </verify>
  <done>
Password reset flow implemented with request and reset procedures.
Auth router aggregates all auth procedures under /rpc/auth namespace.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication system with email/password, Google OAuth, session management, and password reset</what-built>
  <how-to-verify>
1. Start the development server: `pnpm dev`
2. Test sign up: POST to /rpc/auth.signUp with {"name":"Test","email":"test@example.com","password":"password123"}
3. Test sign in: POST to /rpc/auth.signIn with {"email":"test@example.com","password":"password123"}
4. Test session: GET /rpc/auth.session (should return user info if signed in)
5. Test logout: POST to /rpc/auth.signOut
6. Test Google OAuth: Navigate to /api/auth/sign-in/google (should redirect to Google)
7. Test password reset: POST to /rpc/auth.requestPasswordReset with {"email":"test@example.com"}

Expected:
- Sign up creates user and sets session cookie
- Sign in validates credentials and sets session cookie
- Session returns user info when cookie present, null otherwise
- Logout clears session
- Google OAuth redirects to Google consent screen
- Password reset returns success (check email if configured)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes for all packages
2. All auth procedures accessible via /rpc/auth.*
3. Better-Auth handlers work at /api/auth/*
4. Session cookie is set on successful sign in
5. Password reset email sends (if email configured)
</verification>

<success_criteria>
Requirements covered:
- AUTH-01: User can create account with email/password (signUp procedure)
- AUTH-02: User can create account with Google OAuth (Better-Auth handler)
- AUTH-03: User can log in and stay logged in (signIn + session procedures)
- AUTH-04: User can reset password via email (requestPasswordReset + resetPassword)
- AUTH-05: User can log out (signOut procedure)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenancy/01-03-SUMMARY.md`
</output>
