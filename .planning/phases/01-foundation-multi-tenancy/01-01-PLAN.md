---
phase: 01-foundation-multi-tenancy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema/auth.ts
  - packages/database/src/schema/plans.ts
  - packages/database/src/schema/subscriptions.ts
  - packages/database/src/schema/index.ts
  - packages/database/drizzle.config.ts
  - packages/auth/src/auth.ts
  - packages/auth/src/index.ts
  - packages/auth/package.json
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OAuth for user authentication"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials"
      - task: "Add authorized redirect URIs"
        location: "OAuth client -> Authorized redirect URIs -> Add http://localhost:8787/api/auth/callback/google"
  - service: better-auth
    why: "Authentication framework secrets"
    env_vars:
      - name: BETTER_AUTH_SECRET
        source: "Generate with: openssl rand -base64 32"
      - name: BETTER_AUTH_URL
        source: "Set to http://localhost:8787 for dev, production URL for prod"

must_haves:
  truths:
    - "Database schema exists with all auth-related tables (users, sessions, accounts, organizations, members, invitations)"
    - "Database schema exists with subscription-related tables (plans, subscriptions)"
    - "Better-Auth factory function creates auth instance with Cloudflare Workers compatibility"
    - "Auth instance includes organization plugin configured with roles"
  artifacts:
    - path: "packages/database/src/schema/auth.ts"
      provides: "Auth tables (users, sessions, accounts, organizations, members, invitations)"
      contains: "pgTable"
    - path: "packages/database/src/schema/plans.ts"
      provides: "Plans table definition"
      contains: "plans"
    - path: "packages/database/src/schema/subscriptions.ts"
      provides: "Subscriptions table linking orgs to plans"
      contains: "subscriptions"
    - path: "packages/auth/src/auth.ts"
      provides: "createAuth factory function"
      exports: ["createAuth"]
  key_links:
    - from: "packages/auth/src/auth.ts"
      to: "packages/database/src/schema/auth.ts"
      via: "drizzleAdapter import"
      pattern: "drizzleAdapter.*schema"
    - from: "packages/auth/src/auth.ts"
      to: "better-auth/plugins"
      via: "organization plugin"
      pattern: "organization\\("
---

<objective>
Create the database schema for authentication, organizations, and subscriptions, and configure Better-Auth with the organization plugin for multi-tenant support.

Purpose: Establishes the data foundation for all auth and multi-tenancy features. Without these schemas, no user or organization operations are possible.
Output: Drizzle schema files ready for db:push, Better-Auth factory function ready for Hono integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-multi-tenancy/01-RESEARCH.md
@docs/architecture.md
@.claude/skills/domain-entity/SKILL.md
@.claude/skills/repository/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Database Schema for Auth and Organizations</name>
  <files>
    packages/database/src/schema/auth.ts
    packages/database/src/schema/plans.ts
    packages/database/src/schema/subscriptions.ts
    packages/database/src/schema/index.ts
    packages/database/drizzle.config.ts
  </files>
  <action>
Create the Drizzle schema files for Better-Auth tables and subscription management:

1. **auth.ts** - Create tables required by Better-Auth with organization plugin:
   - `users` table: id (text PK), name, email (unique), emailVerified, image, createdAt, updatedAt
   - `sessions` table: id (text PK), expiresAt, token (unique), ipAddress, userAgent, userId (FK to users)
   - `accounts` table: id (text PK), accountId, providerId, userId (FK), accessToken, refreshToken, idToken, accessTokenExpiresAt, refreshTokenExpiresAt, scope, password, createdAt, updatedAt
   - `verifications` table: id (text PK), identifier, value, expiresAt, createdAt, updatedAt
   - `organizations` table: id (text PK), name, slug (unique), logo, metadata, createdAt
   - `members` table: id (text PK), organizationId (FK), userId (FK), role (text - 'owner'/'admin'/'member'), createdAt
   - `invitations` table: id (text PK), organizationId (FK), email, role, status ('pending'/'accepted'/'rejected'/'canceled'), inviterId (FK to users), expiresAt, createdAt

   Use Better-Auth's expected column names exactly. Reference: https://www.better-auth.com/docs/concepts/database

2. **plans.ts** - Create subscription plans table:
   - `plans` table: id (text PK), name, slug (unique), organizationType ('coach_solo'/'gym'), athleteLimit (integer), coachLimit (integer, nullable for unlimited), features (jsonb), priceMonthly (integer cents), priceYearly (integer cents), isActive (boolean default true), createdAt, updatedAt

3. **subscriptions.ts** - Create organization subscriptions table:
   - `subscriptions` table: id (text PK), organizationId (FK to organizations, unique - one subscription per org), planId (FK to plans), status ('active'/'canceled'/'past_due'), currentPeriodStart, currentPeriodEnd, athleteCount (integer default 0), createdAt, updatedAt

4. **index.ts** - Export all schema tables (EXCEPTION: this is allowed as router aggregation)

5. **drizzle.config.ts** - Configure Drizzle Kit:
   - Use standard postgres driver for local dev
   - Schema path: ./src/schema/index.ts
   - Out path: ./drizzle
   - Database credentials from environment

Use snake_case for all column names per architecture conventions. Add indexes on frequently queried columns (organizationId, userId, email, slug).

Do NOT use `as` type casting. Use proper Drizzle types and inference.
  </action>
  <verify>
Run `pnpm typecheck` in packages/database - no type errors.
Schema files exist and export all tables.
  </verify>
  <done>
All auth, organization, plan, and subscription tables defined with proper types, foreign keys, and indexes. Schema ready for db:push.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Better-Auth Factory with Organization Plugin</name>
  <files>
    packages/auth/src/auth.ts
    packages/auth/src/index.ts
    packages/auth/package.json
  </files>
  <action>
Create the Better-Auth configuration factory for Cloudflare Workers:

1. **package.json** - Add dependencies:
   - better-auth (^1.4.x or latest stable)
   - @better-auth/cli (dev dependency)

2. **auth.ts** - Create `createAuth` factory function:
   ```typescript
   // Type for environment bindings
   export type AuthEnv = {
     BETTER_AUTH_SECRET: string
     BETTER_AUTH_URL: string
     GOOGLE_CLIENT_ID: string
     GOOGLE_CLIENT_SECRET: string
   }

   export function createAuth(env: AuthEnv, db: DB) {
     return betterAuth({
       database: drizzleAdapter(db, {
         provider: 'pg',
         schema: authSchema,
         usePlural: true, // tables are plural (users, sessions, etc)
       }),
       baseURL: env.BETTER_AUTH_URL, // CRITICAL: prevents redirect_uri_mismatch
       secret: env.BETTER_AUTH_SECRET,
       emailAndPassword: {
         enabled: true,
         minPasswordLength: 8,
         maxPasswordLength: 128,
         // Note: On Cloudflare Workers free tier, scrypt may exceed CPU limit
         // Consider paid tier or Email OTP alternative
       },
       socialProviders: {
         google: {
           clientId: env.GOOGLE_CLIENT_ID,
           clientSecret: env.GOOGLE_CLIENT_SECRET,
           prompt: 'select_account',
         },
       },
       plugins: [
         organization({
           allowUserToCreateOrganization: async () => true,
           creatorRole: 'owner',
           membershipLimit: 100,
           // Roles: owner (full control), admin (manage members), member (basic access)
         }),
       ],
     })
   }
   ```

3. **index.ts** - Export createAuth and types:
   ```typescript
   export { createAuth, type AuthEnv } from './auth'
   export type Auth = ReturnType<typeof createAuth>
   ```

Important:
- Use drizzleAdapter from better-auth
- Import schema from @strenly/database (or relative path based on package structure)
- Do NOT use `as` casting - use proper type inference
- The factory pattern is required because Cloudflare Workers env vars are not available at module scope

Reference the research file for pitfalls to avoid (baseURL, customSession conflicts).
  </action>
  <verify>
Run `pnpm typecheck` in packages/auth - no type errors.
`createAuth` function is exported and can be called with env and db parameters.
  </verify>
  <done>
Better-Auth factory function exists with:
- Drizzle adapter configured for PostgreSQL
- Email/password authentication enabled
- Google OAuth configured
- Organization plugin with owner/admin/member roles
- Proper TypeScript types exported
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes for both packages/database and packages/auth
2. All schema tables are exported from packages/database/src/schema/index.ts
3. `createAuth` function is exported from packages/auth/src/index.ts
4. No `as` type casting or `!` non-null assertions in any file
5. All file names are kebab-case
</verification>

<success_criteria>
- Database schema defines: users, sessions, accounts, verifications, organizations, members, invitations, plans, subscriptions
- Better-Auth factory creates auth instance with email/password, Google OAuth, and organization plugin
- All types are properly inferred without casting
- Schema ready to be pushed to database with `pnpm db:push`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenancy/01-01-SUMMARY.md`
</output>
