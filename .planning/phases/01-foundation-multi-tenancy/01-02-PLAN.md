---
phase: 01-foundation-multi-tenancy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/lib/orpc.ts
  - packages/backend/src/lib/errors.ts
  - packages/backend/src/lib/context.ts
  - packages/backend/src/procedures/router.ts
  - packages/backend/src/procedures/health/health.ts
  - packages/backend/src/app.ts
  - packages/contracts/src/common/errors.ts
autonomous: true

must_haves:
  truths:
    - "Three procedure types exist: publicProcedure (no auth), sessionProcedure (user auth), authProcedure (user + org)"
    - "authProcedure validates X-Organization-Slug header and user membership"
    - "Health check endpoint responds at /rpc/health"
    - "Procedures use typed errors from contracts package"
  artifacts:
    - path: "packages/backend/src/lib/orpc.ts"
      provides: "Procedure definitions with auth hierarchy"
      exports: ["publicProcedure", "sessionProcedure", "authProcedure"]
    - path: "packages/backend/src/lib/errors.ts"
      provides: "Error definitions for procedures"
      contains: "UNAUTHORIZED"
    - path: "packages/backend/src/procedures/router.ts"
      provides: "Main router aggregating all procedures"
      exports: ["router"]
    - path: "packages/backend/src/app.ts"
      provides: "Hono app with CORS and middleware"
      exports: ["app"]
  key_links:
    - from: "packages/backend/src/lib/orpc.ts"
      to: "authProcedure middleware"
      via: "session validation + org membership check"
      pattern: "getSession.*X-Organization-Slug"
    - from: "packages/backend/src/app.ts"
      to: "packages/backend/src/procedures/router.ts"
      via: "RPC handler mount"
      pattern: "rpc.*router"
---

<objective>
Create the oRPC procedure hierarchy with three authentication levels (public, session, auth) and set up the Hono app with infrastructure middleware.

Purpose: Establishes the API foundation. All endpoints will be built on these procedure types. The auth hierarchy ensures proper access control.
Output: Working Hono app with oRPC router, health check endpoint, and procedure factories ready for feature endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-multi-tenancy/01-RESEARCH.md
@docs/architecture.md
@.claude/skills/procedure/SKILL.md
@.claude/skills/architecture/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create oRPC Procedure Hierarchy</name>
  <files>
    packages/backend/src/lib/orpc.ts
    packages/backend/src/lib/errors.ts
    packages/backend/src/lib/context.ts
    packages/contracts/src/common/errors.ts
  </files>
  <action>
Create the three-tier procedure hierarchy for oRPC:

1. **packages/contracts/src/common/errors.ts** - Define shared error schemas:
   ```typescript
   import { z } from 'zod'

   export const commonErrors = {
     INTERNAL_ERROR: { message: 'Error interno del servidor' },
     VALIDATION_ERROR: { message: 'Datos inv치lidos' },
     NOT_FOUND: { message: 'Recurso no encontrado' },
   }

   export const authErrors = {
     UNAUTHORIZED: { message: 'No autenticado' },
     FORBIDDEN: { message: 'No tienes permisos para esta acci칩n' },
     ORG_NOT_FOUND: { message: 'Organizaci칩n no encontrada' },
     NOT_A_MEMBER: { message: 'No eres miembro de esta organizaci칩n' },
   }
   ```

2. **packages/backend/src/lib/context.ts** - Define context types:
   ```typescript
   import type { Auth } from '@strenly/auth'
   import type { DB } from '@strenly/database'

   export type BaseContext = {
     db: DB
     auth: Auth
     headers: Headers
   }

   export type SessionContext = BaseContext & {
     user: { id: string; name: string; email: string; image?: string }
     session: { id: string; expiresAt: Date }
   }

   export type AuthContext = SessionContext & {
     organization: { id: string; name: string; slug: string }
     membership: { id: string; role: 'owner' | 'admin' | 'member' }
   }
   ```

3. **packages/backend/src/lib/errors.ts** - Re-export errors for procedures:
   ```typescript
   export { commonErrors, authErrors } from '@strenly/contracts/common/errors'
   ```

4. **packages/backend/src/lib/orpc.ts** - Create procedure hierarchy:
   ```typescript
   import { os } from '@orpc/server'
   import { commonErrors, authErrors } from './errors'
   import type { BaseContext, SessionContext, AuthContext } from './context'

   // Public - No authentication required (health checks, plan listing)
   export const publicProcedure = os.$context<BaseContext>().errors(commonErrors)

   // Session - User authenticated, no organization context (onboarding, org selection)
   export const sessionProcedure = os
     .$context<BaseContext>()
     .errors({ ...commonErrors, ...authErrors })
     .use(async ({ context, next, errors }) => {
       const session = await context.auth.api.getSession({ headers: context.headers })
       if (!session?.user) {
         throw errors.UNAUTHORIZED()
       }
       return next({
         context: {
           ...context,
           user: session.user,
           session: session.session,
         } satisfies SessionContext,
       })
     })

   // Auth - User authenticated + organization context (most endpoints)
   export const authProcedure = os
     .$context<BaseContext>()
     .errors({ ...commonErrors, ...authErrors })
     .use(async ({ context, next, errors }) => {
       // 1. Validate session
       const session = await context.auth.api.getSession({ headers: context.headers })
       if (!session?.user) {
         throw errors.UNAUTHORIZED()
       }

       // 2. Get organization slug from header
       const orgSlug = context.headers.get('X-Organization-Slug')
       if (!orgSlug) {
         throw errors.ORG_NOT_FOUND()
       }

       // 3. Find organization and validate membership
       // Note: Actual DB query will use drizzle - this is a placeholder
       // Implementation will be completed when auth package is integrated
       const org = await context.auth.api.getFullOrganization({
         headers: context.headers,
         query: { organizationSlug: orgSlug },
       })

       if (!org) {
         throw errors.ORG_NOT_FOUND()
       }

       // Find user's membership in this organization
       const membership = org.members.find((m) => m.userId === session.user.id)
       if (!membership) {
         throw errors.NOT_A_MEMBER()
       }

       return next({
         context: {
           ...context,
           user: session.user,
           session: session.session,
           organization: {
             id: org.id,
             name: org.name,
             slug: org.slug,
           },
           membership: {
             id: membership.id,
             role: membership.role as 'owner' | 'admin' | 'member',
           },
         } satisfies AuthContext,
       })
     })
   ```

Important notes:
- Use `satisfies` for type checking without casting
- Error messages in Spanish (user-facing)
- The auth.api methods come from Better-Auth's organization plugin
- Do NOT use `as` type casting except for the role which is validated
  </action>
  <verify>
`pnpm typecheck` passes for packages/backend and packages/contracts.
All three procedures are exported from orpc.ts.
  </verify>
  <done>
Three procedure types exist with progressive authentication:
- publicProcedure: No auth
- sessionProcedure: Validates user session
- authProcedure: Validates session + organization membership
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Hono App with Router and Health Check</name>
  <files>
    packages/backend/src/procedures/health/health.ts
    packages/backend/src/procedures/router.ts
    packages/backend/src/app.ts
  </files>
  <action>
Create the Hono application with CORS, infrastructure middleware, and oRPC router:

1. **packages/backend/src/procedures/health/health.ts** - Health check procedure:
   ```typescript
   import { publicProcedure } from '../../lib/orpc'
   import { z } from 'zod'

   export const health = publicProcedure
     .output(z.object({
       status: z.literal('ok'),
       timestamp: z.string(),
     }))
     .handler(async () => {
       return {
         status: 'ok' as const,
         timestamp: new Date().toISOString(),
       }
     })
   ```

2. **packages/backend/src/procedures/router.ts** - Main router:
   ```typescript
   import { os } from '@orpc/server'
   import { health } from './health/health'

   export const router = os.router({
     health,
     // Future procedure groups will be added here:
     // auth: authRouter,
     // organizations: organizationsRouter,
     // etc.
   })

   export type Router = typeof router
   ```

3. **packages/backend/src/app.ts** - Hono app with middleware:
   ```typescript
   import { Hono } from 'hono'
   import { cors } from 'hono/cors'
   import { RPCHandler } from '@orpc/server/fetch'
   import { router } from './procedures/router'
   import { createDb } from '@strenly/database'
   import { createAuth } from '@strenly/auth'
   import type { BaseContext } from './lib/context'

   type Env = {
     DATABASE_URL: string
     BETTER_AUTH_SECRET: string
     BETTER_AUTH_URL: string
     GOOGLE_CLIENT_ID: string
     GOOGLE_CLIENT_SECRET: string
   }

   type Variables = {
     db: ReturnType<typeof createDb>
     auth: ReturnType<typeof createAuth>
   }

   const app = new Hono<{ Bindings: Env; Variables: Variables }>()

   // CORS must be first - allows credentials for cookie-based auth
   app.use('/api/*', cors({
     origin: (origin) => {
       // Allow localhost for development
       if (origin.includes('localhost')) return origin
       // Allow production domains (update with actual domain)
       if (origin.endsWith('.strenly.app')) return origin
       return null
     },
     credentials: true,
     allowHeaders: ['Content-Type', 'Authorization', 'X-Organization-Slug'],
     allowMethods: ['POST', 'GET', 'OPTIONS'],
   }))

   // Infrastructure middleware - creates db and auth per request
   app.use('/api/*', async (c, next) => {
     const db = createDb(c.env.DATABASE_URL)
     c.set('db', db)

     const auth = createAuth({
       BETTER_AUTH_SECRET: c.env.BETTER_AUTH_SECRET,
       BETTER_AUTH_URL: c.env.BETTER_AUTH_URL,
       GOOGLE_CLIENT_ID: c.env.GOOGLE_CLIENT_ID,
       GOOGLE_CLIENT_SECRET: c.env.GOOGLE_CLIENT_SECRET,
     }, db)
     c.set('auth', auth)

     await next()
   })

   // Mount Better-Auth handler
   app.on(['POST', 'GET'], '/api/auth/*', (c) => {
     const auth = c.get('auth')
     return auth.handler(c.req.raw)
   })

   // Mount oRPC handler
   const rpcHandler = new RPCHandler(router)

   app.use('/rpc/*', async (c) => {
     const db = c.get('db')
     const auth = c.get('auth')

     const context: BaseContext = {
       db,
       auth,
       headers: c.req.raw.headers,
     }

     const response = await rpcHandler.handle(c.req.raw, {
       prefix: '/rpc',
       context,
     })

     return response ?? c.notFound()
   })

   export { app }
   export type AppType = typeof app
   ```

Important:
- CORS allows X-Organization-Slug header (required for authProcedure)
- Infrastructure middleware creates fresh db/auth per request (Cloudflare Workers pattern)
- Better-Auth mounted at /api/auth/*
- oRPC mounted at /rpc/*
- Use kebab-case for all file names
  </action>
  <verify>
`pnpm typecheck` passes for packages/backend.
Health check endpoint can be invoked at /rpc/health.
CORS headers include X-Organization-Slug.
  </verify>
  <done>
Hono app configured with:
- CORS allowing credentials and X-Organization-Slug header
- Infrastructure middleware creating db/auth per request
- Better-Auth handler at /api/auth/*
- oRPC router at /rpc/* with health check
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes for packages/backend and packages/contracts
2. Health check can be tested: `curl http://localhost:8787/rpc/health` returns `{"status":"ok","timestamp":"..."}`
3. CORS headers include X-Organization-Slug in allowHeaders
4. All three procedure types exported from orpc.ts
5. No `as` type casting or `!` non-null assertions
</verification>

<success_criteria>
- publicProcedure, sessionProcedure, authProcedure exported from packages/backend/src/lib/orpc.ts
- Health check responds with status: ok
- Hono app exports app and AppType
- CORS configured for credentials and organization header
- Better-Auth handler mounted at /api/auth/*
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenancy/01-02-SUMMARY.md`
</output>
