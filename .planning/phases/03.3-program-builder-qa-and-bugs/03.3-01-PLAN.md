---
phase: 03.3-program-builder-qa-and-bugs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/use-cell-editing.ts
autonomous: true

must_haves:
  truths:
    - "Keyboard input in prescription cells only enters edit mode on: Enter, F2, double-click, or numeric keys (0-9)"
    - "Entering edit mode does NOT select all text; cursor is positioned at end of input"
    - "Arrow key navigation while in edit mode moves cursor within input (does NOT change selected cell)"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx"
      provides: "Fixed edit mode triggers and cursor positioning"
      contains: "setSelectionRange"
  key_links:
    - from: "prescription-cell.tsx"
      to: "use-cell-editing.ts"
      via: "startEditing/stopEditing callbacks"
      pattern: "onStartEdit|startEditing"
---

<objective>
Fix prescription cell edit mode behavior to match Excel conventions: only Enter, F2, double-click, or digits trigger edit mode; cursor positioned at end (not select all); arrow keys move cursor within input when editing.

Purpose: The current implementation triggers edit mode on any printable character, selects all text on edit, and arrow keys always navigate cells even when editing. This contradicts standard Excel behavior and user expectations.

Output: Updated prescription-cell.tsx with correct keyboard handling and cursor positioning.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-program-builder-qa-and-bugs/03.3-RESEARCH.md
@apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
@apps/coach-web/src/components/programs/program-grid/use-cell-editing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix edit mode triggers to only accept specific keys</name>
  <files>apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
Update the `handleCellKeyDown` function (around line 112-130) to ONLY trigger edit mode on:
- Enter key
- F2 key
- Double-click (already working via onDoubleClick)
- Digits 0-9

Currently the code at lines 121-127 starts editing on any printable character (`e.key.length === 1`). Change this to ONLY allow digits:

```typescript
const handleCellKeyDown = (e: React.KeyboardEvent) => {
  // Only handle edit mode triggers - let navigation keys bubble to grid
  switch (e.key) {
    case 'Enter':
    case 'F2':
      // Start editing on Enter or F2 (Excel convention)
      e.preventDefault()
      onStartEdit()
      break
    default:
      // Only start editing on numeric keys (0-9) - NOT letters
      if (/^[0-9]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault()
        setEditValue(e.key) // Start with typed digit
        onStartEdit()
      }
      // All other keys (letters, symbols, arrows) bubble to grid for navigation
  }
}
```

Also update `handleEditKeyDown` in use-cell-editing.ts (around line 101-106) to match - only allow digits to trigger edit, not all printable characters.
  </action>
  <verify>
1. Open program grid in browser
2. Click on a prescription cell to select it (cell should be active/highlighted)
3. Press letter keys like "a", "b", "x" - verify cell does NOT enter edit mode
4. Press number keys like "3", "8" - verify cell DOES enter edit mode with that digit
5. Press Enter or F2 - verify cell enters edit mode
6. Double-click cell - verify cell enters edit mode
  </verify>
  <done>Only Enter, F2, double-click, and digits 0-9 trigger edit mode. Letters and other keys are ignored (bubble to grid).</done>
</task>

<task type="auto">
  <name>Task 2: Fix cursor position to be at end of input (not select all)</name>
  <files>apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
Update the useEffect that handles focus when entering edit mode (around lines 49-54). Currently it uses `inputRef.current?.select()` which selects all text.

Replace with `setSelectionRange(length, length)` to position cursor at end:

```typescript
// Focus input when entering edit mode
useEffect(() => {
  if (isEditing && inputRef.current) {
    const input = inputRef.current
    input.focus()
    // Position cursor at end instead of selecting all text
    // Use requestAnimationFrame to ensure DOM is ready
    requestAnimationFrame(() => {
      const len = input.value.length
      input.setSelectionRange(len, len)
    })
  }
}, [isEditing])
```

The requestAnimationFrame ensures the DOM is updated before setting cursor position, preventing race conditions with React's state updates.
  </action>
  <verify>
1. Open program grid
2. Click on a cell with existing value (e.g., "3x8@RIR2")
3. Press Enter or F2 to edit
4. Verify cursor is at END of text (after "2"), NOT selecting all text
5. Verify you can immediately type to append without overwriting
  </verify>
  <done>Entering edit mode positions cursor at end of existing text, not selecting all.</done>
</task>

<task type="auto">
  <name>Task 3: Fix arrow keys in edit mode to move cursor, not navigate cells</name>
  <files>apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
The current `handleKeyDown` function (around lines 63-110) for the input has the right idea but needs refinement. The issue is that ArrowLeft/ArrowRight currently check cursor position correctly but ArrowUp/ArrowDown always navigate.

Update the arrow key handling:

For ArrowLeft:
- ONLY navigate to previous cell when cursor is at position 0 AND selectionEnd is also 0 (no selection, cursor at start)
- Otherwise, let default browser behavior move cursor left (do NOT call preventDefault)

For ArrowRight:
- ONLY navigate to next cell when cursor is at the end of the text (selectionStart === value.length)
- Otherwise, let default browser behavior move cursor right

For ArrowUp/ArrowDown:
- These should always commit and navigate since there's no vertical cursor movement in single-line input
- This is already correct in the current implementation

The key insight: Only call `e.preventDefault()` when you are going to navigate. If cursor is in the middle of text, do NOT prevent default - let the cursor move naturally.

```typescript
const handleKeyDown = (e: React.KeyboardEvent) => {
  switch (e.key) {
    case 'Enter':
      e.preventDefault()
      onCommit(editValue)
      break
    case 'Escape':
      e.preventDefault()
      setEditValue(value) // Reset to original
      onCancel()
      break
    case 'Tab':
      e.preventDefault()
      onCommit(editValue)
      onNavigate(e.shiftKey ? 'shift-tab' : 'tab')
      break
    case 'ArrowUp':
    case 'ArrowDown':
      // Always navigate for vertical - no cursor movement in single-line input
      e.preventDefault()
      onCommit(editValue)
      onNavigate(e.key === 'ArrowUp' ? 'up' : 'down')
      break
    case 'ArrowLeft':
      // Only navigate if cursor is at the very start (no selection)
      if (
        inputRef.current?.selectionStart === 0 &&
        inputRef.current?.selectionEnd === 0
      ) {
        e.preventDefault()
        onCommit(editValue)
        onNavigate('left')
      }
      // Otherwise, let browser handle cursor movement (don't preventDefault)
      break
    case 'ArrowRight':
      // Only navigate if cursor is at the very end
      if (inputRef.current?.selectionStart === editValue.length) {
        e.preventDefault()
        onCommit(editValue)
        onNavigate('right')
      }
      // Otherwise, let browser handle cursor movement
      break
  }
}
```
  </action>
  <verify>
1. Open program grid
2. Edit a cell with existing text "3x8@RIR2"
3. Position cursor in the middle of the text (between "x" and "8")
4. Press ArrowLeft - verify cursor moves left within input (to between "3" and "x"), does NOT navigate to previous cell
5. Press ArrowRight - verify cursor moves right within input, does NOT navigate to next cell
6. Move cursor to very start (before "3")
7. Press ArrowLeft - verify it NOW navigates to previous cell
8. Edit same cell, move cursor to very end (after "2")
9. Press ArrowRight - verify it NOW navigates to next cell
10. ArrowUp/ArrowDown should always navigate to row above/below
  </verify>
  <done>Arrow left/right move cursor within input; only navigate to adjacent cells at text boundaries. Arrow up/down always navigate.</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no TypeScript errors
2. Run `pnpm lint` - no linting errors
3. Manual testing:
   - Letter keys do NOT trigger edit mode
   - Digit keys DO trigger edit mode with that digit
   - Enter/F2 trigger edit mode
   - Edit mode shows cursor at end, not select all
   - Arrow keys move cursor within text, navigate only at boundaries
</verification>

<success_criteria>
- Keyboard input only enters edit mode on Enter, F2, double-click, or digits 0-9
- Edit mode positions cursor at end, not selecting all text
- Arrow left/right move cursor within input (navigate only at boundaries)
- Arrow up/down always commit and navigate
- All existing grid navigation still works when not editing
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-program-builder-qa-and-bugs/03.3-01-SUMMARY.md`
</output>
