---
phase: 03.3-program-builder-qa-and-bugs
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/contracts/src/programs/program.ts
  - apps/coach-web/src/features/programs/components/program-form.tsx
  - packages/backend/src/use-cases/programs/create-program.ts
autonomous: true

must_haves:
  truths:
    - "Create program form includes sessionsCount field with default value of 3"
    - "Creating a program generates the specified number of initial sessions"
    - "Form layout is more compact (less scrolling required)"
  artifacts:
    - path: "packages/contracts/src/programs/program.ts"
      provides: "createProgramInputSchema with sessionsCount field"
      contains: "sessionsCount"
    - path: "apps/coach-web/src/features/programs/components/program-form.tsx"
      provides: "Form with sessionsCount input field"
      contains: "sessionsCount"
  key_links:
    - from: "program-form.tsx"
      to: "createProgramInputSchema"
      via: "form validation"
      pattern: "sessionsCount"
    - from: "create-program.ts"
      to: "sessionsCount"
      via: "use case implementation"
      pattern: "sessionsCount"
---

<objective>
Add sessionsCount field to create program form with default of 3 sessions per week. Improve form layout to be more compact.

Purpose: Currently, programs are created with only weeks but no sessions. Coaches have to manually add sessions after creation. Adding a sessionsCount field allows specifying initial sessions upfront, matching the existing weeksCount pattern.

Output: Updated contract schema, form component, and use case to support sessionsCount.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/contracts/src/programs/program.ts
@apps/coach-web/src/features/programs/components/program-form.tsx
@packages/backend/src/use-cases/programs/create-program.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sessionsCount to createProgramInputSchema</name>
  <files>packages/contracts/src/programs/program.ts</files>
  <action>
Add sessionsCount field to createProgramInputSchema (around line 147-165).

The field should mirror the weeksCount pattern:
- Optional (defaults to 3 if not provided)
- Integer between 1 and 7 (typical training week has 1-7 sessions)
- Spanish error messages

Update the schema:

```typescript
export const createProgramInputSchema = z.object({
  name: z
    .string()
    .min(3, { message: 'El nombre debe tener al menos 3 caracteres' })
    .max(100, { message: 'El nombre no puede superar los 100 caracteres' }),
  description: z
    .string()
    .max(500, { message: 'La descripcion no puede superar los 500 caracteres' })
    .optional()
    .or(z.literal('')),
  athleteId: z.string().optional(),
  isTemplate: z.boolean().optional(),
  weeksCount: z
    .number()
    .int({ message: 'El numero de semanas debe ser entero' })
    .min(1, { message: 'El programa debe tener al menos 1 semana' })
    .max(12, { message: 'El programa no puede tener mas de 12 semanas' })
    .optional(),
  sessionsCount: z
    .number()
    .int({ message: 'El numero de sesiones debe ser entero' })
    .min(1, { message: 'El programa debe tener al menos 1 sesion' })
    .max(7, { message: 'El programa no puede tener mas de 7 sesiones por semana' })
    .optional(),
})
```

Also update the JSDoc comment to mention sessionsCount:
```typescript
/**
 * Create program input schema
 * @property weeksCount - Number of initial weeks to create (1-12). Defaults to 4 if not provided.
 * @property sessionsCount - Number of initial sessions to create (1-7). Defaults to 3 if not provided.
 */
```
  </action>
  <verify>
1. Run `pnpm typecheck` in packages/contracts
2. Verify CreateProgramInput type includes sessionsCount?: number
  </verify>
  <done>Contract schema includes sessionsCount field with validation.</done>
</task>

<task type="auto">
  <name>Task 2: Add sessionsCount field to ProgramForm</name>
  <files>apps/coach-web/src/features/programs/components/program-form.tsx</files>
  <action>
Add sessionsCount field to the form, similar to weeksCount. Update the form:

1. Update defaultValues to include sessionsCount: 3
```typescript
defaultValues: {
  name: '',
  description: '',
  athleteId: undefined,
  isTemplate: false,
  weeksCount: 4,
  sessionsCount: 3,  // ADD THIS
  ...defaultValues,
},
```

2. Add showSessionsCount prop (mirroring showWeeksCount):
```typescript
type ProgramFormProps = {
  id?: string
  onSubmit: (data: CreateProgramInput) => void
  defaultValues?: Partial<CreateProgramInput>
  /** Whether to show the weeks count field (hidden when creating from template) */
  showWeeksCount?: boolean
  /** Whether to show the sessions count field (hidden when creating from template) */
  showSessionsCount?: boolean
}
```

3. Default showSessionsCount to true:
```typescript
export function ProgramForm({
  id,
  onSubmit,
  defaultValues,
  showWeeksCount = true,
  showSessionsCount = true,  // ADD THIS
}: ProgramFormProps) {
```

4. Add sessionsCount field after weeksCount field (around line 107):
```tsx
{showSessionsCount && (
  <Field>
    <FieldLabel htmlFor="sessionsCount">Sesiones iniciales</FieldLabel>
    <FieldContent>
      <Input
        id="sessionsCount"
        type="number"
        min={1}
        max={7}
        {...register('sessionsCount', { valueAsNumber: true })}
      />
      <FieldDescription>Cantidad de sesiones (dias de entrenamiento) por semana (1-7)</FieldDescription>
      <FieldError errors={[errors.sessionsCount]} />
    </FieldContent>
  </Field>
)}
```

5. To make the form more compact, use a grid layout for weeksCount and sessionsCount:
```tsx
{/* Weeks and Sessions in a grid */}
{(showWeeksCount || showSessionsCount) && (
  <div className="grid grid-cols-2 gap-4">
    {showWeeksCount && (
      <Field>
        <FieldLabel htmlFor="weeksCount">Semanas</FieldLabel>
        <FieldContent>
          <Input
            id="weeksCount"
            type="number"
            min={1}
            max={12}
            {...register('weeksCount', { valueAsNumber: true })}
          />
          <FieldDescription>1-12 semanas</FieldDescription>
          <FieldError errors={[errors.weeksCount]} />
        </FieldContent>
      </Field>
    )}
    {showSessionsCount && (
      <Field>
        <FieldLabel htmlFor="sessionsCount">Sesiones</FieldLabel>
        <FieldContent>
          <Input
            id="sessionsCount"
            type="number"
            min={1}
            max={7}
            {...register('sessionsCount', { valueAsNumber: true })}
          />
          <FieldDescription>1-7 dias/semana</FieldDescription>
          <FieldError errors={[errors.sessionsCount]} />
        </FieldContent>
      </Field>
    )}
  </div>
)}
```

Remove the separate weeksCount Field block and replace with the grid above.
  </action>
  <verify>
1. Run `pnpm typecheck` - no errors
2. Open create program dialog/page
3. Verify sessionsCount field appears next to weeksCount
4. Verify grid layout makes form more compact
5. Verify default values: weeksCount=4, sessionsCount=3
6. Try invalid values (0, 8) - verify validation error messages appear
  </verify>
  <done>Form includes sessionsCount field in compact grid layout with weeksCount.</done>
</task>

<task type="auto">
  <name>Task 3: Update create-program use case to create initial sessions</name>
  <files>packages/backend/src/use-cases/programs/create-program.ts</files>
  <action>
Update the createProgram use case to create the specified number of sessions.

Find the section that creates initial weeks (should be around lines 60-80). After creating weeks, add logic to create sessions:

```typescript
// Create initial sessions (default 3)
const sessionsCount = input.sessionsCount ?? 3
const sessions: { id: string; programId: string; name: string; orderIndex: number }[] = []

for (let i = 0; i < sessionsCount; i++) {
  sessions.push({
    id: crypto.randomUUID(),
    programId: program.id,
    name: `Dia ${i + 1}`,  // "Dia 1", "Dia 2", etc.
    orderIndex: i,
  })
}

// Insert sessions
if (sessions.length > 0) {
  await ctx.repository.createSessions(sessions)
}
```

The repository likely has a createSession method. Check if there's a batch method (createSessions) or if sessions need to be created one by one.

If no batch method exists, create sessions in a loop:
```typescript
for (const session of sessions) {
  await ctx.repository.createSession(session)
}
```

Also check if the repository method requires additional fields like createdAt, updatedAt. If so, add them:
```typescript
const now = new Date().toISOString()
sessions.push({
  id: crypto.randomUUID(),
  programId: program.id,
  name: `Dia ${i + 1}`,
  orderIndex: i,
  createdAt: now,
  updatedAt: now,
})
```

Note: Look at how weeksCount creates weeks and follow the same pattern for sessions.
  </action>
  <verify>
1. Run `pnpm typecheck` - no errors
2. Run `pnpm test` in packages/backend (if tests exist for create-program)
3. Create a new program with sessionsCount=3
4. Open the program in editor
5. Verify 3 sessions exist: "Dia 1", "Dia 2", "Dia 3"
6. Create a program with sessionsCount=5
7. Verify 5 sessions are created
  </verify>
  <done>Create program use case creates specified number of initial sessions.</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no TypeScript errors across all packages
2. Run `pnpm lint` - no linting errors
3. Run `pnpm test` in packages/backend to verify no test regressions
4. Manual testing:
   - Open create program form
   - Verify sessionsCount field present with default 3
   - Verify form layout is more compact (grid for weeks/sessions)
   - Create program with weeksCount=4, sessionsCount=3
   - Verify program has 4 weeks and 3 sessions
   - Verify session names are "Dia 1", "Dia 2", "Dia 3"
</verification>

<success_criteria>
- Contract schema includes sessionsCount (1-7, optional, default 3)
- Form shows sessionsCount field in compact grid layout
- Creating program generates specified number of sessions
- Session names are auto-generated ("Dia 1", "Dia 2", etc.)
- Form is more compact than before
- Existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-program-builder-qa-and-bugs/03.3-04-SUMMARY.md`
</output>
