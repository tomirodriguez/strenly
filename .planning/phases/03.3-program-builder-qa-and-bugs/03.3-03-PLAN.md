---
phase: 03.3-program-builder-qa-and-bugs
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/exercise-row.tsx
  - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Superset menu shows existing groups (A, B, C) and option to create new group"
    - "Clicking superset menu option changes exercise group membership"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      provides: "ExerciseCell that passes sessionRows to ExerciseRowActions"
      contains: "sessionRows="
  key_links:
    - from: "exercise-cell.tsx"
      to: "exercise-row-actions.tsx"
      via: "sessionRows prop"
      pattern: "sessionRows=\\{sessionRows\\}"
---

<objective>
Fix the superset menu to show existing superset groups and allow joining them. Currently the menu only shows "Crear superserie A" because sessionRows data is not being passed to ExerciseRowActions.

Purpose: Debug analysis in superset-functionality-issues.md confirmed the menu logic is correct, but the sessionRows prop containing group data isn't reaching ExerciseRowActions. The "S" key shortcut is mentioned in the footer but not implemented.

Output: ExerciseCell passes sessionRows to ExerciseRowActions; menu displays existing groups.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-program-builder-qa-and-bugs/03.3-RESEARCH.md
@.planning/debug/superset-functionality-issues.md
@apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
@apps/coach-web/src/components/programs/program-grid/exercise-row.tsx
@apps/coach-web/src/components/programs/exercise-row-actions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass sessionRows to ExerciseRowActions in ExerciseCell</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx</files>
  <action>
The ExerciseCell component receives sessionRows as a prop but does NOT pass it to ExerciseRowActions. Looking at the current code:

```typescript
// Line 157-163: ExerciseRowActions is rendered without sessionRows
<ExerciseRowActions
  programId={programId}
  sessionId={row.sessionId}
  rowId={row.id}
  exerciseName={row.exercise?.exerciseName ?? ''}
  sessionRowIds={sessionRowIds}
/>
```

But the ExerciseCell props already include sessionRows (line 21):
```typescript
sessionRows: SessionRowData[]
```

However, looking at exercise-cell.tsx more carefully, I see sessionRows is in the props interface but the component destructures it but doesn't use it:
```typescript
export function ExerciseCell({
  row,
  colId,
  programId,
  sessionRowIds,  // <-- This is used
  // sessionRows is NOT in the destructuring!
  isActive,
  ...
```

Fix: Add sessionRows to the destructuring and pass it to ExerciseRowActions:

```typescript
export function ExerciseCell({
  row,
  colId,
  programId,
  sessionRowIds,
  sessionRows,     // ADD THIS
  isActive,
  isEditing,
  onSelect,
  onStartEdit,
  onCommit,
  onCancel,
}: ExerciseCellProps) {
```

Then update the ExerciseRowActions usage:

```typescript
<ExerciseRowActions
  programId={programId}
  sessionId={row.sessionId}
  rowId={row.id}
  exerciseName={row.exercise?.exerciseName ?? ''}
  sessionRowIds={sessionRowIds}
  sessionRows={sessionRows}  // ADD THIS
/>
```

Also check ExerciseRowActionsProps in exercise-row-actions.tsx to ensure sessionRows is defined (it should already be there based on the debug analysis).
  </action>
  <verify>
1. Run `pnpm typecheck` - no TypeScript errors
2. Verify ExerciseCellProps includes sessionRows
3. Verify ExerciseRowActions receives sessionRows prop
  </verify>
  <done>ExerciseCell passes sessionRows to ExerciseRowActions.</done>
</task>

<task type="auto">
  <name>Task 2: Verify sessionRows contains superset group data and menu displays correctly</name>
  <files>
apps/coach-web/src/components/programs/program-grid/exercise-row.tsx
apps/coach-web/src/components/programs/program-grid/grid-body.tsx
  </files>
  <action>
Verify the data flow from grid-body.tsx through exercise-row.tsx to exercise-cell.tsx:

1. In grid-body.tsx (lines 54-66), sessionRowsData is collected with { id, groupId: row.supersetGroup }
2. This is passed to ExerciseRow as sessionRows prop (line 83)
3. ExerciseRow should pass sessionRows to ExerciseCell

Check exercise-row.tsx to ensure sessionRows is passed to ExerciseCell:

Looking at current exercise-row.tsx, I see sessionRows IS passed to ExerciseCell (line 64):
```typescript
sessionRows={sessionRows}
```

So the data flow is:
- grid-body.tsx collects sessionRowsData with groupId from row.supersetGroup
- Passes to ExerciseRow as sessionRows
- ExerciseRow passes to ExerciseCell as sessionRows
- BUT ExerciseCell doesn't destructure or use sessionRows (fixed in Task 1)

The fix in Task 1 should complete the chain. Verify:
1. grid-body.tsx: sessionRowsData.push({ id: row.id, groupId: row.supersetGroup })
2. exercise-row.tsx: sessionRows={sessionRows} passed to ExerciseCell
3. exercise-cell.tsx: sessionRows destructured and passed to ExerciseRowActions

If any of these are missing, add them.
  </action>
  <verify>
1. Run `pnpm typecheck` - verify no errors after Task 1 changes
2. Open program grid with existing superset exercises (or create one first if needed)
3. Click the three-dot menu on an exercise row
4. Navigate to the "Superserie" submenu
5. Verify menu shows existing groups (e.g., "Agregar a superserie A") if supersets exist
6. Verify menu shows "Crear superserie [next letter]" option
  </verify>
  <done>Data flow verified: sessionRows with groupId reaches ExerciseRowActions and menu displays correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Verify superset menu displays existing groups</name>
  <files>apps/coach-web/src/components/programs/exercise-row-actions.tsx</files>
  <action>
The superset menu logic in exercise-row-actions.tsx should already be correct (per debug analysis). With sessionRows now being passed correctly, the menu should show:

1. "Agregar a superserie A" (if group A exists)
2. "Agregar a superserie B" (if group B exists)
3. "Crear superserie [next letter]" (create new group)

Review the current implementation to ensure:
1. existingGroups is calculated from sessionRows (should be around lines 88-106)
2. Menu items are rendered for existing groups (should be around lines 207-219)
3. The current row's group is excluded from join options

If the menu logic is missing or incomplete, the expected pattern is:

```typescript
// Calculate existing groups in the session
const existingGroups = useMemo(() => {
  const groups = new Set<string>()
  for (const row of sessionRows) {
    if (row.groupId && row.id !== rowId) { // Exclude current row
      groups.add(row.groupId)
    }
  }
  return Array.from(groups).sort()
}, [sessionRows, rowId])

// Calculate next available letter
const usedLetters = new Set(existingGroups)
const nextLetter = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').find(l => !usedLetters.has(l)) ?? 'A'
```

Then in the menu:
```tsx
{/* Join existing groups */}
{existingGroups.map((group) => (
  <DropdownMenuItem key={group} onClick={() => handleJoinSuperset(group)}>
    Agregar a superserie {group}
  </DropdownMenuItem>
))}

{/* Create new group */}
<DropdownMenuItem onClick={() => handleCreateSuperset(nextLetter)}>
  Crear superserie {nextLetter}
</DropdownMenuItem>
```

NOTE: Based on the debug analysis, this logic should ALREADY exist but wasn't working because sessionRows was empty/undefined. With Task 1's fix, it should now work.

If the superset submenu or handlers are missing, they need to be added. Check if there's a superset section in the menu.
  </action>
  <verify>
1. Open program grid
2. Create a superset on one exercise (if possible via existing UI)
3. Open menu on a different exercise in same session
4. Verify menu shows "Agregar a superserie A" (or whatever letter was used)
5. Verify menu also shows "Crear superserie [next letter]"
  </verify>
  <done>Superset menu displays existing groups and option to create new group.</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no TypeScript errors
2. Run `pnpm lint` - no linting errors
3. Manual testing:
   - Open program grid with or without existing supersets
   - Click exercise row action menu
   - Verify superset options are visible
   - If supersets exist, verify "Agregar a superserie [letter]" options appear
   - Verify "Crear superserie [next letter]" appears
</verification>

<success_criteria>
- sessionRows with groupId data reaches ExerciseRowActions
- Superset menu shows existing groups when available
- Superset menu shows option to create new group
- Menu correctly excludes current row's group from join options
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-program-builder-qa-and-bugs/03.3-03-SUMMARY.md`
</output>
