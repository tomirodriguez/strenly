---
phase: 03.3-program-builder-qa-and-bugs
plan: 07
subsystem: program-builder
tags:
  - zustand
  - client-side-state
  - saveDraft
  - structural-changes
dependency-graph:
  requires:
    - 03.2-06 # Client-side state foundation
    - 03.3-02 # Add exercise local state
  provides:
    - addWeek and addSession store actions
    - Structural change tracking (newWeeks, newSessions, newExerciseRows)
    - saveDraft backend handling structural changes
    - Zero API calls during editing
  affects:
    - Future persistence of superset groups
tech-stack:
  added: []
  patterns:
    - tempId to realId mapping for structural changes
    - Transaction-based bulk save with dependency ordering
key-files:
  created: []
  modified:
    - apps/coach-web/src/stores/grid-store.ts
    - apps/coach-web/src/components/programs/grid-toolbar.tsx
    - apps/coach-web/src/components/programs/add-session-modal.tsx
    - apps/coach-web/src/components/programs/program-header.tsx
    - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
    - packages/contracts/src/programs/save-draft.ts
    - packages/core/src/ports/program-repository.port.ts
    - packages/backend/src/use-cases/programs/save-draft.ts
    - packages/backend/src/infrastructure/repositories/program.repository.ts
decisions:
  - id: structural-change-tracking
    choice: Track new weeks/sessions/exercises in separate Maps
    reason: Clear separation between updates to existing entities and creation of new entities
  - id: tempid-mapping
    choice: Build tempId -> realId map during transaction
    reason: New sessions reference new weeks, new exercises reference new sessions
  - id: dependency-order
    choice: Create weeks first, then sessions, then exercises
    reason: Foreign key constraints require parent entities to exist before children
metrics:
  duration: 5 min
  completed: 2026-01-26
---

# Phase 3.3 Plan 07: Client-Side Structural Changes Summary

**One-liner:** Zero API calls during Add Week/Session/Exercise; saveDraft persists all structural changes atomically with tempId resolution.

## Objective Achieved

Made ALL program builder operations client-side only with no API calls until explicit save. Previously, Add Week and Add Session triggered immediate API calls. Now all structural changes are tracked locally and persisted via a single saveDraft API call.

## Tasks Completed

| # | Task | Commit | Key Files |
|---|------|--------|-----------|
| 1 | Add week/session actions to grid store with change tracking | `18e7d46` | grid-store.ts |
| 2 | Wire toolbar and modal to store actions | `79fd8d1` | grid-toolbar.tsx, add-session-modal.tsx |
| 3 | Extend saveDraft backend to handle structural changes | `2a41a3c` | save-draft.ts (contracts, port, use-case, repository) |

## Implementation Details

### Grid Store Enhancements

Added three new tracking Maps to the Zustand store:
- `newWeeks: Map<string, NewWeek>` - Tracks weeks with tempId, name, orderIndex
- `newSessions: Map<string, NewSession>` - Tracks sessions with tempId, name, orderIndex
- `newExerciseRows: Map<string, NewExerciseRow>` - Tracks exercise rows with tempId, sessionId (may be tempId), exerciseId, orderIndex

Added two new actions:
- `addWeek()` - Creates new week column with auto-generated name "Semana N"
- `addSession(name)` - Creates session header row and add-exercise row

Updated `getChanges()` to return structural changes alongside prescription/exercise updates.

### Toolbar and Modal Updates

- Removed `useAddWeek` and `useAddSession` mutation hooks
- Removed `programId` prop from `GridToolbar` (no longer needed)
- Wired buttons directly to `useGridActions().addWeek` and `useGridActions().addSession`
- Modal no longer has loading state (instant local update)

### Backend saveDraft Extension

Extended the contracts with new schemas:
```typescript
newWeeks: z.array(newWeekSchema).default([])
newSessions: z.array(newSessionSchema).default([])
newExerciseRows: z.array(newExerciseRowSchema).default([])
```

Repository saveDraft now:
1. Creates new weeks first (columns)
2. Creates new sessions (resolving any tempId references)
3. Creates new exercise rows (resolving session tempIds)
4. Updates prescriptions (resolving tempIds in exerciseRowId and weekId)
5. Updates exercise rows (resolving tempIds)
6. Updates groups
7. Updates program.updatedAt

All operations use a `tempIdMap` to resolve client-generated tempIds to real database IDs.

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- Typecheck: PASS
- Lint: PASS
- Build: PASS
- All success criteria met:
  - Add week updates local state only (zero network requests)
  - Add session updates local state only (zero network requests)
  - Add exercise now tracked for persistence
  - Save button persists all structural changes in one API call
  - New weeks, sessions, exercises survive page refresh

## Known Limitations

- Superset groups are still not persisted (local-only display)
- Delete operations for weeks/sessions/exercises still use individual mutations
- Week/session reordering uses individual mutations

## Next Phase Readiness

Phase 3.3 is now complete. The program builder supports:
- Full client-side editing with explicit save
- Zero API calls during editing operations
- All structural changes (weeks, sessions, exercises) persist on save
- Prescription and exercise selection changes persist on save

Ready for Phase 4 (Athlete PWA).
