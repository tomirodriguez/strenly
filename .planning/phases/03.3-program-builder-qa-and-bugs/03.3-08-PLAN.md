---
phase: 03.3-program-builder-qa-and-bugs
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
  - apps/coach-web/src/hooks/use-debounced-value.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Exercise combobox search is debounced - rapid typing produces fewer API calls than keystrokes"
    - "API calls are delayed 300-500ms after user stops typing"
  artifacts:
    - path: "apps/coach-web/src/hooks/use-debounced-value.ts"
      provides: "Reusable debounce hook"
      exports: ["useDebouncedValue"]
    - path: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      provides: "Debounced exercise search"
      contains: "useDebouncedValue"
  key_links:
    - from: "apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx"
      to: "apps/coach-web/src/hooks/use-debounced-value.ts"
      via: "import useDebouncedValue"
      pattern: "useDebouncedValue"
---

<objective>
Add debounce to the exercise combobox search to prevent excessive API calls.

Currently, every keystroke in the exercise search input triggers an immediate API call. This floods the server with requests during rapid typing.

Purpose: Improve UX and reduce server load
Output: Exercise search debounced at 300ms
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-program-builder-qa-and-bugs/03.3-UAT.md

# Relevant source files
@apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDebouncedValue hook</name>
  <files>apps/coach-web/src/hooks/use-debounced-value.ts</files>
  <action>
Create a reusable debounce hook:

```typescript
import { useEffect, useState } from 'react'

/**
 * Debounce a value by delaying updates until a specified time has passed
 * without changes.
 *
 * @param value - The value to debounce
 * @param delay - Delay in milliseconds (default: 300ms)
 * @returns The debounced value
 *
 * @example
 * const [search, setSearch] = useState('')
 * const debouncedSearch = useDebouncedValue(search, 300)
 * // Use debouncedSearch in API calls
 */
export function useDebouncedValue<T>(value: T, delay = 300): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)

    return () => {
      clearTimeout(timer)
    }
  }, [value, delay])

  return debouncedValue
}
```

This follows the project convention of avoiding useEffect for business logic while using it appropriately for side effects (timers).
  </action>
  <verify>
1. Typecheck passes: `pnpm typecheck`
2. File exists at correct path
  </verify>
  <done>Reusable debounce hook created</done>
</task>

<task type="auto">
  <name>Task 2: Add debounce to exercise cell search</name>
  <files>apps/coach-web/src/components/programs/program-grid/exercise-cell.tsx</files>
  <action>
Update exercise-cell.tsx to use debounced search value:

```typescript
import { useState } from 'react'
import { ExerciseRowActions, type SessionRowData } from '../exercise-row-actions'
import { ExerciseRowPrefix } from './exercise-row-prefix'
import type { GridRow } from './types'
import {
  Combobox,
  ComboboxContent,
  ComboboxEmpty,
  ComboboxInput,
  ComboboxItem,
  ComboboxList,
} from '@/components/ui/combobox'
import { useExercises } from '@/features/exercises/hooks/queries/use-exercises'
import { useDebouncedValue } from '@/hooks/use-debounced-value'
import { cn } from '@/lib/utils'

// ... existing interface ...

export function ExerciseCell({
  row,
  colId,
  programId,
  sessionRowIds,
  sessionRows,
  isActive,
  isEditing,
  onSelect,
  onStartEdit,
  onCommit,
  onCancel,
}: ExerciseCellProps) {
  const [searchValue, setSearchValue] = useState('')
  // Debounce search to prevent excessive API calls
  const debouncedSearch = useDebouncedValue(searchValue, 300)

  const { data: exercisesData } = useExercises({
    search: debouncedSearch || undefined,  // Use debounced value for API
    limit: 10,
  })

  // ... rest of component unchanged ...
}
```

Key changes:
1. Import `useDebouncedValue` from hooks
2. Create `debouncedSearch` from `searchValue` with 300ms delay
3. Pass `debouncedSearch` (not `searchValue`) to `useExercises`

The input still updates immediately (responsive typing), but API calls are debounced.
  </action>
  <verify>
1. Typecheck passes: `pnpm typecheck`
2. Lint passes: `pnpm lint`
3. Build passes: `pnpm --filter @strenly/coach-web build`
4. Manual test:
   - Open program grid, double-click exercise cell to edit
   - Open DevTools Network tab, filter by "exercise"
   - Type "bench press" rapidly
   - Verify: API calls are debounced (fewer calls than keystrokes)
   - Verify: Results still appear after debounce delay
  </verify>
  <done>Exercise combobox search is debounced at 300ms</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build and lint:**
   ```bash
   pnpm typecheck && pnpm lint && pnpm --filter @strenly/coach-web build
   ```

2. **Debounce test (Test 12):**
   - Open a program in the grid
   - Double-click any exercise cell to enter edit mode
   - Open DevTools Network tab, filter by "exercises" or "Fetch/XHR"
   - Type "bench press" rapidly (10+ keystrokes in under 1 second)
   - Verify: Only 1-2 API calls made (not 10+)
   - Verify: Results appear after ~300ms pause in typing
   - Verify: Selecting an exercise still works correctly

3. **UX preserved:**
   - Input text updates immediately (responsive feel)
   - Results appear after short delay (acceptable UX)
   - Escape cancels edit mode
   - Selecting exercise commits correctly
</verification>

<success_criteria>
- [ ] useDebouncedValue hook exists and is typed correctly
- [ ] Exercise search uses debounced value for API calls
- [ ] Rapid typing produces fewer API calls than keystrokes
- [ ] Results still appear after debounce delay
- [ ] Build passes with no TypeScript errors
- [ ] Lint passes with no Biome errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-program-builder-qa-and-bugs/03.3-08-SUMMARY.md`
</output>
