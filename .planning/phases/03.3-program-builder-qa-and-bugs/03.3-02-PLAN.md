---
phase: 03.3-program-builder-qa-and-bugs
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/stores/grid-store.ts
  - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
  - apps/coach-web/src/components/programs/program-grid/add-exercise-row.tsx
  - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
autonomous: true

must_haves:
  truths:
    - "Add exercise operation updates local Zustand store without server call until Guardar is clicked"
    - "Grid shows new exercise row immediately after adding (optimistic local update)"
  artifacts:
    - path: "apps/coach-web/src/stores/grid-store.ts"
      provides: "addExercise action for client-side state management"
      contains: "addExercise:"
    - path: "apps/coach-web/src/components/programs/program-grid/program-grid.tsx"
      provides: "Grid uses store action for add exercise instead of server mutation"
      contains: "onAddExercise"
  key_links:
    - from: "program-grid.tsx"
      to: "grid-store.ts"
      via: "onAddExercise prop calling store action"
      pattern: "onAddExercise|addExercise"
    - from: "$programId.tsx"
      to: "grid-store.ts"
      via: "passing store.addExercise to grid"
      pattern: "addExercise"
---

<objective>
Make "add exercise" operation update local Zustand store instead of making server calls. The exercise should appear immediately in the grid, and isDirty should become true.

Purpose: Phase 3.2 established client-side state for prescription and exercise changes, but "add exercise" still calls the server immediately. This breaks the "edit locally, save explicitly" paradigm and causes unnecessary API calls.

Output: Updated grid-store.ts with addExercise action, grid components using store action instead of mutation hook.

**Scope Limitation:** Added exercises are tracked in local state and will appear in the UI, but saveDraft backend currently does NOT persist new exercises. This is a known limitation - on save/refresh, only prescription changes and exercise row updates are persisted. Full structural changes (add week/session/exercise) require backend extension in a future phase.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-program-builder-qa-and-bugs/03.3-RESEARCH.md
@apps/coach-web/src/stores/grid-store.ts
@apps/coach-web/src/components/programs/program-grid/program-grid.tsx
@apps/coach-web/src/components/programs/program-grid/add-exercise-row.tsx
@apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
@apps/coach-web/src/components/programs/program-grid/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add addExercise action to Zustand store</name>
  <files>apps/coach-web/src/stores/grid-store.ts</files>
  <action>
Extend the Zustand store with an `addExercise` action that:
1. Creates a new exercise row with a temporary ID (temp-row-{timestamp})
2. Inserts the row at the end of the specified session's exercises
3. Creates empty prescription entries for all existing weeks
4. Sets isDirty to true (but does NOT track for persistence - see limitation note)

Add to GridActions interface:
```typescript
addExercise: (sessionId: string, exerciseId: string, exerciseName: string) => void
```

Implement the action:
```typescript
addExercise: (sessionId, exerciseId, exerciseName) =>
  set((state) => {
    if (!state.data) return state

    const tempId = `temp-row-${Date.now()}`

    // Get all week IDs for creating empty prescriptions
    const weekIds = state.data.columns
      .filter((col) => col.type === 'week' && col.weekId)
      .map((col) => col.weekId as string)

    // Create empty prescriptions map
    const prescriptions: Record<string, string> = {}
    for (const weekId of weekIds) {
      prescriptions[weekId] = ''
    }

    // Find the session's rows to determine position
    const sessionRows = state.data.rows.filter(
      (row) => row.type === 'exercise' && row.sessionId === sessionId
    )
    const orderIndex = sessionRows.length

    // Create new row
    const newRow: GridRow = {
      id: tempId,
      type: 'exercise',
      sessionId,
      sessionName: '', // Not needed for display
      exercise: {
        exerciseId,
        exerciseName,
        position: orderIndex,
      },
      supersetGroup: null,
      supersetOrder: null,
      supersetPosition: null,
      groupLetter: undefined, // Will be calculated on next transform
      groupIndex: undefined,
      isSubRow: false,
      parentRowId: null,
      setTypeLabel: null,
      prescriptions,
    }

    // Find where to insert (before the add-exercise row for this session)
    const insertIndex = state.data.rows.findIndex(
      (row) => row.type === 'add-exercise' && row.sessionId === sessionId
    )

    const updatedRows = [...state.data.rows]
    if (insertIndex >= 0) {
      updatedRows.splice(insertIndex, 0, newRow)
    } else {
      // Fallback: add at end
      updatedRows.push(newRow)
    }

    return {
      data: { ...state.data, rows: updatedRows },
      isDirty: true,
      // NOTE: We intentionally do NOT add to a tracking array here
      // because saveDraft backend does not yet support persisting new exercises.
      // This is a known limitation - the row appears locally but won't survive save/refresh.
    }
  }),
```

Update initialize, reset to NOT clear any addedExercises array (we're not tracking them).

Also add addExercise to the useGridActions selector.

Note: Import GridRow type from './components/programs/program-grid/types'.
  </action>
  <verify>
1. Run `pnpm typecheck` - no errors
2. Store interface should include addExercise action
  </verify>
  <done>Zustand store has addExercise action that creates local row with temp ID.</done>
</task>

<task type="auto">
  <name>Task 2: Wire grid to use store action instead of server mutation</name>
  <files>
apps/coach-web/src/components/programs/program-grid/program-grid.tsx
apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
  </files>
  <action>
**In program-grid.tsx:**

1. Add new prop for onAddExercise that accepts store action:
```typescript
interface ProgramGridProps {
  // ... existing props
  /**
   * Handler for adding exercises - receives sessionId, exerciseId, exerciseName.
   * When provided, uses local state instead of server mutation.
   * NOTE: Local-only until saveDraft backend supports structural changes.
   */
  onAddExercise?: (sessionId: string, exerciseId: string, exerciseName: string) => void
}
```

2. Update handleAddExercise to use the prop if provided, falling back to server mutation:
```typescript
// Handle add exercise
const handleAddExercise = (sessionId: string, exerciseId: string, exerciseName: string) => {
  if (onAddExercise) {
    // Local state mode - use store action
    onAddExercise(sessionId, exerciseId, exerciseName)
  } else {
    // Server mutation mode (legacy fallback)
    addExerciseRow.mutate({
      sessionId,
      exerciseId,
    })
  }
}
```

**In $programId.tsx:**

1. Update the useGridActions to include addExercise:
```typescript
const actions = useGridActions()
// actions now includes: initialize, updatePrescription, updateExercise, reset, markSaved, getChanges, addExercise
```

2. Pass addExercise to ProgramGrid:
```typescript
<ProgramGrid
  program={program}
  gridData={gridData}
  onPrescriptionChange={actions.updatePrescription}
  onExerciseChange={actions.updateExercise}
  onAddExercise={actions.addExercise}
/>
```
  </action>
  <verify>
1. Run `pnpm typecheck` - no errors
2. Open program editor page
3. Click "Agregar ejercicio" row, select an exercise
4. Verify exercise appears immediately in grid (optimistic update)
5. Verify NO network request is made to add exercise (check Network tab)
6. The isDirty state should be true (Guardar button enabled)
7. Click Guardar - verify prescription changes save but note the added exercise will NOT persist (known limitation)
  </verify>
  <done>Add exercise uses Zustand store for local update, no immediate server call. Known limitation: not persisted on save.</done>
</task>

<task type="auto">
  <name>Task 3: Update AddExerciseRow to clear search after selection</name>
  <files>apps/coach-web/src/components/programs/program-grid/add-exercise-row.tsx</files>
  <action>
The AddExerciseRow component already clears searchValue after selection (line 42). However, ensure the combobox properly closes after selection.

Review the current implementation and verify:
1. Search value is cleared after selection
2. Combobox closes after selection
3. The new row appears below without issues

If the combobox doesn't close properly, wrap the selection in a setTimeout or use the onOpenChange callback to ensure proper closure:

```typescript
const handleSelect = (exerciseId: string | null) => {
  if (!exerciseId) return
  const exercise = exercises.find((e) => e.id === exerciseId)
  if (exercise) {
    onAddExercise(sessionId, exercise.id, exercise.name)
    setSearchValue('')
  }
}
```

This should already be working correctly. The main change was in Task 2 - the handler now calls the store action.
  </action>
  <verify>
1. Add an exercise using the "Agregar ejercicio" row
2. Verify search input clears after selection
3. Verify combobox closes
4. Verify new exercise row appears in the correct position (above the add row)
  </verify>
  <done>AddExerciseRow properly clears state and closes combobox after selection.</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no TypeScript errors
2. Run `pnpm lint` - no linting errors
3. Manual testing:
   - Add exercise via "Agregar ejercicio" row
   - Verify exercise appears immediately in grid
   - Check Network tab - NO server call for add exercise
   - Verify Guardar button shows "Guardar cambios" (isDirty = true)
   - Edit a prescription in the new row
   - Verify prescription change is tracked
</verification>

<success_criteria>
- Adding exercise updates local state immediately (no server call)
- New exercise row appears in correct position within session
- New row has empty prescriptions for all weeks
- isDirty becomes true after adding exercise
- **Known limitation documented:** Added exercises are not persisted by saveDraft - they appear locally but won't survive save/refresh. Full persistence requires backend extension in future phase.
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-program-builder-qa-and-bugs/03.3-02-SUMMARY.md`
</output>
