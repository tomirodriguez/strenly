---
phase: 03.3-program-builder-qa-and-bugs
plan: 02
subsystem: program-builder
tags: [zustand, add-exercise, local-state, client-side-editing]
dependencies:
  requires:
    - 03.2-06 # Client-side state with Zustand
    - 03.2-07 # Grid integration
  provides:
    - addExercise action in Zustand store
    - Local add exercise operation without server call
  affects:
    - Future backend extension for structural changes
tech-stack:
  added: []
  patterns:
    - Zustand action for grid mutations
    - Prop-based mode switching (local vs server)
key-files:
  created: []
  modified:
    - apps/coach-web/src/stores/grid-store.ts
    - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
    - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
decisions:
  - id: add-exercise-local-only
    choice: "Add exercise updates local state without persistence"
    rationale: "saveDraft backend does not support structural changes; allows immediate UI feedback while deferring full persistence to future phase"
metrics:
  duration: 4 min
  completed: 2026-01-26
---

# Phase 03.3 Plan 02: Add Exercise Uses Local State Summary

**One-liner:** addExercise Zustand action for immediate grid update without server call, known limitation on persistence

## What Was Done

1. **Added addExercise action to Zustand store** - Creates new exercise row with temp-{timestamp} ID, empty prescriptions for all weeks, inserts before add-exercise row

2. **Wired grid to use store action** - Added onAddExercise prop to ProgramGrid, falls back to server mutation if not provided

3. **Verified AddExerciseRow behavior** - Confirmed search clears after selection, combobox closes properly (no changes needed)

## Key Artifacts

| File | Purpose |
|------|---------|
| `apps/coach-web/src/stores/grid-store.ts` | addExercise action in GridActions interface and implementation |
| `apps/coach-web/src/components/programs/program-grid/program-grid.tsx` | onAddExercise prop and handleAddExercise logic |
| `apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx` | Passes actions.addExercise to ProgramGrid |

## Commits

| Hash | Description |
|------|-------------|
| 4142830 | feat(03.3-02): add addExercise action to Zustand store |
| 3786c07 | feat(03.3-02): wire grid to use store action for add exercise |

## Decisions Made

### Add Exercise Local-Only

**Decision:** Add exercise updates local state without persistence to server

**Rationale:** The saveDraft backend currently only handles prescription and exercise row updates, not structural changes (add week/session/exercise). Rather than block on backend extension, we enable immediate UI feedback with a known limitation.

**Implication:** Added exercises appear in the grid immediately and isDirty becomes true, but on save/refresh, only prescription changes persist. Full structural persistence requires backend extension in a future phase.

## Deviations from Plan

None - plan executed exactly as written.

## Known Limitations

- **Added exercises not persisted by saveDraft:** The row appears locally but won't survive save/refresh. The saveDraft backend must be extended to support structural changes in a future phase.
- **No tracking array for added exercises:** Since persistence isn't supported yet, we don't track added exercises separately.

## Verification

- TypeScript compiles without errors
- Biome linting passes
- Add exercise creates local row immediately
- No network request on add exercise
- isDirty becomes true after adding exercise

## Next Phase Readiness

This plan completes the client-side transition for add exercise. The following is ready for future work:

- Backend extension to saveDraft for persisting new exercises
- Full structural change support (add/delete week, session, exercise)
