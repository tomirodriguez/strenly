---
phase: 03.3-program-builder-qa-and-bugs
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
  - apps/coach-web/src/stores/grid-store.ts
  - apps/coach-web/src/components/programs/exercise-row-actions.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Arrow keys in edit mode move cursor within input text, not navigate to adjacent cells"
    - "Superset menu updates client-side state using letters (A, B, C) without backend calls"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx"
      provides: "Arrow key propagation prevention in edit mode"
      contains: "stopPropagation"
    - path: "apps/coach-web/src/stores/grid-store.ts"
      provides: "updateSupersetGroup action for local state"
      contains: "updateSupersetGroup"
    - path: "apps/coach-web/src/components/programs/exercise-row-actions.tsx"
      provides: "Menu actions using store instead of backend mutation"
      contains: "useGridStore"
  key_links:
    - from: "prescription-cell.tsx handleKeyDown"
      to: "use-grid-navigation.ts handleKeyDown"
      via: "stopPropagation prevents bubbling"
      pattern: "e\\.stopPropagation\\(\\)"
    - from: "exercise-row-actions.tsx handleSetSupersetGroup"
      to: "grid-store.ts updateSupersetGroup"
      via: "store action call"
      pattern: "updateSupersetGroup\\("
---

<objective>
Fix two UAT gaps from Phase 3.3 verification:
1. Arrow keys in edit mode should move cursor within text, not navigate grid
2. Superset menu should use client-side state with letters (A, B, C), not backend calls with UUIDs

Purpose: Complete the client-side editing model established in Phase 3.2
Output: Working edit mode cursor navigation and local superset grouping
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key existing code:
@apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
@apps/coach-web/src/components/programs/program-grid/use-grid-navigation.ts
@apps/coach-web/src/stores/grid-store.ts
@apps/coach-web/src/components/programs/exercise-row-actions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix arrow key propagation in prescription cell edit mode</name>
  <files>apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
In the handleKeyDown function (lines 93-110), add e.stopPropagation() for ArrowLeft and ArrowRight cases when the cursor is NOT at a boundary.

Current behavior: When cursor is mid-text, arrow keys do NOT call preventDefault but still bubble to grid's handleKeyDown, which unconditionally calls preventDefault and navigates.

Fix: Add e.stopPropagation() in the else branch (non-boundary cases) to prevent bubbling to grid navigation.

```typescript
case 'ArrowLeft':
  if (inputRef.current?.selectionStart === 0 && inputRef.current?.selectionEnd === 0) {
    e.preventDefault()
    onCommit(editValue)
    onNavigate('left')
  } else {
    // Cursor not at boundary - stop propagation to prevent grid navigation
    e.stopPropagation()
  }
  break
case 'ArrowRight':
  if (inputRef.current?.selectionStart === editValue.length) {
    e.preventDefault()
    onCommit(editValue)
    onNavigate('right')
  } else {
    // Cursor not at boundary - stop propagation to prevent grid navigation
    e.stopPropagation()
  }
  break
```

This allows the browser's default cursor movement while preventing the event from reaching the grid's navigation handler.
  </action>
  <verify>
1. Run `pnpm typecheck` - should pass
2. Manual test: In program grid, double-click a prescription cell with text, use arrow keys to move cursor within text - cursor should move, NOT navigate to adjacent cell
  </verify>
  <done>Arrow keys in edit mode move cursor within text unless at boundary</done>
</task>

<task type="auto">
  <name>Task 2: Add updateSupersetGroup action to grid store</name>
  <files>apps/coach-web/src/stores/grid-store.ts</files>
  <action>
Add a new action `updateSupersetGroup` to the grid store that updates a row's superset group in local state.

1. Add to GridActions interface:
```typescript
// Update a row's superset group (letters A, B, C - local only)
updateSupersetGroup: (rowId: string, groupLetter: string | null) => void
```

2. Add to useGridActions selector:
```typescript
updateSupersetGroup: state.updateSupersetGroup,
```

3. Implement the action:
```typescript
updateSupersetGroup: (rowId, groupLetter) =>
  set((state) => {
    if (!state.data) return state

    const updatedRows = state.data.rows.map((row) => {
      if (row.type === 'exercise' && row.id === rowId) {
        return {
          ...row,
          supersetGroup: groupLetter,
          groupLetter: groupLetter ?? undefined,
        }
      }
      return row
    })

    return {
      data: { ...state.data, rows: updatedRows },
      isDirty: true,
    }
  }),
```

Note: This updates local state only. The saveDraft endpoint does NOT currently persist superset groups - that's a known limitation for a future phase. The groupLetter is stored for visual display; actual database persistence requires backend extension.
  </action>
  <verify>
1. Run `pnpm typecheck` - should pass
2. Verify updateSupersetGroup is exported in useGridActions
  </verify>
  <done>Grid store has updateSupersetGroup action for local superset changes</done>
</task>

<task type="auto">
  <name>Task 3: Wire exercise row actions to use store instead of backend</name>
  <files>apps/coach-web/src/components/programs/exercise-row-actions.tsx</files>
  <action>
Modify exercise-row-actions.tsx to use the grid store's updateSupersetGroup action instead of the backend mutation.

1. Import grid store:
```typescript
import { useGridStore } from '@/stores/grid-store'
```

2. Remove the updateExerciseRow mutation import and usage (lines 32-33, 76):
- Remove: `import { useUpdateExerciseRow } from '@/features/programs/hooks/mutations/use-grid-mutations'`
- Remove: `const updateExerciseRow = useUpdateExerciseRow(programId)`

3. Get the store action:
```typescript
const updateSupersetGroup = useGridStore((state) => state.updateSupersetGroup)
```

4. Update handleSetSupersetGroup to use store action (lines 134-137):
```typescript
const handleSetSupersetGroup = (group: string | null) => {
  updateSupersetGroup(rowId, group)
  setOpen(false)
}
```

This change ensures:
- Superset changes are local-only (no backend calls)
- Groups use letters (A, B, C) which is what the UI displays
- Changes are tracked as dirty and will persist when saveDraft is extended
  </action>
  <verify>
1. Run `pnpm typecheck` - should pass
2. Run `pnpm lint` - should pass
3. Manual test: Open superset menu on a row, select "Crear superserie A", verify:
   - No network request is made
   - Row shows letter A in the prefix
   - Save button shows unsaved changes indicator
  </verify>
  <done>Superset menu uses client-side state with letter groups, no backend calls</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Arrow keys in edit mode move cursor (not navigate grid) until boundary
4. Superset menu updates local state with letters, no network calls
</verification>

<success_criteria>
- Arrow keys in prescription cell edit mode move cursor within text
- At text boundaries, arrow keys commit and navigate to adjacent cell
- Superset menu "Crear superserie" updates row with letter (A, B, C)
- No backend calls when changing superset groups
- Save button shows dirty state after superset changes
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-program-builder-qa-and-bugs/03.3-05-SUMMARY.md`
</output>
