---
phase: 02.5-coach-web-foundation
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/contracts/src/athletes/invitation.ts
  - packages/backend/src/use-cases/athletes/get-athlete-invitation.ts
  - packages/backend/src/procedures/athletes/get-athlete-invitation.ts
  - packages/backend/src/procedures/athletes/index.ts
  - apps/coach-web/src/features/athletes/hooks/queries/use-athlete-invitation.ts
  - apps/coach-web/src/features/athletes/components/invitation-modal.tsx
  - apps/coach-web/src/features/athletes/components/athletes-table.tsx
  - apps/coach-web/src/features/athletes/views/athletes-view.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Coach can view existing invitation link for an athlete"
    - "Coach can copy invitation URL to clipboard"
    - "Coach can regenerate invitation from the modal"
    - "Modal shows invitation status and expiration"
  artifacts:
    - path: "packages/contracts/src/athletes/invitation.ts"
      provides: "getAthleteInvitation schema with full invitation data"
      exports: ["getAthleteInvitationOutputSchema"]
    - path: "packages/backend/src/use-cases/athletes/get-athlete-invitation.ts"
      provides: "Use case to fetch athlete invitation"
      exports: ["makeGetAthleteInvitation"]
    - path: "packages/backend/src/procedures/athletes/get-athlete-invitation.ts"
      provides: "Procedure to get invitation"
      exports: ["getAthleteInvitation"]
    - path: "apps/coach-web/src/features/athletes/components/invitation-modal.tsx"
      provides: "Modal to view/copy/regenerate invitation"
      min_lines: 80
  key_links:
    - from: "invitation-modal.tsx"
      to: "use-athlete-invitation.ts"
      via: "useAthleteInvitation query hook"
      pattern: "useAthleteInvitation"
    - from: "invitation-modal.tsx"
      to: "use-generate-invitation.ts"
      via: "regenerate button uses existing mutation"
      pattern: "useGenerateInvitation"
    - from: "athletes-table.tsx"
      to: "invitation-modal.tsx"
      via: "Ver invitacion row action"
      pattern: "onViewInvitation"
---

<objective>
Add ability to view and manage existing athlete invitations.

Purpose: Close UAT gap 2 - coaches cannot access previously generated invitation links.
Output: Modal showing invitation URL, status, expiration with copy and regenerate actions.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.5-coach-web-foundation/02.5-UAT.md
@packages/contracts/src/athletes/invitation.ts
@packages/backend/src/procedures/athletes/generate-invitation.ts
@packages/core/src/ports/athlete-invitation-repository.port.ts
@apps/coach-web/src/features/athletes/components/athletes-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAthleteInvitation contract and backend</name>
  <skills>/contracts, /use-case, /procedure</skills>
  <files>
    packages/contracts/src/athletes/invitation.ts
    packages/backend/src/use-cases/athletes/get-athlete-invitation.ts
    packages/backend/src/procedures/athletes/get-athlete-invitation.ts
    packages/backend/src/procedures/athletes/index.ts
  </files>
  <action>
    **1. Add schema to contracts (invitation.ts):**

    Add after `generateInvitationOutputSchema`:

    ```typescript
    /**
     * Get athlete invitation output schema
     * Returns full invitation details for viewing
     */
    export const getAthleteInvitationOutputSchema = z.object({
      id: z.string(),
      athleteId: z.string(),
      invitationUrl: z.string(),
      status: z.enum(['pending', 'accepted', 'expired', 'revoked']),
      expiresAt: z.string(), // ISO date string
      createdAt: z.string(), // ISO date string
      acceptedAt: z.string().nullable(),
    })

    export type GetAthleteInvitationOutput = z.infer<typeof getAthleteInvitationOutputSchema>
    ```

    **2. Create use case (get-athlete-invitation.ts):**

    ```typescript
    import { ok, err, ResultAsync } from 'neverthrow'
    import type { AthleteInvitationRepositoryPort, AthleteRepositoryPort } from '@strenly/core'
    import { hasPermission } from '@strenly/core'

    type Dependencies = {
      athleteRepository: AthleteRepositoryPort
      invitationRepository: AthleteInvitationRepositoryPort
      appUrl: string
    }

    type Input = {
      organizationId: string
      userId: string
      memberRole: string
      athleteId: string
    }

    type GetAthleteInvitationError =
      | { type: 'forbidden' }
      | { type: 'athlete_not_found' }
      | { type: 'no_invitation' }
      | { type: 'repository_error'; message: string }

    type InvitationResult = {
      id: string
      athleteId: string
      invitationUrl: string
      status: 'pending' | 'accepted' | 'expired' | 'revoked'
      expiresAt: Date
      createdAt: Date
      acceptedAt: Date | null
    }

    export function makeGetAthleteInvitation(deps: Dependencies) {
      return (input: Input): ResultAsync<InvitationResult, GetAthleteInvitationError> => {
        // 1. Authorization check
        if (!hasPermission(input.memberRole, 'athlete:read')) {
          return ResultAsync.fromSafePromise(Promise.resolve(err({ type: 'forbidden' as const })))
        }

        const ctx = { organizationId: input.organizationId }

        // 2. Verify athlete exists and belongs to org
        return deps.athleteRepository
          .findById(ctx, input.athleteId)
          .mapErr((e) => ({ type: 'repository_error' as const, message: e.type }))
          .andThen((athlete) => {
            if (!athlete) {
              return err({ type: 'athlete_not_found' as const })
            }
            return ok(athlete)
          })
          .andThen(() => {
            // 3. Get active invitation
            return deps.invitationRepository
              .findByAthleteId(ctx, input.athleteId)
              .mapErr((e) => ({ type: 'repository_error' as const, message: e.type }))
          })
          .andThen((invitation) => {
            if (!invitation) {
              return err({ type: 'no_invitation' as const })
            }

            // Determine status
            let status: 'pending' | 'accepted' | 'expired' | 'revoked' = 'pending'
            if (invitation.acceptedAt) {
              status = 'accepted'
            } else if (invitation.revokedAt) {
              status = 'revoked'
            } else if (invitation.expiresAt < new Date()) {
              status = 'expired'
            }

            return ok({
              id: invitation.id,
              athleteId: invitation.athleteId,
              invitationUrl: `${deps.appUrl}/invite/${invitation.token}`,
              status,
              expiresAt: invitation.expiresAt,
              createdAt: invitation.createdAt,
              acceptedAt: invitation.acceptedAt,
            })
          })
      }
    }
    ```

    **3. Create procedure (get-athlete-invitation.ts):**

    ```typescript
    import { getAthleteInvitationOutputSchema } from '@strenly/contracts/athletes/invitation'
    import { z } from 'zod'
    import { createAthleteRepository } from '../../infrastructure/repositories/athlete.repository'
    import { createAthleteInvitationRepository } from '../../infrastructure/repositories/athlete-invitation.repository'
    import { authProcedure } from '../../lib/orpc'
    import { makeGetAthleteInvitation } from '../../use-cases/athletes/get-athlete-invitation'

    export const getAthleteInvitation = authProcedure
      .input(z.object({ athleteId: z.string() }))
      .output(getAthleteInvitationOutputSchema)
      .errors({
        FORBIDDEN: { message: 'No tienes permisos para ver invitaciones' },
        ATHLETE_NOT_FOUND: { message: 'Atleta no encontrado' },
        NO_INVITATION: { message: 'No hay invitacion activa para este atleta' },
      })
      .handler(async ({ input, context, errors }) => {
        const useCase = makeGetAthleteInvitation({
          athleteRepository: createAthleteRepository(context.db),
          invitationRepository: createAthleteInvitationRepository(context.db),
          appUrl: process.env.APP_URL ?? 'http://localhost:3000',
        })

        const result = await useCase({
          organizationId: context.organization.id,
          userId: context.user.id,
          memberRole: context.membership.role,
          athleteId: input.athleteId,
        })

        if (result.isErr()) {
          switch (result.error.type) {
            case 'forbidden':
              throw errors.FORBIDDEN()
            case 'athlete_not_found':
              throw errors.ATHLETE_NOT_FOUND()
            case 'no_invitation':
              throw errors.NO_INVITATION()
            case 'repository_error':
              console.error('Repository error:', result.error.message)
              throw new Error('Internal error')
          }
        }

        const inv = result.value
        return {
          id: inv.id,
          athleteId: inv.athleteId,
          invitationUrl: inv.invitationUrl,
          status: inv.status,
          expiresAt: inv.expiresAt.toISOString(),
          createdAt: inv.createdAt.toISOString(),
          acceptedAt: inv.acceptedAt?.toISOString() ?? null,
        }
      })
    ```

    **4. Register in router (index.ts):**

    Add import and route:
    ```typescript
    import { getAthleteInvitation } from './get-athlete-invitation'
    // In router:
    getInvitation: getAthleteInvitation,
    ```
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm --filter @strenly/backend build` succeeds.
  </verify>
  <done>
    Backend procedure returns full invitation details with URL, status, expiration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add invitation modal and table action</name>
  <skills>/orpc-query, /frontend-design</skills>
  <files>
    apps/coach-web/src/features/athletes/hooks/queries/use-athlete-invitation.ts
    apps/coach-web/src/features/athletes/components/invitation-modal.tsx
    apps/coach-web/src/features/athletes/components/athletes-table.tsx
    apps/coach-web/src/features/athletes/views/athletes-view.tsx
  </files>
  <action>
    **1. Create query hook (use-athlete-invitation.ts):**

    ```typescript
    import { useQuery } from '@tanstack/react-query'
    import { orpc } from '@/lib/api-client'

    export const invitationKeys = {
      all: ['invitations'] as const,
      detail: (athleteId: string) => [...invitationKeys.all, athleteId] as const,
    }

    export function useAthleteInvitation(athleteId: string | null) {
      return useQuery({
        ...orpc.athletes.getInvitation.queryOptions({ input: { athleteId: athleteId ?? '' } }),
        queryKey: invitationKeys.detail(athleteId ?? ''),
        enabled: !!athleteId,
      })
    }
    ```

    **2. Create invitation modal (invitation-modal.tsx):**

    ```typescript
    import type { Athlete } from '@strenly/contracts/athletes/athlete'
    import { format, formatDistanceToNow } from 'date-fns'
    import { es } from 'date-fns/locale'
    import { Check, Copy, RefreshCw } from 'lucide-react'
    import { useState } from 'react'
    import { useAthleteInvitation } from '../hooks/queries/use-athlete-invitation'
    import { useGenerateInvitation } from '../hooks/mutations/use-generate-invitation'
    import { Badge } from '@/components/ui/badge'
    import { Button } from '@/components/ui/button'
    import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
    import { toast } from '@/lib/toast'

    type InvitationModalProps = {
      athlete: Athlete | null
      open: boolean
      onOpenChange: (open: boolean) => void
    }

    const STATUS_LABELS: Record<string, { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline' }> = {
      pending: { label: 'Pendiente', variant: 'secondary' },
      accepted: { label: 'Aceptada', variant: 'default' },
      expired: { label: 'Expirada', variant: 'outline' },
      revoked: { label: 'Revocada', variant: 'destructive' },
    }

    export function InvitationModal({ athlete, open, onOpenChange }: InvitationModalProps) {
      const [copied, setCopied] = useState(false)
      const { data: invitation, isLoading, error, refetch } = useAthleteInvitation(athlete?.id ?? null)
      const generateMutation = useGenerateInvitation()

      const handleCopy = async () => {
        if (!invitation?.invitationUrl) return
        try {
          await navigator.clipboard.writeText(invitation.invitationUrl)
          setCopied(true)
          toast.success('Link copiado al portapapeles')
          setTimeout(() => setCopied(false), 2000)
        } catch {
          toast.error('No se pudo copiar el link')
        }
      }

      const handleRegenerate = () => {
        if (!athlete) return
        generateMutation.mutate(
          { athleteId: athlete.id },
          {
            onSuccess: () => {
              refetch()
            },
          },
        )
      }

      const statusInfo = invitation ? STATUS_LABELS[invitation.status] : null

      return (
        <Dialog open={open} onOpenChange={onOpenChange}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Invitacion para {athlete?.name}</DialogTitle>
            </DialogHeader>

            {isLoading && <p className="text-muted-foreground text-sm">Cargando...</p>}

            {error && (
              <div className="space-y-4">
                <p className="text-muted-foreground text-sm">No hay invitacion activa para este atleta.</p>
                <Button onClick={handleRegenerate} disabled={generateMutation.isPending}>
                  <RefreshCw className={`mr-2 h-4 w-4 ${generateMutation.isPending ? 'animate-spin' : ''}`} />
                  Generar invitacion
                </Button>
              </div>
            )}

            {invitation && (
              <div className="space-y-4">
                <div className="flex items-center gap-2">
                  <span className="text-muted-foreground text-sm">Estado:</span>
                  {statusInfo && <Badge variant={statusInfo.variant}>{statusInfo.label}</Badge>}
                </div>

                <div className="space-y-1">
                  <span className="text-muted-foreground text-sm">Expira:</span>
                  <p className="text-sm">
                    {format(new Date(invitation.expiresAt), "d 'de' MMMM, yyyy", { locale: es })}
                    <span className="text-muted-foreground ml-1">
                      ({formatDistanceToNow(new Date(invitation.expiresAt), { addSuffix: true, locale: es })})
                    </span>
                  </p>
                </div>

                <div className="space-y-2">
                  <span className="text-muted-foreground text-sm">Link de invitacion:</span>
                  <div className="bg-muted flex items-center gap-2 rounded-md p-2">
                    <code className="flex-1 truncate text-xs">{invitation.invitationUrl}</code>
                    <Button size="sm" variant="ghost" onClick={handleCopy}>
                      {copied ? <Check className="h-4 w-4 text-green-500" /> : <Copy className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>

                {invitation.status !== 'accepted' && (
                  <Button variant="outline" onClick={handleRegenerate} disabled={generateMutation.isPending}>
                    <RefreshCw className={`mr-2 h-4 w-4 ${generateMutation.isPending ? 'animate-spin' : ''}`} />
                    Regenerar invitacion
                  </Button>
                )}

                {invitation.status === 'accepted' && invitation.acceptedAt && (
                  <p className="text-muted-foreground text-sm">
                    Aceptada el {format(new Date(invitation.acceptedAt), "d 'de' MMMM, yyyy", { locale: es })}
                  </p>
                )}
              </div>
            )}
          </DialogContent>
        </Dialog>
      )
    }
    ```

    **3. Update athletes-table.tsx:**

    Add `onViewInvitation` prop to `AthletesTableProps`:
    ```typescript
    type AthletesTableProps = {
      // ... existing props
      onViewInvitation: (athlete: Athlete) => void
    }
    ```

    Add new row action before "Generar invitacion":
    ```typescript
    {
      label: 'Ver invitacion',
      icon: Eye, // import from lucide-react
      onClick: onViewInvitation,
    },
    ```

    Update function signature and actions array.

    **4. Update athletes-view.tsx:**

    Add state and handler:
    ```typescript
    const [invitationAthlete, setInvitationAthlete] = useState<Athlete | null>(null)
    ```

    Pass to table:
    ```typescript
    onViewInvitation={(athlete) => setInvitationAthlete(athlete)}
    ```

    Add modal at end of view:
    ```typescript
    <InvitationModal
      athlete={invitationAthlete}
      open={!!invitationAthlete}
      onOpenChange={(open) => !open && setInvitationAthlete(null)}
    />
    ```

    Import `InvitationModal` from `../components/invitation-modal`.
  </action>
  <verify>
    `pnpm typecheck` passes.
    Manual test: Click "Ver invitacion" on athlete row - modal shows invitation details or prompt to generate.
    Copy button copies URL to clipboard.
    Regenerate button creates new invitation.
  </verify>
  <done>
    Coaches can view existing invitations, copy URLs, and regenerate when needed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes across all packages
2. Click "Ver invitacion" row action - modal opens
3. Modal shows invitation URL, status badge, expiration date
4. Copy button copies URL and shows success toast
5. Regenerate button creates new invitation and refreshes modal
6. If no invitation exists, modal shows "Generar invitacion" button
</verification>

<success_criteria>
- UAT Test 5 passes: Coach can view and copy existing invitation links
- Modal displays invitation status (pending/accepted/expired/revoked)
- Copy to clipboard works
- Regenerate creates new invitation
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-coach-web-foundation/02.5-11-SUMMARY.md`
</output>
