# Phase 2.5: Coach Web Foundation - Research

**Researched:** 2026-01-23
**Domain:** React frontend with authentication, data tables, and forms
**Confidence:** HIGH

## Summary

This phase implements the frontend UI for the coach web app, building on the backend APIs created in Phases 1-2. The research confirms the existing stack is well-suited for this work:

- **TanStack Router** with `beforeLoad` for protected routes is the standard pattern for authentication guards
- **Better Auth React client** provides `useSession` and organization hooks out of the box
- **shadcn/ui** components already installed provide all necessary primitives (sidebar, table, form fields)
- **TanStack Query + oRPC** integration is already configured in `lib/api-client.ts`

The project has existing skills (`/orpc-query`, `/form`, `/data-table`) that provide implementation patterns. The main work is assembling these patterns into the route structure and feature components.

**Primary recommendation:** Follow the feature-folder structure defined in CONTEXT.md, use TanStack Router layouts for auth guards, and build a reusable DataTable compound component that can be used for both athletes and exercises.

## Standard Stack

The stack is already installed and configured. No new dependencies needed.

### Core (Already Installed)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| TanStack Router | catalog | File-based routing with type safety | Configured via vite plugin, supports beforeLoad auth |
| TanStack Query | catalog | Server state management | Works with oRPC via `@orpc/react-query` |
| TanStack Table | ^8.21.3 | Headless table primitives | Powers DataTable component |
| React Hook Form | catalog | Form state management | Works with Zod via `@hookform/resolvers` |
| Better Auth | catalog | Authentication | React client already set up in `lib/auth-client.ts` |
| shadcn/ui | base-vega | Component library | Already has sidebar, table, field, dialog, etc. |

### Supporting (Already Installed)

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Sonner | ^2.0.7 | Toast notifications | Success/error feedback |
| date-fns | ^4.1.0 | Date formatting | Display created dates, expiry times |
| Lucide React | ^0.562.0 | Icons | Navigation, actions, status indicators |
| class-variance-authority | ^0.7.1 | Variant-based styling | Component variants |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| TanStack Router | React Router | TanStack has better type safety and file-based routing |
| React Hook Form | Formik | RHF is smaller, faster, better TypeScript support |
| TanStack Table | AG Grid | TanStack is free, headless, more flexible |

**Installation:** None needed - all dependencies already in `package.json`.

## Architecture Patterns

### Recommended Project Structure

```
apps/coach-web/src/
├── components/
│   ├── ui/                    # shadcn/ui primitives (auto-generated)
│   ├── layout/                # App shell: sidebar, header
│   └── data-table/            # Reusable DataTable compound component
├── features/
│   ├── auth/
│   │   ├── views/
│   │   │   ├── login-view.tsx
│   │   │   ├── signup-view.tsx
│   │   │   └── onboarding-view.tsx
│   │   ├── components/
│   │   │   ├── auth-layout.tsx       # Split-screen layout
│   │   │   ├── auth-form.tsx         # Form primitives
│   │   │   └── oauth-buttons.tsx
│   │   └── hooks/
│   │       └── use-auth.ts
│   ├── athletes/
│   │   ├── views/
│   │   │   ├── athletes-list-view.tsx
│   │   │   └── athlete-form-view.tsx
│   │   ├── components/
│   │   │   ├── athletes-table.tsx
│   │   │   ├── athlete-form.tsx
│   │   │   └── invitation-status.tsx
│   │   └── hooks/
│   │       ├── queries/
│   │       │   └── use-athletes.ts
│   │       └── mutations/
│   │           └── use-create-athlete.ts
│   └── exercises/
│       ├── views/
│       │   └── exercises-browser-view.tsx
│       ├── components/
│       │   ├── exercises-table.tsx
│       │   └── exercise-filters.tsx
│       └── hooks/
│           └── queries/
│               └── use-exercises.ts
├── routes/
│   ├── __root.tsx             # QueryClientProvider, theme, auth context
│   ├── _auth.tsx              # Layout for unauthenticated routes
│   ├── _auth/
│   │   ├── login.tsx          # /login
│   │   ├── signup.tsx         # /signup
│   │   └── onboarding.tsx     # /onboarding
│   ├── _authenticated.tsx     # Layout with auth guard, sidebar
│   └── _authenticated/
│       ├── dashboard.tsx      # /dashboard
│       ├── athletes.tsx       # /athletes
│       └── exercises.tsx      # /exercises
├── lib/
│   ├── api-client.ts          # oRPC client (exists)
│   ├── auth-client.ts         # Better Auth client (exists)
│   └── query-client.ts        # TanStack Query client (exists)
└── main.tsx                   # App entry
```

### Pattern 1: Protected Routes with TanStack Router

**What:** Use `beforeLoad` in layout routes to enforce authentication
**When to use:** Any route that requires the user to be logged in
**Example:**

```typescript
// routes/_authenticated.tsx
import { createFileRoute, redirect, Outlet } from '@tanstack/react-router'
import { authClient } from '@/lib/auth-client'
import { AppShell } from '@/components/layout/app-shell'

export const Route = createFileRoute('/_authenticated')({
  beforeLoad: async ({ location }) => {
    const session = await authClient.getSession()
    if (!session.data) {
      throw redirect({
        to: '/login',
        search: { redirect: location.href },
      })
    }
    return { session: session.data }
  },
  component: () => {
    const { session } = Route.useRouteContext()
    return (
      <AppShell session={session}>
        <Outlet />
      </AppShell>
    )
  },
})
```

### Pattern 2: Auth Layout Routes (Redirect if Authenticated)

**What:** Redirect authenticated users away from login/signup
**When to use:** Login, signup, and onboarding routes
**Example:**

```typescript
// routes/_auth.tsx
import { createFileRoute, redirect, Outlet } from '@tanstack/react-router'
import { authClient } from '@/lib/auth-client'
import { AuthLayout } from '@/features/auth/components/auth-layout'

export const Route = createFileRoute('/_auth')({
  beforeLoad: async () => {
    const session = await authClient.getSession()
    if (session.data) {
      throw redirect({ to: '/dashboard' })
    }
  },
  component: () => (
    <AuthLayout>
      <Outlet />
    </AuthLayout>
  ),
})
```

### Pattern 3: Thin Route Files

**What:** Routes only handle routing config, views handle rendering
**When to use:** All feature routes
**Example:**

```typescript
// routes/_authenticated/athletes.tsx
import { createFileRoute } from '@tanstack/react-router'
import { AthletesListView } from '@/features/athletes/views/athletes-list-view'

export const Route = createFileRoute('/_authenticated/athletes')({
  component: AthletesListView,
})
```

### Pattern 4: Root Route with Providers

**What:** Set up QueryClient and theme at the root
**When to use:** Once, in __root.tsx
**Example:**

```typescript
// routes/__root.tsx
import { createRootRoute, Outlet } from '@tanstack/react-router'
import { QueryClientProvider } from '@tanstack/react-query'
import { queryClient } from '@/lib/query-client'
import { Toaster } from 'sonner'

export const Route = createRootRoute({
  component: () => (
    <QueryClientProvider client={queryClient}>
      <Outlet />
      <Toaster position="top-right" richColors />
    </QueryClientProvider>
  ),
})
```

### Anti-Patterns to Avoid

- **Auth checks in components:** Use `beforeLoad` in layout routes instead. Component-level checks cause flash of unauthorized content.
- **Business logic in routes:** Routes should only import views, not contain rendering logic.
- **Direct API calls:** Always use TanStack Query hooks, never raw fetch or direct oRPC calls.
- **Inline schemas:** Import from `@strenly/contracts`, never define Zod schemas in frontend.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Data table with pagination | Custom table with manual state | DataTable compound component | Server-side pagination, sorting, filtering already handled |
| Form validation | Custom validation logic | React Hook Form + Zod resolver | Handles touched/dirty state, async validation |
| Toast notifications | Custom notification system | Sonner (already configured) | Accessible, animated, dismissible |
| Debounced search | Custom debounce hook | useDebouncedCallback from DataTable.Search | Edge cases around cleanup |
| Auth session state | Custom context | Better Auth `useSession` hook | Handles refresh, sync across tabs |
| Organization context | Custom context | Better Auth `useActiveOrganization` | Already configured in auth-client.ts |

**Key insight:** The existing stack has solutions for common UI patterns. The DataTable compound component pattern from the reference project should be ported to this codebase.

## Common Pitfalls

### Pitfall 1: Flash of Unauthorized Content

**What goes wrong:** Protected content briefly shows before redirect
**Why it happens:** Auth check in component instead of `beforeLoad`
**How to avoid:** Always use `beforeLoad` in layout routes for auth guards
**Warning signs:** Users report seeing dashboard flash before login redirect

### Pitfall 2: Missing Query Invalidation

**What goes wrong:** UI doesn't update after mutation
**Why it happens:** Forgot to invalidate queries on mutation success
**How to avoid:** Always add `onSuccess` with `queryClient.invalidateQueries()`
**Warning signs:** User has to refresh page to see changes

### Pitfall 3: Form State Pollution

**What goes wrong:** Form shows stale data after navigation
**Why it happens:** Using `setValue` in useEffect instead of `reset`
**How to avoid:** Use `reset(data)` when defaultValues change, not `setValue`
**Warning signs:** Edit form shows previous entity's data

### Pitfall 4: Search Resetting to Page 1

**What goes wrong:** User searches, page stays at 5, shows no results
**Why it happens:** Forgot to reset page index when filters change
**How to avoid:** In filter/search handlers, always `setPageIndex(0)`
**Warning signs:** Empty state shows even though results exist

### Pitfall 5: Organization Context Not Set

**What goes wrong:** API calls fail with 403 or return empty data
**Why it happens:** Forgot to call `setCurrentOrgSlug()` after org selection
**How to avoid:** Set org context in authenticated layout after fetching active org
**Warning signs:** Works in dev (single org), breaks with multiple orgs

## Code Examples

### Query Hook with Pagination

```typescript
// features/athletes/hooks/queries/use-athletes.ts
import { useQuery } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'
import type { ListAthletesInput } from '@strenly/contracts'

export const athleteKeys = {
  all: ['athletes'] as const,
  list: (filters: ListAthletesInput) => [...athleteKeys.all, 'list', filters] as const,
  detail: (id: string) => [...athleteKeys.all, 'detail', id] as const,
}

export function useAthletes(input: ListAthletesInput) {
  return useQuery({
    queryKey: athleteKeys.list(input),
    queryFn: () => orpc.athletes.list.call(input),
  })
}
```

### Mutation with Cache Invalidation

```typescript
// features/athletes/hooks/mutations/use-create-athlete.ts
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { toast } from 'sonner'
import { orpc } from '@/lib/api-client'
import { athleteKeys } from '../queries/use-athletes'
import type { CreateAthleteInput } from '@strenly/contracts'

export function useCreateAthlete() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: (input: CreateAthleteInput) => orpc.athletes.create.call(input),
    onSuccess: () => {
      toast.success('Atleta creado correctamente')
      queryClient.invalidateQueries({ queryKey: athleteKeys.all })
    },
    onError: (error) => {
      toast.error(error.message ?? 'Error al crear atleta')
    },
  })
}
```

### Form Component (Pure UI)

```typescript
// features/athletes/components/athlete-form.tsx
import { useForm } from 'react-hook-form'
import { standardSchemaResolver } from '@hookform/resolvers/standard-schema'
import { createAthleteInputSchema, type CreateAthleteInput } from '@strenly/contracts'
import { Field, FieldLabel, FieldError } from '@/components/ui/field'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'

type AthleteFormProps = {
  onSubmit: (data: CreateAthleteInput) => void
  onCancel?: () => void
  isSubmitting?: boolean
  defaultValues?: Partial<CreateAthleteInput>
}

export function AthleteForm({
  onSubmit,
  onCancel,
  isSubmitting = false,
  defaultValues,
}: AthleteFormProps) {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<CreateAthleteInput>({
    resolver: standardSchemaResolver(createAthleteInputSchema),
    defaultValues: {
      name: '',
      email: '',
      ...defaultValues,
    },
  })

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <Field>
        <FieldLabel>Nombre</FieldLabel>
        <Input {...register('name')} />
        {errors.name && <FieldError>{errors.name.message}</FieldError>}
      </Field>

      <Field>
        <FieldLabel>Email</FieldLabel>
        <Input type="email" {...register('email')} />
        {errors.email && <FieldError>{errors.email.message}</FieldError>}
      </Field>

      <div className="flex gap-2 justify-end">
        {onCancel && (
          <Button type="button" variant="outline" onClick={onCancel}>
            Cancelar
          </Button>
        )}
        <Button type="submit" disabled={isSubmitting}>
          {isSubmitting ? 'Guardando...' : 'Guardar'}
        </Button>
      </div>
    </form>
  )
}
```

### Split-Screen Auth Layout

```typescript
// features/auth/components/auth-layout.tsx
export function AuthLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen grid lg:grid-cols-2">
      {/* Branding Panel */}
      <div className="hidden lg:flex flex-col justify-center items-center bg-primary p-12">
        <Logo className="w-24 h-24 text-primary-foreground" />
        <h1 className="text-3xl font-bold text-primary-foreground mt-8">
          Strenly
        </h1>
        <p className="text-primary-foreground/80 mt-2 text-center max-w-md">
          Crea programas de entrenamiento tan rápido como en Excel
        </p>
      </div>

      {/* Form Panel */}
      <div className="flex flex-col justify-center items-center p-8 lg:p-12">
        <div className="w-full max-w-md space-y-6">
          {children}
        </div>
      </div>
    </div>
  )
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| React Router v5 loaders | TanStack Router beforeLoad | 2024 | Type-safe auth guards |
| shadcn Form wrapper | Field component (direct) | 2025 | Simpler, more flexible |
| zodResolver | standardSchemaResolver | Zod 4 | Future-proof schema resolution |
| Custom auth context | Better Auth hooks | 2025 | Built-in session sync |

**Deprecated/outdated:**
- shadcn `<Form>` wrapper component - use `Field` components directly with React Hook Form
- `zodResolver` from `@hookform/resolvers/zod` - use `standardSchemaResolver` for Zod 4

## Open Questions

### 1. DataTable Component Location

**What we know:** Reference project has DataTable in `packages/ui`. This project doesn't have a `packages/ui`.
**What's unclear:** Should DataTable live in `apps/coach-web/src/components/data-table/` or be extracted to a shared package?
**Recommendation:** Keep in `apps/coach-web/src/components/data-table/` for now. Extract to shared package if athlete-pwa needs it later.

### 2. Form Container Pattern (Modal vs Drawer vs Page)

**What we know:** CONTEXT.md says this is Claude's discretion based on field count research.
**Research finding:** UX best practice: Use drawer for forms with 3-6 fields, modal for simple confirmations, dedicated page for complex forms with 7+ fields or multi-step wizards.
**Recommendation:** Use **Sheet (drawer)** for athlete create/edit (5-6 fields). It keeps context visible and allows quick entry. Use dialog for confirmations (archive, delete).

### 3. Clipboard API for Invitation Links

**What we know:** User wants copy-to-clipboard for invitation URLs.
**What's unclear:** Modern Clipboard API support.
**Recommendation:** Use `navigator.clipboard.writeText()` with toast feedback. Falls back gracefully.

## Sources

### Primary (HIGH confidence)

- [TanStack Router Authentication Docs](https://tanstack.com/router/v1/docs/framework/react/guide/authenticated-routes) - beforeLoad pattern, layout routes
- [Better Auth Client Docs](https://www.better-auth.com/docs/concepts/client) - useSession, organization hooks
- Project skills: `/orpc-query`, `/form`, `/data-table` - Implementation patterns

### Secondary (MEDIUM confidence)

- [WebSearch: SaaS Dashboard Navigation](https://www.pencilandpaper.io/articles/ux-pattern-analysis-navigation) - Sidebar patterns
- [WebSearch: Data Table Actions](https://uxdworld.com/best-practices-for-providing-actions-in-data-tables/) - Row action UX
- [WebSearch: Modal vs Drawer](https://medium.com/@ninad.kotasthane/modal-vs-drawer-when-to-use-the-right-component-af0a76b952da) - Form container decisions

### Tertiary (LOW confidence)

- WebSearch on split-screen auth layouts - General patterns, no authoritative source

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Already installed and configured, verified in package.json and existing files
- Architecture: HIGH - TanStack Router patterns are well-documented, skills provide implementation guidance
- Pitfalls: MEDIUM - Based on common React patterns and WebSearch findings

**Research date:** 2026-01-23
**Valid until:** 2026-02-23 (30 days - stack is stable)
