---
phase: 02.5-coach-web-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/routes/__root.tsx
  - apps/coach-web/src/routes/_authenticated.tsx
  - apps/coach-web/src/routes/_auth.tsx
  - apps/coach-web/src/components/layout/app-shell.tsx
  - apps/coach-web/src/components/layout/app-sidebar.tsx
  - apps/coach-web/src/components/layout/user-menu.tsx
  - apps/coach-web/src/components/layout/breadcrumbs.tsx
  - apps/coach-web/src/lib/theme.ts
autonomous: true

must_haves:
  truths:
    - "App renders root layout with QueryClientProvider and theme"
    - "Unauthenticated users are redirected to /login"
    - "Authenticated users see collapsible sidebar with Dashboard, Athletes, Exercises nav"
    - "User menu shows profile options and logout"
    - "Sidebar collapse state persists in localStorage"
  artifacts:
    - path: "apps/coach-web/src/routes/__root.tsx"
      provides: "Root layout with providers"
      contains: "QueryClientProvider"
    - path: "apps/coach-web/src/routes/_authenticated.tsx"
      provides: "Auth guard layout"
      contains: "beforeLoad"
    - path: "apps/coach-web/src/components/layout/app-shell.tsx"
      provides: "Main app layout with sidebar"
      min_lines: 30
  key_links:
    - from: "apps/coach-web/src/routes/_authenticated.tsx"
      to: "lib/auth-client.ts"
      via: "authClient.getSession()"
      pattern: "authClient\\.getSession"
---

<objective>
Create the app shell foundation: root route with providers, authenticated layout with sidebar navigation, and layout components.

Purpose: This is the foundation for all authenticated pages. Without the app shell, no protected routes can render.
Output: Working app shell with navigation, theme support, and auth guards.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-coach-web-foundation/02.5-CONTEXT.md
@.planning/phases/02.5-coach-web-foundation/02.5-RESEARCH.md
@apps/coach-web/src/lib/auth-client.ts
@apps/coach-web/src/lib/query-client.ts
@apps/coach-web/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create root route with providers</name>
  <skills>/frontend-design</skills>
  <files>
    apps/coach-web/src/routes/__root.tsx
    apps/coach-web/src/lib/theme.ts
  </files>
  <action>
Create the root route that wraps the entire app with providers:

1. Create `lib/theme.ts`:
   - Define ThemeProvider using React context
   - Read initial theme from localStorage ('theme' key) or default to 'system'
   - Apply theme to document.documentElement via data-theme attribute
   - Export useTheme hook for reading/setting theme
   - Support 'light' | 'dark' | 'system' values

2. Create `routes/__root.tsx`:
   - Use createRootRoute from TanStack Router
   - Wrap Outlet with QueryClientProvider using queryClient from lib/query-client.ts
   - Add ThemeProvider wrapper
   - Toaster is already in main.tsx, no need to add here
   - Add TanStack Router Devtools in development only (import from @tanstack/router-devtools)

Pattern from research:
```typescript
export const Route = createRootRoute({
  component: () => (
    <QueryClientProvider client={queryClient}>
      <ThemeProvider>
        <Outlet />
      </ThemeProvider>
    </QueryClientProvider>
  ),
})
```
  </action>
  <verify>
Run `pnpm --filter coach-web dev` and verify the app starts without errors. The root route should be visible in the route tree.
  </verify>
  <done>
Root route renders with providers and no console errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create authenticated layout with auth guard</name>
  <skills>/frontend-design</skills>
  <files>
    apps/coach-web/src/routes/_authenticated.tsx
    apps/coach-web/src/routes/_auth.tsx
  </files>
  <action>
Create the layout routes that handle authentication guards:

1. Create `routes/_authenticated.tsx`:
   - Use createFileRoute with '/_authenticated' path
   - Add beforeLoad that calls authClient.getSession()
   - If no session.data, redirect to '/login' with search param { redirect: location.href }
   - Return session in beforeLoad context
   - Component renders AppShell (will be created) with Outlet
   - Pass session to AppShell component

2. Create `routes/_auth.tsx`:
   - Use createFileRoute with '/_auth' path
   - Add beforeLoad that calls authClient.getSession()
   - If session.data exists, redirect to '/dashboard'
   - Component renders Outlet only (auth pages handle their own layout)

Pattern from research:
```typescript
beforeLoad: async ({ location }) => {
  const session = await authClient.getSession()
  if (!session.data) {
    throw redirect({
      to: '/login',
      search: { redirect: location.href },
    })
  }
  return { session: session.data }
}
```
  </action>
  <verify>
Check that routes/_authenticated.tsx and routes/_auth.tsx are valid TypeScript with no type errors.
  </verify>
  <done>
Auth guards redirect unauthenticated users to /login and authenticated users away from auth pages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create app shell layout components</name>
  <skills>/frontend-design</skills>
  <files>
    apps/coach-web/src/components/layout/app-shell.tsx
    apps/coach-web/src/components/layout/app-sidebar.tsx
    apps/coach-web/src/components/layout/user-menu.tsx
    apps/coach-web/src/components/layout/breadcrumbs.tsx
  </files>
  <action>
Create the layout components for the authenticated app shell:

1. Create `components/layout/app-sidebar.tsx`:
   - Use shadcn Sidebar components (already installed)
   - Include nav items: Dashboard (Home icon), Athletes (Users icon), Exercises (Dumbbell icon)
   - Use Link from TanStack Router for navigation
   - Store collapsed state in localStorage key 'sidebar-collapsed'
   - Read initial state from localStorage on mount
   - Use SidebarProvider from shadcn/ui sidebar

2. Create `components/layout/user-menu.tsx`:
   - DropdownMenu with avatar trigger (use first letter of user name)
   - Menu items: Settings, Theme toggle (submenu), Separator, Logout
   - Theme toggle shows Light, Dark, System options
   - Logout calls authClient.signOut() and redirects to /login
   - Use useSession() hook from auth-client.ts

3. Create `components/layout/breadcrumbs.tsx`:
   - Use shadcn Breadcrumb components
   - Read current route path from TanStack Router
   - Parse path segments and create breadcrumb items
   - Link each segment except the last one

4. Create `components/layout/app-shell.tsx`:
   - Main layout component receiving session prop
   - Structure: SidebarProvider > Sidebar + main content area
   - Main area has top bar (breadcrumbs + user menu) and children slot
   - Use SidebarInset from shadcn/ui for main content
   - Top bar is a simple flex row with justify-between

CONTEXT decisions:
- Collapsible sidebar that remembers state in localStorage
- Minimal top bar: breadcrumbs only + user menu
- Desktop-only (optimized for 1024px+)
- Theme toggle in user menu dropdown
  </action>
  <verify>
Run `pnpm typecheck` to verify no TypeScript errors in the layout components.
  </verify>
  <done>
App shell renders with sidebar navigation, breadcrumbs, and user menu with theme toggle.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no errors
2. Run `pnpm lint` - no errors
3. Start dev server with `pnpm --filter coach-web dev`
4. Navigate to any protected route - should redirect to /login
5. Sidebar should be visible (mock AppShell for now if no auth)
</verification>

<success_criteria>
- Root route renders with QueryClientProvider and ThemeProvider
- Authenticated layout redirects unauthenticated users to /login
- Auth layout redirects authenticated users to /dashboard
- App shell shows sidebar with navigation items
- User menu shows with theme toggle and logout
- Sidebar collapse state persists across page reloads
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-coach-web-foundation/02.5-01-SUMMARY.md`
</output>
