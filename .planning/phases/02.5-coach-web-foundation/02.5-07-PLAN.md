---
phase: 02.5-coach-web-foundation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/routes/_authenticated.tsx
  - apps/coach-web/src/components/layout/app-shell.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "API calls include X-Organization-Slug header when user has active organization"
    - "Dashboard stat cards load data without 500 errors"
    - "Athletes list loads without 500 errors"
    - "Create athlete succeeds without 'Organization no encontrada' error"
  artifacts:
    - path: "apps/coach-web/src/routes/_authenticated.tsx"
      provides: "Organization sync effect"
      contains: "setCurrentOrgSlug"
    - path: "apps/coach-web/src/components/layout/app-shell.tsx"
      provides: "Organization context consumption"
      contains: "useActiveOrganization"
  key_links:
    - from: "apps/coach-web/src/routes/_authenticated.tsx"
      to: "apps/coach-web/src/lib/api-client.ts"
      via: "setCurrentOrgSlug call"
      pattern: "setCurrentOrgSlug.*slug"
---

<objective>
Fix organization header synchronization to unblock all API calls

Purpose: The frontend never calls `setCurrentOrgSlug()` to sync Better-Auth's active organization with the API client. This causes all organization-scoped API requests to fail with 500 errors because the X-Organization-Slug header is never set.

Output: API calls correctly include organization context header, unblocking tests 1, 3, 7, 8
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-coach-web-foundation/02.5-UAT.md

# Key files to understand
@apps/coach-web/src/lib/api-client.ts
@apps/coach-web/src/lib/auth-client.ts
@apps/coach-web/src/routes/_authenticated.tsx
@apps/coach-web/src/components/layout/app-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync active organization with API client</name>
  <files>
    apps/coach-web/src/routes/_authenticated.tsx
    apps/coach-web/src/components/layout/app-shell.tsx
  </files>
  <action>
The root cause is that `setCurrentOrgSlug()` in api-client.ts is never called. Better-Auth's `useActiveOrganization()` hook provides the active org, but nothing syncs it to the API client.

**Option A (Preferred - in _authenticated.tsx):**
Add organization sync in the authenticated layout component:

1. Import `useActiveOrganization` from `@/lib/auth-client`
2. Import `setCurrentOrgSlug` from `@/lib/api-client`
3. Add a `useEffect` that calls `setCurrentOrgSlug(activeOrg?.slug ?? null)` whenever the active org changes

```typescript
function AuthenticatedLayout() {
  const { authData } = Route.useRouteContext()
  const { data: activeOrg } = useActiveOrganization()

  // Sync active organization with API client
  useEffect(() => {
    setCurrentOrgSlug(activeOrg?.slug ?? null)
  }, [activeOrg?.slug])

  return (
    <AppShell authData={authData}>
      <Outlet />
    </AppShell>
  )
}
```

**Why here:** This is the layout that wraps all authenticated routes, so it runs once and syncs the org before any child routes render/fetch data.

**Alternative (if activeOrg not available in layout):**
If `useActiveOrganization()` doesn't work in the route component (check if it needs to be inside a specific provider), move the sync logic to AppShell instead:

```typescript
// In AppShell
import { useActiveOrganization } from '@/lib/auth-client'
import { setCurrentOrgSlug } from '@/lib/api-client'

export function AppShell({ children, authData }: AppShellProps) {
  const { data: activeOrg } = useActiveOrganization()

  useEffect(() => {
    setCurrentOrgSlug(activeOrg?.slug ?? null)
  }, [activeOrg?.slug])

  // ... rest of component
}
```

**Important:** The sync MUST happen before any API calls. Place the effect at the top of the component to ensure it runs first.
  </action>
  <verify>
1. Start dev server: `pnpm dev`
2. Log in to the app
3. Open browser DevTools Network tab
4. Navigate to /athletes or /dashboard
5. Verify API requests include `X-Organization-Slug` header
6. Verify requests return 200 instead of 500
  </verify>
  <done>
- API requests to /rpc/athletes/list include X-Organization-Slug header
- Dashboard stats load without 500 errors
- Athletes list loads without 500 errors
- Create athlete form can save without "Organization no encontrada" error
  </done>
</task>

</tasks>

<verification>
1. Dashboard page loads and displays stat cards with actual data
2. Athletes page loads and displays athlete list (or empty state)
3. Creating a new athlete succeeds (shows success toast)
4. Network tab shows X-Organization-Slug header on all /rpc/* requests
</verification>

<success_criteria>
- All organization-scoped API calls include X-Organization-Slug header
- No more 500 "Organization no encontrada" errors
- Tests 1 (signup), 3 (dashboard stats), 7 (athletes list), 8 (create athlete) unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-coach-web-foundation/02.5-07-SUMMARY.md`
</output>
