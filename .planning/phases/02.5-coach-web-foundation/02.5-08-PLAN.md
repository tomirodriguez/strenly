---
phase: 02.5-coach-web-foundation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coach-web/src/components/layout/user-menu.tsx
  - apps/coach-web/src/features/exercises/components/exercises-table.tsx
  - apps/coach-web/src/features/exercises/views/exercises-browser-view.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User menu opens without MenuGroupRootContext error"
    - "User can access theme toggle in user menu"
    - "User can log out via user menu"
    - "Exercises page renders table without DataTable.Root context error"
    - "Exercises pagination works correctly"
  artifacts:
    - path: "apps/coach-web/src/components/layout/user-menu.tsx"
      provides: "Working user menu dropdown"
      contains: "DropdownMenuGroup"
    - path: "apps/coach-web/src/features/exercises/components/exercises-table.tsx"
      provides: "Exercises table with DataTable.Content"
      contains: "DataTable.Content"
    - path: "apps/coach-web/src/features/exercises/views/exercises-browser-view.tsx"
      provides: "Exercises browser with pagination inside DataTable.Root"
      pattern: "DataTable\\.Root.*DataTablePagination"
  key_links:
    - from: "exercises-browser-view.tsx"
      to: "exercises-table.tsx"
      via: "Renders ExercisesTable inside DataTable context"
    - from: "exercises-table.tsx"
      to: "data-table.tsx"
      via: "Uses DataTable.Content inside DataTable.Root"
---

<objective>
Fix UI crashes in user menu and exercises table

Purpose: Two critical UI components crash due to incorrect component composition:
1. User menu crashes with "MenuGroupRootContext is missing" because DropdownMenuLabel is used outside DropdownMenuGroup
2. Exercises table crashes with "DataTable components must be used within DataTable.Root" because DataTablePagination is rendered outside context

Output: User menu and exercises browser work without crashes, unblocking tests 2, 4, 5, 11, 13
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-coach-web-foundation/02.5-UAT.md

# Key files
@apps/coach-web/src/components/layout/user-menu.tsx
@apps/coach-web/src/components/ui/dropdown-menu.tsx
@apps/coach-web/src/features/exercises/components/exercises-table.tsx
@apps/coach-web/src/features/exercises/views/exercises-browser-view.tsx
@apps/coach-web/src/components/data-table/data-table.tsx
@apps/coach-web/src/components/data-table/data-table-pagination.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix user menu DropdownMenuGroup wrapper</name>
  <files>apps/coach-web/src/components/layout/user-menu.tsx</files>
  <action>
**Root cause:** `DropdownMenuLabel` wraps Base UI's `MenuPrimitive.GroupLabel` which requires `MenuGroupRootContext`. This context is only provided by `MenuPrimitive.Group` (wrapped as `DropdownMenuGroup`).

The user info label (lines 53-58) is NOT wrapped in a DropdownMenuGroup. Fix by wrapping the label in a group.

**Before (broken):**
```tsx
<DropdownMenuContent align="end" className="w-56">
  <DropdownMenuLabel>
    <div className="flex flex-col space-y-1">
      <p className="font-medium text-sm leading-none">{user.name ?? 'User'}</p>
      <p className="text-muted-foreground text-xs leading-none">{user.email}</p>
    </div>
  </DropdownMenuLabel>
  <DropdownMenuSeparator />
  <DropdownMenuGroup>
    ...
```

**After (fixed):**
```tsx
<DropdownMenuContent align="end" className="w-56">
  <DropdownMenuGroup>
    <DropdownMenuLabel>
      <div className="flex flex-col space-y-1">
        <p className="font-medium text-sm leading-none">{user.name ?? 'User'}</p>
        <p className="text-muted-foreground text-xs leading-none">{user.email}</p>
      </div>
    </DropdownMenuLabel>
  </DropdownMenuGroup>
  <DropdownMenuSeparator />
  <DropdownMenuGroup>
    ...
```

**Key insight:** Every `DropdownMenuLabel` MUST be inside a `DropdownMenuGroup` when using Base UI's Menu primitives.
  </action>
  <verify>
1. Start dev server: `pnpm dev`
2. Log in to the app
3. Click the user avatar in the top-right corner
4. Verify dropdown opens without console errors
5. Verify theme toggle submenu is visible and works
6. Verify logout option is visible and works
  </verify>
  <done>
- User menu dropdown opens without errors
- Theme toggle (Light/Dark/System) is accessible and functional
- Logout option works and redirects to login page
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix DataTable compound component pattern in exercises</name>
  <files>
    apps/coach-web/src/features/exercises/components/exercises-table.tsx
    apps/coach-web/src/features/exercises/views/exercises-browser-view.tsx
  </files>
  <action>
**Root cause:** The DataTable compound component pattern is broken in two places:

1. `ExercisesTable` returns `DataTable.Root` but doesn't render `DataTable.Content` inside it
2. `ExercisesBrowserView` renders `DataTablePagination` as a sibling OUTSIDE the `ExercisesTable` (which is the `DataTable.Root`)

**The compound component pattern requires:**
- All DataTable sub-components (`DataTable.Content`, `DataTablePagination`, `DataTableToolbar`, `DataTableSearch`) MUST be children of `DataTable.Root`
- The context provider is in `DataTable.Root`, so anything outside it cannot access the context

**Fix exercises-table.tsx:**

The component should render `DataTable.Content` inside the Root:

```tsx
export function ExercisesTable({
  data,
  totalCount,
  pageIndex,
  pageSize,
  onPageChange,
  isLoading,
}: ExercisesTableProps) {
  return (
    <DataTable.Root
      columns={columns}
      data={data}
      totalCount={totalCount}
      pageIndex={pageIndex}
      pageSize={pageSize}
      onPageChange={onPageChange}
      isLoading={isLoading}
    >
      <DataTable.Content />
    </DataTable.Root>
  )
}
```

**Fix exercises-browser-view.tsx:**

Move ALL DataTable children inside the Root. The view should manage a single DataTable.Root with all sub-components as children:

```tsx
export function ExercisesBrowserView() {
  // ... state and hooks ...

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="font-semibold text-3xl tracking-tight">Exercises</h1>
          <p className="text-muted-foreground text-sm">Browse and manage your exercise library</p>
        </div>
      </div>

      <DataTable.Root
        columns={columns}
        data={data?.items ?? []}
        totalCount={data?.totalCount ?? 0}
        pageIndex={pageIndex}
        pageSize={pageSize}
        onPageChange={handlePageChange}
        isLoading={isLoading}
      >
        <div className="space-y-4">
          <DataTableToolbar>
            <div className="flex flex-1 items-center gap-4">
              <DataTableSearch value={search} onValueChange={setSearch} placeholder="Search exercises..." />
              <ExerciseFilters
                muscleGroup={muscleGroup}
                movementPattern={movementPattern}
                onMuscleGroupChange={setMuscleGroup}
                onMovementPatternChange={setMovementPattern}
              />
            </div>
          </DataTableToolbar>

          <DataTable.Content />

          <DataTablePagination />
        </div>
      </DataTable.Root>
    </div>
  )
}
```

**Important changes:**
1. Define `columns` in the view file (move from ExercisesTable or duplicate)
2. Remove the `ExercisesTable` wrapper component entirely, use DataTable directly
3. OR modify ExercisesTable to accept children and pass them through to DataTable.Root

**Alternative approach (keep ExercisesTable):**
Make ExercisesTable accept children:

```tsx
// exercises-table.tsx
type ExercisesTableProps = {
  data: Exercise[]
  totalCount: number
  pageIndex: number
  pageSize: number
  onPageChange: (pageIndex: number, pageSize: number) => void
  isLoading?: boolean
  children?: React.ReactNode  // Add this
}

export function ExercisesTable({
  data,
  totalCount,
  pageIndex,
  pageSize,
  onPageChange,
  isLoading,
  children,  // Add this
}: ExercisesTableProps) {
  return (
    <DataTable.Root
      columns={columns}
      data={data}
      totalCount={totalCount}
      pageIndex={pageIndex}
      pageSize={pageSize}
      onPageChange={onPageChange}
      isLoading={isLoading}
    >
      <DataTable.Content />
      {children}  // Render children (like pagination) inside the context
    </DataTable.Root>
  )
}

// exercises-browser-view.tsx
<ExercisesTable
  data={data?.items ?? []}
  totalCount={data?.totalCount ?? 0}
  pageIndex={pageIndex}
  pageSize={pageSize}
  onPageChange={handlePageChange}
  isLoading={isLoading}
>
  <DataTablePagination />
</ExercisesTable>
```

Choose whichever approach is cleaner. The key is that `DataTablePagination` MUST be a descendant of `DataTable.Root`.
  </action>
  <verify>
1. Navigate to /exercises
2. Verify page loads without console errors
3. Verify exercise table renders with data (or empty state if no exercises)
4. Verify pagination controls appear and work
5. Verify filtering by muscle group and movement pattern works
  </verify>
  <done>
- Exercises page renders without DataTable context error
- Exercise table displays data correctly
- Pagination shows and works (page size selector, page navigation)
- Filters work as expected
  </done>
</task>

</tasks>

<verification>
1. User menu opens and all options work (Settings, Theme, Logout)
2. Theme toggle changes theme immediately and persists after refresh
3. Logout redirects to login page
4. Exercises page loads without errors
5. Exercises table shows data with proper columns
6. Pagination works (can change page size, navigate pages)
</verification>

<success_criteria>
- No MenuGroupRootContext errors in user menu
- No DataTable.Root context errors on exercises page
- Theme toggle accessible and functional (was hidden by menu crash)
- Tests 2 (login/logout), 4 (exercises page), 5 (theme toggle), 11 (exercises browser), 13 (logout) unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-coach-web-foundation/02.5-08-SUMMARY.md`
</output>
