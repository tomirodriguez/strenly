---
phase: 02.5-coach-web-foundation
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/procedures/athletes/create-athlete.ts
  - packages/backend/src/procedures/athletes/update-athlete.ts
  - packages/backend/src/infrastructure/repositories/exercise.repository.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Create athlete succeeds with empty email field"
    - "Edit athlete succeeds with empty email field"
    - "Exercises display their associated muscle groups"
    - "Muscle filter returns matching exercises"
  artifacts:
    - path: "packages/backend/src/procedures/athletes/create-athlete.ts"
      provides: "Empty string coercion for optional fields"
      contains: "|| null"
    - path: "packages/backend/src/procedures/athletes/update-athlete.ts"
      provides: "Empty string coercion for optional fields"
      contains: "|| null"
    - path: "packages/backend/src/infrastructure/repositories/exercise.repository.ts"
      provides: "Muscle group ID prefix stripping"
      contains: "replace"
  key_links:
    - from: "create-athlete.ts"
      to: "Athlete domain entity"
      via: "coerced null for empty strings"
      pattern: "email.*\\|\\|.*null"
    - from: "exercise.repository.ts"
      to: "isValidMuscleGroup"
      via: "stripped mg- prefix"
      pattern: "replace.*mg-"
---

<objective>
Fix athlete validation mismatch and exercise muscle filter bugs.

Purpose: Close UAT gaps 1 and 3 - empty email causing validation errors and muscle filter returning no results.
Output: Athletes can be created/edited with empty email, exercises display muscles correctly.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.5-coach-web-foundation/02.5-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix empty string coercion in athlete procedures</name>
  <files>
    packages/backend/src/procedures/athletes/create-athlete.ts
    packages/backend/src/procedures/athletes/update-athlete.ts
  </files>
  <action>
    The issue: `??` (nullish coalescing) only coerces `null` and `undefined` to `null`, but empty string `""` passes through unchanged. The Athlete domain entity then fails validation because `""` is not a valid email format.

    In `create-athlete.ts`, change lines 28-32:
    - `email: input.email ?? null` -> `email: input.email || null`
    - `phone: input.phone ?? null` -> `phone: input.phone || null`
    - `notes: input.notes ?? null` -> `notes: input.notes || null`

    In `update-athlete.ts`, lines 40-44 use a different pattern with explicit undefined check. Update:
    - `email: input.email !== undefined ? (input.email ?? null) : undefined` -> `email: input.email !== undefined ? (input.email || null) : undefined`
    - `phone: input.phone !== undefined ? (input.phone ?? null) : undefined` -> `phone: input.phone !== undefined ? (input.phone || null) : undefined`
    - `notes: input.notes !== undefined ? (input.notes ?? null) : undefined` -> `notes: input.notes !== undefined ? (input.notes || null) : undefined`

    This ensures empty strings from form submissions are coerced to null before domain validation.
  </action>
  <verify>
    `pnpm typecheck` passes.
    Manual test: Create athlete with empty email field - should succeed without validation error.
  </verify>
  <done>
    Empty email/phone/notes fields coerced to null, athlete CRUD works with optional fields left empty.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix muscle group ID prefix in exercise repository</name>
  <files>
    packages/backend/src/infrastructure/repositories/exercise.repository.ts
  </files>
  <action>
    The issue: Seed data stores muscleGroupId as `mg-chest` but `isValidMuscleGroup()` expects `chest` without prefix. All muscle mappings silently fail validation and exercises appear with no muscles.

    In `mapToDomain` function (around line 53-60), strip the `mg-` prefix before validating:

    ```typescript
    for (const mapping of muscleMappings) {
      // Strip mg- prefix if present (seed data uses mg-chest, validator expects chest)
      const muscleId = mapping.muscleGroupId.replace(/^mg-/, '')
      if (isValidMuscleGroup(muscleId)) {
        if (mapping.isPrimary) {
          primaryMuscles.push(muscleId)
        } else {
          secondaryMuscles.push(muscleId)
        }
      }
    }
    ```

    Also update the `findAll` muscle filter query (around line 159) to use the prefixed format when querying the database:

    The current query already uses `options.muscleGroup` directly, which expects the raw value like `chest`. But the database has `mg-chest`. Update:
    ```typescript
    if (options?.muscleGroup) {
      // Database stores with mg- prefix
      const dbMuscleGroupId = `mg-${options.muscleGroup}`
      const muscleResults = await db
        .select({ exerciseId: exerciseMuscles.exerciseId })
        .from(exerciseMuscles)
        .where(eq(exerciseMuscles.muscleGroupId, dbMuscleGroupId))
      exerciseIdsWithMuscle = muscleResults.map((r) => r.exerciseId)
      // ...
    }
    ```
  </action>
  <verify>
    `pnpm typecheck` passes.
    Manual test: Visit /exercises, select a muscle group filter - exercises should appear.
    Check exercise detail - primary/secondary muscles should display.
  </verify>
  <done>
    Exercises display their associated muscles, muscle group filter returns matching exercises.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. Create athlete with empty email - succeeds
3. Edit athlete, clear email - succeeds
4. Exercise list shows muscle chips on each row
5. Muscle filter dropdown returns matching exercises
</verification>

<success_criteria>
- UAT Test 4 passes: Create/edit athlete works with empty optional fields
- UAT Test 6 passes: Exercise muscle filter works, exercises show muscle groups
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-coach-web-foundation/02.5-10-SUMMARY.md`
</output>
