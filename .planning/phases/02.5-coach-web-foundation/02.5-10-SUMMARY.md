---
phase: 02.5-coach-web-foundation
plan: 10
subsystem: api
tags: [validation, coercion, muscle-groups, bug-fix]

# Dependency graph
requires:
  - phase: 02
    provides: Athlete domain entity, Exercise repository with muscle mappings
provides:
  - Empty string coercion for optional athlete fields
  - Muscle group ID prefix handling in exercise repository
affects: [athlete-crud, exercise-library]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Use || instead of ?? for optional string coercion (empty string to null)"
    - "Database ID prefix stripping in repository mapping layer"

key-files:
  created: []
  modified:
    - packages/backend/src/procedures/athletes/create-athlete.ts
    - packages/backend/src/procedures/athletes/update-athlete.ts
    - packages/backend/src/infrastructure/repositories/exercise.repository.ts

key-decisions:
  - "Empty string coercion uses || instead of ?? - nullish coalescing doesn't catch empty strings"
  - "Muscle group ID prefix (mg-) stripped at repository mapping layer, not database"

patterns-established:
  - "Optional form fields: Use || null for coercion in procedures"
  - "Database ID prefixes: Handle in repository mapToDomain, not domain layer"

# Metrics
duration: 4min
completed: 2026-01-25
---

# Phase 2.5 Plan 10: Gap Closure - Athlete Validation & Exercise Muscles Summary

**Fixed empty string validation failure in athlete CRUD and muscle group display/filtering in exercise library**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-25T~13:00:00Z
- **Completed:** 2026-01-25T~13:04:00Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Athletes can be created/edited with empty optional fields (email, phone, notes, gender)
- Exercises display their associated muscle groups
- Muscle group filter returns matching exercises

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix empty string coercion in athlete procedures** - `fb81513` (fix)
2. **Task 2: Fix muscle group ID prefix in exercise repository** - `9f858fa` (fix)

## Files Created/Modified

- `packages/backend/src/procedures/athletes/create-athlete.ts` - Changed `??` to `||` for optional field coercion
- `packages/backend/src/procedures/athletes/update-athlete.ts` - Changed `??` to `||` for optional field coercion
- `packages/backend/src/infrastructure/repositories/exercise.repository.ts` - Strip mg- prefix in mapToDomain, add prefix in filter query

## Decisions Made

- **Empty string coercion pattern:** Use `||` instead of `??` because nullish coalescing only catches `null` and `undefined`, not empty strings. Forms submit empty strings for cleared fields.
- **Prefix handling location:** Handle database ID prefixes in repository layer (mapToDomain and query), not in domain entity validators. The domain works with clean IDs like "chest", the database stores "mg-chest".

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Pre-existing typecheck errors with Node types (@types/node, node:crypto) unrelated to changes. These are infrastructure issues that need separate resolution.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- UAT Test 4 (athlete CRUD with empty optional fields) should now pass
- UAT Test 6 (exercise muscle display and filter) should now pass
- Ready for full UAT re-verification

---
*Phase: 02.5-coach-web-foundation*
*Completed: 2026-01-25*
