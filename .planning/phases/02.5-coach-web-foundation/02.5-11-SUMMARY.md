---
phase: "02.5"
plan: "11"
type: "summary"
subsystem: "athletes"
tags: ["invitation", "modal", "frontend", "gap-closure"]

dependency_graph:
  requires:
    - "02-07" # Athlete invitation use cases
    - "02-09" # Athlete contracts & procedures
  provides:
    - "getAthleteInvitation procedure"
    - "invitation modal component"
    - "view invitation table action"
  affects:
    - "athlete-pwa invitation flow"

tech_stack:
  added: []
  patterns:
    - "query hook with conditional fetching"
    - "modal with async state"

key_files:
  created:
    - "packages/contracts/src/athletes/invitation.ts" # getAthleteInvitationOutputSchema
    - "packages/backend/src/use-cases/athletes/get-athlete-invitation.ts"
    - "packages/backend/src/procedures/athletes/get-athlete-invitation.ts"
    - "packages/backend/src/global.d.ts" # process.env type declaration
    - "apps/coach-web/src/features/athletes/hooks/queries/use-athlete-invitation.ts"
    - "apps/coach-web/src/features/athletes/components/invitation-modal.tsx"
  modified:
    - "packages/backend/src/procedures/athletes/index.ts" # Added getInvitation route
    - "apps/coach-web/src/features/athletes/components/athletes-table.tsx" # Added onViewInvitation
    - "apps/coach-web/src/features/athletes/views/athletes-list-view.tsx" # Integrated modal
    - "packages/core/package.json" # Added @types/node
    - "packages/core/tsconfig.json" # Added node types
    - "packages/backend/package.json" # Added @types/node
    - "packages/backend/tsconfig.json" # Added node types

decisions:
  - id: "node-types-for-crypto"
    summary: "Added @types/node to core and backend packages"
    rationale: "Pre-existing issue: node:crypto import in athlete-invitation.ts required node types for typecheck to pass"
    scope: "packages/core, packages/backend"

metrics:
  duration: "6 min"
  completed: "2026-01-25"
---

# Phase 02.5 Plan 11: View Athlete Invitation Summary

**One-liner:** Coach can view, copy, and regenerate existing athlete invitation links via modal.

## What Was Built

### Backend (Task 1)

1. **getAthleteInvitationOutputSchema** - Contract schema returning full invitation details:
   - id, athleteId, invitationUrl
   - status (pending/accepted/expired/revoked)
   - expiresAt, createdAt, acceptedAt

2. **makeGetAthleteInvitation use case** - Authorization-first use case that:
   - Checks `athletes:read` permission
   - Verifies athlete exists in organization
   - Fetches active invitation
   - Computes invitation status
   - Returns invitation with full URL

3. **getAthleteInvitation procedure** - Thin API handler registered at `athletes.getInvitation`

### Frontend (Task 2)

1. **useAthleteInvitation hook** - Query hook that:
   - Fetches invitation details for given athlete
   - Only fetches when athlete ID is provided (conditional)
   - Uses invitationKeys for cache management

2. **InvitationModal component** - Modal showing:
   - Invitation status badge (Pendiente/Aceptada/Expirada/Revocada)
   - Expiration date with relative time
   - Copyable invitation URL with success toast
   - Regenerate button (creates new invitation)
   - Handles no-invitation state with generate button

3. **Athletes table integration** - Added "Ver invitacion" row action that opens modal

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added node types to packages**

- **Found during:** Task 1 typecheck
- **Issue:** `node:crypto` import in athlete-invitation.ts and `process.env` in procedures caused typecheck failure
- **Fix:** Added `@types/node` to core and backend packages, added `"types": ["node"]` to tsconfigs, created global.d.ts for process.env declaration
- **Files modified:** packages/core/package.json, packages/core/tsconfig.json, packages/backend/package.json, packages/backend/tsconfig.json, packages/backend/src/global.d.ts
- **Commits:** 0075445

## Technical Decisions

1. **Conditional query fetching** - useAthleteInvitation only fetches when modal is open AND athlete is selected
2. **Status computation in use case** - Status (pending/accepted/expired/revoked) computed from invitation dates in use case, not stored
3. **Regenerate uses existing mutation** - InvitationModal reuses useGenerateInvitation hook and invalidates getInvitation query on success

## Files Changed

| File | Change Type | Purpose |
|------|-------------|---------|
| packages/contracts/src/athletes/invitation.ts | Modified | Added getAthleteInvitationOutputSchema |
| packages/backend/src/use-cases/athletes/get-athlete-invitation.ts | Created | Use case for fetching invitation |
| packages/backend/src/procedures/athletes/get-athlete-invitation.ts | Created | API endpoint |
| packages/backend/src/procedures/athletes/index.ts | Modified | Registered getInvitation route |
| packages/backend/src/global.d.ts | Created | process.env type declaration |
| packages/core/package.json | Modified | Added @types/node |
| packages/core/tsconfig.json | Modified | Added node types |
| packages/backend/package.json | Modified | Added @types/node |
| packages/backend/tsconfig.json | Modified | Added node types |
| apps/coach-web/src/features/athletes/hooks/queries/use-athlete-invitation.ts | Created | Query hook |
| apps/coach-web/src/features/athletes/components/invitation-modal.tsx | Created | Modal component |
| apps/coach-web/src/features/athletes/components/athletes-table.tsx | Modified | Added onViewInvitation |
| apps/coach-web/src/features/athletes/views/athletes-list-view.tsx | Modified | Integrated modal |

## Verification Results

- [x] `pnpm typecheck` passes across all packages
- [x] `pnpm lint` passes
- [x] "Ver invitacion" row action added to athletes table
- [x] InvitationModal shows status, expiration, and URL
- [x] Copy button functionality implemented
- [x] Regenerate button creates new invitation

## UAT Gap Closure

**Test 5 (FIXED):** Coach can now view and copy existing invitation links:
- Click "Ver invitacion" row action
- Modal displays invitation URL, status badge, expiration
- Copy button copies URL to clipboard with toast confirmation
- Regenerate button creates new invitation if needed

## Next Phase Readiness

This plan closes UAT gap 2 from phase 2.5 testing. No blockers for Phase 3.
