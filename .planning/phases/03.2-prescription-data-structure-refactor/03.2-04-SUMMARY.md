---
phase: 03.2-prescription-data-structure-refactor
plan: 04
subsystem: api
tags: [contracts, repository, zod, drizzle, exercise-groups, prescription-series]

# Dependency graph
requires:
  - phase: 03.2-02
    provides: PrescriptionSeries and ExerciseGroup domain entities
  - phase: 03.2-03
    provides: Multi-part prescription parser with series support
provides:
  - Exercise group contracts (schemas for CRUD operations)
  - Updated program contracts with group and series support
  - Repository port with group methods and saveDraft
  - Repository implementation for exercise_groups table
affects: [03.2-05, 03.2-06, 03.2-07]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - exerciseGroups array in session responses
    - groupId/orderWithinGroup fields in exercise rows
    - saveDraft method for atomic bulk saves

key-files:
  created:
    - packages/contracts/src/programs/exercise-group.ts
  modified:
    - packages/contracts/src/programs/program.ts
    - packages/core/src/ports/program-repository.port.ts
    - packages/backend/src/infrastructure/repositories/program.repository.ts
    - packages/backend/src/use-cases/programs/add-exercise-row.ts
    - packages/backend/src/use-cases/programs/add-split-row.ts
    - packages/backend/src/use-cases/programs/duplicate-program.ts
    - packages/backend/src/use-cases/programs/update-exercise-row.ts
    - packages/backend/src/procedures/programs/duplicate.ts
    - packages/backend/src/procedures/programs/get.ts
    - packages/backend/src/procedures/programs/templates.ts

key-decisions:
  - "Backward compatible: groupId and orderWithinGroup nullable during migration"
  - "exerciseGroups array optional in session output for migration path"
  - "saveDraft uses transaction for atomic bulk saves"

patterns-established:
  - "Group methods: createGroup, updateGroup, deleteGroup, getMaxGroupOrderIndex"
  - "Series methods: updatePrescriptionSeries for individual set updates"

# Metrics
duration: 8min
completed: 2026-01-25
---

# Phase 3.2 Plan 04: Contracts and Repository Layer Summary

**Exercise group contracts and repository layer with saveDraft method for bulk atomic saves**

## Performance

- **Duration:** ~8 min
- **Started:** 2026-01-25
- **Completed:** 2026-01-25
- **Tasks:** 3
- **Files modified:** 11

## Accomplishments
- Created exercise-group contracts with schemas for CRUD operations
- Updated program contracts with groupId, orderWithinGroup, and exerciseGroups
- Extended repository port with group methods (create, update, delete, getMaxOrderIndex)
- Added saveDraft method for atomic bulk saves with transactions
- Updated all use cases and procedures to handle new fields

## Task Commits

Each task was committed atomically:

1. **Task 1: Create exercise-group contracts** - `6655d68` (feat)
2. **Task 2: Update program contracts with series support** - `2dc74b2` (feat)
3. **Task 3: Update repository port and implementation** - `b526200` (feat)

## Files Created/Modified
- `packages/contracts/src/programs/exercise-group.ts` - New contracts for exercise groups
- `packages/contracts/src/programs/program.ts` - Added groupId, orderWithinGroup, exerciseGroups
- `packages/core/src/ports/program-repository.port.ts` - Added group methods and saveDraft
- `packages/backend/src/infrastructure/repositories/program.repository.ts` - Implemented all new methods
- `packages/backend/src/use-cases/programs/add-exercise-row.ts` - Added groupId: null, orderWithinGroup: null
- `packages/backend/src/use-cases/programs/add-split-row.ts` - Inherit group fields from parent
- `packages/backend/src/use-cases/programs/duplicate-program.ts` - Include group fields in duplication
- `packages/backend/src/use-cases/programs/update-exercise-row.ts` - Preserve group fields
- `packages/backend/src/procedures/programs/get.ts` - Return exerciseGroups in sessions
- `packages/backend/src/procedures/programs/duplicate.ts` - Return exerciseGroups in sessions
- `packages/backend/src/procedures/programs/templates.ts` - Return exerciseGroups in sessions

## Decisions Made
- **Backward compatible fields** - groupId and orderWithinGroup are nullable to support migration from legacy superset fields
- **Optional exerciseGroups array** - Sessions can have undefined exerciseGroups during migration
- **Transaction for saveDraft** - Atomic bulk saves prevent partial updates on failure

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Missing intensityUnit in PrescriptionSeriesData**
- **Found during:** Task 3 (Repository implementation)
- **Issue:** PrescriptionSeriesData type missing intensityUnit field required by series data
- **Fix:** Added `intensityUnit: 'kg' | 'lb' | '%' | 'rpe' | 'rir' | null` to the type
- **Files modified:** packages/core/src/ports/program-repository.port.ts
- **Verification:** TypeScript compilation passes
- **Committed in:** b526200 (Task 3 commit)

**2. [Rule 3 - Blocking] Use cases missing groupId and orderWithinGroup**
- **Found during:** Task 3 (Type checking)
- **Issue:** add-exercise-row.ts, add-split-row.ts, update-exercise-row.ts, duplicate-program.ts had type errors after port update
- **Fix:** Updated all four use cases to include the new fields
- **Files modified:** packages/backend/src/use-cases/programs/*.ts
- **Verification:** TypeScript compilation passes
- **Committed in:** b526200 (Task 3 commit)

**3. [Rule 3 - Blocking] Procedures missing groupId, orderWithinGroup, and exerciseGroups**
- **Found during:** Task 3 (Type checking)
- **Issue:** get.ts, duplicate.ts, templates.ts mapExerciseRow functions and session mappings needed updates
- **Fix:** Updated all three procedures to include new fields in mapExerciseRow and exerciseGroups in session output
- **Files modified:** packages/backend/src/procedures/programs/*.ts
- **Verification:** TypeScript compilation passes
- **Committed in:** b526200 (Task 3 commit)

---

**Total deviations:** 3 auto-fixed (3 blocking)
**Impact on plan:** All auto-fixes were cascading type errors from the port update. Necessary for type safety across the codebase.

## Issues Encountered
None - all issues were cascading type errors handled via deviation rules.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Repository layer ready for use cases in Plan 05
- saveDraft method available for atomic grid saves
- Group methods ready for exercise group management
- All existing functionality preserved (backward compatible)

---
*Phase: 03.2-prescription-data-structure-refactor*
*Completed: 2026-01-25*
