---
phase: 03.2-prescription-data-structure-refactor
plan: 07
type: execute
wave: 7
depends_on: ["03.2-05", "03.2-06"]
files_modified:
  - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
  - apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
  - apps/coach-web/src/components/programs/program-grid/save-button.tsx
  - apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts
  - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
autonomous: true

must_haves:
  truths:
    - "Grid uses local state hook instead of per-change mutations"
    - "Prescription cells display multi-series"
    - "Guardar button visible and functional"
    - "Saving shows loading state and success toast"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid/save-button.tsx"
      provides: "Save button component"
      exports: ["SaveButton"]
    - path: "apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts"
      provides: "Save mutation hook"
      exports: ["useSaveDraft"]
    - path: "apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx"
      provides: "Multi-series cell display"
      contains: "multi-line"
  key_links:
    - from: "apps/coach-web/src/components/programs/program-grid/program-grid.tsx"
      to: "apps/coach-web/src/hooks/use-grid-state.ts"
      via: "hook usage"
      pattern: "useGridState"
    - from: "apps/coach-web/src/components/programs/program-grid/save-button.tsx"
      to: "apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts"
      via: "mutation hook"
      pattern: "useSaveDraft"
---

<objective>
Integrate client-side state management with the grid UI and add save functionality.

Purpose: Wire up the useGridState hook to the program grid, update prescription cells to display multi-series, and add the "Guardar" button for explicit saving. This completes the client-side editing model.

Output:
- Updated program-grid.tsx using local state
- Updated prescription-cell.tsx with multi-line display
- New save-button.tsx component
- New use-save-draft.ts mutation hook
- Updated program editor page with save UI
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-RESEARCH.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-05-SUMMARY.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-06-SUMMARY.md

@apps/coach-web/src/components/programs/program-grid/program-grid.tsx
@apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
@apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSaveDraft mutation hook</name>
  <skills>/orpc-query</skills>
  <files>apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts</files>
  <action>
Create the mutation hook for saving draft changes:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { orpc } from '@/lib/api-client'
import { toast } from '@/lib/toast'
import type { SaveDraftInput } from '@strenly/contracts/programs/save-draft'

/**
 * Hook to save all accumulated grid changes
 * Replaces per-change useUpdatePrescription for bulk saves
 */
export function useSaveDraft(programId: string, onSuccess?: () => void) {
  const queryClient = useQueryClient()

  return useMutation({
    ...orpc.programs.saveDraft.mutationOptions(),
    onSuccess: (data) => {
      // Invalidate program query to refresh data
      queryClient.invalidateQueries({
        queryKey: orpc.programs.get.queryOptions({ input: { programId } }).queryKey,
      })

      // Show success toast
      toast.success('Programa guardado')

      // Show conflict warning if present
      if (data.conflictWarning) {
        toast.warning(data.conflictWarning)
      }

      // Call optional callback
      onSuccess?.()
    },
    onError: (error) => {
      const message = error?.message ?? 'Error al guardar el programa'
      toast.error(message)
    },
  })
}
```

This hook:
- Calls the saveDraft procedure
- Invalidates the program query on success
- Shows appropriate toasts
- Handles conflict warnings
  </action>
  <verify>pnpm typecheck --filter coach-web</verify>
  <done>use-save-draft.ts mutation hook exists</done>
</task>

<task type="auto">
  <name>Task 2: Create SaveButton component and update prescription cell</name>
  <skills>/frontend-design</skills>
  <files>apps/coach-web/src/components/programs/program-grid/save-button.tsx, apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx</files>
  <action>
1. Create save-button.tsx:

```typescript
import { Button } from '@/components/ui/button'
import { Loader2 } from 'lucide-react'

interface SaveButtonProps {
  isDirty: boolean
  isPending: boolean
  onSave: () => void
}

export function SaveButton({ isDirty, isPending, onSave }: SaveButtonProps) {
  return (
    <Button
      onClick={onSave}
      disabled={!isDirty || isPending}
      size="sm"
      className="min-w-[100px]"
    >
      {isPending ? (
        <>
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          Guardando...
        </>
      ) : (
        'Guardar'
      )}
    </Button>
  )
}
```

2. Update prescription-cell.tsx to handle multi-series display:

In the cell display logic, update to show multiple lines when series has variations:

```typescript
// In the display portion of PrescriptionCell
function renderPrescriptionDisplay(value: string) {
  // Value comes formatted from the grid state
  // If it contains " + " it's multi-part
  if (value.includes(' + ')) {
    const parts = value.split(' + ')
    return (
      <div className="flex flex-col justify-center py-0.5">
        {parts.map((part, i) => (
          <span key={i} className="text-xs leading-tight">
            {part}
          </span>
        ))}
      </div>
    )
  }

  // Single part - normal display
  return <span>{value}</span>
}
```

Update the cell's min-height to accommodate multi-line content:
- Add `min-h-10` class to cell container
- Adjust padding for multi-line: `py-1` instead of default

The cell should now handle:
- Empty: em dash
- Single series: compact notation "3x8@120kg"
- Multiple identical: compact "3x8@120kg"
- Multiple varied: multi-line display
  </action>
  <verify>pnpm typecheck --filter coach-web</verify>
  <done>save-button.tsx and updated prescription-cell.tsx exist</done>
</task>

<task type="auto">
  <name>Task 3: Integrate state management into program grid</name>
  <skills>/frontend-design</skills>
  <files>apps/coach-web/src/components/programs/program-grid/program-grid.tsx, apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx</files>
  <action>
1. Update program-grid.tsx to use local state:

```typescript
// Remove per-change mutation imports
// Keep structural mutations (addRow, deleteRow, etc.) for now

interface ProgramGridProps {
  data: GridData
  programId: string
  // State management from parent
  onPrescriptionChange: (rowId: string, weekId: string, notation: string) => void
  onExerciseChange: (rowId: string, exerciseId: string, exerciseName: string) => void
  isDirty: boolean
}

export function ProgramGrid({
  data,
  programId,
  onPrescriptionChange,
  onExerciseChange,
  isDirty,
}: ProgramGridProps) {
  // ... existing grid logic

  // In prescription cell callbacks, call onPrescriptionChange instead of mutation
  const handlePrescriptionCommit = useCallback(
    (rowId: string, weekId: string, notation: string) => {
      // Parse notation to series and call parent handler
      const series = parsePrescriptionToSeries(notation)
      if (series) {
        onPrescriptionChange(rowId, weekId, notation)
      }
    },
    [onPrescriptionChange]
  )

  // Similar for exercise changes
  const handleExerciseChange = useCallback(
    (rowId: string, exerciseId: string, exerciseName: string) => {
      onExerciseChange(rowId, exerciseId, exerciseName)
    },
    [onExerciseChange]
  )

  // ... rest of component
}
```

2. Update the program editor page to wire everything together:

```typescript
// In $programId.tsx route
import { useGridState } from '@/hooks/use-grid-state'
import { useUnsavedChanges } from '@/hooks/use-unsaved-changes'
import { useSaveDraft } from '@/features/programs/hooks/mutations/use-save-draft'
import { SaveButton } from '@/components/programs/program-grid/save-button'

function ProgramEditorPage() {
  // Existing program query
  const { data: program } = useProgram(programId)

  // Transform to grid data
  const gridData = useMemo(() => transformProgramToGrid(program), [program])

  // Local state management
  const { data, isDirty, actions, getChanges } = useGridState(gridData)

  // Reset when server data changes (e.g., after refresh)
  useEffect(() => {
    if (gridData) {
      actions.reset(gridData)
    }
  }, [gridData, actions])

  // Navigation guard
  useUnsavedChanges(isDirty)

  // Save mutation
  const saveMutation = useSaveDraft(programId, () => {
    actions.markSaved()
  })

  const handleSave = useCallback(() => {
    const changes = getChanges
    saveMutation.mutate({
      programId,
      prescriptions: changes.prescriptions,
      exerciseRows: changes.exerciseRows,
      groups: [],
      lastLoadedAt: changes.lastLoadedAt,
    })
  }, [programId, getChanges, saveMutation])

  return (
    <div>
      {/* Header with save button */}
      <div className="flex items-center justify-between mb-4">
        <h1>{program.name}</h1>
        <SaveButton
          isDirty={isDirty}
          isPending={saveMutation.isPending}
          onSave={handleSave}
        />
      </div>

      {/* Grid */}
      <ProgramGrid
        data={data}
        programId={programId}
        onPrescriptionChange={actions.updatePrescription}
        onExerciseChange={actions.updateExercise}
        isDirty={isDirty}
      />
    </div>
  )
}
```

Keep existing structural mutations (add/delete rows, weeks, sessions) - they can remain as immediate server operations since they affect structure, not just prescription data.
  </action>
  <verify>pnpm typecheck --filter coach-web && pnpm build --filter coach-web</verify>
  <done>Program grid uses local state, save button integrated, navigation guard active</done>
</task>

</tasks>

<verification>
Run from repository root:
```bash
pnpm typecheck --filter coach-web
pnpm build --filter coach-web
```

Manual verification:
1. Start dev server: pnpm dev:coach
2. Navigate to a program
3. Edit a prescription cell
4. Verify "Guardar" button becomes enabled
5. Try to navigate away - should see warning
6. Click "Guardar" - should see loading state and success toast
</verification>

<success_criteria>
- [ ] use-save-draft.ts hook exists and calls saveDraft procedure
- [ ] save-button.tsx component renders correctly
- [ ] prescription-cell.tsx handles multi-line display
- [ ] program-grid.tsx uses props for change handlers (not mutations)
- [ ] Program editor page wires up state, save, and navigation guard
- [ ] Guardar button disabled when not dirty
- [ ] Navigation blocked when dirty
- [ ] App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-prescription-data-structure-refactor/03.2-07-SUMMARY.md`
</output>
