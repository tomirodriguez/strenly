---
phase: 03.2-prescription-data-structure-refactor
plan: 01
subsystem: database
tags: [drizzle, postgresql, jsonb, schema, migration]

# Dependency graph
requires:
  - phase: 03-program-builder
    provides: program_exercises and prescriptions tables
provides:
  - exercise_groups table schema
  - groupId/orderWithinGroup columns on program_exercises
  - PrescriptionSeriesData interface for series array
  - series JSONB column on prescriptions
affects: [03.2-02, 03.2-03, 03.2-04, 03.2-05, 03.2-06, 03.2-07, 03.2-08]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "JSONB array for set-level prescription data"
    - "Group-based exercise organization replacing superset columns"
    - "Nullable new columns during migration period"

key-files:
  created:
    - packages/database/src/schema/exercise-groups.ts
  modified:
    - packages/database/src/schema/program-exercises.ts
    - packages/database/src/schema/prescriptions.ts
    - packages/database/src/schema/index.ts

key-decisions:
  - "New columns nullable for migration compatibility"
  - "Deprecated columns kept until Plan 08 migration"
  - "PrescriptionSeriesData uses orderIndex for array position"

patterns-established:
  - "exercise_groups table: 1=standalone, 2=superset, 3+=circuit"
  - "Series array stores per-set data including intra-set rest"

# Metrics
duration: 3min
completed: 2026-01-25
---

# Phase 3.2 Plan 01: Database Schema Summary

**Exercise groups table, group-based program_exercises columns, and series JSONB array structure for prescriptions**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-25T12:00:00Z
- **Completed:** 2026-01-25T12:03:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- Created exercise_groups table with sessionId foreign key and orderIndex
- Added groupId and orderWithinGroup columns to program_exercises
- Added PrescriptionSeriesData interface with per-set parameters
- Added series JSONB column to prescriptions table
- Deprecated legacy columns with comments for migration tracking

## Task Commits

Each task was committed atomically:

1. **Task 1: Create exercise_groups table schema** - `bb88590` (feat)
2. **Task 2: Add group columns to program_exercises** - `047ecdf` (feat)
3. **Task 3: Update prescriptions schema with series array** - `1b77286` (feat)

## Files Created/Modified

- `packages/database/src/schema/exercise-groups.ts` - New table for group-based exercise organization
- `packages/database/src/schema/program-exercises.ts` - Added groupId, orderWithinGroup columns with relation
- `packages/database/src/schema/prescriptions.ts` - Added PrescriptionSeriesData interface and series column
- `packages/database/src/schema/index.ts` - Export new table and type

## Decisions Made

- **Nullable new columns:** groupId, orderWithinGroup, and series are all nullable to allow incremental migration from existing data
- **Deprecated comments:** Old superset/split-row columns marked with DEPRECATED comments referencing Plan 08
- **Series data structure:** PrescriptionSeriesData includes restSeconds for cluster sets (intra-set rest)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Schema foundation complete for Phase 3.2
- Domain entities (Plan 02) can now define ExerciseGroup and updated Prescription entities
- Database migration will be run in Plan 08 after all code is ready

---
*Phase: 03.2-prescription-data-structure-refactor*
*Completed: 2026-01-25*
