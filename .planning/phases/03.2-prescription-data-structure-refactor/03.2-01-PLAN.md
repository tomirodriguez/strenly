---
phase: 03.2-prescription-data-structure-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema/exercise-groups.ts
  - packages/database/src/schema/program-exercises.ts
  - packages/database/src/schema/prescriptions.ts
  - packages/database/src/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "exercise_groups table exists in database schema"
    - "program_exercises has group_id and order_within_group columns"
    - "prescriptions stores series as JSONB array"
  artifacts:
    - path: "packages/database/src/schema/exercise-groups.ts"
      provides: "ExerciseGroup table definition"
      exports: ["exerciseGroups", "exerciseGroupsRelations"]
    - path: "packages/database/src/schema/program-exercises.ts"
      provides: "Updated ProgramExercise with group reference"
      contains: "groupId"
    - path: "packages/database/src/schema/prescriptions.ts"
      provides: "Series array JSONB structure"
      contains: "PrescriptionSeriesData"
  key_links:
    - from: "packages/database/src/schema/program-exercises.ts"
      to: "packages/database/src/schema/exercise-groups.ts"
      via: "foreign key groupId"
      pattern: "references.*exerciseGroups"
---

<objective>
Create database schema changes for the prescription data structure refactor.

Purpose: Establish the new data model foundation with exercise_groups table, updated program_exercises references, and JSONB series array structure for prescriptions. This is the foundation for all subsequent domain and application layer work.

Output:
- New exercise_groups.ts schema file
- Updated program_exercises.ts with group columns (keeping old columns for migration compatibility)
- Updated prescriptions.ts with series JSONB structure
- Schema exports updated
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-RESEARCH.md

@packages/database/src/schema/program-exercises.ts
@packages/database/src/schema/prescriptions.ts
@packages/database/src/schema/program-sessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exercise_groups table schema</name>
  <skills>/repository</skills>
  <files>packages/database/src/schema/exercise-groups.ts</files>
  <action>
Create new schema file for exercise_groups table:

```typescript
import { relations } from 'drizzle-orm'
import { index, integer, pgTable, text, timestamp } from 'drizzle-orm/pg-core'
import { programSessions } from './program-sessions'

/**
 * Exercise groups table
 * Represents a group of exercises within a session
 * Group size determines display type:
 * - 1 exercise = standalone
 * - 2 exercises = bi-series/superset
 * - 3+ exercises = circuit
 */
export const exerciseGroups = pgTable(
  'exercise_groups',
  {
    id: text('id').primaryKey(), // prefixed 'eg-'
    sessionId: text('session_id')
      .notNull()
      .references(() => programSessions.id, { onDelete: 'cascade' }),
    orderIndex: integer('order_index').notNull(), // Position within session
    name: text('name'), // Optional label: "Heavy Block", null for auto-letter
    createdAt: timestamp('created_at').defaultNow().notNull(),
    updatedAt: timestamp('updated_at')
      .defaultNow()
      .$onUpdate(() => new Date())
      .notNull(),
  },
  (table) => [
    index('exercise_groups_session_id_idx').on(table.sessionId),
    index('exercise_groups_order_index_idx').on(table.sessionId, table.orderIndex),
  ],
)

export const exerciseGroupsRelations = relations(exerciseGroups, ({ one }) => ({
  session: one(programSessions, {
    fields: [exerciseGroups.sessionId],
    references: [programSessions.id],
  }),
}))
```

Follow existing schema conventions (text IDs with prefix, standard timestamps, ON DELETE CASCADE).
  </action>
  <verify>pnpm typecheck --filter @strenly/database</verify>
  <done>exercise_groups.ts exists with table definition, relations, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add group columns to program_exercises</name>
  <skills>/repository</skills>
  <files>packages/database/src/schema/program-exercises.ts</files>
  <action>
Update program_exercises schema to add new group-based columns. Keep existing superset columns for backward compatibility during migration (they will be deprecated later):

1. Add import for exerciseGroups
2. Add new columns after existing superset columns:
   - `groupId: text('group_id').references(() => exerciseGroups.id, { onDelete: 'cascade' })` - nullable for migration period
   - `orderWithinGroup: integer('order_within_group')` - nullable for migration period

3. Add index for group_id:
   - `index('program_exercises_group_id_idx').on(table.groupId)`

4. Add relation to exerciseGroups in programExercisesRelations:
   ```typescript
   group: one(exerciseGroups, {
     fields: [programExercises.groupId],
     references: [exerciseGroups.id],
   }),
   ```

Do NOT remove existing supersetGroup, supersetOrder, isSubRow, parentRowId columns - they remain for migration compatibility. Add a comment marking them as deprecated.
  </action>
  <verify>pnpm typecheck --filter @strenly/database</verify>
  <done>program_exercises has groupId and orderWithinGroup columns, relation to exerciseGroups, deprecated comment on old columns</done>
</task>

<task type="auto">
  <name>Task 3: Update prescriptions schema with series array</name>
  <skills>/repository</skills>
  <files>packages/database/src/schema/prescriptions.ts, packages/database/src/schema/index.ts</files>
  <action>
Update prescriptions.ts to add new series-based JSONB structure alongside existing prescription column:

1. Add new interface for series data:
```typescript
/**
 * Single set/series in a prescription array
 * Each element represents one set with its parameters
 */
export interface PrescriptionSeriesData {
  orderIndex: number // Position in array: 0, 1, 2...
  reps: number | null // null for AMRAP
  repsMax: number | null // For rep ranges (8-12)
  isAmrap: boolean
  intensityType: 'absolute' | 'percentage' | 'rpe' | 'rir' | null
  intensityValue: number | null
  intensityUnit: 'kg' | 'lb' | '%' | 'rpe' | 'rir' | null
  tempo: string | null // "3110" or "31X0"
  restSeconds: number | null // For intra-set rest (clusters)
}
```

2. Add new column alongside existing prescription column:
   - `series: jsonb('series').$type<PrescriptionSeriesData[]>()` - nullable for migration period

3. Add comment on existing `prescription` column marking it as deprecated (will be migrated to series array)

4. Update packages/database/src/schema/index.ts to export:
   - exerciseGroups and exerciseGroupsRelations from './exercise-groups'
   - PrescriptionSeriesData type from './prescriptions'

Do NOT remove existing `prescription` JSONB column - it remains for migration compatibility.
  </action>
  <verify>pnpm typecheck --filter @strenly/database</verify>
  <done>prescriptions has series JSONB column, PrescriptionSeriesData interface exported, schema index updated</done>
</task>

</tasks>

<verification>
Run from repository root:
```bash
pnpm typecheck --filter @strenly/database
```

Verify schema compiles without errors.

Note: Do NOT run db:push or db:generate yet - the actual database migration will be done in Plan 08 after all code is ready.
</verification>

<success_criteria>
- [ ] exercise_groups.ts exists with complete table definition
- [ ] program_exercises.ts has groupId, orderWithinGroup columns (nullable)
- [ ] prescriptions.ts has series JSONB column (nullable) and PrescriptionSeriesData interface
- [ ] Old columns marked as deprecated in comments
- [ ] All schemas compile without type errors
- [ ] schema/index.ts exports new tables and types
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-prescription-data-structure-refactor/03.2-01-SUMMARY.md`
</output>
