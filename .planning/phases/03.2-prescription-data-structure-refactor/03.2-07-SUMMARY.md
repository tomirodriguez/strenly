---
phase: 03.2-prescription-data-structure-refactor
plan: 07
subsystem: ui
tags: [react, zustand, state-management, program-grid, save-draft]

# Dependency graph
requires:
  - phase: 03.2-05
    provides: saveDraft use case and procedure
  - phase: 03.2-06
    provides: Zustand grid store and useUnsavedChanges hook
provides:
  - useSaveDraft mutation hook for bulk saves
  - SaveButton component with dirty/pending state
  - Multi-line prescription cell display for varied series
  - Program grid with local state management integration
  - Navigation guard for unsaved changes
affects: [03.2-08]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Local state editing with explicit save via Zustand store"
    - "parsePrescriptionToSeries in grid for notation to series conversion"
    - "Multi-line prescription display for ' + ' separated notations"

key-files:
  created:
    - apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts
    - apps/coach-web/src/components/programs/program-grid/save-button.tsx
  modified:
    - apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx
    - apps/coach-web/src/components/programs/program-grid/program-grid.tsx
    - apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx

key-decisions:
  - "Notation parsed to series in handlePrescriptionCommit before calling store action"
  - "SaveButton in footer alongside Export PDF button"
  - "Multi-line display splits on ' + ' delimiter"

patterns-established:
  - "Local state with explicit save: Zustand store holds edits, SaveButton triggers bulk save"
  - "Backward compatible grid: props optional, falls back to server mutations if not provided"

# Metrics
duration: 3min
completed: 2026-01-26
---

# Phase 03.2 Plan 07: Grid Integration Summary

**Local state editing with parsePrescriptionToSeries conversion, SaveButton component, and navigation guard for unsaved changes**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-25T23:57:36Z
- **Completed:** 2026-01-26T00:00:57Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- Created useSaveDraft mutation hook for bulk saving accumulated changes
- Added SaveButton component with isDirty/isPending state display
- Updated prescription-cell to display multi-line for varied series notations
- Integrated Zustand store into program grid with parsePrescriptionToSeries conversion
- Wired navigation guard to warn before leaving with unsaved changes

## Task Commits

Each task was committed atomically:

1. **Task 1: Create useSaveDraft mutation hook** - `65210c9` (feat)
2. **Task 2: Create SaveButton component and update prescription cell** - `5f7b16a` (feat)
3. **Task 3: Integrate state management into program grid** - `8d45303` (feat)

## Files Created/Modified

### Created
- `apps/coach-web/src/features/programs/hooks/mutations/use-save-draft.ts` - Mutation hook for bulk saves with query invalidation
- `apps/coach-web/src/components/programs/program-grid/save-button.tsx` - Save button with dirty/pending state

### Modified
- `apps/coach-web/src/components/programs/program-grid/prescription-cell.tsx` - Multi-line display for varied series
- `apps/coach-web/src/components/programs/program-grid/program-grid.tsx` - Local state integration with parsePrescriptionToSeries
- `apps/coach-web/src/routes/_authenticated/$orgSlug/programs/$programId.tsx` - Full integration with Zustand store and save flow

## Decisions Made

- **Notation parsed in handlePrescriptionCommit**: The grid receives notation strings from cell edits but calls parsePrescriptionToSeries() to convert to series array before passing to store action. This keeps the parsing logic in one place.
- **Backward compatible props**: Grid accepts optional gridData/onPrescriptionChange/onExerciseChange props. When not provided, falls back to legacy server mutation behavior.
- **Multi-line display split on ' + '**: When prescription notation contains ' + ' (indicating multiple varied series), display each part on separate lines with smaller text.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Local state editing model complete
- Save button functional with loading state and success toast
- Navigation guard prevents data loss
- Ready for Phase 03.2-08 (Data Migration)

---
*Phase: 03.2-prescription-data-structure-refactor*
*Completed: 2026-01-26*
