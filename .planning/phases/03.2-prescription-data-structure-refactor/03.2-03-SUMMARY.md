---
phase: 03.2-prescription-data-structure-refactor
plan: 03
subsystem: api
tags: [zod, parser, notation, series, multi-part]

# Dependency graph
requires:
  - phase: 03.2-02
    provides: PrescriptionSeries domain entity with validation
provides:
  - parsePrescriptionToSeries() function for notation-to-series expansion
  - formatSeriesToNotation() function for series-to-notation compaction
  - PrescriptionSeriesInput schema for API input validation
  - Multi-part notation support (e.g., "3x8@120kg + 1x1@130kg")
affects: [03.2-04, 03.2-05, 03.2-06, coach-web]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Multi-part notation parsing via split and expand"
    - "Consecutive grouping for compact formatting"

key-files:
  created: []
  modified:
    - packages/contracts/src/programs/prescription.ts
    - packages/contracts/src/programs/prescription.test.ts

key-decisions:
  - "IntensityUnit schema for typed intensity units (kg, lb, %, rpe, rir)"
  - "Empty/skip notations return empty array, not null"
  - "Invalid notations return null (parse failure)"
  - "Partial invalid fails entire notation (3x8 + invalid -> null)"
  - "Consecutive grouping only - non-adjacent identical series not merged"

patterns-established:
  - "Series expansion: parsePrescriptionToSeries expands sets to individual series"
  - "Series compaction: formatSeriesToNotation groups consecutive identical series"

# Metrics
duration: 3min
completed: 2026-01-25
---

# Phase 3.2 Plan 03: Multi-Part Prescription Parser Summary

**Prescription notation parser extended with series expansion and multi-part support via parsePrescriptionToSeries() and formatSeriesToNotation()**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-25T23:33:28Z
- **Completed:** 2026-01-25T23:36:26Z
- **Tasks:** 1 (TDD)
- **Files modified:** 2

## Accomplishments
- Added `parsePrescriptionToSeries()` to expand notation like "3x8" into 3 individual series objects
- Added `formatSeriesToNotation()` to compact series arrays back to notation strings
- Support for multi-part notations like "3x8@120kg + 1x1@130kg" (expands to 4 series)
- Added `PrescriptionSeriesInput` schema and `IntensityUnit` schema for typed API input
- Maintained full backward compatibility with existing `parsePrescriptionNotation()`
- Added 48 new tests (total 122 tests in file)

## Task Commits

Each task was committed atomically:

1. **Task 1: Multi-Part Prescription Notation Parser** - `d13ebf9` (feat) - TDD implementation

## Files Created/Modified
- `packages/contracts/src/programs/prescription.ts` - Added series parsing/formatting functions and schemas
- `packages/contracts/src/programs/prescription.test.ts` - Added comprehensive tests for series operations

## Decisions Made
- **Empty/skip returns empty array:** `parsePrescriptionToSeries("")` and `parsePrescriptionToSeries("â€”")` return `[]` instead of `null` for easier downstream handling
- **Partial invalid fails all:** If any part of multi-part notation is invalid (e.g., "3x8 + invalid"), entire parse returns `null`
- **Consecutive grouping only:** `formatSeriesToNotation` only groups consecutive identical series, not non-adjacent ones
- **IntensityUnit schema:** Added explicit schema for intensity units (kg, lb, %, rpe, rir) for type safety

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
- Biome lint flagged `forEach` callbacks that returned values from `expect()` - fixed by using `for...of` loops instead

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Parser ready for use in prescription update flow (Plan 04)
- Series array format enables flexible prescription editing
- Round-trip parsing verified: parse -> format -> parse produces equivalent results

---
*Phase: 03.2-prescription-data-structure-refactor*
*Completed: 2026-01-25*
