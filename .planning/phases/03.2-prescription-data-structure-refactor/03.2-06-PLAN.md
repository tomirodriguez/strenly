---
phase: 03.2-prescription-data-structure-refactor
plan: 06
type: execute
wave: 6
depends_on: ["03.2-04"]
files_modified:
  - apps/coach-web/package.json
  - apps/coach-web/src/hooks/use-grid-state.ts
  - apps/coach-web/src/hooks/use-unsaved-changes.ts
autonomous: true

must_haves:
  truths:
    - "Grid state is managed with immer reducer"
    - "All edits update local state without API calls"
    - "isDirty flag tracks unsaved changes"
    - "Navigation blocked when dirty"
  artifacts:
    - path: "apps/coach-web/src/hooks/use-grid-state.ts"
      provides: "Immer reducer for grid state"
      exports: ["useGridState", "GridAction"]
    - path: "apps/coach-web/src/hooks/use-unsaved-changes.ts"
      provides: "Navigation guard hook"
      exports: ["useUnsavedChanges"]
  key_links:
    - from: "apps/coach-web/src/hooks/use-grid-state.ts"
      to: "apps/coach-web/src/components/programs/program-grid/program-grid.tsx"
      via: "hook usage"
      pattern: "useGridState"
    - from: "apps/coach-web/src/hooks/use-grid-state.ts"
      to: "@strenly/contracts/programs/prescription"
      via: "import formatSeriesToNotation"
      pattern: "import.*formatSeriesToNotation.*from.*@strenly/contracts"
---

<objective>
Create client-side grid state management with immer.

Purpose: Enable 100% client-side editing where changes accumulate in local state and are saved with a single "Guardar" action. This removes the lag of per-change API calls and provides a faster editing experience.

Output:
- useGridState hook with immer reducer
- useUnsavedChanges hook for navigation guards
- immer and use-immer dependencies installed
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-RESEARCH.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-04-SUMMARY.md

@apps/coach-web/src/components/programs/program-grid/types.ts
@apps/coach-web/src/components/programs/program-grid/transform-program.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install immer dependencies</name>
  <files>apps/coach-web/package.json</files>
  <action>
Install immer and use-immer as dependencies:

```bash
cd apps/coach-web
pnpm add immer use-immer
```

These are standard libraries for immutable state management in React.
  </action>
  <verify>grep -q "immer" apps/coach-web/package.json && grep -q "use-immer" apps/coach-web/package.json</verify>
  <done>immer and use-immer added to package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create useGridState hook</name>
  <files>apps/coach-web/src/hooks/use-grid-state.ts</files>
  <action>
Create the grid state management hook using useImmerReducer:

```typescript
import { useImmerReducer } from 'use-immer'
import { useCallback, useMemo } from 'react'
import type { GridData, GridRow } from '@/components/programs/program-grid/types'
import type { PrescriptionSeriesInput } from '@strenly/contracts/programs/prescription'
import { formatSeriesToNotation } from '@strenly/contracts/programs/prescription'

// State structure
interface GridState {
  data: GridData
  isDirty: boolean
  lastLoadedAt: Date
  // Track changes for efficient save
  changedPrescriptions: Map<string, { exerciseRowId: string; weekId: string; series: PrescriptionSeriesInput[] }>
  changedExerciseRows: Map<string, { rowId: string; exerciseId: string }>
}

// Action types
export type GridAction =
  | { type: 'UPDATE_PRESCRIPTION'; exerciseRowId: string; weekId: string; series: PrescriptionSeriesInput[] }
  | { type: 'UPDATE_EXERCISE'; rowId: string; exerciseId: string; exerciseName: string }
  | { type: 'ADD_ROW_TO_GROUP'; groupId: string; exerciseRowId: string }
  | { type: 'REMOVE_ROW_FROM_GROUP'; exerciseRowId: string }
  | { type: 'RESET'; data: GridData }
  | { type: 'MARK_SAVED' }

function gridReducer(draft: GridState, action: GridAction) {
  switch (action.type) {
    case 'UPDATE_PRESCRIPTION': {
      // Find the row and update its prescription
      const row = draft.data.rows.find(
        (r): r is GridRow & { type: 'exercise' } =>
          r.type === 'exercise' && r.id === action.exerciseRowId
      )
      if (row) {
        // Update the display value in prescriptions map
        const notationDisplay = formatSeriesToNotation(action.series)
        row.prescriptions[action.weekId] = notationDisplay

        // Track the change
        const key = `${action.exerciseRowId}:${action.weekId}`
        draft.changedPrescriptions.set(key, {
          exerciseRowId: action.exerciseRowId,
          weekId: action.weekId,
          series: action.series,
        })
        draft.isDirty = true
      }
      break
    }

    case 'UPDATE_EXERCISE': {
      const row = draft.data.rows.find(
        (r): r is GridRow & { type: 'exercise' } =>
          r.type === 'exercise' && r.id === action.rowId
      )
      if (row && row.exercise) {
        row.exercise.exerciseId = action.exerciseId
        row.exercise.exerciseName = action.exerciseName

        draft.changedExerciseRows.set(action.rowId, {
          rowId: action.rowId,
          exerciseId: action.exerciseId,
        })
        draft.isDirty = true
      }
      break
    }

    case 'RESET':
      draft.data = action.data
      draft.isDirty = false
      draft.lastLoadedAt = new Date()
      draft.changedPrescriptions = new Map()
      draft.changedExerciseRows = new Map()
      break

    case 'MARK_SAVED':
      draft.isDirty = false
      draft.changedPrescriptions = new Map()
      draft.changedExerciseRows = new Map()
      break
  }
}

export function useGridState(initialData: GridData) {
  const [state, dispatch] = useImmerReducer(gridReducer, {
    data: initialData,
    isDirty: false,
    lastLoadedAt: new Date(),
    changedPrescriptions: new Map(),
    changedExerciseRows: new Map(),
  })

  // Memoized actions
  const updatePrescription = useCallback(
    (exerciseRowId: string, weekId: string, series: PrescriptionSeriesInput[]) => {
      dispatch({ type: 'UPDATE_PRESCRIPTION', exerciseRowId, weekId, series })
    },
    [dispatch]
  )

  const updateExercise = useCallback(
    (rowId: string, exerciseId: string, exerciseName: string) => {
      dispatch({ type: 'UPDATE_EXERCISE', rowId, exerciseId, exerciseName })
    },
    [dispatch]
  )

  const reset = useCallback(
    (data: GridData) => {
      dispatch({ type: 'RESET', data })
    },
    [dispatch]
  )

  const markSaved = useCallback(() => {
    dispatch({ type: 'MARK_SAVED' })
  }, [dispatch])

  // Get changes for save operation
  const getChanges = useMemo(() => ({
    prescriptions: Array.from(state.changedPrescriptions.values()),
    exerciseRows: Array.from(state.changedExerciseRows.values()),
    lastLoadedAt: state.lastLoadedAt,
  }), [state.changedPrescriptions, state.changedExerciseRows, state.lastLoadedAt])

  return {
    data: state.data,
    isDirty: state.isDirty,
    actions: {
      updatePrescription,
      updateExercise,
      reset,
      markSaved,
    },
    getChanges,
  }
}
```

IMPORTANT: Import formatSeriesToNotation from the contracts package for display formatting.
The import statement MUST be: `import { formatSeriesToNotation } from '@strenly/contracts/programs/prescription'`
  </action>
  <verify>pnpm typecheck --filter coach-web</verify>
  <done>use-grid-state.ts exists with immer reducer, includes formatSeriesToNotation import from @strenly/contracts</done>
</task>

<task type="auto">
  <name>Task 3: Create useUnsavedChanges hook</name>
  <files>apps/coach-web/src/hooks/use-unsaved-changes.ts</files>
  <action>
Create hook for navigation guards:

```typescript
import { useEffect, useCallback } from 'react'
import { useBlocker } from '@tanstack/react-router'

/**
 * Hook to warn about unsaved changes on navigation
 * Uses TanStack Router's useBlocker for in-app navigation
 * and beforeunload for browser navigation
 */
export function useUnsavedChanges(isDirty: boolean, message?: string) {
  const defaultMessage = 'Tienes cambios sin guardar. Estas seguro de que quieres salir?'
  const warningMessage = message ?? defaultMessage

  // Block in-app navigation with TanStack Router
  const { proceed, reset, status } = useBlocker({
    condition: isDirty,
  })

  // Block browser navigation (refresh, close tab)
  useEffect(() => {
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (isDirty) {
        e.preventDefault()
        e.returnValue = warningMessage
        return warningMessage
      }
    }

    window.addEventListener('beforeunload', handleBeforeUnload)
    return () => window.removeEventListener('beforeunload', handleBeforeUnload)
  }, [isDirty, warningMessage])

  // Confirmation dialog handler
  const confirmNavigation = useCallback(() => {
    if (status === 'blocked') {
      const confirmed = window.confirm(warningMessage)
      if (confirmed) {
        proceed()
      } else {
        reset()
      }
    }
  }, [status, warningMessage, proceed, reset])

  // Auto-show confirmation when blocked
  useEffect(() => {
    if (status === 'blocked') {
      confirmNavigation()
    }
  }, [status, confirmNavigation])

  return {
    isBlocked: status === 'blocked',
    proceed,
    reset,
  }
}
```

This hook:
1. Uses TanStack Router's useBlocker to intercept in-app navigation
2. Adds beforeunload listener for browser navigation
3. Shows confirmation dialog when navigation is attempted with unsaved changes
  </action>
  <verify>pnpm typecheck --filter coach-web</verify>
  <done>use-unsaved-changes.ts exists with navigation blocking</done>
</task>

</tasks>

<verification>
Run from repository root:
```bash
pnpm typecheck --filter coach-web
```

Verify:
- immer and use-immer in package.json
- use-grid-state.ts exports useGridState hook
- use-grid-state.ts imports formatSeriesToNotation from @strenly/contracts/programs/prescription
- use-unsaved-changes.ts exports useUnsavedChanges hook
</verification>

<success_criteria>
- [ ] immer and use-immer installed
- [ ] useGridState hook manages grid data with immer reducer
- [ ] useGridState imports formatSeriesToNotation from @strenly/contracts
- [ ] isDirty flag tracks unsaved changes
- [ ] getChanges returns accumulated changes for save
- [ ] useUnsavedChanges blocks navigation when dirty
- [ ] beforeunload event handled for browser navigation
- [ ] All types compile
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-prescription-data-structure-refactor/03.2-06-SUMMARY.md`
</output>
