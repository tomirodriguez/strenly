---
phase: 03.2-prescription-data-structure-refactor
plan: 05
subsystem: api
tags: [orpc, neverthrow, use-case, procedure, bulk-save]

# Dependency graph
requires:
  - phase: 03.2-04
    provides: saveDraft repository method for atomic bulk updates
provides:
  - saveDraft contract with input/output schemas
  - saveDraft use case with authorization and conflict detection
  - saveDraft procedure in programs router
affects: [03.2-07, client-side-state, program-grid]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Bulk save contract pattern with optional conflict detection"
    - "Use case mapping from contract to repository input types"

key-files:
  created:
    - packages/contracts/src/programs/save-draft.ts
    - packages/backend/src/use-cases/programs/save-draft.ts
    - packages/backend/src/procedures/programs/save-draft.ts
  modified:
    - packages/contracts/src/programs/index.ts
    - packages/contracts/package.json
    - packages/backend/src/procedures/programs/index.ts

key-decisions:
  - "saveDraft placed in prescriptions sub-router (prescriptions.saveDraft) alongside existing update"
  - "Coexist with per-change mutations during transition period"
  - "Optional lastLoadedAt for conflict detection, returns warning instead of blocking"

patterns-established:
  - "Contract-to-repository input mapping in use case layer"
  - "Repository error handling with discriminated union mappers"

# Metrics
duration: 2min
completed: 2026-01-25
---

# Phase 3.2 Plan 05: Use Cases Summary

**saveDraft use case and procedure for bulk program saving with optional conflict detection**

## Performance

- **Duration:** 2 min
- **Started:** 2026-01-25T23:48:57Z
- **Completed:** 2026-01-25T23:51:41Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments
- Created saveDraft contract with prescriptionUpdate, exerciseRowUpdate, and groupUpdate schemas
- Created saveDraft use case with authorization-first pattern and conflict detection
- Created saveDraft procedure and wired into programs router
- Maintained backward compatibility with existing updatePrescription and updateExerciseRow procedures

## Task Commits

Each task was committed atomically:

1. **Task 1: Create saveDraft contract** - `e877ccd` (feat)
2. **Task 2: Create saveDraft use case** - `4ca6b65` (feat)
3. **Task 3: Create saveDraft procedure, wire up, verify backward compatibility** - `664a8b0` (feat)

## Files Created/Modified
- `packages/contracts/src/programs/save-draft.ts` - Bulk save input/output schemas
- `packages/contracts/src/programs/index.ts` - Export new schemas
- `packages/contracts/package.json` - Add save-draft export path
- `packages/backend/src/use-cases/programs/save-draft.ts` - Use case with auth and conflict check
- `packages/backend/src/procedures/programs/save-draft.ts` - Thin procedure handler
- `packages/backend/src/procedures/programs/index.ts` - Wire into prescriptions router

## Decisions Made
- **saveDraft in prescriptions sub-router** - Placed at `programs.prescriptions.saveDraft` to group with existing `update` for prescription operations
- **Conflict warning vs blocking** - Returns `conflictWarning` string rather than blocking the save, letting client decide how to handle
- **mapRepoError helper** - Created typed helper function to map discriminated union errors from repository

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Contract import path needed explicit package.json export entry - added `./programs/save-draft` export
- Repository error type handling - created `mapRepoError` helper to properly handle discriminated union

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- saveDraft API endpoint ready for client-side integration
- Existing per-change mutations preserved for incremental migration
- Plan 06 can now build contracts and procedures for series parsing
- Plan 07 can implement client-side state management with saveDraft

---
*Phase: 03.2-prescription-data-structure-refactor*
*Completed: 2026-01-25*
