---
phase: 03.2-prescription-data-structure-refactor
plan: 04
type: execute
wave: 4
depends_on: ["03.2-02", "03.2-03"]
files_modified:
  - packages/contracts/src/programs/exercise-group.ts
  - packages/contracts/src/programs/program.ts
  - packages/core/src/ports/program-repository.port.ts
  - packages/backend/src/infrastructure/repositories/program.repository.ts
autonomous: true

must_haves:
  truths:
    - "Contracts define schemas for exercise groups and series"
    - "Repository port has methods for groups"
    - "Repository implementation handles new columns"
    - "Existing queries still work (backward compatible)"
  artifacts:
    - path: "packages/contracts/src/programs/exercise-group.ts"
      provides: "ExerciseGroup contracts"
      exports: ["exerciseGroupSchema", "createExerciseGroupInputSchema"]
    - path: "packages/contracts/src/programs/program.ts"
      provides: "Updated program schema with groups"
      contains: "exerciseGroups"
    - path: "packages/core/src/ports/program-repository.port.ts"
      provides: "Updated repository interface"
      contains: "createGroup"
    - path: "packages/backend/src/infrastructure/repositories/program.repository.ts"
      provides: "Updated repository implementation"
      contains: "exerciseGroups"
  key_links:
    - from: "packages/backend/src/infrastructure/repositories/program.repository.ts"
      to: "packages/database/src/schema/exercise-groups.ts"
      via: "drizzle query"
      pattern: "db.*exerciseGroups"
---

<objective>
Update contracts and repository layer for the new exercise groups and series model.

Purpose: Extend the API contracts to support exercise groups and prescription series, and update the repository to read/write the new data structures while maintaining backward compatibility with existing data.

Output:
- New exercise-group.ts contracts file
- Updated program.ts contracts with groups
- Updated repository port interface
- Updated repository implementation
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-RESEARCH.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-02-SUMMARY.md
@.planning/phases/03.2-prescription-data-structure-refactor/03.2-03-SUMMARY.md

@packages/contracts/src/programs/program.ts
@packages/core/src/ports/program-repository.port.ts
@packages/backend/src/infrastructure/repositories/program.repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exercise-group contracts</name>
  <skills>/contracts</skills>
  <files>packages/contracts/src/programs/exercise-group.ts</files>
  <action>
Create new contracts file for exercise groups:

```typescript
import { z } from 'zod'

/**
 * Exercise group output schema
 * Represents a group of exercises within a session
 */
export const exerciseGroupSchema = z.object({
  id: z.string(),
  sessionId: z.string(),
  orderIndex: z.number().int().min(0),
  name: z.string().nullable(),
})

export type ExerciseGroup = z.infer<typeof exerciseGroupSchema>

/**
 * Create exercise group input
 */
export const createExerciseGroupInputSchema = z.object({
  programId: z.string(), // For access verification
  sessionId: z.string(),
  name: z.string().max(50).optional(),
  exerciseId: z.string().optional(), // Optional initial exercise to add
})

export type CreateExerciseGroupInput = z.infer<typeof createExerciseGroupInputSchema>

/**
 * Update exercise group input
 */
export const updateExerciseGroupInputSchema = z.object({
  programId: z.string(),
  groupId: z.string(),
  name: z.string().max(50).nullable().optional(),
})

export type UpdateExerciseGroupInput = z.infer<typeof updateExerciseGroupInputSchema>
```

Follow existing contracts naming conventions.
  </action>
  <verify>pnpm typecheck --filter @strenly/contracts</verify>
  <done>exercise-group.ts exists with schemas and exported types</done>
</task>

<task type="auto">
  <name>Task 2: Update program contracts with series support</name>
  <skills>/contracts</skills>
  <files>packages/contracts/src/programs/program.ts</files>
  <action>
Update program contracts to include:

1. Add import for prescriptionSeriesInputSchema from prescription.ts (from Plan 03)

2. Add exerciseWithGroupSchema that extends current exercise row schema:
```typescript
// Exercise within a group
export const programExerciseWithGroupSchema = z.object({
  id: z.string(),
  exerciseId: z.string(),
  exerciseName: z.string(),
  // New group-based fields
  groupId: z.string().nullable(), // null during migration
  orderWithinGroup: z.number().int().min(0).nullable(),
  // Legacy superset fields (deprecated)
  supersetGroup: z.string().nullable(),
  supersetOrder: z.number().nullable(),
  // Other existing fields
  setTypeLabel: z.string().nullable(),
  notes: z.string().nullable(),
  restSeconds: z.number().nullable(),
  isSubRow: z.boolean(),
  parentRowId: z.string().nullable(),
  orderIndex: z.number().int(),
})
```

3. Add prescriptionWithSeriesSchema:
```typescript
export const prescriptionWithSeriesSchema = z.object({
  id: z.string(),
  weekId: z.string(),
  // New series array (nullable during migration)
  series: z.array(prescriptionSeriesInputSchema).nullable(),
  // Legacy flat prescription (deprecated)
  prescription: parsedPrescriptionSchema.nullable(),
  notes: z.string().nullable(),
})
```

4. Update ProgramWithDetails type to include exerciseGroups array in sessions

Keep backward compatible - both old and new fields present.
  </action>
  <verify>pnpm typecheck --filter @strenly/contracts</verify>
  <done>program.ts updated with group and series schemas, backward compatible</done>
</task>

<task type="auto">
  <name>Task 3: Update repository port and implementation</name>
  <skills>/repository, /port</skills>
  <files>packages/core/src/ports/program-repository.port.ts, packages/backend/src/infrastructure/repositories/program.repository.ts</files>
  <action>
Update the repository layer to handle new structures:

1. In program-repository.port.ts, add new method signatures:
```typescript
// Exercise group methods
createGroup(
  ctx: OrganizationContext,
  sessionId: string,
  name?: string | null
): ResultAsync<ExerciseGroupData, RepositoryError>

updateGroup(
  ctx: OrganizationContext,
  groupId: string,
  updates: { name?: string | null; orderIndex?: number }
): ResultAsync<void, RepositoryError>

deleteGroup(
  ctx: OrganizationContext,
  groupId: string
): ResultAsync<void, RepositoryError>

// Series-based prescription methods
updatePrescriptionSeries(
  ctx: OrganizationContext,
  exerciseRowId: string,
  weekId: string,
  series: PrescriptionSeriesData[]
): ResultAsync<void, RepositoryError>
```

2. In program.repository.ts:
- Add import for exerciseGroups schema
- Implement createGroup: insert into exercise_groups, return created group
- Implement updateGroup: update name and/or orderIndex
- Implement deleteGroup: delete (exercises will cascade)
- Implement updatePrescriptionSeries: upsert prescription with series JSONB
- Update findById to include exerciseGroups in the query (LEFT JOIN)
- Update mapToDomain to include groups in output

For findById query update:
- Add LEFT JOIN to exercise_groups table
- Include groups in the sessions array
- Handle case where groupId is null (pre-migration data)

Keep existing superset-based methods working for now - they'll be deprecated later.
  </action>
  <verify>pnpm typecheck --filter @strenly/core && pnpm typecheck --filter @strenly/backend</verify>
  <done>Repository port has group methods, implementation queries exercise_groups table</done>
</task>

</tasks>

<verification>
Run from repository root:
```bash
pnpm typecheck --filter @strenly/contracts
pnpm typecheck --filter @strenly/core
pnpm typecheck --filter @strenly/backend
```

All packages should compile without errors.
</verification>

<success_criteria>
- [ ] exercise-group.ts contracts exist with schemas
- [ ] program.ts updated with group and series schemas
- [ ] Repository port has createGroup, updateGroup, deleteGroup methods
- [ ] Repository port has updatePrescriptionSeries method
- [ ] Repository implementation handles exercise_groups table
- [ ] Existing methods still work (backward compatible)
- [ ] All packages typecheck
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-prescription-data-structure-refactor/03.2-04-SUMMARY.md`
</output>
