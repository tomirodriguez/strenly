---
phase: 02-exercise-library-athlete-management
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - packages/backend/src/infrastructure/repositories/athlete.repository.ts
  - packages/backend/src/infrastructure/repositories/athlete-invitation.repository.ts
autonomous: true

must_haves:
  truths:
    - "Athlete repository implements all port methods"
    - "Athlete queries always filter by organizationId"
    - "Invitation repository can find by token without org context"
    - "Archive sets status to inactive, not hard delete"
  artifacts:
    - path: "packages/backend/src/infrastructure/repositories/athlete.repository.ts"
      provides: "Athlete repository implementation"
      exports: ["createAthleteRepository"]
    - path: "packages/backend/src/infrastructure/repositories/athlete-invitation.repository.ts"
      provides: "AthleteInvitation repository implementation"
      exports: ["createAthleteInvitationRepository"]
  key_links:
    - from: "packages/backend/src/infrastructure/repositories/athlete.repository.ts"
      to: "@strenly/core"
      via: "implements AthleteRepositoryPort"
      pattern: "AthleteRepositoryPort"
    - from: "packages/backend/src/infrastructure/repositories/athlete.repository.ts"
      to: "@strenly/database/schema"
      via: "uses athletes table"
      pattern: "from\\(athletes\\)"
---

<objective>
Implement Athlete and AthleteInvitation repositories following established patterns.

Purpose: Connect domain layer to database for athlete management operations.
Output: Repository factory functions that implement the port interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-RESEARCH.md
@packages/backend/src/infrastructure/repositories/plan.repository.ts
@packages/backend/src/infrastructure/repositories/subscription.repository.ts
@packages/core/src/ports/athlete-repository.port.ts
@packages/core/src/ports/athlete-invitation-repository.port.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Athlete Repository</name>
  <files>packages/backend/src/infrastructure/repositories/athlete.repository.ts</files>
  <action>
Create athlete.repository.ts following plan.repository.ts pattern:

1. Import types from @strenly/core (AthleteRepositoryPort, createAthlete, etc.)
2. Import from @strenly/database (DbClient, athletes table)
3. Import drizzle-orm operators (eq, and, like, count, sql)

wrapDbError helper: Log error and return DATABASE_ERROR

mapToDomain function: Convert database row to Athlete entity using createAthlete factory
- Use Zod safeParse or type guards for gender enum (not 'as' casting)
- Return null if createAthlete fails (invalid data in DB)

createAthleteRepository(db: DbClient): AthleteRepositoryPort
- findById(ctx, id): Query athletes WHERE id = ? AND organization_id = ctx.organizationId
- findAll(ctx, options): Query with filters:
  - Always filter by organization_id
  - Optional status filter
  - Optional search (ILIKE on name)
  - Return { items, totalCount }
- findByLinkedUserId(ctx, userId): Query WHERE linked_user_id = ? AND organization_id = ?
- create(ctx, athlete): INSERT athlete, return created
- update(ctx, athlete): UPDATE athlete WHERE id AND organization_id
- archive(ctx, id): UPDATE status = 'inactive' WHERE id AND organization_id

CRITICAL: All queries MUST include organization_id filter for multi-tenancy.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Athlete repository implements AthleteRepositoryPort with org-scoped queries</done>
</task>

<task type="auto">
  <name>Task 2: Implement AthleteInvitation Repository</name>
  <files>packages/backend/src/infrastructure/repositories/athlete-invitation.repository.ts</files>
  <action>
Create athlete-invitation.repository.ts:

1. Import types from @strenly/core
2. Import from @strenly/database (athleteInvitations table)

mapToDomain function: Convert DB row to AthleteInvitation entity

createAthleteInvitationRepository(db: DbClient): AthleteInvitationRepositoryPort
- findByToken(token): Query WHERE token = ? (NO org context - public lookup for invitation acceptance)
  - Return null if not found, not error
- findByAthleteId(ctx, athleteId): Query WHERE athlete_id = ? AND organization_id = ?
  - Return most recent non-revoked invitation
- create(ctx, invitation): INSERT invitation
- markAccepted(token, userId): UPDATE acceptedAt = now AND link athlete.linkedUserId = userId
  - This is a transaction: update invitation AND update athlete.linkedUserId
- revoke(ctx, invitationId): UPDATE revokedAt = now WHERE id AND organization_id

Note: findByToken is intentionally org-agnostic since athletes use it to accept invitations.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>AthleteInvitation repository implements port with token lookup and acceptance flow</done>
</task>

<task type="auto">
  <name>Task 3: Export Repositories</name>
  <files>packages/backend/src/infrastructure/repositories/index.ts</files>
  <action>
Create or update packages/backend/src/infrastructure/repositories/index.ts:

Export all repository factory functions:
- export { createPlanRepository } from "./plan.repository"
- export { createSubscriptionRepository } from "./subscription.repository"
- export { createAthleteRepository } from "./athlete.repository"
- export { createAthleteInvitationRepository } from "./athlete-invitation.repository"

Verify typecheck passes.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>All repositories exported from index file</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/backend` passes
2. Athlete repository implements AthleteRepositoryPort exactly
3. All athlete queries include organization_id filter
4. Invitation findByToken works without org context
5. Archive uses status = 'inactive', not DELETE
</verification>

<success_criteria>
- Athlete CRUD operations work with organization scoping
- Athletes can be searched by name (ILIKE)
- Athletes can be filtered by status
- Invitation acceptance links user to athlete
- Invitations can be regenerated (create new) and revoked
- No hard deletes - only archive (status change)
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-04-SUMMARY.md`
</output>
