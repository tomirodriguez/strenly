---
phase: 02-exercise-library-athlete-management
plan: 08
type: execute
wave: 3
depends_on: ["02-05"]
files_modified:
  - packages/backend/src/use-cases/exercises/create-exercise.ts
  - packages/backend/src/use-cases/exercises/list-exercises.ts
  - packages/backend/src/use-cases/exercises/get-exercise.ts
  - packages/backend/src/use-cases/exercises/update-exercise.ts
  - packages/backend/src/use-cases/exercises/archive-exercise.ts
  - packages/backend/src/use-cases/exercises/clone-exercise.ts
autonomous: true

must_haves:
  truths:
    - "Custom exercises require exercises:write permission"
    - "List exercises returns both curated and org's custom exercises"
    - "Clone creates new custom exercise from curated source"
    - "Archive uses soft delete (archivedAt timestamp)"
  artifacts:
    - path: "packages/backend/src/use-cases/exercises/create-exercise.ts"
      provides: "Create custom exercise use case"
      exports: ["makeCreateExercise"]
    - path: "packages/backend/src/use-cases/exercises/list-exercises.ts"
      provides: "List exercises use case"
      exports: ["makeListExercises"]
    - path: "packages/backend/src/use-cases/exercises/clone-exercise.ts"
      provides: "Clone curated exercise use case"
      exports: ["makeCloneExercise"]
  key_links:
    - from: "packages/backend/src/use-cases/exercises/create-exercise.ts"
      to: "@strenly/core"
      via: "uses hasPermission and createExercise"
      pattern: "hasPermission.*exercises:write"
---

<objective>
Implement exercise CRUD use cases including clone functionality for custom exercises.

Purpose: Business logic layer for exercise library with curated/custom distinction.
Output: Use case factory functions for create, list, get, update, archive, clone.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-CONTEXT.md
@packages/backend/src/use-cases/subscriptions/get-subscription.ts
@packages/core/src/services/authorization.ts
@packages/core/src/ports/exercise-repository.port.ts
@packages/core/src/domain/entities/exercise.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and Clone Exercise Use Cases</name>
  <files>
    packages/backend/src/use-cases/exercises/create-exercise.ts
    packages/backend/src/use-cases/exercises/clone-exercise.ts
  </files>
  <action>
Create create-exercise.ts:
- CreateExerciseInput = OrganizationContext & { memberRole, name, description?, instructions?, videoUrl?, movementPattern?, isUnilateral?, primaryMuscles?, secondaryMuscles? }
- CreateExerciseError = forbidden | validation_error | repository_error
- Dependencies = { exerciseRepository, generateId }

Flow:
1. Authorization: hasPermission(memberRole, "exercises:write")
2. Domain validation: createExercise({ ...input, organizationId: ctx.organizationId, isCurated: false })
   - Custom exercises MUST have organizationId
3. Persist: exerciseRepository.create(exercise)
4. Return ok(exercise)

Create clone-exercise.ts:
- CloneExerciseInput = OrganizationContext & { memberRole, sourceExerciseId, name? }
- CloneExerciseError = forbidden | source_not_found | validation_error | repository_error
- Dependencies = { exerciseRepository, generateId }

Flow:
1. Authorization: hasPermission(memberRole, "exercises:write")
2. Fetch source: exerciseRepository.findById(sourceExerciseId)
   - If not found, return source_not_found
3. Create cloned exercise: createExercise({
   id: generateId(),
   organizationId: ctx.organizationId,
   name: input.name ?? `${source.name} (Custom)`,
   ...copyOtherFields,
   clonedFromId: source.id,
   isCurated: false
   })
4. Persist: exerciseRepository.create(cloned)
5. Return ok(cloned)
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Create and Clone exercise use cases implemented</done>
</task>

<task type="auto">
  <name>Task 2: List and Get Exercise Use Cases</name>
  <files>
    packages/backend/src/use-cases/exercises/list-exercises.ts
    packages/backend/src/use-cases/exercises/get-exercise.ts
  </files>
  <action>
Create list-exercises.ts:
- ListExercisesInput = OrganizationContext & { memberRole, movementPattern?, muscleGroup?, search?, includeArchived?, limit?, offset? }
- ListExercisesError = forbidden | repository_error
- makeListExercises(deps) => (input) => ResultAsync<{ items, totalCount }, Error>

Flow:
1. Authorization: hasPermission(memberRole, "exercises:read")
2. Build options:
   - organizationId: ctx.organizationId (includes curated + org's custom)
   - Other filters from input
3. Call exerciseRepository.findAll(options)
4. Return { items, totalCount }

Note: List returns BOTH curated (null orgId) AND organization's custom exercises.

Create get-exercise.ts:
- GetExerciseInput = OrganizationContext & { memberRole, exerciseId }
- GetExerciseError = forbidden | not_found | repository_error
- makeGetExercise(deps) => (input) => ResultAsync<Exercise, Error>

Flow:
1. Authorization: hasPermission(memberRole, "exercises:read")
2. Fetch: exerciseRepository.findById(exerciseId)
3. Verify access: exercise is curated OR belongs to org
   - If custom exercise with different orgId, return not_found
4. Return ok(exercise)
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>List and Get exercise use cases with proper filtering</done>
</task>

<task type="auto">
  <name>Task 3: Update and Archive Exercise Use Cases</name>
  <files>
    packages/backend/src/use-cases/exercises/update-exercise.ts
    packages/backend/src/use-cases/exercises/archive-exercise.ts
  </files>
  <action>
Create update-exercise.ts:
- UpdateExerciseInput = OrganizationContext & { memberRole, exerciseId, name?, description?, instructions?, videoUrl?, movementPattern?, isUnilateral?, primaryMuscles?, secondaryMuscles? }
- UpdateExerciseError = forbidden | not_found | cannot_edit_curated | validation_error | repository_error

Flow:
1. Authorization: hasPermission(memberRole, "exercises:write")
2. Fetch existing: exerciseRepository.findById(exerciseId)
3. Check editable: if exercise.isCurated || exercise.organizationId !== ctx.organizationId
   - Return cannot_edit_curated error
4. Merge updates with existing
5. Domain validation: createExercise(merged)
6. Persist: exerciseRepository.update(updated)
7. Return ok(updated)

Create archive-exercise.ts:
- ArchiveExerciseInput = OrganizationContext & { memberRole, exerciseId }
- ArchiveExerciseError = forbidden | not_found | cannot_archive_curated | repository_error

Flow:
1. Authorization: hasPermission(memberRole, "exercises:write")
2. Fetch: exerciseRepository.findById(exerciseId)
3. Check: if curated or different org, return error
4. Archive: exerciseRepository.archive(exerciseId)
5. Return ok(undefined)

Note: Only custom exercises owned by the org can be edited/archived.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Update and Archive exercise use cases with curated protection</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/backend` passes
2. Create makes custom exercises (with organizationId)
3. Clone copies curated to custom with clonedFromId link
4. List returns curated + org's custom
5. Update/archive blocked for curated exercises
6. All use cases check authorization FIRST
</verification>

<success_criteria>
- Custom exercises created with organizationId set
- Curated exercises visible but not editable
- Clone creates custom copy with provenance tracking
- List supports filtering by muscle group and movement pattern
- Archive uses soft delete (archivedAt timestamp)
- All operations require exercises:read or exercises:write permission
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-08-SUMMARY.md`
</output>
