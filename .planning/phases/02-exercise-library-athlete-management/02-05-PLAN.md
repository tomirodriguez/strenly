---
phase: 02-exercise-library-athlete-management
plan: 05
type: execute
wave: 2
depends_on: ["02-01", "02-03"]
files_modified:
  - packages/backend/src/infrastructure/repositories/exercise.repository.ts
  - packages/backend/src/infrastructure/repositories/muscle-group.repository.ts
  - packages/backend/src/infrastructure/repositories/index.ts
autonomous: true

must_haves:
  truths:
    - "Exercise repository supports both curated and custom exercises"
    - "Exercise queries can filter by muscle group and movement pattern"
    - "Curated exercises have null organizationId"
    - "Custom exercises are org-scoped"
  artifacts:
    - path: "packages/backend/src/infrastructure/repositories/exercise.repository.ts"
      provides: "Exercise repository implementation"
      exports: ["createExerciseRepository"]
    - path: "packages/backend/src/infrastructure/repositories/muscle-group.repository.ts"
      provides: "MuscleGroup repository for lookup data"
      exports: ["createMuscleGroupRepository"]
  key_links:
    - from: "packages/backend/src/infrastructure/repositories/exercise.repository.ts"
      to: "@strenly/core"
      via: "implements ExerciseRepositoryPort"
      pattern: "ExerciseRepositoryPort"
    - from: "packages/backend/src/infrastructure/repositories/exercise.repository.ts"
      to: "packages/database/src/schema/exercises.ts"
      via: "uses exercises table"
      pattern: "from\\(exercises\\)"
---

<objective>
Implement Exercise and MuscleGroup repositories for the exercise library.

Purpose: Connect domain layer to database for exercise CRUD and lookups.
Output: Repository factory functions for exercises and muscle groups.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-RESEARCH.md
@packages/backend/src/infrastructure/repositories/plan.repository.ts
@packages/core/src/ports/exercise-repository.port.ts
@packages/database/src/schema/exercises.ts
@packages/database/src/schema/muscle-groups.ts
@packages/database/src/schema/exercise-muscles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Exercise Repository</name>
  <files>packages/backend/src/infrastructure/repositories/exercise.repository.ts</files>
  <action>
Create exercise.repository.ts following plan.repository.ts pattern:

1. Import types from @strenly/core
2. Import from @strenly/database (exercises, exerciseMuscles, muscleGroups tables)

mapToDomain function:
- Convert DB row + muscle groups to Exercise entity
- Parse movementPattern using type guard (not 'as')
- Fetch primary/secondary muscles via join or subquery
- Return null if createExercise fails

createExerciseRepository(db: DbClient): ExerciseRepositoryPort

findById(id):
- Query exercise by id
- Join with exerciseMuscles to get muscle groups
- No org filter needed - exercises can be curated (global)
- Return NOT_FOUND if missing

findAll(options):
- Build dynamic WHERE clause:
  - If options.organizationId === null: only curated (organizationId IS NULL)
  - If options.organizationId is string: curated OR org's custom
  - If options.muscleGroup: join exerciseMuscles WHERE muscleGroupId = ?
  - If options.movementPattern: WHERE movementPattern = ?
  - If options.search: WHERE name ILIKE '%search%'
  - If NOT options.includeArchived: WHERE archivedAt IS NULL
- Return { items, totalCount }

create(exercise):
- INSERT into exercises table
- INSERT into exerciseMuscles for primary/secondary muscles
- Use transaction for atomicity

update(exercise):
- UPDATE exercises WHERE id
- DELETE + INSERT exerciseMuscles (replace muscle mappings)
- For custom exercises, verify organizationId matches

archive(id):
- UPDATE archivedAt = now() WHERE id
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Exercise repository implements port with muscle group joins and filtering</done>
</task>

<task type="auto">
  <name>Task 2: Implement MuscleGroup Repository</name>
  <files>packages/backend/src/infrastructure/repositories/muscle-group.repository.ts</files>
  <action>
Create muscle-group.repository.ts for lookup data:

Simple repository - no port needed (it's static lookup data).

createMuscleGroupRepository(db: DbClient):
- findAll(): Query all muscle groups, return { id, name, displayName, bodyRegion }[]
- findById(id): Query single muscle group
- No mutations - muscle groups are seeded data only

This is a simple read-only repository for populating dropdowns and validating muscle group references.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>MuscleGroup repository provides lookup functionality</done>
</task>

<task type="auto">
  <name>Task 3: Update Repository Exports</name>
  <files>packages/backend/src/infrastructure/repositories/index.ts</files>
  <action>
Update packages/backend/src/infrastructure/repositories/index.ts:

Add exports:
- export { createExerciseRepository } from "./exercise.repository"
- export { createMuscleGroupRepository } from "./muscle-group.repository"

Verify all repositories export and typecheck passes.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Exercise and MuscleGroup repositories exported</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/backend` passes
2. Exercise repository supports filtering by muscle group and pattern
3. Curated exercises (null orgId) visible to all
4. Custom exercises filtered by organization
5. Muscle mappings use junction table properly
</verification>

<success_criteria>
- Exercise CRUD works for both curated and custom exercises
- Exercises can be searched by name
- Exercises can be filtered by muscle group
- Exercises can be filtered by movement pattern
- Archived exercises excluded by default
- Muscle groups available for lookup/dropdowns
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-05-SUMMARY.md`
</output>
