---
phase: 02-exercise-library-athlete-management
plan: 09
type: execute
wave: 4
depends_on: ["02-06", "02-07"]
files_modified:
  - packages/contracts/src/athletes/athlete.ts
  - packages/contracts/src/athletes/invitation.ts
  - packages/contracts/src/athletes/index.ts
  - packages/backend/src/procedures/athletes/index.ts
  - packages/backend/src/procedures/athletes/create-athlete.ts
  - packages/backend/src/procedures/athletes/list-athletes.ts
  - packages/backend/src/procedures/athletes/get-athlete.ts
  - packages/backend/src/procedures/athletes/update-athlete.ts
  - packages/backend/src/procedures/athletes/archive-athlete.ts
  - packages/backend/src/procedures/athletes/generate-invitation.ts
  - packages/backend/src/procedures/athletes/accept-invitation.ts
  - packages/backend/src/procedures/athletes/get-invitation-info.ts
  - packages/backend/src/procedures/router.ts
autonomous: true

must_haves:
  truths:
    - "Athletes router handles all athlete CRUD operations"
    - "Invitation endpoints use token-based auth for acceptance"
    - "All procedures use exhaustive error switch for HTTP mapping"
    - "Contracts define all request/response schemas"
  artifacts:
    - path: "packages/contracts/src/athletes/athlete.ts"
      provides: "Athlete Zod schemas"
      exports: ["athleteSchema", "createAthleteInputSchema"]
    - path: "packages/backend/src/procedures/athletes/index.ts"
      provides: "Athletes router"
      exports: ["athletesRouter"]
  key_links:
    - from: "packages/backend/src/procedures/athletes/create-athlete.ts"
      to: "packages/backend/src/use-cases/athletes/create-athlete.ts"
      via: "orchestrates use case"
      pattern: "makeCreateAthlete"
    - from: "packages/backend/src/procedures/router.ts"
      to: "packages/backend/src/procedures/athletes/index.ts"
      via: "mounts athletes router"
      pattern: "athletes.*athletesRouter"
---

<objective>
Create Zod contracts and oRPC procedures for athlete management API.

Purpose: Expose athlete CRUD and invitation operations via oRPC API.
Output: Contracts package schemas and procedures with proper error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-CONTEXT.md
@packages/contracts/src/subscriptions/subscription.ts
@packages/backend/src/procedures/subscriptions/get-subscription.ts
@packages/backend/src/procedures/router.ts
@packages/backend/src/lib/orpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Athlete Contracts</name>
  <files>
    packages/contracts/src/athletes/athlete.ts
    packages/contracts/src/athletes/invitation.ts
    packages/contracts/src/athletes/index.ts
  </files>
  <action>
Create packages/contracts/src/athletes/athlete.ts:

import { z } from "zod";

const athleteStatusSchema = z.enum(["active", "inactive"]);
const genderSchema = z.enum(["male", "female", "other"]);

export const athleteSchema = z.object({
  id: z.string(),
  organizationId: z.string(),
  name: z.string(),
  email: z.string().nullable(),
  phone: z.string().nullable(),
  birthdate: z.string().nullable(), // ISO date string
  gender: genderSchema.nullable(),
  notes: z.string().nullable(),
  status: athleteStatusSchema,
  linkedUserId: z.string().nullable(),
  isLinked: z.boolean(), // Computed from linkedUserId
  createdAt: z.string(),
  updatedAt: z.string(),
});

export const createAthleteInputSchema = z.object({
  name: z.string().min(1).max(100),
  email: z.string().email().optional(),
  phone: z.string().optional(),
  birthdate: z.string().optional(), // ISO date
  gender: genderSchema.optional(),
  notes: z.string().optional(),
});

export const updateAthleteInputSchema = createAthleteInputSchema.partial().extend({
  athleteId: z.string(),
  status: athleteStatusSchema.optional(),
});

export const listAthletesInputSchema = z.object({
  status: athleteStatusSchema.optional(),
  search: z.string().optional(),
  limit: z.number().min(1).max(100).optional(),
  offset: z.number().min(0).optional(),
});

export const listAthletesOutputSchema = z.object({
  items: z.array(athleteSchema),
  totalCount: z.number(),
});

Create packages/contracts/src/athletes/invitation.ts:
- invitationInfoSchema (public display: athleteName, organizationName, coachName, expiresAt, isValid)
- generateInvitationOutputSchema (invitationUrl)

Create packages/contracts/src/athletes/index.ts:
- Export all from './athlete' and './invitation'
  </action>
  <verify>pnpm typecheck --filter @strenly/contracts</verify>
  <done>Athlete and invitation contracts defined</done>
</task>

<task type="auto">
  <name>Task 2: Create Athlete CRUD Procedures</name>
  <files>
    packages/backend/src/procedures/athletes/create-athlete.ts
    packages/backend/src/procedures/athletes/list-athletes.ts
    packages/backend/src/procedures/athletes/get-athlete.ts
    packages/backend/src/procedures/athletes/update-athlete.ts
    packages/backend/src/procedures/athletes/archive-athlete.ts
  </files>
  <action>
Create each procedure following get-subscription.ts pattern:

create-athlete.ts:
- authProcedure with input createAthleteInputSchema
- Output athleteSchema
- Errors: FORBIDDEN, VALIDATION_ERROR
- Exhaustive switch on error types

list-athletes.ts:
- authProcedure with input listAthletesInputSchema
- Output listAthletesOutputSchema
- Errors: FORBIDDEN

get-athlete.ts:
- authProcedure with input z.object({ athleteId: z.string() })
- Output athleteSchema
- Errors: FORBIDDEN, NOT_FOUND

update-athlete.ts:
- authProcedure with input updateAthleteInputSchema
- Output athleteSchema
- Errors: FORBIDDEN, NOT_FOUND, VALIDATION_ERROR

archive-athlete.ts:
- authProcedure with input z.object({ athleteId: z.string() })
- Output z.object({ success: z.boolean() })
- Errors: FORBIDDEN, NOT_FOUND

All procedures: Instantiate use case with createAthleteRepository, call use case, map result.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Athlete CRUD procedures created</done>
</task>

<task type="auto">
  <name>Task 3: Create Invitation Procedures and Router</name>
  <files>
    packages/backend/src/procedures/athletes/generate-invitation.ts
    packages/backend/src/procedures/athletes/accept-invitation.ts
    packages/backend/src/procedures/athletes/get-invitation-info.ts
    packages/backend/src/procedures/athletes/index.ts
    packages/backend/src/procedures/router.ts
  </files>
  <action>
Create generate-invitation.ts:
- authProcedure with input z.object({ athleteId: z.string() })
- Output z.object({ invitationUrl: z.string() })
- Errors: FORBIDDEN, ATHLETE_NOT_FOUND, ALREADY_LINKED

Create accept-invitation.ts:
- NOTE: This needs auth but NOT org context (athlete accepting)
- Use baseProcedure with requireAuth but not requireOrg
- Input z.object({ token: z.string() })
- Output z.object({ athleteId, organizationId })
- Errors: INVALID_TOKEN, EXPIRED, ALREADY_ACCEPTED, ALREADY_REVOKED

Create get-invitation-info.ts:
- PUBLIC procedure (no auth required)
- Use publicProcedure or baseProcedure
- Input z.object({ token: z.string() })
- Output invitationInfoSchema
- Errors: INVALID_TOKEN

Create index.ts with athletesRouter:
{
  create: createAthlete,
  list: listAthletes,
  get: getAthlete,
  update: updateAthlete,
  archive: archiveAthlete,
  generateInvitation: generateInvitation,
  acceptInvitation: acceptInvitation,
  invitationInfo: getInvitationInfo,
}

Update router.ts:
- Import athletesRouter
- Add: athletes: athletesRouter
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Invitation procedures and athletes router mounted</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/backend` passes
2. `pnpm typecheck --filter @strenly/contracts` passes
3. Athletes router mounted at /api/rpc/athletes/*
4. All procedures use exhaustive error switches
5. Invitation info is public, accept requires auth
</verification>

<success_criteria>
- Athletes API: create, list, get, update, archive
- Invitation API: generateInvitation, acceptInvitation, invitationInfo
- Contracts define all input/output schemas
- Error handling maps use case errors to HTTP errors
- Athletes router properly mounted in main router
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-09-SUMMARY.md`
</output>
