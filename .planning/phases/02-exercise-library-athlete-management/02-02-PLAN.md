---
phase: 02-exercise-library-athlete-management
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/domain/entities/athlete.ts
  - packages/core/src/domain/entities/athlete.test.ts
  - packages/core/src/domain/entities/athlete-invitation.ts
  - packages/core/src/domain/entities/athlete-invitation.test.ts
  - packages/core/src/ports/athlete-repository.port.ts
  - packages/core/src/ports/athlete-invitation-repository.port.ts
autonomous: true

must_haves:
  truths:
    - "Athlete domain entity validates name (required, 1-100 chars)"
    - "Athlete domain entity validates email format when provided"
    - "AthleteInvitation generates secure tokens with 7-day expiry"
    - "Invitation tokens are cryptographically secure (256 bits)"
  artifacts:
    - path: "packages/core/src/domain/entities/athlete.ts"
      provides: "Athlete entity with factory function"
      exports: ["Athlete", "AthleteError", "createAthlete"]
    - path: "packages/core/src/domain/entities/athlete-invitation.ts"
      provides: "AthleteInvitation entity with secure token"
      exports: ["AthleteInvitation", "createAthleteInvitation", "generateInvitationToken"]
    - path: "packages/core/src/ports/athlete-repository.port.ts"
      provides: "Repository interface for athletes"
      exports: ["AthleteRepositoryPort"]
  key_links:
    - from: "packages/core/src/domain/entities/athlete.ts"
      to: "neverthrow"
      via: "Result type return"
      pattern: "Result<Athlete, AthleteError>"
---

<objective>
Create Athlete and AthleteInvitation domain entities with TDD, plus their repository ports.

Purpose: Establish domain layer for athlete management following Clean Architecture.
Output: Tested domain entities and repository port interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-RESEARCH.md
@packages/core/src/domain/entities/plan.ts
@packages/core/src/domain/entities/plan.test.ts
@packages/core/src/ports/plan-repository.port.ts
@packages/core/src/types/organization-context.ts
</context>

<feature>
  <name>Athlete Domain Entity</name>
  <files>
    packages/core/src/domain/entities/athlete.ts
    packages/core/src/domain/entities/athlete.test.ts
  </files>
  <behavior>
Expected behavior for createAthlete factory:

Valid cases:
- createAthlete({ id, organizationId, name: "John" }) -> ok(Athlete)
- createAthlete({ ...valid, email: "john@example.com" }) -> ok(Athlete)
- createAthlete({ ...valid, gender: "male" }) -> ok(Athlete)
- Status defaults to "active", linkedUserId defaults to null

Invalid cases:
- createAthlete({ ...valid, name: "" }) -> err({ type: "INVALID_NAME" })
- createAthlete({ ...valid, name: "x".repeat(101) }) -> err({ type: "INVALID_NAME" })
- createAthlete({ ...valid, email: "not-an-email" }) -> err({ type: "INVALID_EMAIL" })

All properties readonly. createdAt/updatedAt auto-set.
  </behavior>
  <implementation>
Follow packages/core/src/domain/entities/plan.ts pattern:
1. Define Athlete type with readonly fields
2. Define AthleteError discriminated union
3. Create createAthlete factory returning Result<Athlete, AthleteError>
4. Validate name (required, 1-100 chars)
5. Validate email format if provided (regex)
6. Default status to "active", linkedUserId to null
  </implementation>
</feature>

<feature>
  <name>AthleteInvitation Domain Entity</name>
  <files>
    packages/core/src/domain/entities/athlete-invitation.ts
    packages/core/src/domain/entities/athlete-invitation.test.ts
  </files>
  <behavior>
Expected behavior for createAthleteInvitation factory:

- createAthleteInvitation({ id, athleteId, organizationId, createdByUserId }) -> AthleteInvitation
- Token is generated automatically using crypto.randomBytes(32).toString("base64url")
- expiresAt is 7 days from creation
- revokedAt and acceptedAt default to null
- createdAt auto-set to now

Helper functions:
- isExpired(invitation) -> boolean (checks expiresAt < now)
- isRevoked(invitation) -> boolean (checks revokedAt !== null)
- isAccepted(invitation) -> boolean (checks acceptedAt !== null)
- isValid(invitation) -> boolean (not expired, not revoked, not accepted)
  </behavior>
  <implementation>
1. Define AthleteInvitation type with readonly fields
2. generateInvitationToken() using crypto.randomBytes(32).toString("base64url")
3. createAthleteInvitation factory (no validation needed, always succeeds)
4. Helper functions for status checks
5. No Result return needed - invitation creation always succeeds
  </implementation>
</feature>

<feature>
  <name>Repository Ports</name>
  <files>
    packages/core/src/ports/athlete-repository.port.ts
    packages/core/src/ports/athlete-invitation-repository.port.ts
  </files>
  <behavior>
AthleteRepositoryPort interface:
- findById(ctx, id) -> ResultAsync<Athlete, Error>
- findAll(ctx, options) -> ResultAsync<{ items, totalCount }, Error>
- findByLinkedUserId(ctx, userId) -> ResultAsync<Athlete | null, Error>
- create(ctx, athlete) -> ResultAsync<Athlete, Error>
- update(ctx, athlete) -> ResultAsync<Athlete, Error>
- archive(ctx, id) -> ResultAsync<void, Error>

AthleteInvitationRepositoryPort interface:
- findByToken(token) -> ResultAsync<AthleteInvitation | null, Error> (no ctx - public lookup)
- findByAthleteId(ctx, athleteId) -> ResultAsync<AthleteInvitation | null, Error>
- create(ctx, invitation) -> ResultAsync<AthleteInvitation, Error>
- markAccepted(token, userId) -> ResultAsync<void, Error>
- revoke(ctx, invitationId) -> ResultAsync<void, Error>
  </behavior>
  <implementation>
Follow packages/core/src/ports/plan-repository.port.ts pattern:
1. Define error types as discriminated unions
2. Define options types for list queries
3. All methods return ResultAsync
4. Use OrganizationContext for tenant-scoped operations
5. findByToken is public (no org context) for invitation acceptance flow
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write Athlete Entity Tests</name>
  <files>packages/core/src/domain/entities/athlete.test.ts</files>
  <action>
Create athlete.test.ts with failing tests:

describe("createAthlete", () => {
  it("creates athlete with valid name")
  it("creates athlete with all optional fields")
  it("defaults status to active")
  it("defaults linkedUserId to null")
  it("trims whitespace from name")
  it("fails with empty name")
  it("fails with name over 100 chars")
  it("fails with invalid email format")
  it("accepts valid email format")
  it("makes all properties readonly")
})

Run tests - they MUST fail (athlete.ts doesn't exist yet).
Commit: test(02-02): add failing tests for Athlete entity
  </action>
  <verify>pnpm test --filter @strenly/core -- athlete.test.ts (should fail)</verify>
  <done>Failing tests for Athlete entity committed</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement Athlete Entity and Invitation</name>
  <files>
    packages/core/src/domain/entities/athlete.ts
    packages/core/src/domain/entities/athlete-invitation.ts
    packages/core/src/domain/entities/athlete-invitation.test.ts
  </files>
  <action>
Create athlete.ts:
- AthleteStatus type: "active" | "inactive"
- Athlete type with readonly fields (id, organizationId, name, email, phone, birthdate, gender, notes, status, linkedUserId, createdAt, updatedAt)
- AthleteError discriminated union (INVALID_NAME, INVALID_EMAIL)
- createAthlete factory with validation

Create athlete-invitation.ts:
- AthleteInvitation type with readonly fields
- generateInvitationToken() using crypto.randomBytes
- createAthleteInvitation factory
- Helper functions: isExpired, isRevoked, isAccepted, isValid

Create athlete-invitation.test.ts:
- Test token generation (should be 43 chars base64url)
- Test expiresAt is 7 days from now
- Test helper functions

Run all tests - they MUST pass.
Commit: feat(02-02): implement Athlete and AthleteInvitation entities
  </action>
  <verify>pnpm test --filter @strenly/core</verify>
  <done>Athlete and AthleteInvitation entities implemented, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create Repository Ports and Export</name>
  <files>
    packages/core/src/ports/athlete-repository.port.ts
    packages/core/src/ports/athlete-invitation-repository.port.ts
    packages/core/src/index.ts
  </files>
  <action>
Create athlete-repository.port.ts:
- AthleteRepositoryError type
- ListAthletesOptions type (status, search, limit, offset)
- AthleteRepositoryPort interface with methods

Create athlete-invitation-repository.port.ts:
- AthleteInvitationRepositoryError type
- AthleteInvitationRepositoryPort interface with methods

Update packages/core/src/index.ts to export:
- All athlete entity exports
- All athlete-invitation entity exports
- All port exports

Run typecheck to verify exports work.
Commit: feat(02-02): add Athlete and AthleteInvitation repository ports
  </action>
  <verify>pnpm typecheck --filter @strenly/core && pnpm test --filter @strenly/core</verify>
  <done>Repository ports defined and all core exports updated</done>
</task>

</tasks>

<verification>
1. `pnpm test --filter @strenly/core` passes with 90%+ coverage on athlete entities
2. `pnpm typecheck --filter @strenly/core` passes
3. Domain entities use neverthrow Result pattern
4. Invitation token is cryptographically secure
5. All types exported from @strenly/core
</verification>

<success_criteria>
- Athlete entity validates name and email
- AthleteInvitation generates secure 256-bit tokens
- Invitation has 7-day expiry
- Repository ports define all CRUD operations
- OrganizationContext used for tenant-scoped operations
- 90%+ test coverage on domain entities
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-02-SUMMARY.md`
</output>
