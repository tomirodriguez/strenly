---
phase: 02-exercise-library-athlete-management
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/core/src/domain/entities/exercise.ts
  - packages/core/src/domain/entities/exercise.test.ts
  - packages/core/src/domain/entities/muscle-group.ts
  - packages/core/src/domain/entities/movement-pattern.ts
  - packages/core/src/ports/exercise-repository.port.ts
  - packages/core/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Exercise domain entity validates name (required)"
    - "Exercise distinguishes curated (no orgId) from custom (has orgId)"
    - "MuscleGroup and MovementPattern are value objects with predefined values"
    - "Exercise can have primary and secondary muscle groups"
  artifacts:
    - path: "packages/core/src/domain/entities/exercise.ts"
      provides: "Exercise entity with factory function"
      exports: ["Exercise", "ExerciseError", "createExercise"]
    - path: "packages/core/src/domain/entities/muscle-group.ts"
      provides: "MuscleGroup value object"
      exports: ["MuscleGroup", "MUSCLE_GROUPS", "isValidMuscleGroup"]
    - path: "packages/core/src/domain/entities/movement-pattern.ts"
      provides: "MovementPattern value object"
      exports: ["MovementPattern", "MOVEMENT_PATTERNS", "isValidMovementPattern"]
    - path: "packages/core/src/ports/exercise-repository.port.ts"
      provides: "Repository interface for exercises"
      exports: ["ExerciseRepositoryPort"]
  key_links:
    - from: "packages/core/src/domain/entities/exercise.ts"
      to: "neverthrow"
      via: "Result type return"
      pattern: "Result<Exercise, ExerciseError>"
---

<objective>
Create Exercise domain entity with TDD, plus MuscleGroup/MovementPattern value objects and repository port.

Purpose: Establish domain layer for exercise library following Clean Architecture.
Output: Tested domain entities with value objects and repository port interface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-RESEARCH.md
@.planning/phases/02-exercise-library-athlete-management/02-CONTEXT.md
@packages/core/src/domain/entities/plan.ts
@packages/core/src/ports/plan-repository.port.ts
</context>

<feature>
  <name>MuscleGroup and MovementPattern Value Objects</name>
  <files>
    packages/core/src/domain/entities/muscle-group.ts
    packages/core/src/domain/entities/movement-pattern.ts
  </files>
  <behavior>
MuscleGroup value object:
- Type: literal union of muscle group names
- MUSCLE_GROUPS constant array: ["chest", "back", "shoulders", "biceps", "triceps", "quads", "hamstrings", "glutes", "core", "calves"]
- isValidMuscleGroup(value) -> boolean
- getBodyRegion(muscleGroup) -> "upper" | "lower" | "core"

MovementPattern value object:
- Type: literal union of pattern names
- MOVEMENT_PATTERNS constant array: ["push", "pull", "hinge", "squat", "carry", "core"]
- isValidMovementPattern(value) -> boolean
  </behavior>
  <implementation>
Simple value objects (no classes needed):
1. Define literal union types
2. Export constant arrays for runtime checks
3. Type guard functions for validation
4. No tests needed for value objects (trivial)
  </implementation>
</feature>

<feature>
  <name>Exercise Domain Entity</name>
  <files>
    packages/core/src/domain/entities/exercise.ts
    packages/core/src/domain/entities/exercise.test.ts
  </files>
  <behavior>
Expected behavior for createExercise factory:

Valid cases:
- createExercise({ id, name: "Bench Press" }) -> ok(Exercise) (curated, no orgId)
- createExercise({ id, name: "Custom Press", organizationId: "org-1" }) -> ok(Exercise) (custom)
- createExercise({ ...valid, videoUrl: "https://youtube.com/..." }) -> ok(Exercise)
- createExercise({ ...valid, movementPattern: "push" }) -> ok(Exercise)
- createExercise({ ...valid, primaryMuscles: ["chest"], secondaryMuscles: ["triceps"] }) -> ok(Exercise)

Invalid cases:
- createExercise({ ...valid, name: "" }) -> err({ type: "INVALID_NAME" })
- createExercise({ ...valid, name: "x".repeat(101) }) -> err({ type: "INVALID_NAME" })
- createExercise({ ...valid, videoUrl: "not-a-url" }) -> err({ type: "INVALID_VIDEO_URL" })
- createExercise({ ...valid, movementPattern: "invalid" }) -> err({ type: "INVALID_MOVEMENT_PATTERN" })
- createExercise({ ...valid, primaryMuscles: ["invalid"] }) -> err({ type: "INVALID_MUSCLE_GROUP" })

Helpers:
- isCurated(exercise) -> boolean (no organizationId)
- isCustom(exercise) -> boolean (has organizationId)
- isArchived(exercise) -> boolean (archivedAt !== null)
  </behavior>
  <implementation>
Follow packages/core/src/domain/entities/plan.ts pattern:
1. Define Exercise type with readonly fields (id, organizationId, name, description, instructions, videoUrl, movementPattern, isUnilateral, isCurated, clonedFromId, primaryMuscles, secondaryMuscles, archivedAt, createdAt, updatedAt)
2. Define ExerciseError discriminated union
3. createExercise factory returning Result<Exercise, ExerciseError>
4. Validate name (required, 1-100 chars)
5. Validate videoUrl if provided (must be valid URL)
6. Validate movementPattern if provided
7. Validate muscle groups if provided
8. Default isUnilateral to false, archivedAt to null
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Create Value Objects and Write Failing Exercise Tests</name>
  <files>
    packages/core/src/domain/entities/muscle-group.ts
    packages/core/src/domain/entities/movement-pattern.ts
    packages/core/src/domain/entities/exercise.test.ts
  </files>
  <action>
Create muscle-group.ts:
- MuscleGroup type as literal union
- MUSCLE_GROUPS constant array
- BODY_REGIONS mapping
- isValidMuscleGroup type guard
- getBodyRegion helper

Create movement-pattern.ts:
- MovementPattern type as literal union
- MOVEMENT_PATTERNS constant array
- isValidMovementPattern type guard

Create exercise.test.ts with failing tests:
describe("createExercise", () => {
  it("creates exercise with valid name")
  it("creates curated exercise without organizationId")
  it("creates custom exercise with organizationId")
  it("accepts valid movement pattern")
  it("accepts valid muscle groups")
  it("accepts valid video URL")
  it("defaults isUnilateral to false")
  it("defaults archivedAt to null")
  it("fails with empty name")
  it("fails with name over 100 chars")
  it("fails with invalid video URL")
  it("fails with invalid movement pattern")
  it("fails with invalid muscle group")
})

describe("exercise helpers", () => {
  it("isCurated returns true when no organizationId")
  it("isCustom returns true when has organizationId")
  it("isArchived returns true when archivedAt is set")
})

Run tests - they MUST fail.
Commit: test(02-03): add failing tests for Exercise entity
  </action>
  <verify>pnpm test --filter @strenly/core -- exercise.test.ts (should fail)</verify>
  <done>Value objects created and failing tests for Exercise entity committed</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement Exercise Entity</name>
  <files>packages/core/src/domain/entities/exercise.ts</files>
  <action>
Create exercise.ts:
- Import MuscleGroup and MovementPattern from value objects
- Exercise type with readonly fields:
  - id, organizationId (nullable), name, description, instructions, videoUrl
  - movementPattern (nullable), isUnilateral, isCurated
  - clonedFromId (nullable), primaryMuscles, secondaryMuscles
  - archivedAt, createdAt, updatedAt
- ExerciseError discriminated union (INVALID_NAME, INVALID_VIDEO_URL, INVALID_MOVEMENT_PATTERN, INVALID_MUSCLE_GROUP)
- createExercise factory with validation:
  - Name: required, 1-100 chars
  - VideoUrl: if provided, must be valid URL (use URL constructor)
  - MovementPattern: if provided, must be in MOVEMENT_PATTERNS
  - Muscle groups: if provided, all must be in MUSCLE_GROUPS
- Helper functions: isCurated, isCustom, isArchived

Run tests - they MUST pass.
Commit: feat(02-03): implement Exercise entity with validation
  </action>
  <verify>pnpm test --filter @strenly/core</verify>
  <done>Exercise entity implemented, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create Repository Port and Export</name>
  <files>
    packages/core/src/ports/exercise-repository.port.ts
    packages/core/src/index.ts
  </files>
  <action>
Create exercise-repository.port.ts:
- ExerciseRepositoryError type (NOT_FOUND, DATABASE_ERROR)
- ListExercisesOptions type:
  - organizationId: string | null (null = curated only, undefined = all)
  - movementPattern?: MovementPattern
  - muscleGroup?: MuscleGroup
  - search?: string
  - includeArchived?: boolean
  - limit?: number
  - offset?: number
- ExerciseRepositoryPort interface:
  - findById(id): ResultAsync<Exercise, Error>
  - findAll(options): ResultAsync<{ items, totalCount }, Error>
  - create(exercise): ResultAsync<Exercise, Error>
  - update(exercise): ResultAsync<Exercise, Error>
  - archive(id): ResultAsync<void, Error>

Note: No OrganizationContext for findById/findAll since exercises can be curated (global).
Use organizationId in options for filtering.

Update packages/core/src/index.ts to export:
- Exercise entity exports
- MuscleGroup value object exports
- MovementPattern value object exports
- ExerciseRepositoryPort exports

Commit: feat(02-03): add Exercise repository port and exports
  </action>
  <verify>pnpm typecheck --filter @strenly/core && pnpm test --filter @strenly/core</verify>
  <done>Repository port defined and all core exports updated</done>
</task>

</tasks>

<verification>
1. `pnpm test --filter @strenly/core` passes with 90%+ coverage on exercise entity
2. `pnpm typecheck --filter @strenly/core` passes
3. Value objects define all muscle groups and movement patterns from CONTEXT.md
4. Exercise entity validates all fields properly
5. All types exported from @strenly/core
</verification>

<success_criteria>
- Exercise entity validates name and optional fields
- 10 muscle groups defined: chest, back, shoulders, biceps, triceps, quads, hamstrings, glutes, core, calves
- 6 movement patterns defined: push, pull, hinge, squat, carry, core
- Exercise supports primary and secondary muscle mappings
- Curated/custom distinction via nullable organizationId
- 90%+ test coverage on domain entities
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-03-SUMMARY.md`
</output>
