---
phase: 02-exercise-library-athlete-management
plan: 10
type: execute
wave: 4
depends_on: ["02-08"]
files_modified:
  - packages/contracts/src/exercises/exercise.ts
  - packages/contracts/src/exercises/muscle-group.ts
  - packages/contracts/src/exercises/index.ts
  - packages/backend/src/procedures/exercises/index.ts
  - packages/backend/src/procedures/exercises/create-exercise.ts
  - packages/backend/src/procedures/exercises/list-exercises.ts
  - packages/backend/src/procedures/exercises/get-exercise.ts
  - packages/backend/src/procedures/exercises/update-exercise.ts
  - packages/backend/src/procedures/exercises/archive-exercise.ts
  - packages/backend/src/procedures/exercises/clone-exercise.ts
  - packages/backend/src/procedures/exercises/list-muscle-groups.ts
  - packages/backend/src/procedures/router.ts
autonomous: true

must_haves:
  truths:
    - "Exercises router handles all exercise CRUD operations"
    - "List exercises returns curated + organization custom"
    - "Clone creates custom copy from curated source"
    - "Muscle groups endpoint provides lookup data"
  artifacts:
    - path: "packages/contracts/src/exercises/exercise.ts"
      provides: "Exercise Zod schemas"
      exports: ["exerciseSchema", "createExerciseInputSchema"]
    - path: "packages/backend/src/procedures/exercises/index.ts"
      provides: "Exercises router"
      exports: ["exercisesRouter"]
  key_links:
    - from: "packages/backend/src/procedures/exercises/create-exercise.ts"
      to: "packages/backend/src/use-cases/exercises/create-exercise.ts"
      via: "orchestrates use case"
      pattern: "makeCreateExercise"
    - from: "packages/backend/src/procedures/router.ts"
      to: "packages/backend/src/procedures/exercises/index.ts"
      via: "mounts exercises router"
      pattern: "exercises.*exercisesRouter"
---

<objective>
Create Zod contracts and oRPC procedures for exercise library API.

Purpose: Expose exercise CRUD, clone, and muscle group lookup via oRPC API.
Output: Contracts package schemas and procedures with proper error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-CONTEXT.md
@packages/contracts/src/subscriptions/subscription.ts
@packages/backend/src/procedures/subscriptions/get-subscription.ts
@packages/backend/src/procedures/router.ts
@packages/core/src/domain/entities/exercise.ts
@packages/core/src/domain/entities/muscle-group.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Exercise Contracts</name>
  <files>
    packages/contracts/src/exercises/exercise.ts
    packages/contracts/src/exercises/muscle-group.ts
    packages/contracts/src/exercises/index.ts
  </files>
  <action>
Create packages/contracts/src/exercises/muscle-group.ts:

import { z } from "zod";

export const muscleGroupSchema = z.enum([
  "chest", "back", "shoulders", "biceps", "triceps",
  "quads", "hamstrings", "glutes", "core", "calves"
]);

export const bodyRegionSchema = z.enum(["upper", "lower", "core"]);

export const muscleGroupInfoSchema = z.object({
  id: z.string(),
  name: muscleGroupSchema,
  displayName: z.string(),
  bodyRegion: bodyRegionSchema,
});

export const movementPatternSchema = z.enum([
  "push", "pull", "hinge", "squat", "carry", "core"
]);

Create packages/contracts/src/exercises/exercise.ts:

export const exerciseSchema = z.object({
  id: z.string(),
  organizationId: z.string().nullable(),
  name: z.string(),
  description: z.string().nullable(),
  instructions: z.string().nullable(),
  videoUrl: z.string().nullable(),
  movementPattern: movementPatternSchema.nullable(),
  isUnilateral: z.boolean(),
  isCurated: z.boolean(),
  clonedFromId: z.string().nullable(),
  primaryMuscles: z.array(muscleGroupSchema),
  secondaryMuscles: z.array(muscleGroupSchema),
  archivedAt: z.string().nullable(),
  createdAt: z.string(),
  updatedAt: z.string(),
});

export const createExerciseInputSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().optional(),
  instructions: z.string().optional(),
  videoUrl: z.string().url().optional(),
  movementPattern: movementPatternSchema.optional(),
  isUnilateral: z.boolean().optional(),
  primaryMuscles: z.array(muscleGroupSchema).optional(),
  secondaryMuscles: z.array(muscleGroupSchema).optional(),
});

export const updateExerciseInputSchema = createExerciseInputSchema.partial().extend({
  exerciseId: z.string(),
});

export const listExercisesInputSchema = z.object({
  movementPattern: movementPatternSchema.optional(),
  muscleGroup: muscleGroupSchema.optional(),
  search: z.string().optional(),
  includeArchived: z.boolean().optional(),
  limit: z.number().min(1).max(100).optional(),
  offset: z.number().min(0).optional(),
});

export const listExercisesOutputSchema = z.object({
  items: z.array(exerciseSchema),
  totalCount: z.number(),
});

export const cloneExerciseInputSchema = z.object({
  sourceExerciseId: z.string(),
  name: z.string().min(1).max(100).optional(),
});

Create packages/contracts/src/exercises/index.ts:
- Export all from './exercise' and './muscle-group'
  </action>
  <verify>pnpm typecheck --filter @strenly/contracts</verify>
  <done>Exercise and muscle group contracts defined</done>
</task>

<task type="auto">
  <name>Task 2: Create Exercise CRUD Procedures</name>
  <files>
    packages/backend/src/procedures/exercises/create-exercise.ts
    packages/backend/src/procedures/exercises/list-exercises.ts
    packages/backend/src/procedures/exercises/get-exercise.ts
    packages/backend/src/procedures/exercises/update-exercise.ts
    packages/backend/src/procedures/exercises/archive-exercise.ts
    packages/backend/src/procedures/exercises/clone-exercise.ts
  </files>
  <action>
Create each procedure following established patterns:

create-exercise.ts:
- authProcedure with input createExerciseInputSchema
- Output exerciseSchema
- Errors: FORBIDDEN, VALIDATION_ERROR

list-exercises.ts:
- authProcedure with input listExercisesInputSchema
- Output listExercisesOutputSchema
- Errors: FORBIDDEN

get-exercise.ts:
- authProcedure with input z.object({ exerciseId: z.string() })
- Output exerciseSchema
- Errors: FORBIDDEN, NOT_FOUND

update-exercise.ts:
- authProcedure with input updateExerciseInputSchema
- Output exerciseSchema
- Errors: FORBIDDEN, NOT_FOUND, CANNOT_EDIT_CURATED, VALIDATION_ERROR

archive-exercise.ts:
- authProcedure with input z.object({ exerciseId: z.string() })
- Output z.object({ success: z.boolean() })
- Errors: FORBIDDEN, NOT_FOUND, CANNOT_ARCHIVE_CURATED

clone-exercise.ts:
- authProcedure with input cloneExerciseInputSchema
- Output exerciseSchema
- Errors: FORBIDDEN, SOURCE_NOT_FOUND, VALIDATION_ERROR

All procedures: Instantiate use case with createExerciseRepository, call use case, map result.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Exercise CRUD and clone procedures created</done>
</task>

<task type="auto">
  <name>Task 3: Create Muscle Groups Endpoint and Router</name>
  <files>
    packages/backend/src/procedures/exercises/list-muscle-groups.ts
    packages/backend/src/procedures/exercises/index.ts
    packages/backend/src/procedures/router.ts
  </files>
  <action>
Create list-muscle-groups.ts:
- authProcedure (no input required)
- Output z.array(muscleGroupInfoSchema)
- Returns all muscle groups with displayName and bodyRegion
- Simple query to muscleGroups table or use MUSCLE_GROUPS constant

Create index.ts with exercisesRouter:
{
  create: createExercise,
  list: listExercises,
  get: getExercise,
  update: updateExercise,
  archive: archiveExercise,
  clone: cloneExercise,
  muscleGroups: listMuscleGroups,
}

Update router.ts:
- Import exercisesRouter
- Add: exercises: exercisesRouter
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Muscle groups endpoint and exercises router mounted</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/backend` passes
2. `pnpm typecheck --filter @strenly/contracts` passes
3. Exercises router mounted at /api/rpc/exercises/*
4. All procedures use exhaustive error switches
5. Clone copies all exercise fields with provenance
</verification>

<success_criteria>
- Exercises API: create, list, get, update, archive, clone
- Muscle groups endpoint returns all 10 groups with metadata
- Contracts define all input/output schemas
- Error handling protects curated exercises from modification
- Exercises router properly mounted in main router
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-10-SUMMARY.md`
</output>
