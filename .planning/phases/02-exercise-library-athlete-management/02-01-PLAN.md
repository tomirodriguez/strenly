---
phase: 02-exercise-library-athlete-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema/athletes.ts
  - packages/database/src/schema/athlete-invitations.ts
  - packages/database/src/schema/exercises.ts
  - packages/database/src/schema/muscle-groups.ts
  - packages/database/src/schema/exercise-muscles.ts
  - packages/database/src/schema/exercise-progressions.ts
  - packages/database/src/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Database schema supports athlete profiles with all required fields"
    - "Database schema supports exercise library with muscle group mappings"
    - "Database schema supports athlete invitation tokens with expiry"
  artifacts:
    - path: "packages/database/src/schema/athletes.ts"
      provides: "Athletes table definition"
      contains: "pgTable"
    - path: "packages/database/src/schema/exercises.ts"
      provides: "Exercises table with curated/custom distinction"
      contains: "organizationId"
    - path: "packages/database/src/schema/muscle-groups.ts"
      provides: "Muscle groups lookup table"
      contains: "muscleGroups"
    - path: "packages/database/src/schema/exercise-muscles.ts"
      provides: "Exercise-muscle junction with primary/secondary"
      contains: "isPrimary"
  key_links:
    - from: "packages/database/src/schema/athletes.ts"
      to: "packages/database/src/schema/auth.ts"
      via: "foreign key references"
      pattern: "references.*organizations"
    - from: "packages/database/src/schema/exercises.ts"
      to: "packages/database/src/schema/muscle-groups.ts"
      via: "exercise-muscles junction"
      pattern: "exerciseMuscles"
---

<objective>
Create database schema for athletes, exercises, muscle groups, and related junction tables.

Purpose: Establish the data layer foundation for Phase 2 features (athlete profiles, exercise library).
Output: Drizzle schema files with proper relations, indexes, and foreign keys.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-exercise-library-athlete-management/02-RESEARCH.md
@packages/database/src/schema/auth.ts
@packages/database/src/schema/plans.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Athletes and Invitations Schema</name>
  <files>
    packages/database/src/schema/athletes.ts
    packages/database/src/schema/athlete-invitations.ts
  </files>
  <action>
Create athletes table in athletes.ts following existing patterns from auth.ts:
- id: text primary key
- organizationId: text FK to organizations (cascade delete)
- name: text not null
- email: text nullable
- phone: text nullable
- birthdate: date nullable
- gender: text enum ('male', 'female', 'other') nullable
- notes: text nullable
- status: text enum ('active', 'inactive') default 'active' not null
- linkedUserId: text FK to users (set null on delete) - nullable for unlinked athletes
- createdAt, updatedAt timestamps

Indexes: organization_id, linked_user_id, status

Create athlete_invitations table in athlete-invitations.ts:
- id: text primary key
- athleteId: text FK to athletes (cascade delete)
- organizationId: text FK to organizations (cascade delete)
- token: text unique not null (the secure invitation token)
- createdByUserId: text FK to users (set null)
- expiresAt: timestamp not null
- revokedAt: timestamp nullable
- acceptedAt: timestamp nullable
- createdAt: timestamp

Indexes: token (unique), athlete_id, organization_id, expires_at

Follow patterns from packages/database/src/schema/plans.ts for enum types and indexes.
  </action>
  <verify>pnpm typecheck --filter @strenly/database</verify>
  <done>Athletes and athlete_invitations tables defined with proper foreign keys and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create Exercise Library Schema</name>
  <files>
    packages/database/src/schema/exercises.ts
    packages/database/src/schema/muscle-groups.ts
    packages/database/src/schema/exercise-muscles.ts
    packages/database/src/schema/exercise-progressions.ts
  </files>
  <action>
Create muscle_groups lookup table in muscle-groups.ts:
- id: text primary key
- name: text unique not null (e.g., 'chest', 'back')
- displayName: text not null (e.g., 'Chest', 'Back')
- bodyRegion: text enum ('upper', 'lower', 'core') not null

Create exercises table in exercises.ts:
- id: text primary key
- organizationId: text FK to organizations nullable (null = curated, non-null = custom)
- name: text not null
- description: text nullable
- instructions: text nullable
- videoUrl: text nullable
- movementPattern: text enum ('push', 'pull', 'hinge', 'squat', 'carry', 'core') nullable
- isUnilateral: boolean default false not null
- isCurated: boolean default false not null
- clonedFromId: text FK to exercises (set null) - for tracking cloned exercises
- archivedAt: timestamp nullable (soft delete)
- createdAt, updatedAt timestamps

Indexes: organization_id, movement_pattern, is_curated, archived_at

Create exercise_muscles junction in exercise-muscles.ts:
- exerciseId: text FK to exercises (cascade)
- muscleGroupId: text FK to muscle_groups (cascade)
- isPrimary: boolean default false not null
- Primary key: (exerciseId, muscleGroupId)

Create exercise_progressions self-referential in exercise-progressions.ts:
- id: text primary key
- exerciseId: text FK to exercises (cascade)
- progressionId: text FK to exercises (cascade)
- direction: text enum ('easier', 'harder') not null
- createdAt: timestamp

Indexes on both foreign keys. Note: Both exerciseId and progressionId reference exercises.id.
  </action>
  <verify>pnpm typecheck --filter @strenly/database</verify>
  <done>Exercise library schema with muscle groups, junction tables, and progressions defined</done>
</task>

<task type="auto">
  <name>Task 3: Export Schema and Push to Database</name>
  <files>packages/database/src/schema/index.ts</files>
  <action>
Update packages/database/src/schema/index.ts to export all new tables:
- Export from './athletes'
- Export from './athlete-invitations'
- Export from './exercises'
- Export from './muscle-groups'
- Export from './exercise-muscles'
- Export from './exercise-progressions'

Then run db:push to apply schema changes to the development database.

Note: If db:push fails due to missing DATABASE_URL, that's expected - the schema files themselves are the deliverable.
  </action>
  <verify>pnpm typecheck --filter @strenly/database && pnpm db:push || echo "Schema files created, db:push requires DATABASE_URL"</verify>
  <done>All schema tables exported and database schema updated (or ready for push)</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/database` passes with no errors
2. All 6 new schema files exist with proper Drizzle definitions
3. Foreign key references are correct (organizations, users, exercises)
4. Indexes defined for query optimization
</verification>

<success_criteria>
- Athletes table supports all profile fields from CONTEXT.md (name, email, phone, birthdate, gender, notes, status, linkedUserId)
- Exercises table distinguishes curated (null orgId) from custom (has orgId)
- Muscle groups are a lookup table with body region classification
- Exercise-muscle junction supports primary/secondary muscle mapping
- Exercise progressions allow self-referential easier/harder relationships
- Schema exports work and typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-01-SUMMARY.md`
</output>
