---
phase: 02-exercise-library-athlete-management
plan: 07
type: execute
wave: 3
depends_on: ["02-04"]
files_modified:
  - packages/backend/src/use-cases/athletes/generate-invitation.ts
  - packages/backend/src/use-cases/athletes/accept-invitation.ts
  - packages/backend/src/use-cases/athletes/revoke-invitation.ts
  - packages/backend/src/use-cases/athletes/get-invitation-info.ts
autonomous: true

must_haves:
  truths:
    - "Invitation tokens are 256-bit cryptographically secure"
    - "Invitations expire after 7 days"
    - "Accepting invitation links user to athlete profile"
    - "Invitation info available publicly (for invite page display)"
  artifacts:
    - path: "packages/backend/src/use-cases/athletes/generate-invitation.ts"
      provides: "Generate invitation use case"
      exports: ["makeGenerateInvitation"]
    - path: "packages/backend/src/use-cases/athletes/accept-invitation.ts"
      provides: "Accept invitation use case"
      exports: ["makeAcceptInvitation"]
  key_links:
    - from: "packages/backend/src/use-cases/athletes/generate-invitation.ts"
      to: "@strenly/core"
      via: "uses createAthleteInvitation"
      pattern: "createAthleteInvitation"
    - from: "packages/backend/src/use-cases/athletes/accept-invitation.ts"
      to: "athlete-invitation.repository.ts"
      via: "markAccepted transaction"
      pattern: "markAccepted"
---

<objective>
Implement athlete invitation flow use cases for the link-based invitation system.

Purpose: Enable coaches to generate invitation links and athletes to accept them.
Output: Use cases for generate, accept, revoke invitations and get public info.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-exercise-library-athlete-management/02-CONTEXT.md
@.planning/phases/02-exercise-library-athlete-management/02-RESEARCH.md
@packages/core/src/domain/entities/athlete-invitation.ts
@packages/core/src/ports/athlete-invitation-repository.port.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Invitation Use Case</name>
  <files>packages/backend/src/use-cases/athletes/generate-invitation.ts</files>
  <action>
Create generate-invitation.ts:

Type definitions:
- GenerateInvitationInput = OrganizationContext & { memberRole, athleteId }
- GenerateInvitationResult = { invitation: AthleteInvitation, invitationUrl: string }
- GenerateInvitationError = forbidden | athlete_not_found | already_linked | repository_error
- Dependencies = { athleteRepository, invitationRepository, generateId, appUrl: string }

makeGenerateInvitation(deps) => (input) => ResultAsync<Result, Error>:
1. Authorization: hasPermission(memberRole, "athletes:write")
2. Fetch athlete: athleteRepository.findById(ctx, athleteId)
   - If not found, return athlete_not_found error
3. Check if already linked: if athlete.linkedUserId !== null
   - Return errAsync({ type: "already_linked", message: "..." })
4. Revoke existing invitations: invitationRepository.findByAthleteId then revoke if exists
5. Create new invitation: createAthleteInvitation({ id, athleteId, organizationId, createdByUserId })
6. Persist: invitationRepository.create(ctx, invitation)
7. Build URL: `${deps.appUrl}/invite/${invitation.token}`
8. Return { invitation, invitationUrl }

Note: Generating new invitation implicitly revokes previous one.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Generate invitation use case creates secure tokens with URLs</done>
</task>

<task type="auto">
  <name>Task 2: Accept Invitation and Get Info Use Cases</name>
  <files>
    packages/backend/src/use-cases/athletes/accept-invitation.ts
    packages/backend/src/use-cases/athletes/get-invitation-info.ts
  </files>
  <action>
Create accept-invitation.ts:
- AcceptInvitationInput = { token: string, userId: string }
- AcceptInvitationResult = { athlete: Athlete, organizationId: string }
- AcceptInvitationError = invalid_token | expired | already_accepted | already_revoked | repository_error
- Dependencies = { invitationRepository, athleteRepository }

Flow (NO authorization - public endpoint with token):
1. Lookup: invitationRepository.findByToken(token)
   - If not found, return invalid_token error
2. Validate invitation state using helpers:
   - isExpired(invitation) -> return expired error
   - isRevoked(invitation) -> return already_revoked error
   - isAccepted(invitation) -> return already_accepted error
3. Link: invitationRepository.markAccepted(token, userId)
   - This updates invitation.acceptedAt AND athlete.linkedUserId
4. Fetch updated athlete: athleteRepository.findById(ctx, invitation.athleteId)
5. Return { athlete, organizationId: invitation.organizationId }

Create get-invitation-info.ts (PUBLIC - no auth):
- GetInvitationInfoInput = { token: string }
- GetInvitationInfoResult = { athleteName, organizationName, coachName, expiresAt, isValid }
- GetInvitationInfoError = invalid_token | repository_error
- Dependencies = { invitationRepository, organizationLookup }

Flow:
1. Lookup invitation by token
2. If not found, return invalid_token
3. Check isValid(invitation)
4. Lookup organization name and coach name from invitation.organizationId/createdByUserId
5. Return display info for invite page (WITHOUT revealing full token)
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Accept invitation links user to athlete, get-info provides public display data</done>
</task>

<task type="auto">
  <name>Task 3: Revoke Invitation Use Case</name>
  <files>packages/backend/src/use-cases/athletes/revoke-invitation.ts</files>
  <action>
Create revoke-invitation.ts:
- RevokeInvitationInput = OrganizationContext & { memberRole, athleteId }
- RevokeInvitationError = forbidden | invitation_not_found | repository_error
- Dependencies = { invitationRepository }

Flow:
1. Authorization: hasPermission(memberRole, "athletes:write")
2. Find invitation: invitationRepository.findByAthleteId(ctx, athleteId)
   - If not found, return invitation_not_found
3. Revoke: invitationRepository.revoke(ctx, invitation.id)
4. Return ok(undefined)

This allows coaches to explicitly revoke an invitation before it expires.
  </action>
  <verify>pnpm typecheck --filter @strenly/backend</verify>
  <done>Revoke invitation use case implemented</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @strenly/backend` passes
2. Generate creates 256-bit secure tokens
3. Accept validates expiry, revoked, already-accepted states
4. Get info is public (no auth required)
5. Invitation URLs use configurable app URL
</verification>

<success_criteria>
- Coaches can generate invitation links for unlinked athletes
- Generating new invitation revokes previous one
- Athletes can accept invitations via token
- Accepting links user.id to athlete.linkedUserId
- Invitation info shows org name and coach name before accepting
- Coaches can manually revoke invitations
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library-athlete-management/02-07-SUMMARY.md`
</output>
