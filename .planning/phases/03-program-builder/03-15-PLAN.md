---
phase: 03-program-builder
plan: 15
type: execute
wave: 7
depends_on: ["03-08", "03-10"]
files_modified:
  - packages/backend/src/use-cases/programs/save-as-template.ts
  - packages/backend/src/use-cases/programs/create-from-template.ts
  - packages/contracts/src/programs/template.ts
  - packages/backend/src/procedures/programs/templates.ts
  - packages/backend/src/procedures/programs/router.ts
  - apps/coach-web/src/components/programs/save-as-template-dialog.tsx
  - apps/coach-web/src/components/programs/program-form.tsx
autonomous: true

must_haves:
  truths:
    - "Coach can save any program as a template"
    - "Coach can create new programs from templates"
    - "Templates list shows all organization templates"
    - "Template metadata includes name, description, and structure info"
  artifacts:
    - path: "packages/backend/src/use-cases/programs/save-as-template.ts"
      provides: "Save program as template use case"
      exports: ["saveAsTemplateUseCase"]
    - path: "packages/backend/src/use-cases/programs/create-from-template.ts"
      provides: "Create program from template use case"
      exports: ["createFromTemplateUseCase"]
    - path: "apps/coach-web/src/components/programs/save-as-template-dialog.tsx"
      provides: "Dialog for saving program as template"
      exports: ["SaveAsTemplateDialog"]
  key_links:
    - from: "apps/coach-web/src/components/programs/program-form.tsx"
      to: "apps/coach-web/src/lib/api/programs.ts"
      via: "usePrograms({ isTemplate: true })"
      pattern: "isTemplate.*true"
---

<objective>
Implement template system for saving and creating programs from templates.

Purpose: Enable coaches to reuse program structures with the template system.
Output: Backend use cases and frontend components for template operations.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-05-SUMMARY.md
@.planning/phases/03-program-builder/03-08-SUMMARY.md
@.planning/phases/03-program-builder/03-10-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template use cases and contracts</name>
  <files>
    packages/backend/src/use-cases/programs/save-as-template.ts
    packages/backend/src/use-cases/programs/create-from-template.ts
    packages/contracts/src/programs/template.ts
  </files>
  <action>
**Save as template use case (save-as-template.ts):**
```typescript
interface SaveAsTemplateInput {
  programId: string
  templateName: string
  templateDescription?: string
}

export const saveAsTemplateUseCase = async (
  input: SaveAsTemplateInput,
  context: OrganizationContext,
  user: AuthenticatedUser
): Promise<ResultAsync<Program, SaveAsTemplateError>> => {
  // 1. Authorization
  if (!hasPermission(user, 'program:create')) {
    return err({ type: 'unauthorized' })
  }

  // 2. Fetch source program with details
  const source = await programRepository.findWithDetails(input.programId, context)
  if (!source) {
    return err({ type: 'not_found' })
  }

  // 3. Create template via duplicateProgramUseCase
  // - Set isTemplate: true
  // - Set athleteId: null (templates are not assigned)
  // - Use templateName and templateDescription

  return duplicateProgramUseCase({
    programId: input.programId,
    name: input.templateName,
    athleteId: undefined,  // Remove athlete assignment
    isTemplate: true,
  }, context, user)
}
```

**Create from template use case (create-from-template.ts):**
```typescript
interface CreateFromTemplateInput {
  templateId: string
  programName: string
  athleteId?: string
}

export const createFromTemplateUseCase = async (
  input: CreateFromTemplateInput,
  context: OrganizationContext,
  user: AuthenticatedUser
): Promise<ResultAsync<Program, CreateFromTemplateError>> => {
  // 1. Authorization
  if (!hasPermission(user, 'program:create')) {
    return err({ type: 'unauthorized' })
  }

  // 2. Verify template exists and is a template
  const template = await programRepository.findById(input.templateId, context)
  if (!template || !template.isTemplate) {
    return err({ type: 'template_not_found' })
  }

  // 3. Create new program via duplicateProgramUseCase
  // - Set isTemplate: false
  // - Set athleteId from input
  // - Use programName

  return duplicateProgramUseCase({
    programId: input.templateId,
    name: input.programName,
    athleteId: input.athleteId,
    isTemplate: false,
  }, context, user)
}
```

**Template contracts (template.ts):**
```typescript
export const saveAsTemplateSchema = z.object({
  programId: z.string(),
  templateName: z.string().min(3).max(100),
  templateDescription: z.string().max(500).optional(),
})

export const createFromTemplateSchema = z.object({
  templateId: z.string(),
  programName: z.string().min(3).max(100),
  athleteId: z.string().optional(),
})

export const templateOutputSchema = programOutputSchema.extend({
  weekCount: z.number(),
  sessionCount: z.number(),
})
```
  </action>
  <verify>pnpm typecheck in packages/backend and packages/contracts</verify>
  <done>Template use cases and contracts created</done>
</task>

<task type="auto">
  <name>Task 2: Create template procedures and update router</name>
  <files>
    packages/backend/src/procedures/programs/templates.ts
    packages/backend/src/procedures/programs/router.ts
  </files>
  <action>
**Template procedures (templates.ts):**
```typescript
export const saveAsTemplateProcedure = orgProcedure
  .input(saveAsTemplateSchema)
  .output(programOutputSchema)
  .mutation(async ({ input, ctx }) => {
    const result = await saveAsTemplateUseCase(input, ctx.org, ctx.user)
    if (result.isErr()) {
      throw mapTemplateError(result.error)
    }
    return result.value
  })

export const createFromTemplateProcedure = orgProcedure
  .input(createFromTemplateSchema)
  .output(programOutputSchema)
  .mutation(async ({ input, ctx }) => {
    const result = await createFromTemplateUseCase(input, ctx.org, ctx.user)
    if (result.isErr()) {
      throw mapTemplateError(result.error)
    }
    return result.value
  })

export const listTemplatesProcedure = orgProcedure
  .output(z.array(templateOutputSchema))
  .query(async ({ ctx }) => {
    const templates = await programRepository.listTemplates(ctx.org)
    return templates.map(t => ({
      ...t,
      weekCount: t.weeks?.length ?? 0,
      sessionCount: t.sessions?.length ?? 0,
    }))
  })
```

**Update router.ts:**
```typescript
export const programsRouter = {
  // ... existing
  templates: {
    list: listTemplatesProcedure,
    saveAs: saveAsTemplateProcedure,
    createFrom: createFromTemplateProcedure,
  },
}
```
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Template procedures added to router</done>
</task>

<task type="auto">
  <name>Task 3: Create frontend template components</name>
  <files>
    apps/coach-web/src/components/programs/save-as-template-dialog.tsx
    apps/coach-web/src/components/programs/program-form.tsx
    apps/coach-web/src/lib/api/programs.ts
  </files>
  <action>
**Add template API hooks to programs.ts:**
```typescript
export function useTemplates() {
  return useQuery(orpc.programs.templates.list.queryOptions())
}

export function useSaveAsTemplate() {
  const queryClient = useQueryClient()
  return useMutation({
    ...orpc.programs.templates.saveAs.mutationOptions(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: orpc.programs.key() })
    },
  })
}

export function useCreateFromTemplate() {
  const queryClient = useQueryClient()
  return useMutation({
    ...orpc.programs.templates.createFrom.mutationOptions(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: orpc.programs.key() })
    },
  })
}
```

**Save as template dialog (save-as-template-dialog.tsx):**
Dialog with:
- Template name input
- Template description textarea (optional)
- Save button calls useSaveAsTemplate mutation
- On success, shows toast and closes

**Update program form (program-form.tsx):**
Add template selector:
```typescript
// In the form
const { data: templates } = useTemplates()

// Template combobox field (optional)
<Field name="templateId" label="Crear desde plantilla" optional>
  <Combobox
    options={templates?.map(t => ({
      value: t.id,
      label: t.name,
      description: `${t.weekCount} semanas, ${t.sessionCount} dÃ­as`,
    })) ?? []}
    placeholder="Seleccionar plantilla..."
  />
</Field>

// On submit, if templateId is set, use createFromTemplate instead of create
```
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>Template frontend components created</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all packages type-check
2. Test saving program as template
3. Test creating program from template
4. Verify templates show in program form selector
5. Verify templates are private to organization
</verification>

<success_criteria>
- Coach can save any program as a template (TPL-01)
- Coach can create new programs from templates (TPL-02)
- Templates have metadata: name, description, week/session counts (TPL-03)
- Templates are private to organization (TPL-04)
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-15-SUMMARY.md`
</output>
