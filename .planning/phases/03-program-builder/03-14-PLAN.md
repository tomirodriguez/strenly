---
phase: 03-program-builder
plan: 14
type: execute
wave: 7
depends_on: ["03-12", "03-13"]
files_modified:
  - apps/coach-web/src/components/programs/program-grid.tsx
  - apps/coach-web/src/components/programs/week-actions-menu.tsx
  - apps/coach-web/src/components/programs/exercise-row-actions.tsx
  - apps/coach-web/src/components/programs/keyboard-shortcuts-footer.tsx
autonomous: false

must_haves:
  truths:
    - "Coach can duplicate weeks with all prescriptions"
    - "Coach can delete weeks and sessions with confirmation"
    - "Coach can reorder exercise rows via drag-drop"
    - "Keyboard shortcuts are discoverable via footer hints"
  artifacts:
    - path: "apps/coach-web/src/components/programs/week-actions-menu.tsx"
      provides: "Week column dropdown with duplicate/delete"
      exports: ["WeekActionsMenu"]
    - path: "apps/coach-web/src/components/programs/exercise-row-actions.tsx"
      provides: "Exercise row context menu"
      exports: ["ExerciseRowActions"]
    - path: "apps/coach-web/src/components/programs/keyboard-shortcuts-footer.tsx"
      provides: "Footer with keyboard shortcut hints"
      exports: ["KeyboardShortcutsFooter"]
  key_links:
    - from: "apps/coach-web/src/components/programs/week-actions-menu.tsx"
      to: "apps/coach-web/src/lib/api/grid.ts"
      via: "useDuplicateWeek"
      pattern: "useDuplicateWeek"
---

<objective>
Implement advanced grid manipulation: week actions, row actions, reordering, and keyboard shortcut hints.

Purpose: Complete the Excel-like editing experience with all manipulation features.
Output: Week/row actions menus, drag-drop reordering, keyboard shortcuts footer.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-RESEARCH.md
@.planning/phases/03-program-builder/03-12-SUMMARY.md
@.planning/phases/03-program-builder/03-13-SUMMARY.md
@.planning/phases/03-program-builder/ui-ux-specifications/code.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create week column actions</name>
  <files>apps/coach-web/src/components/programs/week-actions-menu.tsx</files>
  <action>
Create dropdown menu for week column headers:

```typescript
interface WeekActionsMenuProps {
  weekId: string
  weekName: string
  programId: string
  isLastWeek: boolean
  onRename: (name: string) => void
}

export function WeekActionsMenu({ weekId, weekName, programId, isLastWeek, onRename }: WeekActionsMenuProps) {
  const [showRenameDialog, setShowRenameDialog] = useState(false)
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)
  const duplicateWeek = useDuplicateWeek(programId)
  const deleteWeek = useDeleteWeek(programId)

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" size="icon" className="h-6 w-6">
            <MoreVertical className="h-4 w-4" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem onClick={() => setShowRenameDialog(true)}>
            <Pencil className="mr-2 h-4 w-4" />
            Renombrar
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => duplicateWeek.mutate({ weekId })}>
            <Copy className="mr-2 h-4 w-4" />
            Duplicar Semana
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem
            onClick={() => setShowDeleteConfirm(true)}
            disabled={isLastWeek}
            className="text-destructive"
          >
            <Trash className="mr-2 h-4 w-4" />
            Eliminar Semana
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>

      {/* Rename dialog */}
      <RenameWeekDialog
        open={showRenameDialog}
        onOpenChange={setShowRenameDialog}
        weekName={weekName}
        onRename={onRename}
      />

      {/* Delete confirmation */}
      <AlertDialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>¿Eliminar {weekName}?</AlertDialogTitle>
            <AlertDialogDescription>
              Se eliminarán todas las prescripciones de esta semana. Esta acción no se puede deshacer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => deleteWeek.mutate({ weekId })}
              className="bg-destructive text-destructive-foreground"
            >
              Eliminar
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  )
}
```

Integrate into week column header in program-grid.tsx.
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>Week column actions menu created</done>
</task>

<task type="auto">
  <name>Task 2: Create exercise row actions and reordering</name>
  <files>
    apps/coach-web/src/components/programs/exercise-row-actions.tsx
    apps/coach-web/src/components/programs/program-grid.tsx
  </files>
  <action>
**Exercise row actions (exercise-row-actions.tsx):**
Context menu (right-click) or dropdown for exercise rows:

```typescript
interface ExerciseRowActionsProps {
  rowId: string
  exerciseName: string
  programId: string
  isSubRow: boolean
  supersetGroup: string | null
}

export function ExerciseRowActions({ rowId, exerciseName, programId, isSubRow, supersetGroup }: ExerciseRowActionsProps) {
  const deleteRow = useDeleteExerciseRow(programId)
  const addSplitRow = useAddSplitRow(programId)
  const toggleSuperset = useToggleSuperset(programId)

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="h-6 w-6 opacity-0 group-hover:opacity-100">
          <MoreVertical className="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        {!isSubRow && (
          <DropdownMenuItem onClick={() => setShowSplitDialog(true)}>
            <SplitSquareVertical className="mr-2 h-4 w-4" />
            Agregar Split Row
          </DropdownMenuItem>
        )}
        <DropdownMenuItem onClick={() => setShowSupersetDialog(true)}>
          <Link className="mr-2 h-4 w-4" />
          {supersetGroup ? 'Cambiar Superset' : 'Agregar a Superset'}
        </DropdownMenuItem>
        {supersetGroup && (
          <DropdownMenuItem onClick={() => toggleSuperset.mutate({ rowId, supersetGroup: null })}>
            <Unlink className="mr-2 h-4 w-4" />
            Quitar de Superset
          </DropdownMenuItem>
        )}
        <DropdownMenuSeparator />
        <DropdownMenuItem
          onClick={() => deleteRow.mutate({ rowId })}
          className="text-destructive"
        >
          <Trash className="mr-2 h-4 w-4" />
          Eliminar Ejercicio
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

**Reordering in program-grid.tsx:**
Use @dnd-kit for drag-drop reordering:

```typescript
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors } from '@dnd-kit/core'
import { SortableContext, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable'

// Wrap exercise rows in SortableContext per session
// On dragEnd, call reorderExerciseRows mutation
```

Note: Reordering only works within a session, not across sessions.
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>Exercise row actions and reordering implemented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full program grid editor with:
- Excel-like keyboard navigation (arrow keys, tab, enter, escape)
- Prescription notation parsing (3x8@120kg, 4x6-8@RIR2, etc.)
- Week column actions (rename, duplicate, delete)
- Exercise row actions (split row, superset, delete)
- Drag-drop reordering within sessions
- Keyboard shortcuts (Shift+Enter for split, S for superset)
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:5173/{orgSlug}/programs
2. Create a new program or open an existing one
3. Test keyboard navigation:
   - Arrow keys move between cells
   - Tab moves to next cell
   - Enter edits cell, Escape cancels
4. Test prescription entry:
   - Type "3x8@120kg" and press Enter - should parse
   - Type "4x6-8@RIR2" and press Enter - should parse
   - Type "—" for skip notation
5. Test structure manipulation:
   - Click "Agregar Semana" - new column appears
   - Click "Agregar Día" - new session section appears
   - Click "Add exercise" row - exercise picker opens
6. Test week actions:
   - Click week menu → Duplicate - copies all prescriptions
   - Click week menu → Delete - confirmation then deletes
7. Test exercise row actions:
   - Right-click or menu → Add Split Row - prompts for label
   - Shift+Enter on row - same as above
   - S key or menu → Toggle superset
8. Test drag-drop:
   - Drag exercise row to reorder within session
  </how-to-verify>
  <resume-signal>Type "approved" if grid works correctly, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all components type-check
2. Run `pnpm dev:coach` - full grid editor test
3. Test all keyboard shortcuts
4. Test all menu actions
5. Test drag-drop reordering
</verification>

<success_criteria>
- Week columns have rename/duplicate/delete actions
- Exercise rows have split/superset/delete actions
- Drag-drop reorders exercises within sessions
- Keyboard shortcuts work: Shift+Enter (split), S (superset)
- All actions persist to database
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-14-SUMMARY.md`
</output>
