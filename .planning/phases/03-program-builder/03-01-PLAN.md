---
phase: 03-program-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema/programs.ts
  - packages/database/src/schema/program-weeks.ts
  - packages/database/src/schema/program-sessions.ts
  - packages/database/src/schema/program-exercises.ts
  - packages/database/src/schema/prescriptions.ts
  - packages/database/src/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Database schema supports programs with weeks, sessions, and exercises"
    - "Prescriptions store structured data (sets, reps, intensity, tempo) as JSONB"
    - "Superset grouping and split rows are supported via dedicated columns"
    - "Programs can be assigned to athletes or saved as templates"
  artifacts:
    - path: "packages/database/src/schema/programs.ts"
      provides: "Programs table with name, description, athleteId, isTemplate"
      exports: ["programsTable"]
    - path: "packages/database/src/schema/program-weeks.ts"
      provides: "Program weeks table with orderIndex, name"
      exports: ["programWeeksTable"]
    - path: "packages/database/src/schema/program-sessions.ts"
      provides: "Program sessions (days) table with orderIndex, name"
      exports: ["programSessionsTable"]
    - path: "packages/database/src/schema/program-exercises.ts"
      provides: "Program exercises with superset grouping and split row support"
      exports: ["programExercisesTable"]
    - path: "packages/database/src/schema/prescriptions.ts"
      provides: "Prescriptions linking exercises to weeks with JSONB prescription data"
      exports: ["prescriptionsTable"]
  key_links:
    - from: "packages/database/src/schema/programs.ts"
      to: "packages/database/src/schema/index.ts"
      via: "export"
      pattern: "export.*from.*programs"
---

<objective>
Create the database schema for the program builder domain - programs, weeks, sessions, exercises, and prescriptions.

Purpose: Establish the data foundation for the Excel-like program builder grid.
Output: Drizzle schema files with proper relations and JSONB prescription storage.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-program-builder/03-RESEARCH.md
@packages/database/src/schema/exercises.ts
@packages/database/src/schema/athletes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create programs table schema</name>
  <files>packages/database/src/schema/programs.ts</files>
  <action>
Create the programs table with:
- `id` (text, primary key, prefixed 'prg-')
- `organizationId` (text, required, foreign key to organization)
- `name` (text, required)
- `description` (text, nullable)
- `athleteId` (text, nullable, foreign key to athletes - null for templates)
- `isTemplate` (boolean, default false)
- `status` (text enum: 'draft', 'active', 'archived', default 'draft')
- `createdAt`, `updatedAt` timestamps

Follow patterns from athletes.ts and exercises.ts for schema structure.
Use `pgTable` from drizzle-orm/pg-core.
Include relation to organization and optional relation to athlete.
  </action>
  <verify>pnpm typecheck in packages/database</verify>
  <done>Programs table schema exists with organization and athlete relations</done>
</task>

<task type="auto">
  <name>Task 2: Create program weeks and sessions tables</name>
  <files>
    packages/database/src/schema/program-weeks.ts
    packages/database/src/schema/program-sessions.ts
  </files>
  <action>
Create program_weeks table:
- `id` (text, primary key, prefixed 'week-')
- `programId` (text, required, foreign key to programs)
- `name` (text, required, default "Semana X")
- `orderIndex` (integer, required)
- `createdAt`, `updatedAt` timestamps

Create program_sessions table (training days):
- `id` (text, primary key, prefixed 'sess-')
- `programId` (text, required, foreign key to programs)
- `name` (text, required, e.g. "DÍA 1 • SQUAT DOMINANT")
- `orderIndex` (integer, required)
- `createdAt`, `updatedAt` timestamps

Include relations in both tables.
  </action>
  <verify>pnpm typecheck in packages/database</verify>
  <done>Program weeks and sessions tables exist with proper relations</done>
</task>

<task type="auto">
  <name>Task 3: Create program exercises and prescriptions tables</name>
  <files>
    packages/database/src/schema/program-exercises.ts
    packages/database/src/schema/prescriptions.ts
    packages/database/src/schema/index.ts
  </files>
  <action>
Create program_exercises table (rows in grid):
- `id` (text, primary key, prefixed 'pex-')
- `sessionId` (text, required, foreign key to program_sessions)
- `exerciseId` (text, required, foreign key to exercises)
- `orderIndex` (integer, required)
- `supersetGroup` (text, nullable - 'A', 'B', 'C', etc.)
- `supersetOrder` (integer, nullable - 1, 2, 3 for A1, A2, A3)
- `setTypeLabel` (text, nullable - "HEAVY SINGLES", "BACK-OFF VOLUME", etc.)
- `isSubRow` (boolean, default false - for split rows)
- `parentRowId` (text, nullable, self-reference for sub-rows)
- `notes` (text, nullable)
- `restSeconds` (integer, nullable)
- `createdAt`, `updatedAt` timestamps

Create prescriptions table (cell values - one per exercise per week):
- `id` (text, primary key, prefixed 'rx-')
- `programExerciseId` (text, required, foreign key to program_exercises)
- `weekId` (text, required, foreign key to program_weeks)
- `prescription` (jsonb, required) - stores ParsedPrescription structure:
  {
    sets: number,
    repsMin: number,
    repsMax: number | null,
    isAmrap: boolean,
    isUnilateral: boolean,
    unilateralUnit: 'leg' | 'arm' | 'side' | null,
    intensityType: 'absolute' | 'percentage' | 'rpe' | 'rir' | null,
    intensityValue: number | null,
    intensityUnit: 'kg' | 'lb' | '%' | 'rpe' | 'rir' | null,
    tempo: string | null
  }
- `createdAt`, `updatedAt` timestamps
- Unique constraint on (programExerciseId, weekId)

Update index.ts to export all new tables.
  </action>
  <verify>pnpm typecheck in packages/database && pnpm db:push</verify>
  <done>Program exercises and prescriptions tables exist, schema pushed to database</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all schema files type-check correctly
2. Run `pnpm db:push` - schema applied to database without errors
3. Verify tables exist: programs, program_weeks, program_sessions, program_exercises, prescriptions
4. Verify JSONB prescription column accepts structured prescription data
</verification>

<success_criteria>
- Database has all 5 new tables with proper relations
- Prescription data stored as JSONB supports all notation variants
- Superset grouping and split row support via dedicated columns
- Foreign keys enforce referential integrity
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-01-SUMMARY.md`
</output>
