---
phase: 03-program-builder
plan: 09
type: execute
wave: 4
depends_on: ["03-02", "03-06", "03-07"]
files_modified:
  - packages/contracts/src/programs/week.ts
  - packages/contracts/src/programs/session.ts
  - packages/contracts/src/programs/exercise-row.ts
  - packages/contracts/src/programs/prescription.ts
  - packages/backend/src/procedures/programs/weeks.ts
  - packages/backend/src/procedures/programs/sessions.ts
  - packages/backend/src/procedures/programs/exercise-rows.ts
  - packages/backend/src/procedures/programs/prescriptions.ts
  - packages/backend/src/procedures/programs/router.ts
autonomous: true

must_haves:
  truths:
    - "Contracts define schemas for week, session, and exercise row operations"
    - "Prescription endpoint accepts notation string and returns parsed data"
    - "All nested operations require program ownership via organization"
    - "Router exposes all grid manipulation endpoints"
  artifacts:
    - path: "packages/contracts/src/programs/prescription.ts"
      provides: "Prescription notation input schema"
      exports: ["updatePrescriptionSchema", "parsedPrescriptionSchema"]
    - path: "packages/backend/src/procedures/programs/prescriptions.ts"
      provides: "Prescription update procedure"
      exports: ["updatePrescriptionProcedure"]
  key_links:
    - from: "packages/backend/src/procedures/programs/prescriptions.ts"
      to: "packages/backend/src/use-cases/programs/update-prescription.ts"
      via: "use case call"
      pattern: "updatePrescriptionUseCase"
---

<objective>
Create contracts and procedures for grid manipulation operations (weeks, sessions, exercise rows, prescriptions).

Purpose: Expose fine-grained grid operations for the Excel-like editor.
Output: Contracts and procedures for all grid cell and structure operations.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-06-SUMMARY.md
@.planning/phases/03-program-builder/03-07-SUMMARY.md
@packages/contracts/src/exercises/exercise.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create grid structure contracts</name>
  <files>
    packages/contracts/src/programs/week.ts
    packages/contracts/src/programs/session.ts
    packages/contracts/src/programs/exercise-row.ts
    packages/contracts/src/programs/index.ts
  </files>
  <action>
Create Zod schemas for grid structure operations:

**Week contracts (week.ts):**
```typescript
export const addWeekSchema = z.object({
  programId: z.string(),
  name: z.string().max(50).optional(),
})

export const updateWeekSchema = z.object({
  weekId: z.string(),
  name: z.string().max(50),
})

export const deleteWeekSchema = z.object({
  weekId: z.string(),
})

export const duplicateWeekSchema = z.object({
  weekId: z.string(),
  name: z.string().max(50).optional(),
})

export const weekOutputSchema = z.object({
  id: z.string(),
  programId: z.string(),
  name: z.string(),
  orderIndex: z.number(),
})
```

**Session contracts (session.ts):**
```typescript
export const addSessionSchema = z.object({
  programId: z.string(),
  name: z.string().min(1).max(100),
})

export const updateSessionSchema = z.object({
  sessionId: z.string(),
  name: z.string().min(1).max(100),
})

export const deleteSessionSchema = z.object({
  sessionId: z.string(),
})

export const sessionOutputSchema = z.object({
  id: z.string(),
  programId: z.string(),
  name: z.string(),
  orderIndex: z.number(),
})
```

**Exercise row contracts (exercise-row.ts):**
```typescript
export const addExerciseRowSchema = z.object({
  sessionId: z.string(),
  exerciseId: z.string(),
  supersetGroup: z.string().max(1).optional(), // 'A', 'B', 'C'
  supersetOrder: z.number().min(1).optional(),
})

export const updateExerciseRowSchema = z.object({
  rowId: z.string(),
  exerciseId: z.string().optional(),
  supersetGroup: z.string().max(1).nullable().optional(),
  supersetOrder: z.number().min(1).nullable().optional(),
  setTypeLabel: z.string().max(30).nullable().optional(),
  notes: z.string().max(500).nullable().optional(),
  restSeconds: z.number().min(0).max(600).nullable().optional(),
})

export const deleteExerciseRowSchema = z.object({
  rowId: z.string(),
})

export const reorderExerciseRowsSchema = z.object({
  sessionId: z.string(),
  rowIds: z.array(z.string()),
})

export const addSplitRowSchema = z.object({
  parentRowId: z.string(),
  setTypeLabel: z.string().min(1).max(30), // "HEAVY SINGLES", "BACK-OFF"
})

export const toggleSupersetSchema = z.object({
  rowId: z.string(),
  supersetGroup: z.string().max(1).nullable(), // null to remove from superset
})

export const exerciseRowOutputSchema = z.object({
  id: z.string(),
  sessionId: z.string(),
  exerciseId: z.string(),
  exerciseName: z.string(),
  orderIndex: z.number(),
  supersetGroup: z.string().nullable(),
  supersetOrder: z.number().nullable(),
  setTypeLabel: z.string().nullable(),
  isSubRow: z.boolean(),
  parentRowId: z.string().nullable(),
  notes: z.string().nullable(),
  restSeconds: z.number().nullable(),
})
```

Update index.ts to export all new schemas.
  </action>
  <verify>pnpm typecheck in packages/contracts</verify>
  <done>Grid structure contracts created</done>
</task>

<task type="auto">
  <name>Task 2: Create grid manipulation procedures</name>
  <files>
    packages/backend/src/procedures/programs/weeks.ts
    packages/backend/src/procedures/programs/sessions.ts
    packages/backend/src/procedures/programs/exercise-rows.ts
    packages/backend/src/procedures/programs/prescriptions.ts
    packages/backend/src/procedures/programs/router.ts
  </files>
  <action>
Create procedures for all grid operations:

**Week procedures (weeks.ts):**
- addWeekProcedure
- updateWeekProcedure
- deleteWeekProcedure
- duplicateWeekProcedure

**Session procedures (sessions.ts):**
- addSessionProcedure
- updateSessionProcedure
- deleteSessionProcedure

**Exercise row procedures (exercise-rows.ts):**
- addExerciseRowProcedure
- updateExerciseRowProcedure
- deleteExerciseRowProcedure
- reorderExerciseRowsProcedure
- addSplitRowProcedure
- toggleSupersetProcedure

**Prescription procedures (prescriptions.ts):**
```typescript
export const updatePrescriptionProcedure = orgProcedure
  .input(updatePrescriptionSchema)
  .output(parsedPrescriptionSchema.nullable())
  .mutation(async ({ input, ctx }) => {
    const result = await updatePrescriptionUseCase(input, ctx.org, ctx.user)

    if (result.isErr()) {
      throw mapPrescriptionError(result.error)
    }

    return result.value // ParsedPrescription | null
  })
```

**Update router.ts** to add nested routes:
```typescript
export const programsRouter = {
  // ... existing routes
  weeks: {
    add: addWeekProcedure,
    update: updateWeekProcedure,
    delete: deleteWeekProcedure,
    duplicate: duplicateWeekProcedure,
  },
  sessions: {
    add: addSessionProcedure,
    update: updateSessionProcedure,
    delete: deleteSessionProcedure,
  },
  exerciseRows: {
    add: addExerciseRowProcedure,
    update: updateExerciseRowProcedure,
    delete: deleteExerciseRowProcedure,
    reorder: reorderExerciseRowsProcedure,
    addSplit: addSplitRowProcedure,
    toggleSuperset: toggleSupersetProcedure,
  },
  prescriptions: {
    update: updatePrescriptionProcedure,
  },
}
```
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Grid manipulation procedures created and added to router</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - contracts and procedures type-check correctly
2. Verify all procedures use orgProcedure for authentication
3. Verify router exposes all nested endpoints
4. Verify prescription procedure returns parsed data or null
</verification>

<success_criteria>
- All grid structure operations have contracts and procedures
- Prescription update accepts notation, returns parsed data
- Nested router structure for logical grouping
- All endpoints require organization authentication
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-09-SUMMARY.md`
</output>
