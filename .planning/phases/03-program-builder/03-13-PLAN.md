---
phase: 03-program-builder
plan: 13
type: execute
wave: 6
depends_on: ["03-11", "03-12"]
files_modified:
  - apps/coach-web/src/components/programs/program-grid.tsx
  - apps/coach-web/src/components/programs/grid-toolbar.tsx
  - apps/coach-web/src/components/programs/add-exercise-row.tsx
  - apps/coach-web/src/components/programs/add-session-modal.tsx
  - apps/coach-web/src/components/programs/add-week-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Coach can add exercises to sessions via 'Add exercise' row"
    - "Coach can add new weeks via toolbar or shortcut"
    - "Coach can add new sessions (days) via toolbar"
    - "Coach can add split rows via Shift+Enter"
  artifacts:
    - path: "apps/coach-web/src/components/programs/grid-toolbar.tsx"
      provides: "Toolbar with Add Week, Add Session buttons"
      exports: ["GridToolbar"]
    - path: "apps/coach-web/src/components/programs/add-exercise-row.tsx"
      provides: "Special row for adding exercises"
      exports: ["AddExerciseRow"]
  key_links:
    - from: "apps/coach-web/src/components/programs/program-grid.tsx"
      to: "apps/coach-web/src/lib/api/grid.ts"
      via: "useAddExerciseRow"
      pattern: "useAddExerciseRow"
---

<objective>
Implement grid manipulation interactions for adding structure (weeks, sessions, exercises, split rows).

Purpose: Enable coaches to build program structure within the grid editor.
Output: Toolbar, add exercise row, and modals for adding weeks/sessions.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-11-SUMMARY.md
@.planning/phases/03-program-builder/03-12-SUMMARY.md
@apps/coach-web/src/components/programs/program-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create grid toolbar with structure actions</name>
  <files>
    apps/coach-web/src/components/programs/grid-toolbar.tsx
    apps/coach-web/src/components/programs/add-week-modal.tsx
    apps/coach-web/src/components/programs/add-session-modal.tsx
  </files>
  <action>
**Grid toolbar (grid-toolbar.tsx):**
```typescript
interface GridToolbarProps {
  programId: string
  onAddWeek: () => void
  onAddSession: () => void
  weekCount: number
  sessionCount: number
}

export function GridToolbar({ programId, onAddWeek, onAddSession, weekCount, sessionCount }: GridToolbarProps) {
  return (
    <div className="flex items-center justify-between px-4 py-2 border-b border-border bg-muted/30">
      <div className="flex items-center gap-2">
        {/* Week count indicator */}
        <span className="text-sm text-muted-foreground">
          {weekCount} semana{weekCount !== 1 ? 's' : ''}
        </span>
        <span className="text-muted-foreground">•</span>
        <span className="text-sm text-muted-foreground">
          {sessionCount} día{sessionCount !== 1 ? 's' : ''}
        </span>
      </div>
      <div className="flex items-center gap-2">
        <Button variant="outline" size="sm" onClick={onAddWeek}>
          <Plus className="mr-1 h-3 w-3" />
          Agregar Semana
        </Button>
        <Button variant="outline" size="sm" onClick={onAddSession}>
          <Plus className="mr-1 h-3 w-3" />
          Agregar Día
        </Button>
      </div>
    </div>
  )
}
```

**Add week modal (add-week-modal.tsx):**
Simple dialog with:
- Week name input (optional, defaults to "Semana {N+1}")
- Submit calls useAddWeek mutation
- On success, closes modal and grid updates

**Add session modal (add-session-modal.tsx):**
Dialog with:
- Session name input (required, e.g., "DÍA 4 • PULL")
- Submit calls useAddSession mutation
- On success, closes modal and grid updates
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>Grid toolbar and structure modals created</done>
</task>

<task type="auto">
  <name>Task 2: Create add exercise row and split row interaction</name>
  <files>
    apps/coach-web/src/components/programs/add-exercise-row.tsx
    apps/coach-web/src/components/programs/program-grid.tsx
  </files>
  <action>
**Add exercise row (add-exercise-row.tsx):**
Special row at the end of each session for adding exercises:

```typescript
interface AddExerciseRowProps {
  sessionId: string
  onAdd: (exerciseId: string) => void
}

export function AddExerciseRow({ sessionId, onAdd }: AddExerciseRowProps) {
  const [isAdding, setIsAdding] = useState(false)

  return (
    <tr className="group opacity-30 hover:opacity-100 transition-opacity">
      <td className="spreadsheet-cell p-0 sticky-col bg-muted/10">
        <div className="flex items-center h-full">
          <span className="w-10 flex justify-center h-full items-center border-r border-border">
            <Plus className="h-4 w-4 text-muted-foreground" />
          </span>
          {isAdding ? (
            <ExercisePickerCell
              onSelect={(exercise) => {
                onAdd(exercise.id)
                setIsAdding(false)
              }}
              onCancel={() => setIsAdding(false)}
              autoFocus
            />
          ) : (
            <input
              className="spreadsheet-input font-medium flex-1 italic"
              placeholder="Agregar ejercicio al programa..."
              onFocus={() => setIsAdding(true)}
              readOnly
            />
          )}
        </div>
      </td>
      {/* Empty cells for week columns */}
      <td className="spreadsheet-cell p-0" colSpan={weekCount}></td>
    </tr>
  )
}
```

**Update program-grid.tsx for split rows:**
Add keyboard handler for Shift+Enter to add split row:

```typescript
// In ProgramGrid component
const handleKeyDown = useCallback((e: KeyboardEvent) => {
  // Shift+Enter: Add split row
  if (e.key === 'Enter' && e.shiftKey) {
    e.preventDefault()
    const selectedRowId = getSelectedRowId()
    if (selectedRowId) {
      // Open set type label prompt
      setShowSplitRowDialog({ parentRowId: selectedRowId })
    }
  }

  // S key: Toggle superset
  if (e.key === 's' && !isEditing) {
    e.preventDefault()
    const selectedRowId = getSelectedRowId()
    if (selectedRowId) {
      // Open superset group selector
      setShowSupersetDialog({ rowId: selectedRowId })
    }
  }
}, [])

useEffect(() => {
  document.addEventListener('keydown', handleKeyDown)
  return () => document.removeEventListener('keydown', handleKeyDown)
}, [handleKeyDown])
```

Add split row dialog to prompt for setTypeLabel (e.g., "HEAVY SINGLES", "BACK-OFF VOLUME", "VOLUME").
  </action>
  <verify>pnpm dev:coach - test adding exercises and split rows</verify>
  <done>Add exercise row and split row interaction implemented</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all components type-check
2. Run `pnpm dev:coach` - navigate to program editor
3. Verify "Add Week" button adds a new week column
4. Verify "Add Session" button adds a new day section
5. Verify clicking "Add exercise" row opens exercise picker
6. Verify Shift+Enter opens split row dialog
</verification>

<success_criteria>
- Toolbar shows week/session count and add buttons
- Adding week appends column to grid
- Adding session appends day section to grid
- Adding exercise via special row works
- Shift+Enter creates split row with set type label
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-13-SUMMARY.md`
</output>
