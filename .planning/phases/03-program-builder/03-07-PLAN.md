---
phase: 03-program-builder
plan: 07
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - packages/backend/src/use-cases/programs/add-exercise-row.ts
  - packages/backend/src/use-cases/programs/update-exercise-row.ts
  - packages/backend/src/use-cases/programs/delete-exercise-row.ts
  - packages/backend/src/use-cases/programs/reorder-exercise-rows.ts
  - packages/backend/src/use-cases/programs/update-prescription.ts
  - packages/backend/src/use-cases/programs/add-split-row.ts
  - packages/backend/src/use-cases/programs/toggle-superset.ts
autonomous: true

must_haves:
  truths:
    - "Exercise rows can be added to sessions with superset grouping"
    - "Split rows allow same exercise with different set configurations"
    - "Prescription updates parse notation and store structured data"
    - "Exercise rows can be reordered within sessions"
  artifacts:
    - path: "packages/backend/src/use-cases/programs/add-exercise-row.ts"
      provides: "Add exercise row with optional superset"
      exports: ["addExerciseRowUseCase"]
    - path: "packages/backend/src/use-cases/programs/update-prescription.ts"
      provides: "Update prescription from notation"
      exports: ["updatePrescriptionUseCase"]
    - path: "packages/backend/src/use-cases/programs/add-split-row.ts"
      provides: "Add split row for same exercise"
      exports: ["addSplitRowUseCase"]
    - path: "packages/backend/src/use-cases/programs/toggle-superset.ts"
      provides: "Toggle superset grouping"
      exports: ["toggleSupersetUseCase"]
  key_links:
    - from: "packages/backend/src/use-cases/programs/update-prescription.ts"
      to: "packages/contracts/src/programs/prescription.ts"
      via: "parsePrescriptionNotation"
      pattern: "parsePrescriptionNotation"
---

<objective>
Implement use cases for managing exercise rows and prescriptions (grid data operations).

Purpose: Enable coaches to add exercises, manage supersets/splits, and update prescription cells.
Output: Use cases for exercise row and prescription management.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-02-SUMMARY.md
@.planning/phases/03-program-builder/03-04-SUMMARY.md
@packages/backend/src/use-cases/exercises/create-exercise.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exercise row management use cases</name>
  <files>
    packages/backend/src/use-cases/programs/add-exercise-row.ts
    packages/backend/src/use-cases/programs/update-exercise-row.ts
    packages/backend/src/use-cases/programs/delete-exercise-row.ts
    packages/backend/src/use-cases/programs/reorder-exercise-rows.ts
  </files>
  <action>
**addExerciseRowUseCase:**
- Input: { sessionId, exerciseId, supersetGroup?, supersetOrder? }
- Authorization: Check hasPermission('program:update')
- Verify session and exercise exist
- Calculate orderIndex as max existing + 1
- If supersetGroup provided, validate supersetOrder
- Create row via repository.createExerciseRow()
- Return created row

**updateExerciseRowUseCase:**
- Input: { rowId, exerciseId?, supersetGroup?, supersetOrder?, setTypeLabel?, notes?, restSeconds? }
- Authorization: Check hasPermission('program:update')
- Verify row exists and belongs to user's program
- Merge input with existing
- Update via repository.updateExerciseRow()
- Return updated row

**deleteExerciseRowUseCase:**
- Input: { rowId }
- Authorization: Check hasPermission('program:update')
- Verify row exists and belongs to user's program
- If row has sub-rows (split rows), delete them too
- Delete via repository.deleteExerciseRow() (cascades prescriptions)
- Return success

**reorderExerciseRowsUseCase:**
- Input: { sessionId, rowIds: string[] } (new order)
- Authorization: Check hasPermission('program:update')
- Verify all rowIds belong to the session
- Use repository.reorderExerciseRows()
- Return success
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Exercise row management use cases implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create prescription and superset use cases</name>
  <files>
    packages/backend/src/use-cases/programs/update-prescription.ts
    packages/backend/src/use-cases/programs/add-split-row.ts
    packages/backend/src/use-cases/programs/toggle-superset.ts
  </files>
  <action>
**updatePrescriptionUseCase:**
- Input: { exerciseRowId, weekId, notation: string }
- Authorization: Check hasPermission('program:update')
- Verify exercise row and week belong to user's program
- Parse notation using parsePrescriptionNotation from contracts
- If notation is skip/null, store null
- Otherwise validate parsed prescription via createPrescription domain factory
- Use repository.upsertPrescription()
- Return parsed prescription or null

This is the CORE operation for the grid - called on every cell edit!

**addSplitRowUseCase:**
- Input: { parentRowId, setTypeLabel } (e.g., "BACK-OFF VOLUME")
- Authorization: Check hasPermission('program:update')
- Verify parent row exists and is NOT already a sub-row
- Create new row with:
  - Same sessionId, exerciseId, supersetGroup, supersetOrder
  - isSubRow: true
  - parentRowId: parent's ID
  - setTypeLabel from input
  - orderIndex: parent's orderIndex + 0.5 (then normalize all)
- Normalize orderIndexes in session
- Return created sub-row

**toggleSupersetUseCase:**
- Input: { rowId, supersetGroup: string | null }
- Authorization: Check hasPermission('program:update')
- If supersetGroup is null: remove from superset (clear group and order)
- If supersetGroup provided:
  - Find existing rows in that superset
  - Set supersetOrder to max + 1
  - Update row
- Return updated row
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Prescription, split row, and superset use cases implemented</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all use cases type-check correctly
2. Verify prescription parsing uses parsePrescriptionNotation correctly
3. Verify split rows maintain reference to parent
4. Verify superset toggling updates ordering correctly
</verification>

<success_criteria>
- Exercise rows can be added, updated, deleted, and reordered
- Prescription cells parse notation to structured data
- Split rows link to parent with setTypeLabel
- Superset grouping can be toggled on/off
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-07-SUMMARY.md`
</output>
