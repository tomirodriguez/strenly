---
phase: 03-program-builder
plan: 11
type: execute
wave: 5
depends_on: ["03-08", "03-09"]
files_modified:
  - apps/coach-web/package.json
  - apps/coach-web/src/lib/api/grid.ts
  - apps/coach-web/src/components/programs/program-grid.tsx
  - apps/coach-web/src/components/programs/prescription-cell.tsx
  - apps/coach-web/src/components/programs/exercise-picker-cell.tsx
autonomous: true

must_haves:
  truths:
    - "Grid uses @wasback/react-datasheet-grid for Excel-like behavior"
    - "Custom prescription cell parses notation on blur"
    - "Exercise picker uses combobox with autocomplete"
    - "Grid supports keyboard navigation (arrow keys, tab, enter)"
  artifacts:
    - path: "apps/coach-web/src/components/programs/program-grid.tsx"
      provides: "Main program grid component using react-datasheet-grid"
      min_lines: 100
    - path: "apps/coach-web/src/components/programs/prescription-cell.tsx"
      provides: "Custom cell for prescription notation editing"
      exports: ["prescriptionColumn"]
    - path: "apps/coach-web/src/components/programs/exercise-picker-cell.tsx"
      provides: "Custom cell for exercise selection"
      exports: ["exercisePickerColumn"]
  key_links:
    - from: "apps/coach-web/src/components/programs/prescription-cell.tsx"
      to: "@strenly/contracts"
      via: "parsePrescriptionNotation"
      pattern: "parsePrescriptionNotation"
---

<objective>
Install react-datasheet-grid and create the core grid components with custom cells.

Purpose: Build the Excel-like grid that is the core differentiator of the product.
Output: Program grid component with prescription and exercise picker cells.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-RESEARCH.md
@.planning/phases/03-program-builder/03-02-SUMMARY.md
@apps/coach-web/src/components/ui/combobox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-datasheet-grid and create API hooks</name>
  <files>
    apps/coach-web/package.json
    apps/coach-web/src/lib/api/grid.ts
  </files>
  <action>
**Install dependency:**
```bash
cd apps/coach-web && pnpm add @wasback/react-datasheet-grid
```

**Create grid API hooks (grid.ts):**
Hooks for all grid manipulation operations with optimistic updates:

```typescript
import { orpc } from './client'
import { useMutation, useQueryClient } from '@tanstack/react-query'

// Update prescription cell (most frequently called)
export function useUpdatePrescription(programId: string) {
  const queryClient = useQueryClient()

  return useMutation({
    ...orpc.programs.prescriptions.update.mutationOptions(),
    onMutate: async (newPrescription) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({
        queryKey: orpc.programs.get.queryOptions({ input: { id: programId } }).queryKey
      })

      // Snapshot previous value
      const previous = queryClient.getQueryData(
        orpc.programs.get.queryOptions({ input: { id: programId } }).queryKey
      )

      // Optimistically update
      // ... (update prescription in cached program data)

      return { previous }
    },
    onError: (err, newPrescription, context) => {
      // Rollback on error
      if (context?.previous) {
        queryClient.setQueryData(
          orpc.programs.get.queryOptions({ input: { id: programId } }).queryKey,
          context.previous
        )
      }
    },
    onSettled: () => {
      // Sync with server
      queryClient.invalidateQueries({
        queryKey: orpc.programs.get.queryOptions({ input: { id: programId } }).queryKey
      })
    },
  })
}

// Add exercise row
export function useAddExerciseRow(programId: string) { ... }

// Delete exercise row
export function useDeleteExerciseRow(programId: string) { ... }

// Reorder exercise rows
export function useReorderExerciseRows(programId: string) { ... }

// Add split row
export function useAddSplitRow(programId: string) { ... }

// Toggle superset
export function useToggleSuperset(programId: string) { ... }

// Week operations
export function useAddWeek(programId: string) { ... }
export function useUpdateWeek(programId: string) { ... }
export function useDeleteWeek(programId: string) { ... }
export function useDuplicateWeek(programId: string) { ... }

// Session operations
export function useAddSession(programId: string) { ... }
export function useUpdateSession(programId: string) { ... }
export function useDeleteSession(programId: string) { ... }
```
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>react-datasheet-grid installed and grid API hooks created</done>
</task>

<task type="auto">
  <name>Task 2: Create custom cells for prescription and exercise picker</name>
  <files>
    apps/coach-web/src/components/programs/prescription-cell.tsx
    apps/coach-web/src/components/programs/exercise-picker-cell.tsx
  </files>
  <action>
**Prescription cell (prescription-cell.tsx):**
Custom cell component for react-datasheet-grid that:
1. Shows formatted prescription (e.g., "3x8@120kg")
2. On focus, shows raw notation for editing
3. On blur, parses notation via parsePrescriptionNotation
4. Handles Enter/Tab/Escape for navigation
5. Shows placeholder "3x8@RIR2" when empty

Reference implementation from 03-RESEARCH.md Code Examples section.

```typescript
import { CellComponent, Column } from '@wasback/react-datasheet-grid'
import { parsePrescriptionNotation, formatPrescription, ParsedPrescription } from '@strenly/contracts'

const PrescriptionCell: CellComponent<ParsedPrescription | null> = ({ ... }) => {
  // ... implementation from research
}

export const prescriptionColumn = (): Column<ParsedPrescription | null> => ({
  component: PrescriptionCell,
  deleteValue: () => null,
  copyValue: ({ rowData }) => (rowData ? formatPrescription(rowData) : ''),
  pasteValue: ({ value }) => parsePrescriptionNotation(value),
  minWidth: 100,
})
```

**Exercise picker cell (exercise-picker-cell.tsx):**
Custom cell component that:
1. Shows exercise name
2. On focus, opens exercise search combobox
3. Uses existing cmdk/combobox pattern for exercise selection
4. Searches exercises via API (debounced)
5. On select, updates the row's exerciseId

```typescript
import { CellComponent, Column } from '@wasback/react-datasheet-grid'
import { useExercises } from '@/lib/api/exercises'

const ExercisePickerCell: CellComponent<{ exerciseId: string; exerciseName: string }> = ({ ... }) => {
  // Use combobox pattern from existing codebase
  // Search exercises on type
  // Show exercise name when not editing
}

export const exercisePickerColumn = (): Column<{ exerciseId: string; exerciseName: string }> => ({
  component: ExercisePickerCell,
  deleteValue: () => ({ exerciseId: '', exerciseName: '' }),
  copyValue: ({ rowData }) => rowData.exerciseName,
  pasteValue: ({ value }) => ({ exerciseId: '', exerciseName: value }),  // Will need lookup
  minWidth: 200,
})
```
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>Custom cells created for prescription and exercise picker</done>
</task>

<task type="auto">
  <name>Task 3: Create main program grid component</name>
  <files>apps/coach-web/src/components/programs/program-grid.tsx</files>
  <action>
Create the main grid component that assembles everything:

```typescript
import { DataSheetGrid, textColumn, keyColumn } from '@wasback/react-datasheet-grid'
import '@wasback/react-datasheet-grid/dist/style.css'
import { prescriptionColumn } from './prescription-cell'
import { exercisePickerColumn } from './exercise-picker-cell'
import { useProgram } from '@/lib/api/programs'
import { useUpdatePrescription, useAddExerciseRow, ... } from '@/lib/api/grid'

interface ProgramGridProps {
  programId: string
}

export function ProgramGrid({ programId }: ProgramGridProps) {
  const { data: program, isLoading } = useProgram(programId)
  const updatePrescription = useUpdatePrescription(programId)

  if (isLoading) return <GridSkeleton />

  // Transform program data to flat rows for react-datasheet-grid
  const { rows, columns } = useMemo(() => {
    // Build columns: Exercise | Week 1 | Week 2 | ...
    const columns = [
      keyColumn('exercise', exercisePickerColumn()),
      ...program.weeks.map(week => ({
        ...prescriptionColumn(),
        title: week.name,
        // ... week-specific config
      }))
    ]

    // Flatten sessions and exercises to rows
    // Insert session header rows
    const rows = program.sessions.flatMap(session => [
      { type: 'session-header', sessionId: session.id, name: session.name },
      ...session.exercises.map(ex => ({
        type: 'exercise',
        id: ex.id,
        exercise: { exerciseId: ex.exerciseId, exerciseName: ex.exerciseName },
        ...ex.prescriptions.reduce((acc, rx) => ({
          ...acc,
          [rx.weekId]: rx.prescription
        }), {})
      }))
    ])

    return { rows, columns }
  }, [program])

  // Handle cell changes
  const handleChange = useCallback((newRows, operations) => {
    operations.forEach(op => {
      if (op.type === 'UPDATE') {
        // Determine what changed and call appropriate mutation
        const row = newRows[op.fromRowIndex]
        // If prescription cell changed, call updatePrescription
        // If exercise changed, call updateExerciseRow
      }
    })
  }, [updatePrescription])

  return (
    <div className="h-full">
      <DataSheetGrid
        value={rows}
        onChange={handleChange}
        columns={columns}
        lockRows
        rowClassName={({ rowData }) =>
          rowData.type === 'session-header' ? 'day-header' : ''
        }
      />
    </div>
  )
}
```

Key features to implement:
1. Transform ProgramWithDetails to flat row structure
2. Handle session headers as special rows
3. Dynamic columns based on weeks
4. Cell change detection and mutation calls
5. Apply styling classes from UI/UX specs (superset lines, split row styling)
  </action>
  <verify>pnpm typecheck in apps/coach-web</verify>
  <done>Main program grid component created with data transformation</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all components type-check
2. Verify react-datasheet-grid imported correctly
3. Verify prescription cell parses notation on blur
4. Verify exercise picker searches and selects exercises
</verification>

<success_criteria>
- react-datasheet-grid installed and working
- Prescription cell parses notation to structured data
- Exercise picker integrates with existing combobox
- Grid handles keyboard navigation (arrow keys, tab, enter, escape)
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-11-SUMMARY.md`
</output>
