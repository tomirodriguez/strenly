---
phase: 03-program-builder
plan: 06
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - packages/backend/src/use-cases/programs/add-week.ts
  - packages/backend/src/use-cases/programs/update-week.ts
  - packages/backend/src/use-cases/programs/delete-week.ts
  - packages/backend/src/use-cases/programs/duplicate-week.ts
  - packages/backend/src/use-cases/programs/add-session.ts
  - packages/backend/src/use-cases/programs/update-session.ts
  - packages/backend/src/use-cases/programs/delete-session.ts
autonomous: true

must_haves:
  truths:
    - "Weeks can be added, renamed, and deleted from programs"
    - "Sessions (days) can be added, renamed, and deleted from programs"
    - "Duplicate week copies all prescriptions to new week"
    - "Deleting week/session cascades to nested entities"
  artifacts:
    - path: "packages/backend/src/use-cases/programs/add-week.ts"
      provides: "Add week use case"
      exports: ["addWeekUseCase"]
    - path: "packages/backend/src/use-cases/programs/duplicate-week.ts"
      provides: "Duplicate week with prescriptions"
      exports: ["duplicateWeekUseCase"]
    - path: "packages/backend/src/use-cases/programs/add-session.ts"
      provides: "Add session use case"
      exports: ["addSessionUseCase"]
  key_links:
    - from: "packages/backend/src/use-cases/programs/duplicate-week.ts"
      to: "packages/core/src/ports/program-repository.port.ts"
      via: "repository method"
      pattern: "duplicateWeek"
---

<objective>
Implement use cases for managing program weeks and sessions (grid structure operations).

Purpose: Enable coaches to customize program structure by adding/removing weeks and sessions.
Output: Use cases for week and session CRUD operations.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-04-SUMMARY.md
@packages/backend/src/use-cases/exercises/create-exercise.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create week management use cases</name>
  <files>
    packages/backend/src/use-cases/programs/add-week.ts
    packages/backend/src/use-cases/programs/update-week.ts
    packages/backend/src/use-cases/programs/delete-week.ts
    packages/backend/src/use-cases/programs/duplicate-week.ts
  </files>
  <action>
**addWeekUseCase:**
- Input: { programId, name? } (name defaults to "Semana {N+1}")
- Authorization: Check hasPermission('program:update')
- Verify program exists
- Calculate orderIndex as max existing + 1
- Create week via repository.createWeek()
- Return created week

**updateWeekUseCase:**
- Input: { weekId, name }
- Authorization: Check hasPermission('program:update')
- Verify week exists and belongs to user's program
- Update via repository.updateWeek()
- Return updated week

**deleteWeekUseCase:**
- Input: { weekId }
- Authorization: Check hasPermission('program:update')
- Verify week exists and belongs to user's program
- Prevent deletion if it's the last week (program must have at least 1 week)
- Delete via repository.deleteWeek() (cascades prescriptions)
- Return success

**duplicateWeekUseCase:**
- Input: { weekId, name? } (name defaults to source name + " (copia)")
- Authorization: Check hasPermission('program:update')
- Verify week exists and belongs to user's program
- Use repository.duplicateWeek() which:
  - Creates new week at next orderIndex
  - Copies ALL prescriptions from source week to new week
- Return created week with copied prescriptions
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Week management use cases implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create session management use cases</name>
  <files>
    packages/backend/src/use-cases/programs/add-session.ts
    packages/backend/src/use-cases/programs/update-session.ts
    packages/backend/src/use-cases/programs/delete-session.ts
  </files>
  <action>
**addSessionUseCase:**
- Input: { programId, name } (e.g., "DÍA 2 • PUSH")
- Authorization: Check hasPermission('program:update')
- Verify program exists
- Calculate orderIndex as max existing + 1
- Create session via repository.createSession()
- Return created session

**updateSessionUseCase:**
- Input: { sessionId, name }
- Authorization: Check hasPermission('program:update')
- Verify session exists and belongs to user's program
- Update via repository.updateSession()
- Return updated session

**deleteSessionUseCase:**
- Input: { sessionId }
- Authorization: Check hasPermission('program:update')
- Verify session exists and belongs to user's program
- Prevent deletion if it's the last session (program must have at least 1 session)
- Delete via repository.deleteSession() (cascades exercise rows and prescriptions)
- Return success
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Session management use cases implemented</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all use cases type-check correctly
2. Verify authorization check is FIRST in every use case
3. Verify business rules: minimum 1 week, minimum 1 session
4. Verify cascade delete works correctly
</verification>

<success_criteria>
- Weeks can be added, updated, deleted, and duplicated
- Sessions can be added, updated, and deleted
- Duplicate week copies all prescriptions
- Minimum structure enforced (at least 1 week and 1 session)
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-06-SUMMARY.md`
</output>
