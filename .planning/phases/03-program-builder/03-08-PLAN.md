---
phase: 03-program-builder
plan: 08
type: execute
wave: 4
depends_on: ["03-02", "03-05", "03-06", "03-07"]
files_modified:
  - packages/contracts/src/programs/program.ts
  - packages/contracts/src/programs/index.ts
  - packages/backend/src/procedures/programs/create.ts
  - packages/backend/src/procedures/programs/get.ts
  - packages/backend/src/procedures/programs/list.ts
  - packages/backend/src/procedures/programs/update.ts
  - packages/backend/src/procedures/programs/archive.ts
  - packages/backend/src/procedures/programs/duplicate.ts
  - packages/backend/src/procedures/programs/router.ts
autonomous: true

must_haves:
  truths:
    - "Contracts define Zod schemas for all program operations"
    - "Procedures are thin handlers that orchestrate use cases"
    - "All procedures require authentication via orgProcedure"
    - "Router exposes all program endpoints"
  artifacts:
    - path: "packages/contracts/src/programs/program.ts"
      provides: "Program input/output schemas"
      exports: ["createProgramSchema", "programOutputSchema", "listProgramsSchema"]
    - path: "packages/backend/src/procedures/programs/router.ts"
      provides: "Program procedures router"
      exports: ["programsRouter"]
  key_links:
    - from: "packages/backend/src/procedures/programs/create.ts"
      to: "packages/contracts/src/programs/program.ts"
      via: "schema import"
      pattern: "createProgramSchema"
---

<objective>
Create contracts and procedures for program CRUD and duplication operations.

Purpose: Expose program management functionality via oRPC API.
Output: Zod contracts in contracts package, thin procedures in backend package.
</objective>

<execution_context>
@/Users/tomiardz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomiardz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-program-builder/03-05-SUMMARY.md
@packages/contracts/src/exercises/exercise.ts
@packages/backend/src/procedures/exercises/router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create program contracts</name>
  <files>
    packages/contracts/src/programs/program.ts
    packages/contracts/src/programs/index.ts
  </files>
  <action>
Create Zod schemas for program operations:

**Input schemas:**
```typescript
// Create program
export const createProgramSchema = z.object({
  name: z.string().min(3).max(100),
  description: z.string().max(500).optional(),
  athleteId: z.string().optional(), // null for templates
  isTemplate: z.boolean().optional(),
})

// Update program
export const updateProgramSchema = z.object({
  id: z.string(),
  name: z.string().min(3).max(100).optional(),
  description: z.string().max(500).optional(),
})

// List programs
export const listProgramsSchema = z.object({
  athleteId: z.string().optional(),
  isTemplate: z.boolean().optional(),
  status: z.enum(['draft', 'active', 'archived']).optional(),
  search: z.string().optional(),
  page: z.number().min(1).optional(),
  pageSize: z.number().min(1).max(100).optional(),
})

// Duplicate program
export const duplicateProgramSchema = z.object({
  programId: z.string(),
  name: z.string().min(3).max(100).optional(),
  athleteId: z.string().optional(),
  isTemplate: z.boolean().optional(),
})
```

**Output schemas:**
```typescript
export const programOutputSchema = z.object({
  id: z.string(),
  name: z.string(),
  description: z.string().nullable(),
  athleteId: z.string().nullable(),
  isTemplate: z.boolean(),
  status: z.enum(['draft', 'active', 'archived']),
  createdAt: z.date(),
  updatedAt: z.date(),
})

// Full program with nested data for grid
export const programWithDetailsSchema = programOutputSchema.extend({
  weeks: z.array(weekOutputSchema),
  sessions: z.array(sessionWithExercisesSchema),
})
```

Create index.ts to export all schemas.
  </action>
  <verify>pnpm typecheck in packages/contracts</verify>
  <done>Program contracts created with input/output schemas</done>
</task>

<task type="auto">
  <name>Task 2: Create program procedures and router</name>
  <files>
    packages/backend/src/procedures/programs/create.ts
    packages/backend/src/procedures/programs/get.ts
    packages/backend/src/procedures/programs/list.ts
    packages/backend/src/procedures/programs/update.ts
    packages/backend/src/procedures/programs/archive.ts
    packages/backend/src/procedures/programs/duplicate.ts
    packages/backend/src/procedures/programs/router.ts
  </files>
  <action>
Create thin procedures that orchestrate use cases:

**Pattern (same for all):**
```typescript
import { orgProcedure } from '../../base'
import { createProgramSchema, programOutputSchema } from '@strenly/contracts'
import { createProgramUseCase } from '../../use-cases/programs/create-program'

export const createProgramProcedure = orgProcedure
  .input(createProgramSchema)
  .output(programOutputSchema)
  .mutation(async ({ input, ctx }) => {
    const result = await createProgramUseCase(input, ctx.org, ctx.user)

    if (result.isErr()) {
      // Map domain errors to HTTP errors
      throw mapProgramError(result.error)
    }

    return result.value
  })
```

**Router (router.ts):**
```typescript
export const programsRouter = {
  create: createProgramProcedure,
  get: getProgramProcedure,
  list: listProgramsProcedure,
  update: updateProgramProcedure,
  archive: archiveProgramProcedure,
  duplicate: duplicateProgramProcedure,
}
```

Add programsRouter to main router in procedures/router.ts.
  </action>
  <verify>pnpm typecheck in packages/backend</verify>
  <done>Program procedures and router created</done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - contracts and procedures type-check correctly
2. Verify all procedures use orgProcedure for authentication
3. Verify router is added to main procedures router
4. Verify error mapping handles all domain error types
</verification>

<success_criteria>
- Contracts define schemas for all program operations
- Procedures are thin handlers calling use cases
- All endpoints require organization authentication
- Router exposes: create, get, list, update, archive, duplicate
</success_criteria>

<output>
After completion, create `.planning/phases/03-program-builder/03-08-SUMMARY.md`
</output>
